<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Science Leaderboard - Grade 6 - Edutaktika</title>
</head>
<body>
 <script>
    document.addEventListener("DOMContentLoaded", function() {
        firebase.auth().onAuthStateChanged(async function(user) {
            if (!user) {
                window.location.href = "logreg.html";
                return;
            }
            const uid = user.uid;
            const snapshot = await firebase.database().ref('students/' + uid).once('value');
            const student = snapshot.val();
            if (!student || student.role !== "student") {
                document.getElementById('mainContent').style.display = "none";
                alert("Access denied. Only students can access this page.");
                await firebase.auth().signOut();
                window.location.href = "logreg.html";
            } else {
                document.getElementById('mainContent').style.display = "block";
                // Load leaderboard after authentication is confirmed
                loadLeaderboard();
                loadAssessmentLeaderboard();
            }
        });
    });
    </script>

<head>
    <meta charset="UTF-8">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <title>Science Leaderboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../CSS/header.css">
    <link rel="stylesheet" href="../CSS/leaderboard.css">
    <link rel="stylesheet" href="../CSS/footer.css">
        <link rel="stylesheet" href="../CSS/fonts.css">
<!-- ...inside <head> -->
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700&family=Manrope:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
    <div id="mainContent" style="display:none;">
        <!-- All your visible content goes here -->
        <header>
            <div class="floating-elements">
                <div class="floating-element"></div>
                <div class="floating-element"></div>
                <div class="floating-element"></div>
                <div class="floating-element"></div>
            </div>
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <!-- Replace your logo-text div with this for per-letter bounce -->
                    <div class="logo-text">
                        <span>E</span><span>d</span><span>u</span><span>t</span><span>a</span><span>k</span><span>t</span><span>i</span><span>k</span><span>a</span>
                    </div>
                </div>
                <nav>
                    <ul>
                        <li><a href="homepage.html">Home</a></li>
                       <li class="dropdown">
                            <a href="#" class="dropbtn">Subject <i class="fa fa-caret-down"></i></a>
                            <ul class="dropdown-content">
                                <li><a href="subject_math.html">Math</a></li>
                                <li><a href="subject_english.html">English</a></li>
                                <li><a href="subject_science.html">Science</a></li>
                            </ul>
                        </li>
                        <li class="dropdown">
                            <a href="#" class="dropbtn">Leaderboard <i class="fa fa-caret-down"></i></a>
                            <ul class="dropdown-content">
                                <li><a href="leaderboard_math.html">Math</a></li>
                                <li><a href="leaderboard_english.html">English</a></li>
                                <li><a href="leaderboard_science.html">Science</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="#" id="profileBtn"><i class="fas fa-user-circle"></i> Profile</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </header>

     <!-- Profile Sidebar (Dynamic with Firebase) -->
<div id="profileSidebar" class="profile-sidebar">
    <div class="sidebar-content">
        <button class="close-btn" id="closeSidebar">&times;</button>
        <div style="position:relative; display:flex; flex-direction:column; align-items:center;">
            <img class="profile-avatar" id="profileAvatar" src="https://api.dicebear.com/7.x/bottts/svg?seed=user" alt="Profile Avatar">
            <i class="fa-solid fa-star sidebar-star" style="position:absolute; bottom:0; right:10px; color:#ffd700; font-size:1.2rem; background:white; border-radius:50%; padding:2px 4px; box-shadow:0 1px 4px #ffd70044;"></i>
        </div>
        <div class="profile-name" id="profileName">Loading...</div>
        <br>
        <div class="profile-info" style="width:100%;max-width:260px;margin-bottom:24px;">
            <div class="profile-role" style="color:#2e8b57; font-weight:700; font-size:1.1rem; margin-bottom:8px; letter-spacing:1px; text-align:center;">
            Student
        </div>
            <div>
                <i class="fa-solid fa-id-badge" style="color:violet;margin-right:10px;"></i>
                <strong>ID:</strong> <span id="profileId">-</span>
            </div>
            <div>
                <i class="fa-solid fa-user" style="color:#ff69b4;margin-right:10px;"></i>
                <strong>First Name:</strong> <span id="profileFirstName">-</span>
            </div>
            <div>
                <i class="fa-solid fa-user" style="color:#ffd700;margin-right:10px;"></i>
                <strong>Middle Name:</strong> <span id="profileMiddleName">-</span>
            </div>
            <div>
                <i class="fa-solid fa-user" style="color:#f14141;margin-right:10px;"></i>
                <strong>Last Name:</strong> <span id="profileLastName">-</span>
            </div>
            <div>
                <i class="fa-solid fa-graduation-cap" style="color:#2e8b57;margin-right:10px;"></i>
                <strong>Grade Level:</strong> <span id="profileGrade">-</span>
            </div>
            <div>
                <i class="fa-solid fa-apple-whole" style="color:#4faaff;margin-right:10px;"></i>
                <strong>Section:</strong> <span id="profileSection">-</span>
            </div>
            <div>
    <i class="fas fa-map-marker-alt" style="color:#ff69b4;margin-right:10px;"></i>
    <strong>House/Street:</strong> <span id="profileAddressStreet">-</span>
</div>
<div>
    <i class="fas fa-map-marker-alt" style="color:#ffd700;margin-right:10px;"></i>
    <strong>Barangay:</strong> <span id="profileAddressBarangay">-</span>
</div>
<div>
    <i class="fas fa-map-marker-alt" style="color:#4faaff;margin-right:10px;"></i>
    <strong>City:</strong> <span id="profileAddressCity">-</span>
</div>
<div>
    <i class="fas fa-map-marker-alt" style="color:#2e8b57;margin-right:10px;"></i>
    <strong>Province:</strong> <span id="profileAddressProvince">-</span>
</div>
<div>
    <i class="fas fa-map-marker-alt" style="color:#f14141;margin-right:10px;"></i>
    <strong>ZIP:</strong> <span id="profileAddressZip">-</span>
</div>
<div>
    <i class="fas fa-map-marker-alt" style="color:violet;margin-right:10px;"></i>
    <strong>Region:</strong> <span id="profileAddressRegion">-</span>
</div>
        </div>
        <div class="logout-switch-row">
            <div class="logout-switch" id="logoutSwitch">
                <div class="logout-switch-circle"></div>
            </div>
            <span class="logout-label" id="logoutLabel">LOGOUT</span>
        </div>
    </div>
</div>

<style>
    .profile-sidebar {
    margin-top: 20px;
    max-height: 95vh;
    overflow-y: auto;
    scrollbar-width: none;         /* Firefox */
    -ms-overflow-style: none;      /* IE and Edge */
}
.profile-sidebar::-webkit-scrollbar {
    display: none;                 /* Chrome, Safari, Opera */
}
</style>

            <!-- Firebase App (the core Firebase SDK) -->
            <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
            <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
            <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

            

        <script src="../assets/js/Student Side/header.js"></script>

        <div class="leaderboard-container">
            <div class="leaderboard-title" id="leaderboardTitle">üåü Science Leaderboard üåü</div>
            <div class="leaderboard-desc">See who's on top this week! Play games, earn points, and climb the ranks!</div>
            
            <!-- Podium -->
            <div class="podium" id="podium"></div>
            <!-- Leaderboard Table -->
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Player</th>
                        <th>Quiz Points</th>
                        <th>Assessment Points</th>
                        <th>Total</th>
                        <th>Badges</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <!-- Leaderboard rows will be inserted here -->
                </tbody>
            </table>
            <!-- Pagination (static, for demo) -->
            <div class="pagination">
                <button disabled>&lt; Prev</button>
                <button class="active">1</button>
                <button disabled>2</button>
                <button disabled>3</button>
                <button disabled>Next &gt;</button>
            </div>
        </div>
        
        <script>
        const firebaseConfig = {
                apiKey: "AIzaSyB5BbeLLvPX8l1c4Lq0f-CmIUml4hQOQlE",
                authDomain: "edutaktika.firebaseapp.com",
                databaseURL: "https://edutaktika-default-rtdb.firebaseio.com",
                projectId: "edutaktika",
                storageBucket: "edutaktika.appspot.com",
                messagingSenderId: "676848575316",
                appId: "1:676848575316:web:f78f8c0f83bf3d9dfb5ec1",
                measurementId: "G-X3GT5TNN87"
            };
            // Removed legacy v8 firebase-app.js & firebase-database.js to prevent duplicate global definition
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            const auth = firebase.auth();
       

        // 2. Fetch and display leaderboard (based on current user's grade)
        async function loadLeaderboard() {
            // Get current user's grade level
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return;
            
            const userSnapshot = await db.ref('students/' + currentUser.uid).once('value');
            const userData = userSnapshot.val();
            const userGrade = userData ? userData.gradelevel : null;
            
            if (!userGrade) {
                console.error('Could not determine user grade level');
                return;
            }
            
            // Update title to show current user's grade
            const titleEl = document.getElementById('leaderboardTitle');
            if (titleEl) {
                titleEl.textContent = `üåü Science Leaderboard - Grade ${userGrade} üåü`;
            }
            
            // Update page title
            document.title = `Science Leaderboard - Grade ${userGrade}`;
            
            // Base student snapshot (ordered by quiz points for initial retrieval)
            const snapshot = await db.ref('students').orderByChild('points').once('value');
            let students = [];
            snapshot.forEach(child => {
                const s = child.val() || {};
                s._key = child.key;
                students.push(s);
            });

            // Try global assessmentSummaries first
            let assessmentTotals = {}; // uid -> total assessment best
            try {
                const summariesSnap = await db.ref('assessmentSummaries').once('value');
                if (summariesSnap.exists()) {
                    summariesSnap.forEach(assessNode => {
                        assessNode.forEach(userNode => {
                            const uid = userNode.key;
                            const val = userNode.val();
                            const best = (val && typeof val.best === 'number') ? val.best : 0;
                            if (!assessmentTotals[uid]) assessmentTotals[uid] = 0;
                            assessmentTotals[uid] += best; // sum bests across assessments
                        });
                    });
                } else {
                    // Fallback: compute from students/<uid>/assessments/*/summary already present in student objects
                    students.forEach(s => {
                        let total = 0;
                        if (s.assessments) {
                            Object.keys(s.assessments).forEach(aid => {
                                const summary = s.assessments[aid]?.summary;
                                if (summary && typeof summary.best === 'number') total += summary.best;
                            });
                        }
                        if (total > 0) assessmentTotals[s._key] = total;
                    });
                }
            } catch(err) {
                console.warn('Assessment totals fetch issue:', err);
            }

            // Attach quiz, assessment, total points
            // Note: No Science quizzes exist, so all quiz points are 0
            students.forEach(s => {
                s.quizPoints = 0; // No Science quizzes available
                s.assessmentPoints = assessmentTotals[s._key] || 0;
                s.combinedPoints = s.quizPoints + s.assessmentPoints;
            });

            // Filter for current user's grade level only
            students = students.filter(s => s.gradelevel == userGrade);

            // Sort descending by combined, then assessment, then quiz, then name
            students.sort((a,b) => {
                // Primary sort: Combined points (descending)
                if (b.combinedPoints !== a.combinedPoints) return b.combinedPoints - a.combinedPoints;
                // Secondary sort: Assessment points (descending)
                if (b.assessmentPoints !== a.assessmentPoints) return b.assessmentPoints - a.assessmentPoints;
                // Tertiary sort: Quiz points (descending)
                if (b.quizPoints !== a.quizPoints) return b.quizPoints - a.quizPoints;
                // Final sort: Name (ascending)
                const nameA = ((a.fname||'') + ' ' + (a.lname||'')).trim();
                const nameB = ((b.fname||'') + ' ' + (b.lname||'')).trim();
                return nameA.localeCompare(nameB);
            });

            // Podium (top 3) based on combinedPoints
            const podiumIndices = [1, 0, 2]; // 2nd, 1st, 3rd visually
            const podiumClasses = ['silver', 'gold', 'bronze'];
            const podiumRanks = [2, 1, 3];
            let podiumHtml = '';
            podiumIndices.forEach((studentIdx, i) => {
                if (!students[studentIdx]) return;
                const student = students[studentIdx];
                const avatar = student.avatar ? student.avatar : `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent((student.fname||'') + (student.lname||''))}`;
                podiumHtml += `
                <div class="podium-place ${podiumClasses[i]}">
                    <div class="podium-rank">${podiumRanks[i]}</div>
                    <img src="${avatar}" class="avatar" alt="${student.fname||''}">
                    <div class="podium-name">${(student.fname||'') + ' ' + (student.lname||'')}</div>
                    <div class="podium-score">${student.combinedPoints} total</div>
                </div>`;
            });
            document.getElementById('podium').innerHTML = podiumHtml;

            // Leaderboard table rows
            let tbodyHtml = '';
            students.forEach((student, idx) => {
                const avatar = student.avatar ? student.avatar : `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent((student.fname||'') + (student.lname||''))}`;
                let badges = 'üèÖ';
                if (idx === 0) badges = 'üèÖüèÖüèÖ';
                else if (idx === 1) badges = 'üèÖüèÖ';
                tbodyHtml += `
                <tr${idx === 0 ? ' class="me"' : ''}>
                    <td>${idx + 1}</td>
                    <td>
                        <span class="player-cell">
                            <img src="${avatar}" class="avatar-small" alt="${student.fname||''}">
                            <span class="player-name">${(student.fname||'') + ' ' + (student.lname||'')}</span>
                            <span class="tooltiptext">${idx === 0 ? 'Top scorer!' : 'Great job!'}</span>
                        </span>
                    </td>
                    <td>${student.quizPoints}</td>
                    <td>${student.assessmentPoints}</td>
                    <td>${student.combinedPoints}</td>
                    <td>${badges}</td>
                </tr>`;
            });
            document.getElementById('leaderboard-body').innerHTML = tbodyHtml;
        }

        // loadLeaderboard() and loadAssessmentLeaderboard() are now called after authentication is confirmed
        </script>

        <footer>
            <div class="footer-content">
                <div class="footer-column">
                    <h3 class="edu">Eduktaktika</h3>
                    <p>
                        Making learning fun and engaging through interactive game-based
                        education.
                    </p>
                </div>
                <div class="footer-column">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="homepage.php">Home</a></li>
                        <li><a href="subjectTeacher.php">Subject</a></li>
                        <li><a href="studentlistTeacher.php">Student</a></li>
                        <li><a href="leaderboardTeacher.php">Leaderboard</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Support</h3>
                    <ul>
                        <li><a href="#">Help Center</a></li>
                        <li><a href="#">Contact Us</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Service</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <div class="footer-links">
                    <a href="#"><i class="fab fa-facebook"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-youtube"></i></a>
                </div>
                <p>¬© 2023 Eduktaktika. All rights reserved.</p>
            </div>
        </footer>

            <!-- Edit Profile Modal -->
    <link rel="stylesheet" href="../CSS/editProfile.css">

    <div id="editProfileModal">
        <div class="modal-content">
            <h3>Edit Profile</h3>
            <form id="editProfileForm">
                <label>First Name:<br>
                    <input type="text" id="edit_fname" required>
                </label><br>
                <label>Middle Name:<br>
                    <input type="text" id="edit_mname">
                </label><br>
                <label>Last Name:<br>
                    <input type="text" id="edit_lname" required>
                </label><br>
                <label>Grade Level:<br>
                    <input type="text" id="edit_gradelevel" required>
                </label><br>
                <label>Section:<br>
                    <input type="text" id="edit_section">
                </label><br>
                
                <div style="text-align:right;">
                    <button type="button" onclick="closeEditProfileModal()">Cancel</button>
                    <button type="submit">Save</button>
                </div>
            </form>
        </div>
    </div>
    <script src="../assets/js/Student Side/editProfile.js"></script>

    <style>
        nav ul {
        display: flex;
        align-items: center;
        padding: 0;
        margin: 0;
    }
    nav ul li {
        list-style: none;
        margin: 0 10px;
        position: relative;
        height: 100%;
        display: flex;
        align-items: center;
    }
    nav ul li a, nav ul li .dropbtn {
        display: flex;
        align-items: center;
        height: 48px; /* Match your nav height */
        line-height: 48px;
        padding: 0 18px;
        color: #2d3923;
        text-decoration: none;
        font-size: 1rem;
        background: none;
        border: none;
        cursor: pointer;
    }
    nav ul li .dropdown-content {
        display: none;
        position: absolute;
        background: #fff;
        min-width: 120px;
        box-shadow: 0 4px 16px #0002;
        z-index: 1000;
        border-radius: 8px;
        padding: 0;
        margin: 0;
        top: 100%;
        left: 0;
    }
    nav ul li .dropdown-content li {
        list-style: none;
        border-bottom: 1px solid #eee;
    }
    nav ul li .dropdown-content li:last-child {
        border-bottom: none;
    }
    nav ul li .dropdown-content a {
        color:  18px;
        color: #2d3923;
        padding: 10px 20px;
        display: block;
        text-decoration: none;
        border-radius: 0;
        transition: background 0.2s;
        height: auto;
        line-height: normal;
    }
    nav ul li .dropdown-content a:hover {
        background: #f0f0f0;
    }
    nav ul li.dropdown:hover .dropdown-content {
        display: block;
    }
    </style>

    <script>
    // Fetch and display student info in the profile sidebarh
    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            firebase.database().ref('students/' + user.uid).once('value').then(function(snapshot) {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('profileName').textContent = (data.fname || '') + ' ' + (data.lname || '');
                    document.getElementById('profileId').textContent = data.id || user.uid;
                    document.getElementById('profileFirstName').textContent = data.fname || '';
                    document.getElementById('profileMiddleName').textContent = data.mname || '';
                    document.getElementById('profileLastName').textContent = data.lname || '';
                    document.getElementById('profileGrade').textContent = data.gradelevel || '-';
                    document.getElementById('profileSection').textContent = data.section || '-';
                    document.getElementById('profileAvatar').src = "https://api.dicebear.com/7.x/bottts/svg?seed=" + encodeURIComponent(data.fname || "student");
                }
                if (data.address) {
                    document.getElementById('profileAddressStreet').textContent = data.address.street || '-';
                    document.getElementById('profileAddressBarangay').textContent = data.address.barangay || '-';
                    document.getElementById('profileAddressCity').textContent = data.address.city || '-';
                    document.getElementById('profileAddressProvince').textContent = data.address.province || '-';
                    document.getElementById('profileAddressZip').textContent = data.address.zip || '-';
                    document.getElementById('profileAddressRegion').textContent = data.address.region || '-';
                }
                
            });
        }
    });
    </script>

    <script src="../assets/js/Student Side/profile.js"></script>

    <div class="leaderboard-container" style="margin-top:40px;">
            <div class="leaderboard-title" id="assessmentTitle">üìò Assessment Leaderboard</div>
            <div class="leaderboard-desc" id="assessmentDesc">Top students by best assessment scores.</div>
            <table class="leaderboard-table" id="assessmentLeaderboardTable" style="margin-top:18px;">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Student</th>
                        <th>Assessment 1 Best</th>
                        <th>Total Best (All)</th>
                    </tr>
                </thead>
                <tbody id="assessment-leaderboard-body">
                    <tr><td colspan="4" style="text-align:center;padding:18px;">Loading...</td></tr>
                </tbody>
            </table>
        </div>

    <script>
    // Unified Assessment Data Fetch
    async function fetchAssessmentAggregates(){
      // Try global summaries first
      const summariesSnap = await firebase.database().ref('assessmentSummaries').once('value');
      let source = 'summaries';
      const aggregates = {}; // uid -> {assessmentBest:{id:best}, totalBest}
      if(summariesSnap.exists()){
        summariesSnap.forEach(assessNode => {
          const aid = assessNode.key;
          assessNode.forEach(userNode => {
            const uid = userNode.key; const val = userNode.val();
            if(!aggregates[uid]) aggregates[uid] = { assessmentBest:{}, totalBest:0 };
            const best = (val && typeof val.best === 'number') ? val.best : 0;
            aggregates[uid].assessmentBest[aid] = best;
          });
        });
      } else {
        // Fallback: per student path: students/<uid>/assessments/<assessmentId>/summary
        source = 'students';
        const studentsSnap = await firebase.database().ref('students').once('value');
        studentsSnap.forEach(stuNode => {
          const uid = stuNode.key;
          const assessRoot = stuNode.child('assessments');
          if(!assessRoot.exists()) return;
          assessRoot.forEach(aNode => {
            const aid = aNode.key;
            const summaryNode = aNode.child('summary');
            if(!summaryNode.exists()) return;
            const summary = summaryNode.val();
            const best = (summary && typeof summary.best === 'number') ? summary.best : 0;
            if(!aggregates[uid]) aggregates[uid] = { assessmentBest:{}, totalBest:0 };
            aggregates[uid].assessmentBest[aid] = best;
          });
        });
      }
      // compute totals
      Object.keys(aggregates).forEach(uid => {
        const a = aggregates[uid];
        a.totalBest = Object.values(a.assessmentBest).reduce((s,v)=> s+ (v||0), 0);
      });
      return {aggregates, source};
    }
    </script>
    <script>
    // Assessment leaderboard based on current user's grade
    async function loadAssessmentLeaderboard() {
      const tbody = document.getElementById('assessment-leaderboard-body');
      if(!tbody) return;
      
      // Get current user's grade level
      const currentUser = firebase.auth().currentUser;
      if (!currentUser) return;
      
      const userSnapshot = await firebase.database().ref('students/' + currentUser.uid).once('value');
      const userData = userSnapshot.val();
      const userGrade = userData ? userData.gradelevel : null;
      
      if (!userGrade) {
        console.error('Could not determine user grade level for assessment leaderboard');
        return;
      }
      
      // Update assessment title and description
      const assessmentTitleEl = document.getElementById('assessmentTitle');
      const assessmentDescEl = document.getElementById('assessmentDesc');
      if (assessmentTitleEl) {
        assessmentTitleEl.textContent = `üìò Assessment Leaderboard - Grade ${userGrade}`;
      }
      if (assessmentDescEl) {
        assessmentDescEl.textContent = `Top Grade ${userGrade} students by best assessment scores.`;
      }
      
      try {
        const [{aggregates}, studentsSnap] = await Promise.all([
          fetchAssessmentAggregates(),
          firebase.database().ref('students').once('value')
        ]);
        const students = studentsSnap.val() || {};
        let rows = Object.keys(aggregates).map(uid => {
          const info = students[uid] || {};
          const name = ((info.fname||'') + ' ' + (info.lname||'')).trim() || uid.substring(0,6);
          const a1 = aggregates[uid].assessmentBest['assessment1'] !== undefined ? aggregates[uid].assessmentBest['assessment1'] : '-';
          return { uid, name, a1, totalBest: aggregates[uid].totalBest, gradelevel: info.gradelevel };
        });
        
        // Filter for current user's grade level only
        rows = rows.filter(r => r.gradelevel == userGrade);
        
        rows.sort((a,b)=> {
            // Primary sort: Total best score (descending)
            if (b.totalBest !== a.totalBest) return b.totalBest - a.totalBest;
            // Secondary sort: Assessment 1 score (descending)
            if (b.a1 !== a.a1) return b.a1 - a.a1;
            // Final sort: Name (ascending)
            return a.name.localeCompare(b.name);
        });
        if(rows.length === 0){
          tbody.innerHTML = `<tr><td colspan="4" style="padding:18px;text-align:center;">No Grade ${userGrade} assessment data.</td></tr>`; return;
        }
        tbody.innerHTML = rows.map((r,i)=>`<tr><td>${i+1}</td><td>${r.name}</td><td>${r.a1}</td><td>${r.totalBest}</td></tr>`).join('');
      } catch(e){
        console.error(e); tbody.innerHTML = `<tr><td colspan='4' style='padding:18px;text-align:center;color:#c00;'>${e.message}</td></tr>`;
      }
    }
    </script>
    <script>
    // Update Quiz vs Assessment aggregation to use unified fetch
    (async function(){
      const bodyEl = document.getElementById('qa-comparison-body');
      if(!bodyEl) return;
      try {
        const [{aggregates}, studentsSnap] = await Promise.all([
          fetchAssessmentAggregates(),
          firebase.database().ref('students').once('value')
        ]);
        const students = studentsSnap.val() || {};
        const rows = Object.keys(students).map(uid => {
          const stu = students[uid] || {};
          const quizPoints = 0; // No Science quizzes available
          const assessPoints = (aggregates[uid] && aggregates[uid].totalBest) || 0;
          const overall = quizPoints + assessPoints;
          const name = ((stu.fname||'') + ' ' + (stu.lname||'')).trim() || uid.substring(0,6);
          return { uid, name, quizPoints, assessPoints, overall };
        });
        rows.sort((a,b)=> {
            // Primary sort: Overall points (descending)
            if (b.overall !== a.overall) return b.overall - a.overall;
            // Secondary sort: Assessment points (descending)
            if (b.assessPoints !== a.assessPoints) return b.assessPoints - a.assessPoints;
            // Tertiary sort: Quiz points (descending)
            if (b.quizPoints !== a.quizPoints) return b.quizPoints - a.quizPoints;
            // Final sort: Name (ascending)
            return a.name.localeCompare(b.name);
        });
        if(rows.length === 0){ bodyEl.innerHTML = '<tr><td colspan="5" style="padding:18px;text-align:center;">No data.</td></tr>'; return; }
        bodyEl.innerHTML = rows.map((r,i)=>`<tr><td>${i+1}</td><td>${r.name}</td><td>${r.quizPoints}</td><td>${r.assessPoints}</td><td>${r.overall}</td></tr>`).join('');
      } catch(err){
        console.error('QA comparison error', err);
        bodyEl.innerHTML = `<tr><td colspan='5' style='padding:18px;text-align:center;color:#c00;'>Error: ${err.message}</td></tr>`;
      }
    })();
    </script>
    </div>
</body>
</html>
