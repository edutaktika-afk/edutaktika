 <script>
    document.addEventListener("DOMContentLoaded", function() {
        firebase.auth().onAuthStateChanged(async function(user) {
            if (!user) {
                window.location.href = "logreg.html";
                return;
            }
            const uid = user.uid;
            const snapshot = await firebase.database().ref('students/' + uid).once('value');
            const student = snapshot.val();
            if (!student || student.role !== "student") {
                document.getElementById('mainContent').style.display = "none";
                alert("Access denied. Only students can access this page.");
                await firebase.auth().signOut();
                window.location.href = "logreg.html";
            } else {
                document.getElementById('mainContent').style.display = "block";
                // Load leaderboard after authentication is confirmed
                loadLeaderboard();
            }
        });
    });
    </script>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Leaderboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="../CSS/fonts.css">
<!-- ...inside <head> -->
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700&family=Manrope:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="../CSS/header.css">
    <link rel="stylesheet" href="../CSS/leaderboard.css">
    <link rel="stylesheet" href="../CSS/footer.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
    <div id="mainContent" style="display:none;">
        <!-- All your visible content goes here -->
        <header>
            <div class="floating-elements">
                <div class="floating-element"></div>
                <div class="floating-element"></div>
                <div class="floating-element"></div>
                <div class="floating-element"></div>
            </div>
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <!-- Replace your logo-text div with this for per-letter bounce -->
                    <div class="logo-text">
                        <span>E</span><span>d</span><span>u</span><span>t</span><span>a</span><span>k</span><span>t</span><span>i</span><span>k</span><span>a</span>
                    </div>
                </div>
                <nav>
                    <ul>
                        <li><a href="homepage.html">Home</a></li>
                       <li class="dropdown">
                            <a href="#" class="dropbtn">Subject <i class="fa fa-caret-down"></i></a>
                            <ul class="dropdown-content">
                                <li><a href="subject_math.html">Math</a></li>
                                <li><a href="subject_english.html">English</a></li>
                                <li><a href="subject_science.html">Science</a></li>
                            </ul>
                        </li>
                        <li><a href="leaderboard.html">Leaderboard</a></li>
                        <li>
                            <a href="#" id="profileBtn"><i class="fas fa-user-circle"></i> Profile</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </header>

         <!-- Profile Sidebar (Dynamic with Firebase) -->
            <div id="profileSidebar" class="profile-sidebar">
                <div class="sidebar-content">
                    <button class="close-btn" id="closeSidebar">&times;</button>
                    <img class="profile-avatar" id="profileAvatar" src="https://api.dicebear.com/7.x/bottts/svg?seed=user" alt="Profile Avatar">
                    <div class="profile-name" id="profileName">Loading...</div>
                    <button class="profile-edit-btn">Edit Profile</button><br>
                    <div class="profile-info" style="width:100%;max-width:260px;margin-bottom:24px;">
                        <div><strong>ID:</strong> <span id="profileId">-</span></div>
                        <div><strong>First Name:</strong> <span id="profileFirstName">-</span></div>
                        <div><strong>Middle Name:</strong> <span id="profileMiddleName">-</span></div>
                        <div><strong>Last Name:</strong> <span id="profileLastName">-</span></div>
                        <div><strong>Grade Level:</strong> <span id="profileGrade">-</span></div>
                        <div><strong>Section:</strong> <span id="profileSection">-</span></div>
                    </div>
                    <div class="logout-switch-row">
                        <div class="logout-switch" id="logoutSwitch">
                            <div class="logout-switch-circle"></div>
                        </div>
                        <span class="logout-label" id="logoutLabel">LOGOUT</span>
                    </div>
                </div>
            </div>

            <!-- Firebase App (the core Firebase SDK) -->
            <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
            <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
            <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

            

        <script src="../assets/js/Teacher Side/header.js"></script>

        <div class="leaderboard-container">
            <div class="leaderboard-title">üåü Student Leaderboard üåü</div>
            <div class="leaderboard-desc">See who's on top this week! Play games, earn points, and climb the ranks!</div>
            <!-- Podium -->
            <div class="podium" id="podium"></div>
            <!-- Leaderboard Table -->
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Player</th>
                        <th>Quiz Points</th>
                        <th>Assessment Points</th>
                        <th>Total</th>
                        <th>Badges</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <!-- Leaderboard rows will be inserted here -->
                </tbody>
            </table>
            <!-- Pagination (static, for demo) -->
            <div class="pagination">
                <button disabled>&lt; Prev</button>
                <button class="active">1</button>
                <button disabled>2</button>
                <button disabled>3</button>
                <button disabled>Next &gt;</button>
            </div>
        </div>
        
        <script>
        const firebaseConfig = {
                apiKey: "AIzaSyB5BbeLLvPX8l1c4Lq0f-CmIUml4hQOQlE",
                authDomain: "edutaktika.firebaseapp.com",
                databaseURL: "https://edutaktika-default-rtdb.firebaseio.com",
                projectId: "edutaktika",
                storageBucket: "edutaktika.appspot.com",
                messagingSenderId: "676848575316",
                appId: "1:676848575316:web:f78f8c0f83bf3d9dfb5ec1",
                measurementId: "G-X3GT5TNN87"
            };
            // Removed legacy v8 firebase-app.js & firebase-database.js to prevent duplicate global definition
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            const auth = firebase.auth();
       

        // 2. Fetch and display leaderboard (Overall - all subjects combined)
        async function loadLeaderboard() {
            // Get current user's grade level
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return;
            
            const userSnapshot = await db.ref('students/' + currentUser.uid).once('value');
            const userData = userSnapshot.val();
            const userGrade = userData ? userData.gradelevel : null;
            
            if (!userGrade) {
                console.error('Could not determine user grade level');
                return;
            }
            
            // Update title to show current user's grade
            const titleEl = document.querySelector('.leaderboard-title');
            if (titleEl) {
                titleEl.textContent = `üåü Overall Leaderboard - Grade ${userGrade} üåü`;
            }
            
            // Update page title
            document.title = `Overall Leaderboard - Grade ${userGrade}`;
            
            // Base student snapshot
            const snapshot = await db.ref('students').once('value');
            let students = [];
            snapshot.forEach(child => {
                const s = child.val() || {};
                s._key = child.key;
                students.push(s);
            });

            // Calculate overall scores (all subjects combined)
            students.forEach(s => {
                // Total quiz points from all subjects
                let totalQuizPoints = 0;
                if (s.quizzes) {
                    Object.keys(s.quizzes).forEach(quizKey => {
                        const summary = s.quizzes[quizKey]?.summary;
                        if (summary && typeof summary.best === 'number') {
                            totalQuizPoints += summary.best;
                        }
                    });
                }
                
                // Total assessment points from all subjects
                let totalAssessmentPoints = 0;
                if (s.assessments) {
                    Object.keys(s.assessments).forEach(aid => {
                        const summary = s.assessments[aid]?.summary;
                        if (summary && typeof summary.best === 'number') {
                            totalAssessmentPoints += summary.best;
                        }
                    });
                }
                
                s.quizPoints = totalQuizPoints;
                s.assessmentPoints = totalAssessmentPoints;
                s.combinedPoints = s.quizPoints + s.assessmentPoints;
            });

            // Filter for current user's grade level only
            students = students.filter(s => s.gradelevel == userGrade);

            // Sort descending by combined, then assessment, then quiz, then name
            students.sort((a,b) => b.combinedPoints - a.combinedPoints || b.assessmentPoints - a.assessmentPoints || b.quizPoints - a.quizPoints || ((a.fname||'')+(a.lname||'')).localeCompare((b.fname||'')+(b.lname||'')) );

            // Podium (top 3) based on combinedPoints
            const podiumIndices = [1, 0, 2]; // 2nd, 1st, 3rd visually
            const podiumClasses = ['silver', 'gold', 'bronze'];
            const podiumRanks = [2, 1, 3];
            let podiumHtml = '';
            podiumIndices.forEach((studentIdx, i) => {
                if (!students[studentIdx]) return;
                const student = students[studentIdx];
                const avatar = student.avatar ? student.avatar : `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent((student.fname||'') + (student.lname||''))}`;
                podiumHtml += `
                <div class="podium-place ${podiumClasses[i]}">
                    <div class="podium-rank">${podiumRanks[i]}</div>
                    <img src="${avatar}" class="avatar" alt="${student.fname||''}">
                    <div class="podium-name">${(student.fname||'') + ' ' + (student.lname||'')}</div>
                    <div class="podium-score">${student.combinedPoints} total</div>
                </div>`;
            });
            document.getElementById('podium').innerHTML = podiumHtml;

            // Leaderboard table rows
            let tbodyHtml = '';
            students.forEach((student, idx) => {
                const avatar = student.avatar ? student.avatar : `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent((student.fname||'') + (student.lname||''))}`;
                let badges = 'üèÖ';
                if (idx === 0) badges = 'üèÖüèÖüèÖ';
                else if (idx === 1) badges = 'üèÖüèÖ';
                tbodyHtml += `
                <tr${idx === 0 ? ' class="me"' : ''}>
                    <td>${idx + 1}</td>
                    <td>
                        <span class="player-cell">
                            <img src="${avatar}" class="avatar-small" alt="${student.fname||''}">
                            <span class="player-name">${(student.fname||'') + ' ' + (student.lname||'')}</span>
                            <span class="tooltiptext">${idx === 0 ? 'Top scorer!' : 'Great job!'}</span>
                        </span>
                    </td>
                    <td>${student.quizPoints}</td>
                    <td>${student.assessmentPoints}</td>
                    <td>${student.combinedPoints}</td>
                    <td>${badges}</td>
                </tr>`;
            });
            document.getElementById('leaderboard-body').innerHTML = tbodyHtml;
        }

        // loadLeaderboard() is now called after authentication is confirmed
        </script>

<footer>
  <div class="footer-wrap">
    <div class="footer-col">
      <h4 class="footer-brand">Eduktaktika</h4>
      <p>Interactive, game‚Äëbased learning for Math, English, and Science.</p>
    </div>
    <div class="footer-col">
      <h4>Connect</h4>
      <ul class="footer-social">
        <li><a href="homepage.html">Homepage</a></li>
        <li><a href="studentlist.html">Student</a></li>
      </ul>
    </div>
    <div class="footer-col">
      <h4>Subjects</h4>
      <ul class="footer-links">
        <li><a href="subject_math.html">Math</a></li>
        <li><a href="subject_english.html">English</a></li>
        <li><a href="subject_science.html">Science</a></li>
      </ul>
    </div>
    <div class="footer-col">
      <h4>Leaderboards</h4>
      <ul class="footer-links">
        <li><a href="leaderboard_math.html">Math</a></li>
        <li><a href="leaderboard_english.html">English</a></li>
        <li><a href="leaderboard_science.html">Science</a></li>
      </ul>
    </div>
  </div>
  <div class="footer-bottom">
    <div class="footer-social-row">
      <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
      <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
      <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
      <a href="#" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
    </div>
    <p>¬© 2025 Eduktaktika. All rights reserved.</p>
  </div>
</footer>
            <!-- Edit Profile Modal -->
    <link rel="stylesheet" href="../CSS/editProfile.css">

    <div id="editProfileModal">
        <div class="modal-content">
            <h3>Edit Profile</h3>
            <form id="editProfileForm">
                <label>First Name:<br>
                    <input type="text" id="edit_fname" required>
                </label><br>
                <label>Middle Name:<br>
                    <input type="text" id="edit_mname">
                </label><br>
                <label>Last Name:<br>
                    <input type="text" id="edit_lname" required>
                </label><br>
                <label>Grade Level:<br>
                    <input type="text" id="edit_gradelevel" required>
                </label><br>
                <label>Section:<br>
                    <input type="text" id="edit_section">
                </label><br>
                
                <div style="text-align:right;">
                    <button type="button" onclick="closeEditProfileModal()">Cancel</button>
                    <button type="submit">Save</button>
                </div>
            </form>
        </div>
    </div>
    <script src="../assets/js/Student Side/editProfile.js"></script>

    <style>
        nav ul {
        display: flex;
        align-items: center;
        padding: 0;
        margin: 0;
    }
    nav ul li {
        list-style: none;
        margin: 0 10px;
        position: relative;
        height: 100%;
        display: flex;
        align-items: center;
    }
    nav ul li a, nav ul li .dropbtn {
        display: flex;
        align-items: center;
        height: 48px; /* Match your nav height */
        line-height: 48px;
        padding: 0 18px;
        color: #2d3923;
        text-decoration: none;
        font-size: 1rem;
        background: none;
        border: none;
        cursor: pointer;
    }
    nav ul li .dropdown-content {
        display: none;
        position: absolute;
        background: #fff;
        min-width: 120px;
        box-shadow: 0 4px 16px #0002;
        z-index: 1000;
        border-radius: 8px;
        padding: 0;
        margin: 0;
        top: 100%;
        left: 0;
    }
    nav ul li .dropdown-content li {
        list-style: none;
        border-bottom: 1px solid #eee;
    }
    nav ul li .dropdown-content li:last-child {
        border-bottom: none;
    }
    nav ul li .dropdown-content a {
        color:  18px;
        color: #2d3923;
        padding: 10px 20px;
        display: block;
        text-decoration: none;
        border-radius: 0;
        transition: background 0.2s;
        height: auto;
        line-height: normal;
    }
    nav ul li .dropdown-content a:hover {
        background: #f0f0f0;
    }
    nav ul li.dropdown:hover .dropdown-content {
        display: block;
    }
    </style>

    <script>
        // Fetch and display student info in the profile sidebar
    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            firebase.database().ref('students/' + user.uid).once('value').then(function(snapshot) {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('profileName').textContent = (data.fname || '') + ' ' + (data.lname || '');
                    document.getElementById('profileId').textContent = data.id || user.uid;
                    document.getElementById('profileFirstName').textContent = data.fname || '';
                    document.getElementById('profileMiddleName').textContent = data.mname || '';
                    document.getElementById('profileLastName').textContent = data.lname || '';
                    document.getElementById('profileGrade').textContent = data.gradelevel || '-';
                    document.getElementById('profileSection').textContent = data.section || '-';
                    document.getElementById('profileAvatar').src = "https://api.dicebear.com/7.x/bottts/svg?seed=" + encodeURIComponent(data.fname || "student");
                }
            });
        }
    });
    </script>

    <script src="../assets/js/Student Side/profile.js"></script>

    <div class="leaderboard-container" style="margin-top:40px;">
            <div class="leaderboard-title">üìò Assessment Leaderboard</div>
            <div class="leaderboard-desc">Top students by best assessment scores.</div>
            <table class="leaderboard-table" id="assessmentLeaderboardTable" style="margin-top:18px;">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Student</th>
                        <th>Assessment 1 Best</th>
                        <th>Total Best (All)</th>
                    </tr>
                </thead>
                <tbody id="assessment-leaderboard-body">
                    <tr><td colspan="4" style="text-align:center;padding:18px;">Loading...</td></tr>
                </tbody>
            </table>
        </div>

    <script>
    // Unified Assessment Data Fetch
    async function fetchAssessmentAggregates(){
      // Try global summaries first
      const summariesSnap = await firebase.database().ref('assessmentSummaries').once('value');
      let source = 'summaries';
      const aggregates = {}; // uid -> {assessmentBest:{id:best}, totalBest}
      if(summariesSnap.exists()){
        summariesSnap.forEach(assessNode => {
          const aid = assessNode.key;
          assessNode.forEach(userNode => {
            const uid = userNode.key; const val = userNode.val();
            if(!aggregates[uid]) aggregates[uid] = { assessmentBest:{}, totalBest:0 };
            const best = (val && typeof val.best === 'number') ? val.best : 0;
            aggregates[uid].assessmentBest[aid] = best;
          });
        });
      } else {
        // Fallback: per student path: students/<uid>/assessments/<assessmentId>/summary
        source = 'students';
        const studentsSnap = await firebase.database().ref('students').once('value');
        studentsSnap.forEach(stuNode => {
          const uid = stuNode.key;
          const assessRoot = stuNode.child('assessments');
          if(!assessRoot.exists()) return;
          assessRoot.forEach(aNode => {
            const aid = aNode.key;
            const summaryNode = aNode.child('summary');
            if(!summaryNode.exists()) return;
            const summary = summaryNode.val();
            const best = (summary && typeof summary.best === 'number') ? summary.best : 0;
            if(!aggregates[uid]) aggregates[uid] = { assessmentBest:{}, totalBest:0 };
            aggregates[uid].assessmentBest[aid] = best;
          });
        });
      }
      // compute totals
      Object.keys(aggregates).forEach(uid => {
        const a = aggregates[uid];
        a.totalBest = Object.values(a.assessmentBest).reduce((s,v)=> s+ (v||0), 0);
      });
      return {aggregates, source};
    }
    </script>
    <script>
    // Replace previous Assessment leaderboard logic with unified fetch
    (async function(){
      const tbody = document.getElementById('assessment-leaderboard-body');
      if(!tbody) return;
      try {
        const [{aggregates}, studentsSnap] = await Promise.all([
          fetchAssessmentAggregates(),
          firebase.database().ref('students').once('value')
        ]);
        const students = studentsSnap.val() || {};
        const rows = Object.keys(aggregates).map(uid => {
          const info = students[uid] || {};
          const name = ((info.fname||'') + ' ' + (info.lname||'')).trim() || uid.substring(0,6);
          const a1 = aggregates[uid].assessmentBest['assessment1'] !== undefined ? aggregates[uid].assessmentBest['assessment1'] : '-';
          return { uid, name, a1, totalBest: aggregates[uid].totalBest };
        });
        rows.sort((a,b)=> b.totalBest - a.totalBest || a.name.localeCompare(b.name));
        if(rows.length === 0){
          tbody.innerHTML = '<tr><td colspan="4" style="padding:18px;text-align:center;">No assessment data.</td></tr>'; return;
        }
        tbody.innerHTML = rows.map((r,i)=>`<tr><td>${i+1}</td><td>${r.name}</td><td>${r.a1}</td><td>${r.totalBest}</td></tr>`).join('');
      } catch(e){
        console.error(e); tbody.innerHTML = `<tr><td colspan='4' style='padding:18px;text-align:center;color:#c00;'>${e.message}</td></tr>`;
      }
    })();
    </script>
    <script>
    // Update Quiz vs Assessment aggregation to use unified fetch
    (async function(){
      const bodyEl = document.getElementById('qa-comparison-body');
      if(!bodyEl) return;
      try {
        const [{aggregates}, studentsSnap] = await Promise.all([
          fetchAssessmentAggregates(),
          firebase.database().ref('students').once('value')
        ]);
        const students = studentsSnap.val() || {};
        const rows = Object.keys(students).map(uid => {
          const stu = students[uid] || {};
          const quizPoints = parseInt(stu.points || 0);
          const assessPoints = (aggregates[uid] && aggregates[uid].totalBest) || 0;
          const overall = quizPoints + assessPoints;
          const name = ((stu.fname||'') + ' ' + (stu.lname||'')).trim() || uid.substring(0,6);
          return { uid, name, quizPoints, assessPoints, overall };
        });
        rows.sort((a,b)=> b.overall - a.overall || b.assessPoints - a.assessPoints || b.quizPoints - a.quizPoints);
        if(rows.length === 0){ bodyEl.innerHTML = '<tr><td colspan="5" style="padding:18px;text-align:center;">No data.</td></tr>'; return; }
        bodyEl.innerHTML = rows.map((r,i)=>`<tr><td>${i+1}</td><td>${r.name}</td><td>${r.quizPoints}</td><td>${r.assessPoints}</td><td>${r.overall}</td></tr>`).join('');
      } catch(err){
        console.error('QA comparison error', err);
        bodyEl.innerHTML = `<tr><td colspan='5' style='padding:18px;text-align:center;color:#c00;'>Error: ${err.message}</td></tr>`;
      }
    })();
    </script>
    </div>
</body>
</html>