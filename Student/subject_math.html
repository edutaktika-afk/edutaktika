<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Subject - Edutaktika</title>
</head>
<body>
 <script>
    document.addEventListener("DOMContentLoaded", function() {
        firebase.auth().onAuthStateChanged(async function(user) {
            if (!user) {
                window.location.href = "logreg.html";
                return;
            }
            const uid = user.uid;
            const snapshot = await firebase.database().ref('students/' + uid).once('value');
            const student = snapshot.val();
            if (!student || student.role !== "student") {
                document.getElementById('mainContent').style.display = "none";
                alert("Access denied.");
                await firebase.auth().signOut();
                window.location.href = "logreg.html";
            } else {
                document.getElementById('mainContent').style.display = "block";
            }
        });
    });
    </script>
    
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="../CSS/fonts.css">

    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700&family=Manrope:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="../CSS/header.css">
    <link rel="stylesheet" href="../CSS/subject.css">
    <link rel="stylesheet" href="../CSS/footer.css">
    <link rel="stylesheet" href="../CSS/burger.css">
    <link rel="stylesheet" href="../CSS/loadQuizzes.css">
    <title>Math</title>
    <style>
        nav ul {
            display: flex;
            align-items: center;
            padding: 0;
            margin: 0;
        }
        nav ul li {
            list-style: none;
            margin: 0 10px;
            position: relative;
            height: 100%;
            display: flex;
            align-items: center;
        }
        nav ul li a, nav ul li .dropbtn {
            display: flex;
            align-items: center;
            height: 48px;
            line-height: 48px;
            padding: 0 18px;
            color: #2d3923;
            text-decoration: none;
            font-size: 1rem;
            background: none;
            border: none;
            cursor: pointer;
        }
        nav ul li .dropdown-content {
            display: none;
            position: absolute;
            background: #fff;
            min-width: 120px;
            box-shadow: 0 4px 16px #0002;
            z-index: 1000;
            border-radius: 8px;
            padding: 0;
            margin: 0;
            top: 100%;
            left: 0;
        }
        nav ul li .dropdown-content li {
            list-style: none;
            border-bottom: 1px solid #eee;
        }
        nav ul li .dropdown-content li:last-child {
            border-bottom: none;
        }
        nav ul li .dropdown-content a {
            color: #2d3923;
            padding: 10px 20px;
            display: block;
            text-decoration: none;
            border-radius: 0;
            transition: background 0.2s;
            height: auto;
            line-height: normal;
        }
        nav ul li .dropdown-content a:hover {
            background: #f0f0f0;
        }
        nav ul li.dropdown:hover .dropdown-content {
            display: block;
        }
    </style>
</head>
<body>
    <div id="mainContent" style="display:none;">

                    <!-- Burger icon for mobile -->
<button id="burgerBtn" class="burger-btn" aria-label="Open menu">
    <span></span>
    <span></span>
    <span></span>
</button>
    <header>
        <div class="floating-elements">
            <div class="floating-element"></div>
            <div class="floating-element"></div>
            <div class="floating-element"></div>
            <div class="floating-element"></div>
        </div>
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <!-- Replace your logo-text div with this for per-letter bounce -->
                <div class="logo-text">
                    <span>E</span><span>d</span><span>u</span><span>t</span><span>a</span><span>k</span><span>t</span><span>i</span><span>k</span><span>a</span>
                </div>
            </div>
            <nav>
                <ul>
                    <li><a href="homepage.html">Home</a></li>
                    <li class="dropdown subject-dropdown">
                        <button id="navSubjectBtn" class="dropbtn" type="button" aria-haspopup="listbox" aria-expanded="false">
                            <span id="navSubjectLabel">Subject</span>
                            <i class="fa fa-caret-down" aria-hidden="true" style="margin-left:6px;font-size:.75rem;"></i>
                        </button>
                        <ul id="navSubjectMenu" class="dropdown-content" role="listbox" aria-labelledby="navSubjectBtn">
                            <li><a href="subject_math.html" data-subject="Math" role="option">Math</a></li>
                            <li><a href="subject_english.html" data-subject="English" role="option">English</a></li>
                            <li><a href="subject_science.html" data-subject="Science" role="option">Science</a></li>
                        </ul>
                    </li>
                   <li class="dropdown">
                            <a href="#" class="dropbtn">Leaderboard <i class="fa fa-caret-down"></i></a>
                            <ul class="dropdown-content">
                                <li><a href="leaderboard_math.html">Math</a></li>
                                <li><a href="leaderboard_english.html">English</a></li>
                                <li><a href="leaderboard_science.html">Science</a></li>
                            </ul>
                        </li>
                    <li>
                        <a href="#" id="profileBtn"><i class="fas fa-user-circle"></i> Profile</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

        <!-- Overlay for navbar -->
<div class="sidebar-overlay" id="navOverlay"></div>
<!-- Overlay for profile sidebar -->
<div class="sidebar-overlay" id="profileSidebarOverlay"></div>

     <!-- Profile Sidebar (Dynamic with Firebase) -->
<div id="profileSidebar" class="profile-sidebar">
    <div class="sidebar-content">
        <button class="close-btn" id="closeSidebar">&times;</button>
        <div style="position:relative; display:flex; flex-direction:column; align-items:center;">
            <img class="profile-avatar" id="profileAvatar" src="https://api.dicebear.com/7.x/bottts/svg?seed=user" alt="Profile Avatar">
            <i class="fa-solid fa-star sidebar-star" style="position:absolute; bottom:0; right:10px; color:#ffd700; font-size:1.2rem; background:white; border-radius:50%; padding:2px 4px; box-shadow:0 1px 4px #ffd70044;"></i>
        </div>
        <div class="profile-name" id="profileName">Loading...</div>
        <br>
        <div class="profile-info" style="width:100%;max-width:260px;margin-bottom:24px;">
            <div class="profile-role" style="color:#2e8b57; font-weight:700; font-size:1.1rem; margin-bottom:8px; letter-spacing:1px; text-align:center;">
            Student
        </div>
            <div>
                <i class="fa-solid fa-id-badge" style="color:violet;margin-right:10px;"></i>
                <strong>ID:</strong> <span id="profileId">-</span>
            </div>
            <div>
                <i class="fa-solid fa-user" style="color:#ff69b4;margin-right:10px;"></i>
                <strong>First Name:</strong> <span id="profileFirstName">-</span>
            </div>
            <div>
                <i class="fa-solid fa-user" style="color:#ffd700;margin-right:10px;"></i>
                <strong>Middle Name:</strong> <span id="profileMiddleName">-</span>
            </div>
            <div>
                <i class="fa-solid fa-user" style="color:#f14141;margin-right:10px;"></i>
                <strong>Last Name:</strong> <span id="profileLastName">-</span>
            </div>
            <div>
                <i class="fa-solid fa-graduation-cap" style="color:#2e8b57;margin-right:10px;"></i>
                <strong>Grade Level:</strong> <span id="profileGrade">-</span>
            </div>
            <div>
                <i class="fa-solid fa-apple-whole" style="color:#4faaff;margin-right:10px;"></i>
                <strong>Section:</strong> <span id="profileSection">-</span>
            </div>
            <div>
    <i class="fas fa-map-marker-alt" style="color:#ff69b4;margin-right:10px;"></i>
    <strong>House/Street:</strong> <span id="profileAddressStreet">-</span>
</div>
<div>
    <i class="fas fa-map-marker-alt" style="color:#ffd700;margin-right:10px;"></i>
    <strong>Barangay:</strong> <span id="profileAddressBarangay">-</span>
</div>
<div>
    <i class="fas fa-map-marker-alt" style="color:#4faaff;margin-right:10px;"></i>
    <strong>City:</strong> <span id="profileAddressCity">-</span>
</div>
<div>
    <i class="fas fa-map-marker-alt" style="color:#2e8b57;margin-right:10px;"></i>
    <strong>Province:</strong> <span id="profileAddressProvince">-</span>
</div>
<div>
    <i class="fas fa-map-marker-alt" style="color:#f14141;margin-right:10px;"></i>
    <strong>ZIP:</strong> <span id="profileAddressZip">-</span>
</div>
<div>
    <i class="fas fa-map-marker-alt" style="color:violet;margin-right:10px;"></i>
    <strong>Region:</strong> <span id="profileAddressRegion">-</span>
</div>
        </div>
        <div class="logout-switch-row">
            <div class="logout-switch" id="logoutSwitch">
                <div class="logout-switch-circle"></div>
            </div>
            <span class="logout-label" id="logoutLabel">LOGOUT</span>
        </div>
    </div>
</div>

<style>
    .profile-sidebar {
    margin-top: 20px;
    max-height: 95vh;
    overflow-y: auto;
    scrollbar-width: none;         /* Firefox */
    -ms-overflow-style: none;      /* IE and Edge */
}
.profile-sidebar::-webkit-scrollbar {
    display: none;                 /* Chrome, Safari, Opera */
}
</style>

        <!-- Firebase App (the core Firebase SDK) -->
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>


    <script src="../assets/js/Student Side/header.js"></script>

    <div class="container">
        <!-- Dropdown for mobile -->
<div class="quarter-dropdown-custom">
    <button class="quarter-dropdown-btn" id="quarterDropdownBtn">Quarter 1</button>
    <ul class="quarter-dropdown-list" id="quarterDropdownList">
        <li data-target="quarter-1" class="active">Quarter 1</li>
        <li data-target="quarter-2">Quarter 2</li>
        <li data-target="quarter-3">Quarter 3</li>
        <li data-target="quarter-4">Quarter 4</li>
        <li data-target="quarter-5">Quizzes</li>
        <li data-target="quarter-assessments">Assessments</li>
    </ul>
</div>
        <div class="quarter-nav">
            <div class="quarter-tab active" data-quarter="1">Quarter 1</div>
            <div class="quarter-tab" data-quarter="2">Quarter 2</div>
            <div class="quarter-tab" data-quarter="3">Quarter 3</div>
            <div class="quarter-tab" data-quarter="4">Quarter 4</div>
            <div class="quarter-tab" data-quarter="5" style="margin-left: auto;">Quizzes</div>
            <div class="quarter-tab" data-quarter="assessments">Assessments</div>
        </div>

        <div class="quarter-section active" id="quarter-1">
            <div class="quarter-title">
                <i class="fas fa-calendar-alt"></i>
                <h2>Quarter 1: <span class="bounce-word"><span>M</span><span>a</span><span>t</span><span>h</span><span>e</span><span>m</span><span>a</span><span>t</span><span>i</span><span>c</span><span>s</span>
</h2>
            </div>
            <div class="lessons-container">

            </div>
            
        </div>
        <div class="quarter-section" id="quarter-2">
            <div class="quarter-title">
                <i class="fas fa-calendar-alt"></i>
                <h2>Quarter 2: <span class="bounce-word"><span>M</span><span>a</span><span>t</span><span>h</span><span>e</span><span>m</span><span>a</span><span>t</span><span>i</span><span>c</span><span>s</span>
</h2>
            </div>
            <div class="lessons-container"></div>
        </div>
        <div class="quarter-section" id="quarter-3">
            <div class="quarter-title">
                <i class="fas fa-calendar-alt"></i>
                <h2>Quarter 3: 
                    <span class="bounce-word">
                        <span>M</span><span>a</span><span>t</span><span>h</span><span>e</span><span>m</span><span>a</span><span>t</span><span>i</span><span>c</span><span>s</span>
                    </span>
                </h2>
            </div>
            <div class="lessons-container"></div>
        </div>
        <div class="quarter-section" id="quarter-4">
            <div class="quarter-title">
                <i class="fas fa-calendar-alt"></i>
                <h2>Quarter 4: 
                    <span class="bounce-word">
                        <span>M</span><span>a</span><span>t</span><span>h</span><span>e</span><span>m</span><span>a</span><span>t</span><span>i</span><span>c</span><span>s</span>
                    </span>
                </h2>
            </div>
            <div class="lessons-container"></div>
        </div>

        <!-- Quizzes -->
        <div class="quarter-section" id="quarter-5">
            <div class="quarter-title" style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <i class="fas fa-calendar-alt"></i>
                    <h2 style="display:inline-block;margin:0 0 0 8px;">Quizzes</h2>
                </div>
                <div style="display: flex; align-items: center;">
                    <label for="quiz-quarter-filter" style="font-weight:600; margin-right:8px;">Filter by Quarter:</label>
                    <select id="quiz-quarter-filter" style="min-width:120px;">
                        <option value="">All Quarters</option>
                        <option value="1">Quarter 1</option>
                        <option value="2">Quarter 2</option>
                        <option value="3">Quarter 3</option>
                        <option value="4">Quarter 4</option>
                    </select>
                </div>
            </div>
            <div class="lessons-container">
                <div id="quizzesContainer"></div>
                
            </div>
        </div>

        

        <!-- Assessments panel -->
        <div class="quarter-section" id="quarter-assessments">
            <div class="quarter-title">
                <i class="fas fa-clipboard-check"></i>
                <h2>Summative Assessments</h2>
            </div>
            <div class="lessons-container" id="assessmentsContainer">
                <!-- Assessment cards injected here -->
            </div>
        </div>
    </div>

<footer>
  <div class="footer-wrap">
    <div class="footer-col">
      <h4 class="footer-brand">Eduktaktika</h4>
      <p>Interactive, game‑based learning for Math, English, and Science.</p>
    </div>
    <div class="footer-col">
      <h4>Connect</h4>
      <ul class="footer-social">
        <li><a href="homepage.html">Homepage</a></li>
        <li><a href="studentlist.html">Student</a></li>
      </ul>
    </div>
    <div class="footer-col">
      <h4>Subjects</h4>
      <ul class="footer-links">
        <li><a href="subject_math.html">Math</a></li>
        <li><a href="subject_english.html">English</a></li>
        <li><a href="subject_science.html">Science</a></li>
      </ul>
    </div>
    <div class="footer-col">
      <h4>Leaderboards</h4>
      <ul class="footer-links">
        <li><a href="leaderboard_math.html">Math</a></li>
        <li><a href="leaderboard_english.html">English</a></li>
        <li><a href="leaderboard_science.html">Science</a></li>
      </ul>
    </div>
  </div>
  <div class="footer-bottom">
    <div class="footer-social-row">
      <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
      <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
      <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
      <a href="#" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
    </div>
    <p>© 2025 Eduktaktika. All rights reserved.</p>
  </div>
</footer>

     <script src="../assets/js/Student Side/subject.js"></script>

    <!-- Firebase scripts already included above -->

    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyB5BbeLLvPX8l1c4Lq0f-CmIUml4hQOQlE",
        authDomain: "edutaktika.firebaseapp.com",
        databaseURL: "https://edutaktika-default-rtdb.firebaseio.com",
        projectId: "edutaktika",
        storageBucket: "edutaktika.appspot.com",
        messagingSenderId: "676848575316",
        appId: "1:676848575316:web:f78f8c0f83bf3d9dfb5ec1",
        measurementId: "G-X3GT5TNN87"
    };
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    const auth = firebase.auth();

    auth.onAuthStateChanged(async function(user) {
        if (user) {
            const uid = user.uid;
            // Get student info
            const studentSnap = await db.ref('students/' + uid).once('value');
            const student = studentSnap.val();
            if (!student || !student.section) return;

            // Find teacher for this section
            let teacherUID = null;
            const teachersSnap = await db.ref('teachers').once('value');
            teachersSnap.forEach(tsnap => {
                const t = tsnap.val();
                if (t.section && t.section.trim().toLowerCase() === student.section.trim().toLowerCase()) {
                    teacherUID = tsnap.key;
                }
            });

            if (!teacherUID) {
                document.querySelectorAll('.lessons-container').forEach(c => c.innerHTML = "<div>No teacher found for your section.</div>");
                return;
            }

            for (let q = 1; q <= 4; q++) {
                const lessonsSnap = await db.ref('teachers/' + teacherUID + '/sections/' + student.section + '/lessons/subject_math/quarter-' + q).once('value');
                const container = document.querySelector(`#quarter-${q} .lessons-container`);
                if (!container) continue;
                container.innerHTML = '';
                if (!lessonsSnap.exists()) {
                    
                    continue;
                }
                lessonsSnap.forEach(lessonSnap => {
                    const lesson = lessonSnap.val();
                    const name = lesson.title || lessonSnap.key;
                    const div = document.createElement('div');
                    div.className = 'lesson-item';
                    div.setAttribute('data-presentation', name);
                    div.innerHTML = `
                        <div class="lesson-thumbnail" style="background-color: var(--peach)"></div>
                        <div class="lesson-title">
                            <h3>${name}</h3>
                            <p>${lesson.description || ''}</p>
                            <span class="lesson-badge" onclick="window.location.href='present.html?subject=subject_math&quarter=${q}&name=${encodeURIComponent(name)}'" style="cursor:pointer;">View</span>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
        }
    });

    
// Listen for auth state
firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
        firebase.database().ref('students/' + user.uid).once('value').then(function(snapshot) {
            const data = snapshot.val();
            if (data) {
                document.getElementById('profileName').textContent = (data.fname || '') + ' ' + (data.lname || '');
                document.getElementById('profileId').textContent = data.id || user.uid;
                document.getElementById('profileFirstName').textContent = data.fname || '';
                document.getElementById('profileMiddleName').textContent = data.mname || '';
                document.getElementById('profileLastName').textContent = data.lname || '';
                document.getElementById('profileGrade').textContent = data.gradelevel || '';
                document.getElementById('profileSection').textContent = data.section || '';
                document.getElementById('profileAvatar').src = "https://api.dicebear.com/7.x/bottts/svg?seed=" + encodeURIComponent(data.fname || "user");
            }
            // After fetching student data in the sidebar:
if (data.address) {
    document.getElementById('profileAddressStreet').textContent = data.address.street || '-';
    document.getElementById('profileAddressBarangay').textContent = data.address.barangay || '-';
    document.getElementById('profileAddressCity').textContent = data.address.city || '-';
    document.getElementById('profileAddressProvince').textContent = data.address.province || '-';
    document.getElementById('profileAddressZip').textContent = data.address.zip || '-';
    document.getElementById('profileAddressRegion').textContent = data.address.region || '-';
}
        });
    } else if(!user) {
        window.location.href = "../index.html";
    } else {
        document.getElementById('profileName').textContent = "Not logged in";
    }
});

// Logout logic
document.getElementById('logoutSwitch').onclick = function() {
    firebase.auth().signOut().then(function() {
        window.location.href = "../index.html";
    });
};

const subjectPage = "subject_math"; // For Math page
// For Science: const subjectPage = "subject_science";
// For English: const subjectPage = "subject_english";

auth.onAuthStateChanged(async function(user) {
    if (user) {
        const uid = user.uid;
        // Get student info
        const studentSnap = await db.ref('students/' + uid).once('value');
        const student = studentSnap.val();
        if (!student || !student.section) return;

        // Find teacher for this section
        let teacherUID = null;
        const teachersSnap = await db.ref('teachers').once('value');
        teachersSnap.forEach(tsnap => {
            const t = tsnap.val();
            if (t.section && t.section.trim().toLowerCase() === student.section.trim().toLowerCase()) {
                teacherUID = tsnap.key;
            }
        });

        if (!teacherUID) {
            document.querySelectorAll('.lessons-container').forEach(c => c.innerHTML = "<div>No teacher found for your section.</div>");
            return;
        }

        for (let q = 1; q <= 4; q++) {
            const lessonsSnap = await db.ref('teachers/' + teacherUID + '/sections/' + student.section + '/lessons/' + subjectPage + '/quarter-' + q).once('value');
            const container = document.querySelector(`#quarter-${q} .lessons-container`);
            if (!container) continue;
            container.innerHTML = '';
            if (!lessonsSnap.exists()) {
               
                continue;
            }
            lessonsSnap.forEach(lessonSnap => {
                const lesson = lessonSnap.val();
                const name = lesson.title || lessonSnap.key;
                const div = document.createElement('div');
                div.className = 'lesson-item';
                div.setAttribute('data-presentation', name);
                div.innerHTML = `
                    <div class="lesson-thumbnail" style="background-color: var(--peach)"></div>
                    <div class="lesson-title">
                        <h3>${name}</h3>
                        <p>${lesson.description || ''}</p>
                        <span class="lesson-badge" onclick="window.location.href='present.html?subject=${subjectPage}&quarter=${q}&name=${encodeURIComponent(name)}'" style="cursor:pointer;">View</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }
    }
});
    </script>

<script>


auth.onAuthStateChanged(async function(user) {
    if (user) {
        const uid = user.uid;
        // Get student info
        const studentSnap = await db.ref('students/' + uid).once('value');
        const student = studentSnap.val();
        if (!student || !student.section) return;

        // Find teacher for this section
        let teacherUID = null;
        const teachersSnap = await db.ref('teachers').once('value');
        teachersSnap.forEach(tsnap => {
            const t = tsnap.val();
            if (t.section && t.section.trim().toLowerCase() === student.section.trim().toLowerCase()) {
                teacherUID = tsnap.key;
            }
        });

        for (let q = 1; q <= 4; q++) {
            const container = document.querySelector(`#quarter-${q} .lessons-container`);
            if (!container) continue;

            let lessons = [];

            // Only fetch lessons from teacher whose section matches
            if (teacherUID) {
                const teacherSnap = await db.ref('teachers/' + teacherUID + '/sections/' + student.section + '/lessons/' + subjectPage + '/quarter-' + q).once('value');
                if (teacherSnap.exists()) {
                    teacherSnap.forEach(child => {
                        const data = child.val();
                        lessons.push({
                            title: data.title || child.key,
                            description: data.description || ''
                        });
                    });
                }
            }

            // Sort all lessons by title
            lessons.sort((a, b) => a.title.localeCompare(b.title));

            // Render
            if (lessons.length === 0) {
                
            } else {
                container.innerHTML = lessons.map(lesson => `
                    <div class="lesson-item" data-presentation="${lesson.title}">
                        <div class="lesson-thumbnail" style="background-color: var(--peach)"></div>
                        <div class="lesson-title">
                            <h3>${lesson.title}</h3>
                            <p>${lesson.description}</p>
                            <span class="lesson-badge" onclick="window.location.href='present.html?subject=${subjectPage}&quarter=${q}&name=${encodeURIComponent(lesson.title)}'" style="cursor:pointer;">View</span>
                        </div>
                    </div>
                `).join('');
            }
        }
    }
});
</script>

<!-- Edit Profile Modal -->
<div id="editProfileModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:99999;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:32px 28px;border-radius:14px;max-width:350px;width:90%;box-shadow:0 4px 24px #0002;text-align:left;position:relative;">
        <h3 style="margin-top:0;">Edit Profile</h3>
        <form id="editProfileForm">
            <label>First Name:<br>
                <input type="text" id="edit_fname" required>
            </label><br><br>
            <label>Middle Name:<br>
                <input type="text" id="edit_mname">
            </label><br><br>
            <label>Last Name:<br>
                <input type="text" id="edit_lname" required>
            </label><br><br>
            <label>Grade Level:<br>
                <input type="text" id="edit_gradelevel" required>
            </label><br><br>
            <label>Section:<br>
                <input type="text" id="edit_section" required>
            </label><br><br>
            <div style="text-align:right;">
                <button type="button" onclick="closeEditProfileModal()" style="margin-right:10px;">Cancel</button>
                <button type="submit">Save</button>
            </div>
        </form>
    </div>
</div>
    
<script src="../assets/js/Student Side/editProfile.js"></script>
<link rel="stylesheet" href="../CSS/editProfile.css">
<script>
// --- Inject Assessment Card & Score ---
(function(){
    const container = document.getElementById('assessmentsContainer');
    if(!container) return;

    // Create Assessment 1 card
    const card = document.createElement('div');
    card.className = 'lesson-item';
    card.innerHTML = `
        <div class="lesson-thumbnail" style="background-color: var(--peach);display:flex;align-items:center;justify-content:center;font-size:42px;color:#fff;">A1</div>
        <div class="lesson-title">
            <h3>Assessment 1: Everyday Math</h3>
            <p>10-item real‑life math skills check.</p>
            <span class="lesson-badge" style="cursor:pointer;" onclick="window.location.href='../Games/Assessment/Assexam.html'">Start</span>
            <div style="margin-top:8px;font-size:0.9rem;color:#444;" id="a1LastScore">Last Score: -</div>
        </div>`;
    container.appendChild(card);

    // Fetch last score if user logged in
    firebase.auth().onAuthStateChanged(function(user){
        if(!user) return;
        const uid = user.uid;
        firebase.database().ref('assessmentScores/assessment1/' + uid).orderByChild('timestamp').limitToLast(1).once('value', snap => {
            if(!snap.exists()) return;
            let val; snap.forEach(c=> val = c.val ? c.val() : c); // handle object or direct
            const dataObj = (typeof val === 'object') ? val : null;
            const scoreEl = document.getElementById('a1LastScore');
            if(scoreEl && dataObj) {
                scoreEl.textContent = `Last Score: ${dataObj.score}/${dataObj.total} (${dataObj.percentage}%)`;
            } else if(scoreEl && !dataObj){
                // If stored as direct leaf (score object)
                const raw = snap.val();
                if(raw && raw.score !== undefined) {
                    scoreEl.textContent = `Last Score: ${raw.score}/${raw.total} (${raw.percentage}%)`;
                }
            }
        });
    });
})();




(function(){
    const tabs = document.querySelectorAll('.quarter-tab');
    const sections = document.querySelectorAll('.quarter-section');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t=>t.classList.remove('active'));
            tab.classList.add('active');
            const target = tab.getAttribute('data-quarter');
            sections.forEach(sec => sec.classList.remove('active'));
            if(target === 'assessments') {
                document.getElementById('quarter-assessments').classList.add('active');
            } else {
                const sec = document.getElementById('quarter-' + target);
                if(sec) sec.classList.add('active');
            }
        });
    });
})();

// Extend existing assessment UI scoring display
(function(){
  const assessCard = document.querySelector('#assessmentsContainer .lesson-item');
  if(!assessCard) return;
  // Append placeholders
  const scoreDiv = assessCard.querySelector('#a1LastScore');
  if(scoreDiv){
    scoreDiv.insertAdjacentHTML('afterend', `<div id="a1BestScore" style="font-size:0.9rem;color:#444;">Best Score: -</div><button id="viewAttemptsFromSubject" style="margin-top:6px;padding:4px 10px;font-size:0.75rem;border:none;background:#6d28d9;color:#fff;border-radius:6px;cursor:pointer;">View Attempts</button>`);
  }



  // Fetch summary + leaderboard
  firebase.auth().onAuthStateChanged(user => {
    if(!user) return;
    const uid = user.uid;
    // User summary
    firebase.database().ref('assessmentSummaries/assessment1/' + uid).once('value', snap => {
      if(snap.exists()){
        const s = snap.val();
        const lastEl = document.getElementById('a1LastScore');
        const bestEl = document.getElementById('a1BestScore');
        if(lastEl) lastEl.textContent = `Last Score: ${s.last}/${s.total} (${s.lastPercentage}%)`;
        if(bestEl) bestEl.textContent = `Best Score: ${s.best}/${s.total} (${s.bestPercentage}%) in ${s.attempts} attempt${s.attempts>1?'s':''}`;
      }
    });
    // Leaderboard (pull all summaries once)
    firebase.database().ref('assessmentSummaries/assessment1').once('value', snap => {
      const lbEl = document.getElementById('a1Leaderboard');
      if(!snap.exists()){ lbEl.textContent = 'No scores yet.'; return; }
      const arr = [];
      snap.forEach(child => { const v = child.val(); arr.push({ uid: child.key, best: v.best, bestPct: v.bestPercentage, last: v.last, attempts: v.attempts || 1 }); });
      arr.sort((a,b)=> b.best - a.best || a.attempts - b.attempts);
      const top = arr.slice(0,10);
      lbEl.innerHTML = top.map((r,i)=> `<div style='display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #eee;'><span>#${i+1}</span><span>${r.uid.substring(0,6)}</span><span>${r.best}</span><span>${r.bestPct}%</span><span>${r.attempts}x</span></div>`).join('');
    });
  });

  // Attempts modal reuse via hidden iframe open (we'll just navigate to assessment and let user click view attempts). Simpler: open assessment in new tab.
  const btn = document.getElementById('viewAttemptsFromSubject');
  if(btn){ btn.addEventListener('click', ()=> { window.location.href = '../Games/Assessment/Assexam.html'; }); }
})();
</script>
    </div>

    <style>
    #quiz-list {
    display: flex;
    flex-wrap: wrap;
    gap: 18px;
    justify-content: flex-start;
    align-items: stretch;
    margin-top: 10px;
}
.lesson-item {
    flex: 1 1 260px;
    min-width: 220px;
    max-width: 320px;
    box-sizing: border-box;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 12px #0001;
    padding: 18px 14px 14px 14px;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    margin-bottom: 8px;
}
.lesson-thumbnail {
    width: 100%;
    height: 80px;
    border-radius: 8px;
    margin-bottom: 12px;
    background-size: cover;
    background-position: center;
}
.lesson-title h3 {
    font-size: 1.15rem;
    margin: 0 0 6px 0;
}
.lesson-title p {
    font-size: 0.98rem;
    color: #444;
    margin: 0 0 10px 0;
}
.lesson-badge {
    background: #ffe600;
    color: #222;
    border: none;
    border-radius: 6px;
    padding: 7px 18px;
    font-size: 1rem;
    font-weight: 600;
    margin-right: 8px;
    cursor: pointer;
    transition: background 0.2s;
}
.lesson-badge:hover {
    background: #ffd600;
}
    #createQuizModal {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.35);
        z-index: 99999;
        align-items: center;
        justify-content: center;
    }
    #createQuizModal .modal-content {
        background: #fff;
        padding: 32px 28px;
        border-radius: 16px;
        max-width: 370px;
        width: 90%;
        box-shadow: 0 4px 24px #0002;
        text-align: left;
        position: relative;
        animation: modalPop 0.25s;
    }
        @keyframes modalPop {
        0% { transform: scale(0.95); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }
    #createQuizModal h3 {
        margin-top: 0;
        margin-bottom: 18px;
        font-size: 1.35rem;
        color: #059981;
        letter-spacing: 1px;
    }
    #createQuizModal label {
        font-weight: 500;
        color: #2d3923;
        font-size: 1rem;
    }
    #createQuizModal input, #createQuizModal select, #createQuizModal textarea {
        width: 100%;
        padding: 8px 10px;
        margin-top: 4px;
        margin-bottom: 12px;
        border: 1px solid #b2b2b2;
        border-radius: 6px;
        font-size: 1rem;
        background: #f8f8f8;
        transition: border 0.2s;
    }
    #createQuizModal input:focus, #createQuizModal select:focus, #createQuizModal textarea:focus {
        border: 1.5px solid #059981;
        outline: none;
        background: #fff;
    }
    #createQuizModal .modal-actions {
        text-align: right;
        margin-top: 10px;
    }
    #createQuizModal button[type="button"] {
        background: #eee;
        color: #333;
        border: none;
        border-radius: 6px;
        padding: 8px 18px;
        font-size: 1rem;
        margin-right: 8px;
        cursor: pointer;
        transition: background 0.2s;
    }
    #createQuizModal button[type="button"]:hover {
        background: #e0e0e0;
    }
    #createQuizModal button[type="submit"] {
        background: #059981;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 8px 22px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }
    #createLessonModal button[type="submit"]:hover {
        background: #037a65;
    }
</style>
 
<script>

async function loadYouTubeVideosStudent() {
    const wrapper = document.getElementById('youtube-lessons');
    const container = document.querySelector('#youtube-lessons .lessons-container');
    if (!container || !wrapper) return;

    // Configure your playlist ID here or set data-playlist-id on #youtube-lessons
    const playlistId = (wrapper.dataset.playlistId || '').trim();
    if (!playlistId) {
        container.innerHTML = '<div style="color:#888;">Set a YouTube playlist ID to load videos.</div>';
        return;
    }

    const feedUrl = `https://www.youtube.com/feeds/videos.xml?playlist_id=${encodeURIComponent(playlistId)}`;

    // CORS proxy for RSS feeds
    const fetchWithCors = async (url) => {
        try {
            const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
            return await response.text();
        } catch (e) {
            console.warn('CORS proxy failed, trying direct fetch:', e);
            return await fetch(url).then(r => r.text());
        }
    };

    try {
        console.log('Fetching Math playlist:', playlistId);
        const xmlText = await fetchWithCors(feedUrl);
        const parser = new DOMParser();
        const doc = parser.parseFromString(xmlText, 'text/xml');
        const entries = Array.from(doc.getElementsByTagName('entry'));
        console.log('Found entries:', entries.length);

        if (!entries.length) {
            container.innerHTML = '<div>No recent videos found.</div>';
            return;
        }

        const YT_NS = 'http://www.youtube.com/xml/schemas/2015';
        
        // Math-related keywords to filter content
        const mathKeywords = ['math', 'mathematics', 'number', 'addition', 'subtraction', 'multiplication', 'division', 'fraction', 'decimal', 'geometry', 'algebra', 'equation', 'problem', 'solve', 'calculate', 'gmdas', 'clock', 'time', 'measurement', 'sequence', 'operation', 'counting', 'place value', 'rounding', 'percentage', 'ratio', 'proportion', 'angle', 'triangle', 'circle', 'square', 'rectangle', 'area', 'perimeter', 'volume', 'statistics', 'graph', 'chart', 'data', 'pattern', 'logic', 'reasoning', 'arithmetic', 'computation', 'calculation', 'formula', 'theorem', 'proof', 'concept', 'principle', 'rule', 'method', 'technique', 'strategy', 'approach', 'solution', 'answer', 'result', 'sum', 'difference', 'product', 'quotient', 'remainder', 'factor', 'multiple', 'prime', 'composite', 'even', 'odd', 'positive', 'negative', 'integer', 'whole', 'natural', 'rational', 'irrational', 'real', 'imaginary', 'complex', 'variable', 'constant', 'coefficient', 'exponent', 'power', 'root', 'square root', 'cube root', 'logarithm', 'trigonometry', 'sine', 'cosine', 'tangent', 'secant', 'cosecant', 'cotangent', 'radian', 'degree', 'coordinate', 'axis', 'origin', 'slope', 'intercept', 'function', 'domain', 'range', 'graph', 'plot', 'curve', 'line', 'parabola', 'hyperbola', 'ellipse', 'circle', 'sphere', 'cylinder', 'cone', 'pyramid', 'prism', 'polygon', 'quadrilateral', 'pentagon', 'hexagon', 'octagon', 'dodecagon', 'polyhedron', 'tetrahedron', 'cube', 'octahedron', 'dodecahedron', 'icosahedron', 'symmetry', 'reflection', 'rotation', 'translation', 'dilation', 'similarity', 'congruence', 'parallel', 'perpendicular', 'intersection', 'midpoint', 'bisector', 'median', 'altitude', 'centroid', 'circumcenter', 'incenter', 'orthocenter', 'circumradius', 'inradius', 'diameter', 'radius', 'chord', 'tangent', 'secant', 'arc', 'sector', 'segment', 'central angle', 'inscribed angle', 'intercepted arc', 'chord length', 'arc length', 'sector area', 'segment area', 'surface area', 'lateral area', 'volume', 'capacity', 'density', 'mass', 'weight', 'force', 'pressure', 'velocity', 'acceleration', 'momentum', 'energy', 'work', 'power', 'efficiency', 'ratio', 'proportion', 'rate', 'speed', 'distance', 'time', 'average', 'mean', 'median', 'mode', 'range', 'standard deviation', 'variance', 'correlation', 'regression', 'probability', 'permutation', 'combination', 'factorial', 'binomial', 'normal distribution', 'standard normal', 'z-score', 'confidence interval', 'hypothesis testing', 'null hypothesis', 'alternative hypothesis', 'type I error', 'type II error', 'p-value', 'significance level', 'critical value', 'test statistic', 'degrees of freedom', 'chi-square', 't-test', 'f-test', 'anova', 'linear regression', 'multiple regression', 'correlation coefficient', 'coefficient of determination', 'residual', 'outlier', 'leverage', 'influence', 'multicollinearity', 'heteroscedasticity', 'autocorrelation', 'durbin-watson', 'breusch-pagan', 'white test', 'jarque-bera', 'shapiro-wilk', 'kolmogorov-smirnov', 'mann-whitney', 'wilcoxon', 'kruskal-wallis', 'friedman', 'spearman', 'kendall', 'cronbach alpha', 'factor analysis', 'principal component', 'cluster analysis', 'discriminant analysis', 'logistic regression', 'poisson regression', 'negative binomial', 'gamma regression', 'beta regression', 'tobit regression', 'censored regression', 'truncated regression', 'sample selection', 'endogeneity', 'instrumental variables', 'two-stage least squares', 'generalized method of moments', 'maximum likelihood', 'bayesian', 'markov chain monte carlo', 'gibbs sampling', 'metropolis-hastings', 'importance sampling', 'rejection sampling', 'inverse transform', 'box-muller', 'acceptance-rejection', 'composition', 'alias method', 'walker algorithm', 'marsaglia polar', 'ziggurat', 'ratio of uniforms', 'exponential', 'gamma', 'beta', 'dirichlet', 'multinomial', 'poisson', 'negative binomial', 'geometric', 'hypergeometric', 'binomial', 'bernoulli', 'uniform', 'normal', 'lognormal', 'chi-square', 'f-distribution', 't-distribution', 'cauchy', 'laplace', 'logistic', 'weibull', 'pareto', 'exponential', 'gamma', 'beta', 'dirichlet', 'multinomial', 'poisson', 'negative binomial', 'geometric', 'hypergeometric', 'binomial', 'bernoulli', 'uniform', 'normal', 'lognormal', 'chi-square', 'f-distribution', 't-distribution', 'cauchy', 'laplace', 'logistic', 'weibull', 'pareto'];
        
        const filteredEntries = entries.filter(entry => {
            const titleEl = entry.getElementsByTagName('title')[0];
            const title = titleEl ? (titleEl.textContent || '').toLowerCase() : '';
            return mathKeywords.some(keyword => title.includes(keyword));
        });
        
        // Sort all entries by published date (chronological order - newest first)
        const sortedEntries = (filteredEntries.length > 0 ? filteredEntries : entries).sort((a, b) => {
            const dateA = new Date(a.getElementsByTagName('published')[0]?.textContent || 0);
            const dateB = new Date(b.getElementsByTagName('published')[0]?.textContent || 0);
            return dateB - dateA; // Newest first
        });
        
        // Show all videos (remove the .slice(0,5) limit)
        sortedEntries.forEach(entry => {
            const vidEl = entry.getElementsByTagNameNS?.(YT_NS, 'videoId')?.[0]
                || entry.getElementsByTagName('yt:videoId')?.[0]
                || entry.querySelector('yt\\:videoId, videoId');
            const titleEl = entry.getElementsByTagName('title')[0];
            const publishedEl = entry.getElementsByTagName('published')[0];
            const videoId = vidEl ? (vidEl.textContent || '').trim() : '';
            const title = titleEl ? (titleEl.textContent || 'YouTube Video').trim() : 'YouTube Video';
            const publishedDate = publishedEl ? new Date(publishedEl.textContent).toLocaleDateString() : '';
            if (!videoId) return;

            const div = document.createElement('div');
            div.className = 'lesson-item';
            div.innerHTML = `
                <div class="lesson-thumbnail" style="background-color: var(--peach); background-image: url('https://img.youtube.com/vi/${videoId}/mqdefault.jpg'); background-size: cover; background-position: center;"></div>
                <div class="lesson-title">
                    <h3>${title}</h3>
                    <p style="font-size:0.9rem;color:#666;margin:4px 0;">Published: ${publishedDate}</p>
                    <span class="lesson-badge" style="cursor:pointer;" onclick="window.location.href='video.html?id=${videoId}'">Watch</span>
                </div>
            `;
            container.appendChild(div);
        });

        if (!container.children.length) {
            container.innerHTML = '<div>No math-related videos found in the playlist.</div>';
        }
    } catch (err) {
        console.error('Error fetching YouTube videos:', err);
        container.innerHTML = '<div>Failed to load YouTube videos.</div>';
    }
}

document.addEventListener('DOMContentLoaded', loadYouTubeVideosStudent);
</script>
<script src="../assets/js/navbar.js"></script>

<script src="../assets/tabDropdown.js"></script>

<script src="../assets/js/header-dynamic-labels.js"></script>
<script src="../assets/js/student-empty-state.js"></script>

<script src="../assets/js/student-qa-empty-state.js"></script>

<script src="../assets/js/Student Side/student-card-clickable.js"></script>

<script>
// Enhanced quiz loading with filter functionality for English - Teacher quizzes only
async function loadStudentAvailableQuizzes(studentUID, filterQuarter = null) {
    console.log('Loading available quizzes for student:', studentUID, 'Quarter filter:', filterQuarter);
    
    const quizzesContainer = document.getElementById('quizzesContainer');
    if (!quizzesContainer) return;

    // Show loading message
    quizzesContainer.innerHTML = '<div style="color:#888;text-align:center;padding:20px;">Loading your assigned quizzes...</div>';

    try {
        const subjectPage = "subject_math";
        let allQuizzes = [];

        // Load quizzes from specific quarter or all quarters
        const quartersToLoad = filterQuarter ? [parseInt(filterQuarter)] : [1, 2, 3, 4];
        
        for (let q of quartersToLoad) {
            const quizzesPath = `students/${studentUID}/quizzes/${subjectPage}/${q}`;
            console.log(`Checking available quizzes: ${quizzesPath}`);
            
            const quizzesSnap = await db.ref(quizzesPath).once('value');
            if (quizzesSnap.exists()) {
                console.log(`✓ Found available quizzes for Q${q}:`, quizzesSnap.val());
                quizzesSnap.forEach(quizSnap => {
                    const quiz = quizSnap.val();
                    allQuizzes.push({
                        ...quiz,
                        name: quizSnap.key,
                        quarter: q,
                        source: 'teacher'
                    });
                });
            }
        }

        console.log(`Total teacher quizzes found:`, allQuizzes.length);

        // Clear container and set proper grid styling
        quizzesContainer.innerHTML = '';
        quizzesContainer.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 12px; margin-top: 15px;';

        if (allQuizzes.length === 0) {
            const emptyMsg = document.createElement('div');
            
            quizzesContainer.appendChild(emptyMsg);
        } else {
            // Sort quizzes by creation date (newest first)
            allQuizzes.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

            allQuizzes.forEach(quiz => {
                const quizItem = document.createElement('div');
                quizItem.className = 'lesson-item student-quiz-item';
                
                const createdDate = quiz.createdAt ? new Date(quiz.createdAt).toLocaleDateString() : '';
                const isLocked = quiz.isLocked !== false;
                const hasPassword = quiz.hasPassword !== false;
                
                quizItem.innerHTML = `
                    <div class="lesson-thumbnail" style="background: linear-gradient(135deg, #ffe600 0%, #ffcd00 100%); position: relative; height: 120px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem;">
                        <div style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; font-size: 10px; padding: 2px 6px; border-radius: 3px;">
                            ${quiz.teacherName || 'Teacher'}
                        </div>
                        <div style="position: absolute; top: 5px; left: 5px; background: ${isLocked ? '#e74c3c' : '#27ae60'}; color: white; font-size: 9px; padding: 2px 4px; border-radius: 3px; font-weight: bold;">
                            ${isLocked ? '🔒 LOCKED' : '🔓 UNLOCKED'}
                        </div>
                        <div style="position: absolute; bottom: 5px; right: 5px; background: rgba(255,255,255,0.9); color: #333; font-size: 10px; padding: 2px 6px; border-radius: 3px;">
                            Q${quiz.quarter}
                        </div>
                        <div style="position: absolute; top: 8px; center: 8px; background: rgba(255,255,255,0.9); color: #333; font-size: 9px; padding: 3px 8px; border-radius: 12px; font-weight: bold;">
                            TEACHER QUIZ
                        </div>
                        📝
                    </div>
                    <div class="lesson-title">
                        <h3>${quiz.title || quiz.name}</h3>
                        <p>${quiz.description || 'Teacher-created quiz'}</p>
                        <div style="font-size: 0.85rem; color: #666; margin: 8px 0; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                            <i class="fas fa-user-tie" style="margin-right: 4px;"></i><strong>Teacher:</strong> ${quiz.teacherName || 'Unknown'}<br>
                            ${createdDate ? `<i class="fas fa-calendar" style="margin-right: 4px;"></i><strong>Created:</strong> ${createdDate}<br>` : ''}
                            <strong>Status:</strong> <span style="color: ${isLocked ? '#e74c3c' : '#27ae60'};">${isLocked ? 'Locked' : 'Available'}</span>
                            ${quiz.attempts ? `<br><strong>Attempts:</strong> ${quiz.attempts}` : ''}
                            ${quiz.bestScore ? `<br><strong>Best Score:</strong> ${quiz.bestScore}` : ''}
                        </div>
                        ${isLocked ? 
                            `<button class="lesson-badge" onclick="unlockStudentQuiz('${quiz.quarter}','${quiz.name}','${subjectPage}')" style="cursor:pointer; background: #e74c3c;">
                                🔒 Enter Password
                            </button>` :
                            `<button class="lesson-badge" onclick="startStudentQuiz('${quiz.quarter}','${quiz.name}','${quiz.createdBy}','${subjectPage}')" style="cursor:pointer; background: #27ae60;">
                                ▶ Start Quiz
                            </button>`
                        }
                    </div>
                `;
                quizzesContainer.appendChild(quizItem);
            });
        }

    } catch (error) {
        console.error('Error loading available quizzes:', error);
        quizzesContainer.innerHTML = `<div style="color:#e74c3c;text-align:center;padding:20px;">Error loading quizzes: ${error.message}</div>`;
    }
}

// Function to unlock student quiz with password
window.unlockStudentQuiz = async function(quarter, name, subject) {
    const password = prompt('Enter the quiz password provided by your teacher:');
    if (!password) return;

    const user = firebase.auth().currentUser;
    if (!user) return;

    const studentUID = user.uid;

    try {
        // Check the quiz from student's collection to get the correct password
        const studentQuizRef = db.ref(`students/${studentUID}/quizzes/${subject}/${quarter}/${name}`);
        const studentQuizSnap = await studentQuizRef.once('value');
        
        if (!studentQuizSnap.exists()) {
            alert('Quiz not found.');
            return;
        }

        const studentQuiz = studentQuizSnap.val();
        
        if (studentQuiz.password === password) {
            // Unlock the quiz
            await studentQuizRef.update({
                isLocked: false,
                unlockedAt: new Date().toISOString(),
                status: 'unlocked'
            });
            
            alert('Quiz unlocked successfully! You can now start the quiz.');
            
            // Reload the quizzes to show updated status
            const filterSelect = document.getElementById('quiz-quarter-filter');
            const currentFilter = filterSelect ? filterSelect.value : null;
            loadStudentAvailableQuizzes(studentUID, currentFilter);
        } else {
            alert('Incorrect password. Please try again.');
        }
    } catch (error) {
        console.error('Error unlocking quiz:', error);
        alert('Error unlocking quiz. Please try again.');
    }
};

// Function to start student quiz
// FIXED: Function to start student quiz - loads from teacher's collection
window.startStudentQuiz = async function(quarter, name, teacherUID, subject) {
    console.log('Starting student quiz:', { quarter, name, teacherUID, subject });
    
    const user = firebase.auth().currentUser;
    if (!user) return;
    
    try {
        // Get student info to find their section
        const studentUID = user.uid;
        const studentSnap = await db.ref('students/' + studentUID).once('value');
        const student = studentSnap.val();
        
        if (!student || !student.section) {
            alert('Student section not found.');
            return;
        }
        
        console.log('Student section:', student.section);
        console.log('Teacher UID:', teacherUID);
        
        // Build the correct parameters to load from teacher's collection
        const params = new URLSearchParams({
            quarter: quarter,
            name: name,
            subject: subject,
            teacherUID: teacherUID, // This is critical - tells quizView to load from teacher's collection
            studentSection: student.section,
            mode: 'student'
        });
        
        console.log('Redirecting to quizView with params:', params.toString());
        
        window.location.href = 'quizView.html?' + params.toString();
        
    } catch (error) {
        console.error('Error starting student quiz:', error);
        alert('Error starting quiz. Please try again.');
    }
};

// Enhanced auth state handler with filter support for English
firebase.auth().onAuthStateChanged(async function(user) {
    if (!user) {
        window.location.href = "logreg.html";
        return;
    }

    const studentUID = user.uid;
    
    try {
        const studentSnap = await db.ref('students/' + studentUID).once('value');
        const student = studentSnap.val();
        
        if (!student || student.role !== "student") {
            alert("Access denied.");
            await firebase.auth().signOut();
            window.location.href = "logreg.html";
            return;
        }

        document.getElementById('mainContent').style.display = "block";

        // Load quizzes initially (all quarters)
        await loadStudentAvailableQuizzes(studentUID);

        // Set up filter functionality
        const filterSelect = document.getElementById('quiz-quarter-filter');
        if (filterSelect) {
            filterSelect.addEventListener('change', function() {
                const selectedQuarter = this.value;
                console.log('Filter changed to quarter:', selectedQuarter);
                loadStudentAvailableQuizzes(studentUID, selectedQuarter);
            });
        }

    } catch (error) {
        console.error('Error in student auth state change:', error);
    }
});
</script>

</body>
</html>
