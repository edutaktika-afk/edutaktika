<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quiz Editor | Edutaktika</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    
    <style>
        /* CSS Variables */
        :root {
            --primary: #2e8b57;
            --secondary: #ffd700;
            --accent: #ff69b4;
            --background: #f0f8ff;
            --card-bg: #ffffff;
            --text-main: #22223b;
            --text-light: #9a8c98;
            --shadow: 0 4px 24px rgba(46, 139, 87, 0.08);
            --radius: 18px;
        }

        /* Base Styles */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            overflow: hidden;
            background: var(--background);
            color: var(--text-main);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            min-height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
        }

        /* Header/Breadcrumbs */
        .breadcrumbs {
            width: 100vw;
            left: 0;
            top: 0;
            position: relative;
            box-sizing: border-box;
            padding: 8px 24px;
            color: #888;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 18px;
            background: rgb(255, 255, 255);
            z-index: 100;
            border-bottom: 1px solid #e0e0e0;
        }

        .breadcrumbs .logo {
            font-weight: bold;
            font-size: 1.3rem;
            color: var(--primary);
        }

        .right-breadcrumb-btns {
            margin-left: auto;
            margin-right: 20px;
            display: flex;
            gap: 10px;
        }

        .right-breadcrumb-btns button {
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }

        .right-breadcrumb-btns button:hover {
            background: #1e5f3f;
            transform: translateY(-1px);
        }

        .right-breadcrumb-btns button#present-btn {
            background: var(--accent);
        }

        /* Burger Menu */
        #burger-menu-btn {
            background: none;
            border: none;
            padding: 0 10px 0 0;
            cursor: pointer;
            font-size: 1.7rem;
            color: var(--primary);
            outline: none;
        }

        #burger-dropdown {
            display: none;
            position: absolute;
            top: 54px;
            left: 16px;
            min-width: 160px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            padding: 10px 0;
            z-index: 1000;
        }

        #burger-dropdown a {
            display: block;
            padding: 12px 24px;
            color: var(--text-main);
            text-decoration: none;
            transition: background 0.2s;
        }

        #burger-dropdown a:hover {
            background: #f5f5f5;
        }

        /* Main Layout */
        .editor-layout {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 70px);
            min-height: 0;
            overflow: hidden;
        }

        .main-area {
            display: flex;
            flex: 1 1 auto;
            min-height: 0;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            min-width: 200px;
            width: 220px;
            max-width: 280px;
            height: 100%;
            overflow-y: auto;
            background: #e8f5e8;
            border-right: 1px solid #d0d0d0;
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            z-index: 10;
        }

        .sidebar-group {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .sidebar-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar button {
            display: block;
            width: 100%;
            margin-bottom: 8px;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .sidebar button:hover {
            background: #1e5f3f;
            transform: translateY(-1px);
        }

        /* Canvas Area */
        .editor-content {
            flex: 1 1 auto;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 0;
            overflow: hidden;
            background: var(--background);
            padding: 20px;
            box-sizing: border-box;
        }

        .canvas-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1 1 auto;
            max-width: 100%;
            max-height: 100%;
        }

        .canvas-wrapper {
            width: 80%;
            max-width: 800px;
            aspect-ratio: 16/9;
            background: #fff;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden; /* Ensure games don't overflow */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        #canvas {
            width: 100%;
            height: 100%;
            max-width: 800px;
            max-height: 450px;
            display: block;
            outline: none;
            position: relative;
            z-index: 1; /* Lower z-index than iframe */
        }

        /* Game Iframe Styles */
/* Update the Game Iframe Styles to fill the entire canvas */
#game-iframe {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    transform: none !important; /* Remove the scale and centering transform */
    width: 100% !important; /* Fill entire canvas width */
    height: 100% !important; /* Fill entire canvas height */
    border: none !important;
    z-index: 10 !important;
    max-width: 100% !important;
    max-height: 100% !important;
    object-fit: cover !important; /* Cover the entire area */
    overflow: hidden !important;
    border-radius: 0 !important; /* Remove border radius to fill corners */
    box-shadow: none !important; /* Remove shadow for full coverage */
    -webkit-overflow-scrolling: touch !important;
    -ms-overflow-style: none !important;
    scrollbar-width: none !important;
}

#game-iframe::-webkit-scrollbar {
    display: none !important;
}

        /* Slide Navigation */
        .slide-nav {
            position: fixed;
            bottom: 0px;
            left: 59%;
            transform: translateX(-50%);
            z-index: 50;
            display: flex;
            align-items: center;
            gap: 16px;
            background: transparent;
            padding: 8px 24px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            max-width: 80vw;
            border: 1px solid rgba(255, 255, 255, 0.2); /* Subtle border for definition */
        }

        #slide-preview-bar {
            display: flex;
            gap: 12px;
            align-items: center;
            overflow-x: auto;
            overflow-y: hidden; /* Prevent vertical scrollbar */
            max-width: 50vw;
            padding: 0 8px;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* Internet Explorer 10+ */
        }

        #slide-preview-bar::-webkit-scrollbar {
            display: none;
        }

        .slide-thumb {
            width: 60px;
            height: 40px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .slide-thumb.active {
            border-color: var(--primary);
            box-shadow: 0 4px 16px rgba(46, 139, 87, 0.2);
        }

        .slide-thumb:hover {
            transform: translateY(-2px);
        }

        #slide-indicator {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
            white-space: nowrap;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .zoom-controls label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-main);
        }

        #canvas-scale {
            width: 120px;
        }

        #canvas-scale-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--primary);
            min-width: 40px;
        }

        #reset-zoom-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }

        #reset-zoom-btn:hover {
            background: #1e5f3f;
        }

        /* Game Modal */
        #game-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        #game-modal > div {
            background: white;
            padding: 40px;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 16px 64px rgba(0,0,0,0.2);
            position: relative;
        }

        #game-modal h2 {
            margin-top: 0;
            margin-bottom: 24px;
            font-size: 24px;
            color: var(--primary);
        }

        .game-option {
            display: block;
            width: 100%;
            margin-bottom: 12px;
            padding: 16px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s ease;
            text-align: left;
        }

        .game-option:hover {
            background: #1e5f3f;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(46, 139, 87, 0.3);
        }

        .cancel-button {
            margin-top: 24px;
            padding: 12px 24px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .cancel-button:hover {
            background: #ff4444;
            color: white;
            border-color: #ff4444;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 180px;
                min-width: 180px;
            }
            
            .canvas-wrapper {
                width: 90%;
            }
        }

        @media (max-width: 768px) {
            .main-area {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 200px;
                flex-direction: row;
                overflow-x: auto;
                gap: 16px;
                padding: 16px;
            }
            
            .sidebar-group {
                min-width: 200px;
                flex-shrink: 0;
            }
            
            .canvas-wrapper {
                width: 95%;
                max-width: none;
            }
            
            .slide-nav {
                max-width: 95vw;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            #slide-preview-bar {
                max-width: 70vw;
            }
            
            .zoom-controls {
                flex-wrap: wrap;
                gap: 4px;
            }
        }

        @media (max-width: 480px) {
            .breadcrumbs {
                flex-wrap: wrap;
                gap: 8px;
                padding: 8px 16px;
            }
            
            .right-breadcrumb-btns {
                margin-right: 0;
                gap: 8px;
            }
            
            .right-breadcrumb-btns button {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .slide-nav {
                padding: 12px 16px;
                bottom: 10px;
            }
            
            .slide-thumb {
                width: 60px;
                height: 38px;
            }
        }

        /* Animation Keyframes */
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Utility Classes */
        .fade-in {
            animation: modalFadeIn 0.3s ease-out;
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        /* Canvas Scaling */
        .canvas-wrapper.scaled {
            transform-origin: center center;
        }
    </style>

    <style>
/* Enhanced save button with loading state */
#save-btn.saving {
    background: #888 !important;
    cursor: not-allowed !important;
    opacity: 0.7;
}

#save-btn.saving:before {
    content: '‚è≥ ';
    margin-right: 4px;
}

/* Custom prompt styling (if you want to enhance the browser prompt) */
.custom-prompt-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.custom-prompt {
    background: white;
    padding: 30px;
    border-radius: 12px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 16px 64px rgba(0,0,0,0.2);
}

.custom-prompt h3 {
    margin-top: 0;
    color: var(--primary);
    font-size: 1.2rem;
}

.custom-prompt textarea {
    width: 100%;
    height: 80px;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-family: inherit;
    font-size: 14px;
    resize: vertical;
    box-sizing: border-box;
}

.custom-prompt textarea:focus {
    outline: none;
    border-color: var(--primary);
}

.custom-prompt-buttons {
    display: flex;
    gap: 12px;
    margin-top: 20px;
    justify-content: flex-end;
}

.custom-prompt-buttons button {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
}

.custom-prompt-buttons .save-btn {
    background: var(--primary);
    color: white;
}

.custom-prompt-buttons .save-btn:hover {
    background: #1e5f3f;
}

.custom-prompt-buttons .cancel-btn {
    background: #f5f5f5;
    color: #333;
}

.custom-prompt-buttons .cancel-btn:hover {
    background: #e74c3c;
    color: white;
}
</style>
</head>

<body>
    <!-- Firebase Configuration -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB5BbeLLvPX8l1c4Lq0f-CmIUml4hQOQlE",
            authDomain: "edutaktika.firebaseapp.com",
            databaseURL: "https://edutaktika-default-rtdb.firebaseio.com",
            projectId: "edutaktika",
            storageBucket: "edutaktika.appspot.com",
            messagingSenderId: "676848575316",
            appId: "1:676848575316:web:f78f8c0f83bf3d9dfb5ec1",
            measurementId: "G-X3GT5TNN87"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
    </script>

    <!-- Header/Breadcrumbs -->
    <div class="breadcrumbs">
        <div style="display:flex;align-items:center;gap:12px;">
            <button id="burger-menu-btn" aria-label="Open menu">
                <i class="fa fa-bars"></i>
            </button>
            <span class="logo">Edutaktika</span>
        </div>
        
        <div class="right-breadcrumb-btns">
            <button id="save-btn"><i class="fa fa-save"></i> Save</button>
            <button id="export-btn"><i class="fa fa-download"></i> Export</button>
            <button id="import-btn"><i class="fa fa-upload"></i> Import</button>
            <button id="present-btn"><i class="fa fa-play"></i> Present</button>
        </div>
        
        <div id="burger-dropdown">
            <a href="#" id="burger-export"><i class="fa fa-download"></i> Export</a>
            <a href="#" id="burger-import"><i class="fa fa-upload"></i> Import</a>
            <a href="homepage.html"><i class="fa fa-home"></i> Home</a>
            <a href="#"><i class="fa fa-presentation-screen"></i> My Quizzes</a>
            <a href="#"><i class="fa fa-cog"></i> Settings</a>
        </div>
    </div>

    <!-- Main Editor Layout -->
    <div class="editor-layout">
        <div class="main-area">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-group">
                    <div class="sidebar-label">Games & Activities</div>
                    <button id="add-game-btn">
                        <i class="fa fa-gamepad"></i> Add Game
                    </button>
                </div>
            </aside>

            <!-- Canvas Area -->
            <div class="editor-content">
                <div class="canvas-area">
                    <div class="canvas-wrapper">
                        <canvas id="canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Slide Navigation -->
    <div class="slide-nav">
        <div id="slide-preview-bar"></div>
        <span id="slide-indicator">Slide 1/1</span>
        <div class="zoom-controls">
            <label for="canvas-scale">Zoom:</label>
            <input type="range" id="canvas-scale" min="0.1" max="1" step="0.01" value="0.9">
            <span id="canvas-scale-value">80%</span>
            <button id="reset-zoom-btn" title="Reset Zoom">
                <i class="fa fa-refresh"></i>
            </button>
        </div>
    </div>

    <!-- Game Selection Modal -->
    <div id="game-modal">
        <div class="fade-in">
            <h2><i class="fa fa-gamepad"></i> Choose a Game</h2>
            <button class="game-option" data-game="../Games/Quiz/game2.html">
                <i class="fa fa-puzzle-piece"></i> Fraction Match Game
            </button>
            <button class="game-option" data-game="../Games/Quiz/game1.html">
                <i class="fa fa-drag-left-right"></i> Drag & Drop Math Quiz
            </button>
            <button class="cancel-button" onclick="document.getElementById('game-modal').style.display='none'">
                <i class="fa fa-times"></i> Cancel
            </button>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Global Variables
        let slides = [];
        let currentSlide = 0;
        let gameUrl = null;
        let gameSlideIndex = null;
        let lastDescription = "";
        let isAutoSaveEnabled = true;
        let autoSaveInterval = 30000; // 30 seconds
        let autoSaveTimeout;
        let lastCanvasState = '';

        // Initialize Fabric.js Canvas
        const canvas = new fabric.Canvas('canvas', {
            backgroundColor: '#fff',
            width: 800,
            height: 450
        });

        // Utility Functions
        function getParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }

        // Burger Menu Functionality
        const burgerBtn = document.getElementById('burger-menu-btn');
        const burgerDropdown = document.getElementById('burger-dropdown');

        burgerBtn.addEventListener('click', function(e) {
            const isVisible = burgerDropdown.style.display === 'block';
            burgerDropdown.style.display = isVisible ? 'none' : 'block';
            e.stopPropagation();
        });

        document.addEventListener('click', function(e) {
            if (!burgerDropdown.contains(e.target) && e.target !== burgerBtn) {
                burgerDropdown.style.display = 'none';
            }
        });

        // Burger menu actions
        document.getElementById('burger-export').onclick = function(e) {
            e.preventDefault();
            document.getElementById('export-btn').click();
            burgerDropdown.style.display = 'none';
        };

        document.getElementById('burger-import').onclick = function(e) {
            e.preventDefault();
            document.getElementById('import-btn').click();
            burgerDropdown.style.display = 'none';
        };

        // Canvas Scaling
        const scaleInput = document.getElementById('canvas-scale');
        const scaleValue = document.getElementById('canvas-scale-value');
        const canvasWrapper = document.querySelector('.canvas-wrapper');

        function updateCanvasScale() {
            const scale = parseFloat(scaleInput.value);
            canvasWrapper.style.transform = `scale(${scale})`;
            canvasWrapper.classList.add('scaled');
            scaleValue.textContent = Math.round(scale * 100) + '%';
        }

        scaleInput.addEventListener('input', updateCanvasScale);
        document.getElementById('reset-zoom-btn').onclick = function() {
            scaleInput.value = 0.8;
            updateCanvasScale();
        };

        // Initialize scale
        updateCanvasScale();

        // Responsive Canvas
        function resizeCanvas() {
            const wrapper = document.querySelector('.canvas-wrapper');
            const rect = wrapper.getBoundingClientRect();
            canvas.setWidth(rect.width);
            canvas.setHeight(rect.height);
            canvas.calcOffset && canvas.calcOffset();
            canvas.renderAll();
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

// Replace the showGameIframe function (around line 560) with this corrected version:
function showGameIframe() {
    console.log('showGameIframe called for slide:', currentSlide);
    console.log('Current slide data:', slides[currentSlide]);
    
    const wrapper = document.querySelector('.canvas-wrapper');
    let existing = document.getElementById('game-iframe');
    
    // Remove if not on a game slide
    if (!slides[currentSlide] || !slides[currentSlide].game) {
        console.log('No game on current slide, removing iframe');
        if (existing) existing.remove();
        return;
    }
    
    console.log('Game found on slide, creating/updating iframe');
    
    // Show if on a game slide
    if (!existing) {
        console.log('Creating new iframe');
        
        const iframe = document.createElement('iframe');
        iframe.id = 'game-iframe';
        
        // Add edit mode parameter to game URL for quiz-specific editing
        let gameUrl = slides[currentSlide].game.url;
        const separator = gameUrl.includes('?') ? '&' : '?';
        const quizId = getQuizId();
        gameUrl += separator + `edit=true&mode=quiz&quizId=${encodeURIComponent(quizId)}`;
        
        console.log('Game URL:', gameUrl);
        
        iframe.src = gameUrl;
        iframe.style.cssText = `
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            border: none !important;
            z-index: 10 !important;
            max-width: 100% !important;
            max-height: 100% !important;
            overflow: hidden !important;
            object-fit: cover !important;
            border-radius: 0 !important;
            background: white !important;
        `;
        iframe.scrolling = 'no';
        iframe.allow = 'fullscreen';

        // Listen for game data updates from iframe
        if (!window.gameMessageListenerAdded) {
            window.addEventListener('message', handleGameMessage, false);
            window.gameMessageListenerAdded = true;
        }

        // Ensure wrapper is properly configured
        wrapper.style.position = 'relative';
        wrapper.style.overflow = 'hidden';
        
        // Hide canvas when game is active
        const canvas = document.getElementById('canvas');
        if (canvas) {
            canvas.style.display = 'none';
        }
        
        wrapper.appendChild(iframe);
        
        console.log('Iframe created and added to wrapper');
        
        // FIXED: Load existing game data if available with better timing
        iframe.onload = function() {
            console.log('Iframe loaded, checking for existing game data');
            
            // Give the game time to initialize
            setTimeout(() => {
                if (slides[currentSlide].game.data) {
                    console.log('Sending existing game data to iframe:', slides[currentSlide].game.data);
                    
                    // Parse game data if it's a string
                    let gameData = slides[currentSlide].game.data;
                    if (typeof gameData === 'string') {
                        try {
                            gameData = JSON.parse(gameData);
                        } catch (e) {
                            console.error('Error parsing game data:', e);
                        }
                    }
                    
                    iframe.contentWindow.postMessage({
                        type: 'loadQuizGameData',
                        gameData: gameData,
                        quizId: getQuizId(),
                        isEditMode: true
                    }, '*');
                } else {
                    console.log('No existing game data found');
                    // Send request for game to load in edit mode
                    iframe.contentWindow.postMessage({
                        type: 'requestQuizGameData',
                        quizId: getQuizId()
                    }, '*');
                }
            }, 1000); // Increased delay to ensure game is fully loaded
        };
    } else {
        console.log('Updating existing iframe');
        
        // Update existing iframe with edit parameters
        let gameUrl = slides[currentSlide].game.url;
        const separator = gameUrl.includes('?') ? '&' : '?';
        const quizId = getQuizId();
        gameUrl += separator + `edit=true&mode=quiz&quizId=${encodeURIComponent(quizId)}`;
        
        existing.src = gameUrl;
        existing.style.display = 'block';
        
        // Hide canvas when game is active
        const canvas = document.getElementById('canvas');
        if (canvas) {
            canvas.style.display = 'none';
        }
        
        // Send existing game data after a delay
        setTimeout(() => {
            if (slides[currentSlide].game.data) {
                let gameData = slides[currentSlide].game.data;
                if (typeof gameData === 'string') {
                    try {
                        gameData = JSON.parse(gameData);
                    } catch (e) {
                        console.error('Error parsing game data:', e);
                    }
                }
                
                existing.contentWindow.postMessage({
                    type: 'loadQuizGameData',
                    gameData: gameData,
                    quizId: getQuizId(),
                    isEditMode: true
                }, '*');
            }
        }, 500);
    }
}
        
// FIXED: Enhanced message handler to properly capture and save game data
function handleGameMessage(event) {
    console.log('üì® Quiz Editor received message:', event.data);
    
    const data = event.data;
    
    if (data.type === 'saveQuizGameData' || data.type === 'gameDataUpdate') {
        console.log('üíæ SAVING quiz-specific game data:', data.gameData);
        
        // Update the current slide's game data
        if (slides[currentSlide] && slides[currentSlide].game) {
            // CRITICAL: Store the ACTUAL game data (values, questions, etc.)
            slides[currentSlide].game.data = data.gameData;
            slides[currentSlide].game.lastModified = new Date().toISOString();
            slides[currentSlide].game.quizId = getQuizId();
            slides[currentSlide].game.isQuizSpecific = true;
            slides[currentSlide].game.customized = true;
            
            console.log('‚úÖ Game data saved to slide:', {
                slideIndex: currentSlide,
                hasData: !!slides[currentSlide].game.data,
                dataPreview: typeof slides[currentSlide].game.data === 'object' ? 
                            JSON.stringify(slides[currentSlide].game.data).substring(0, 100) + '...' :
                            slides[currentSlide].game.data
            });
            
            // Force immediate save to ensure data persistence
            saveCurrentSlide();
            triggerImmediateAutoSave();
            showAutoSaveIndicator('üéÆ Game edits saved!');
        }
    } else if (data.type === 'requestQuizGameData') {
        console.log('üîÑ Game requesting existing data for slide:', currentSlide);
        
        const iframe = document.getElementById('game-iframe');
        if (iframe && slides[currentSlide] && slides[currentSlide].game) {
            let gameData = slides[currentSlide].game.data;
            
            // Don't parse if it's already an object
            if (typeof gameData === 'string' && gameData) {
                try {
                    gameData = JSON.parse(gameData);
                } catch (e) {
                    console.error('Error parsing game data:', e);
                    gameData = null;
                }
            }
            
            console.log('üì§ Sending existing data to game:', gameData);
            
            iframe.contentWindow.postMessage({
                type: 'loadQuizGameData',
                gameData: gameData,
                quizId: getQuizId(),
                isEditMode: true
            }, '*');
        } else {
            console.log('‚ùå No existing game data found');
            
            // Send empty data to let game know it can start fresh
            iframe.contentWindow.postMessage({
                type: 'loadQuizGameData',
                gameData: null,
                quizId: getQuizId(),
                isEditMode: true
            }, '*');
        }
    } else if (data.type === 'currentGameData') {
        // Handle response from requestCurrentGameData
        console.log('üì• Received current game data from game:', data.gameData);
        
        if (slides[currentSlide] && slides[currentSlide].game) {
            slides[currentSlide].game.data = data.gameData;
            slides[currentSlide].game.lastModified = new Date().toISOString();
            slides[currentSlide].game.customized = true;
            
            console.log('‚úÖ Current game state captured and saved');
            
            saveCurrentSlide();
            triggerImmediateAutoSave();
            showAutoSaveIndicator('üéÆ Current game state saved');
        }
    }
}


        // Generate unique quiz ID for this editing session
        function getQuizId() {
            const subject = getParam('subject') || 'general';
            const quarter = getParam('quarter') || 'auto';
            const name = getParam('name') || 'untitled';
            const user = firebase.auth().currentUser;
            const userId = user ? user.uid : 'anonymous';
            
            return `${userId}_${subject}_${quarter}_${name}`;
        }

        // Add Game Button Functionality
        document.getElementById('add-game-btn').addEventListener('click', function() {
            document.getElementById('game-modal').style.display = 'flex';
        });

        // Enhanced game option selection with quiz-specific data structure
        document.querySelectorAll('.game-option').forEach(btn => {
            btn.onclick = function() {
                console.log('Game option clicked:', this.dataset.game); // Debug log
                
                saveCurrentSlide();
                
                const selectedGameUrl = this.dataset.game; // Use different variable name
                const quizId = getQuizId();
                
                // Create game object with quiz-specific data structure
                const gameData = {
                    url: selectedGameUrl,
                    type: getGameType(selectedGameUrl),
                    quizId: quizId,
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString(),
                    data: null, // Will store quiz-specific customizations
                    isQuizSpecific: true
                };
                
                const currentSlideData = slides[currentSlide] || canvas.toJSON();
                currentSlideData.game = gameData;
                
                slides[currentSlide] = currentSlideData;
                
                // Update global game variables
                gameUrl = selectedGameUrl; // Fix: assign to global variable
                gameSlideIndex = currentSlide;
                
                console.log('Game data created:', gameData); // Debug log
                console.log('Current slide updated:', slides[currentSlide]); // Debug log
                
                // Immediately show the game iframe
                showGameIframe();
                updateSlideIndicator();
                renderSlidePreviews(); // Update previews to show game icon
                
                document.getElementById('game-modal').style.display = 'none';
                showAutoSaveIndicator('Game embedded - ready for quiz-specific editing');
            };
        });

        // Helper function to determine game type
        function getGameType(url) {
            if (url.includes('game1.html')) return 'multiple-choice-quiz';
            if (url.includes('game2.html')) return 'drag-drop-quiz';
            return 'unknown';
        }

        // Slide Management Functions
function saveCurrentSlide() {
    if (currentSlide < slides.length) {
        const slideData = canvas.toJSON();
        
        // Preserve existing game data if it exists
        if (slides[currentSlide] && slides[currentSlide].game) {
            slideData.game = slides[currentSlide].game;
        }
        
        slides[currentSlide] = slideData;
    }
}

function loadSlide(index) {
    console.log('Loading slide:', index); // Debug log
    
    if (index >= 0 && index < slides.length && slides[index]) {
        canvas.loadFromJSON(slides[index], function() {
            canvas.renderAll();
            
            // Show/hide canvas and game based on slide content
            const canvasElement = document.getElementById('canvas');
            const hasGame = slides[index].game;
            
            if (hasGame) {
                console.log('Slide has game, hiding canvas and showing game'); // Debug log
                canvasElement.style.display = 'none';
                showGameIframe();
            } else {
                console.log('Slide has no game, showing canvas'); // Debug log
                canvasElement.style.display = 'block';
                // Remove any existing game iframe
                const existing = document.getElementById('game-iframe');
                if (existing) existing.remove();
            }
        });
    } else {
        // Create new slide
        console.log('Creating new slide'); // Debug log
        canvas.clear();
        canvas.backgroundColor = '#fff';
        canvas.renderAll();
        
        if (!slides[index]) {
            slides[index] = canvas.toJSON();
        }
        
        // Show canvas for new slide
        const canvasElement = document.getElementById('canvas');
        canvasElement.style.display = 'block';
        
        // Remove any existing game iframe
        const existing = document.getElementById('game-iframe');
        if (existing) existing.remove();
    }
    
    currentSlide = index;
    updateSlideIndicator();
}

function addSlide() {
    saveCurrentSlide();
    const newIndex = slides.length;
    slides.push(canvas.toJSON());
    loadSlide(newIndex);
    updateSlideIndicator();
    renderSlidePreviews();
}

function deleteSlide(index) {
    if (slides.length <= 1) {
        alert('Cannot delete the last slide.');
        return;
    }
    
    slides.splice(index, 1);
    
    if (currentSlide >= slides.length) {
        currentSlide = slides.length - 1;
    }
    
    loadSlide(currentSlide);
    renderSlidePreviews();
}

function updateSlideIndicator() {
    const indicator = document.getElementById('slide-indicator');
    if (indicator) {
        indicator.textContent = `Slide ${currentSlide + 1}/${Math.max(slides.length, 1)}`;
    }
}

function renderSlidePreviews() {
    const previewBar = document.getElementById('slide-preview-bar');
    if (!previewBar) return;
    
    previewBar.innerHTML = '';
    
    // Add button
    const addBtn = document.createElement('button');
    addBtn.innerHTML = '<i class="fa fa-plus"></i>';
    addBtn.style.cssText = `
        width: 40px;
        height: 40px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
        margin-right: 8px;
    `;
    addBtn.onclick = addSlide;
    addBtn.title = 'Add New Slide';
    previewBar.appendChild(addBtn);
    
    // Slide thumbnails
    slides.forEach((slide, index) => {
        const thumb = document.createElement('div');
        thumb.className = 'slide-thumb';
        if (index === currentSlide) {
            thumb.classList.add('active');
        }
        
        // Add game indicator if slide has a game
        if (slide.game) {
            const gameIcon = document.createElement('i');
            gameIcon.className = 'fa fa-gamepad';
            gameIcon.style.cssText = `
                position: absolute;
                top: 2px;
                right: 2px;
                color: var(--primary);
                font-size: 12px;
                background: white;
                border-radius: 50%;
                width: 16px;
                height: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            thumb.appendChild(gameIcon);
        }
        
        const slideNumber = document.createElement('span');
        slideNumber.textContent = index + 1;
        slideNumber.style.cssText = `
            font-size: 12px;
            font-weight: 600;
            color: var(--text-main);
        `;
        thumb.appendChild(slideNumber);
        
        thumb.onclick = () => {
            saveCurrentSlide();
            loadSlide(index);
        };
        
        // Delete button (on right-click or long press)
        thumb.oncontextmenu = (e) => {
            e.preventDefault();
            if (confirm(`Delete slide ${index + 1}?`)) {
                deleteSlide(index);
            }
        };
        
        previewBar.appendChild(thumb);
    });
}

// Auto-save trigger function (enhanced)
function triggerImmediateAutoSave() {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
        saveCurrentSlide(); // Ensure current slide is saved before auto-save
        autoSaveCanvas();
    }, 1000); // Save after 1 second delay
}

// Enhanced auto-save that captures everything
async function autoSaveCanvas() {
    if (!isAutoSaveEnabled) return;
    
    try {
        // Always save current slide first
        saveCurrentSlide();
        
        const user = firebase.auth().currentUser;
        if (!user) {
            // Save to localStorage if not logged in
            localStorage.setItem('quiz-autosave-slides', JSON.stringify(slides));
            localStorage.setItem('quiz-autosave-timestamp', new Date().toISOString());
            showAutoSaveIndicator('Auto-saved locally');
            return;
        }
        
        console.log('Auto-saving to Firebase...'); // Debug log
        
        const teacherUID = user.uid;
        const teacherSnap = await db.ref('teachers/' + teacherUID).once('value');
        const teacher = teacherSnap.val();
        const section = teacher && teacher.section ? teacher.section : null;
        const gradeLevel = teacher && teacher.gradelevel ? teacher.gradelevel : null;
        
        if (!section || !gradeLevel) {
            // Save locally if teacher profile incomplete
            localStorage.setItem('quiz-autosave-slides', JSON.stringify(slides));
            showAutoSaveIndicator('Auto-saved locally (profile incomplete)');
            return;
        }

        let quarter = getParam('quarter') || 'auto';
        let name = getParam('name') || 'AutoSaved_' + new Date().toISOString().slice(0,19).replace(/:/g,'-');
        let subject = getParam('subject') || 'general';

        // Process slides with all content including game data
        const processedSlides = slides.map(slide => {
            const processedSlide = { ...slide };
            
            // Include game data if present
            if (slide.game) {
                processedSlide.game = {
                    ...slide.game,
                    data: typeof slide.game.data === 'string' ? 
                          slide.game.data : JSON.stringify(slide.game.data || null),
                    isQuizSpecific: true,
                    autoSaved: true,
                    lastAutoSave: new Date().toISOString()
                };
            }
            
            return processedSlide;
        });
        
        const currentCanvasState = JSON.stringify(processedSlides);
        
        // Only save if there are actual changes
        if (currentCanvasState === lastCanvasState) {
            console.log('No changes detected, skipping auto-save');
            return;
        }

        let existingDescription = lastDescription || '';
        
        // Try to get existing description
        try {
            const existingQuizSnap = await db.ref('teachers/' + teacherUID + '/sections/' + section + '/quizzes/' + subject + '/' + quarter + '/' + name).once('value');
            if (existingQuizSnap.exists()) {
                const existingQuiz = existingQuizSnap.val();
                existingDescription = existingQuiz.description || lastDescription || '';
            }
        } catch (error) {
            console.log('Could not fetch existing description:', error);
        }
        
        const teacherName = `${teacher.firstname || ''} ${teacher.lastname || ''}`.trim();
        const quizPassword = Math.floor(100000 + Math.random() * 900000).toString();
        const now = new Date().toISOString();

        // Comprehensive auto-save data
        const teacherAutoSaveData = {
            slides: currentCanvasState,
            savedAt: now,
            title: name,
            quarter: quarter,
            subject: subject,
            description: existingDescription,
            autoSaved: true,
            section: section,
            gradeLevel: gradeLevel,
            createdBy: teacherUID,
            teacherName: teacherName,
            password: quizPassword,
            isLocked: true,
            hasPassword: true,
            // Game tracking
            hasCustomGames: processedSlides.some(slide => slide.game && slide.game.data),
            gameCount: processedSlides.filter(slide => slide.game).length,
            customGameCount: processedSlides.filter(slide => slide.game && slide.game.data).length,
            // Canvas content tracking
            totalSlides: processedSlides.length,
            hasContent: processedSlides.some(slide => slide.objects && slide.objects.length > 0),
            lastModified: now,
            quizId: getQuizId(),
            version: '1.0'
        };

        // Save to teacher's collection
        await db.ref('teachers/' + teacherUID + '/sections/' + section + '/quizzes/' + subject + '/' + quarter + '/' + name).set(teacherAutoSaveData);

        // Update students with complete quiz data
        const studentsSnap = await db.ref('students').once('value');
        const studentUpdatePromises = [];
        let studentsUpdated = 0;

        if (studentsSnap.exists()) {
            studentsSnap.forEach(studentSnap => {
                const student = studentSnap.val();
                const studentUID = studentSnap.key;
                
                const studentSection = (student.section || '').toString().trim().toLowerCase();
                const teacherSectionLower = (section || '').toString().trim().toLowerCase();
                const studentGrade = (student.gradelevel || '').toString().trim();
                const teacherGrade = (gradeLevel || '').toString().trim();
                
                if (studentSection === teacherSectionLower && studentGrade === teacherGrade) {
                    studentsUpdated++;
                    
                    const studentAutoSaveData = {
                        title: name,
                        description: existingDescription,
                        quarter: quarter,
                        section: section,
                        gradeLevel: gradeLevel,
                        createdBy: teacherUID,
                        teacherName: teacherName,
                        password: quizPassword,
                        isLocked: true,
                        slides: currentCanvasState, // Complete slide data including games
                        assignedBy: teacherUID,
                        assignedAt: now,
                        status: 'available',
                        attempts: 0,
                        bestScore: 0,
                        lastAttemptAt: null,
                        hasCustomGames: teacherAutoSaveData.hasCustomGames,
                        gameCount: teacherAutoSaveData.gameCount,
                        customGameCount: teacherAutoSaveData.customGameCount,
                        totalSlides: teacherAutoSaveData.totalSlides,
                        quizId: teacherAutoSaveData.quizId,
                        lastUpdated: now
                    };
                    
                    studentUpdatePromises.push(
                        db.ref(`students/${studentUID}/quizzes/${subject}/${quarter}/${name}`).set(studentAutoSaveData)
                    );
                }
            });
        }

        await Promise.all(studentUpdatePromises);
        
        // Update last saved state
        lastCanvasState = currentCanvasState;
        
        // Also save to localStorage as backup
        localStorage.setItem('quiz-autosave-slides', JSON.stringify(processedSlides));
        localStorage.setItem('quiz-autosave-timestamp', now);
        
        const gameInfo = teacherAutoSaveData.customGameCount > 0 ? 
            ` (${teacherAutoSaveData.customGameCount} customized games)` : '';
        
        showAutoSaveIndicator(`Auto-saved: ${studentsUpdated} students updated${gameInfo}`);
        console.log('Auto-save completed successfully');
        
    } catch (error) {
        console.error('Auto-save failed:', error);
        // Fallback to localStorage
        try {
            saveCurrentSlide();
            localStorage.setItem('quiz-autosave-slides', JSON.stringify(slides));
            localStorage.setItem('quiz-autosave-timestamp', new Date().toISOString());
            showAutoSaveIndicator('Auto-saved locally (Firebase error)', true);
        } catch (localError) {
            console.error('Local auto-save also failed:', localError);
            showAutoSaveIndicator('Auto-save Failed', true);
        }
    }
}

// Enhanced canvas event listeners for comprehensive auto-save
function setupCanvasAutoSave() {
    // Canvas object events
    canvas.on('object:added', triggerImmediateAutoSave);
    canvas.on('object:removed', triggerImmediateAutoSave);
    canvas.on('object:modified', triggerImmediateAutoSave);
    canvas.on('object:moving', debounce(triggerImmediateAutoSave, 2000));
    canvas.on('object:scaling', debounce(triggerImmediateAutoSave, 2000));
    canvas.on('object:rotating', debounce(triggerImmediateAutoSave, 2000));
    canvas.on('text:changed', debounce(triggerImmediateAutoSave, 1000));
    
    // Background changes
    canvas.on('after:render', debounce(triggerImmediateAutoSave, 3000));
    
    // Selection changes (less frequent)
    canvas.on('selection:created', debounce(triggerImmediateAutoSave, 5000));
    canvas.on('selection:updated', debounce(triggerImmediateAutoSave, 5000));
    canvas.on('selection:cleared', debounce(triggerImmediateAutoSave, 5000));
}

// Debounce utility function to prevent excessive auto-saves
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Enhanced initialization
function initializeEditor() {
    // Load from localStorage backup if available
    const backupSlides = localStorage.getItem('quiz-autosave-slides');
    if (backupSlides && slides.length === 0) {
        try {
            const parsedSlides = JSON.parse(backupSlides);
            if (parsedSlides && parsedSlides.length > 0) {
                slides = parsedSlides;
                showAutoSaveIndicator('Restored from local backup');
            }
        } catch (error) {
            console.error('Error loading backup slides:', error);
        }
    }
    
    // Create initial slide if none exist
    if (slides.length === 0) {
        slides.push(canvas.toJSON());
    }
    
    loadSlide(0);
    renderSlidePreviews();
    updateSlideIndicator();
    
    // Setup comprehensive auto-save
    setupCanvasAutoSave();
    
    // Periodic auto-save every 30 seconds
    setInterval(() => {
        if (isAutoSaveEnabled) {
            triggerImmediateAutoSave();
        }
    }, autoSaveInterval);
    
    // Auto-save on page unload
    window.addEventListener('beforeunload', (e) => {
        saveCurrentSlide();
        localStorage.setItem('quiz-autosave-slides', JSON.stringify(slides));
        localStorage.setItem('quiz-autosave-timestamp', new Date().toISOString());
    });
}

// Manual save trigger for testing
function forceSave() {
    console.log('Force saving...');
    triggerImmediateAutoSave();
}

// Add keyboard shortcut for manual save (Ctrl+S)
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        forceSave();
        showAutoSaveIndicator('Manual save triggered');
    }
});

// Update the existing DOMContentLoaded event listener
document.addEventListener('DOMContentLoaded', function() {
    initializeEditor();
});


// Fix the modal display issue
document.getElementById('add-game-btn').addEventListener('click', function() {
    console.log('Add game button clicked'); // Debug log
    const modal = document.getElementById('game-modal');
    modal.style.display = 'flex';
    console.log('Modal display set to flex'); // Debug log
});

// Add a close modal function for the cancel button
function closeGameModal() {
    document.getElementById('game-modal').style.display = 'none';
}

// Make sure the cancel button works
document.querySelector('.cancel-button').onclick = closeGameModal;

// Also close modal when clicking outside
document.getElementById('game-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeGameModal();
    }
});

// Enhanced auto-save that includes quiz-specific game data
async function autoSaveCanvas() {
    if (!isAutoSaveEnabled) return;
    
    try {
        const user = firebase.auth().currentUser;
        if (!user) return;
        
        console.log('Auto-saving...'); // Debug log
        
        const teacherUID = user.uid;
        const teacherSnap = await db.ref('teachers/' + teacherUID).once('value');
        const teacher = teacherSnap.val();
        const section = teacher && teacher.section ? teacher.section : null;
        const gradeLevel = teacher && teacher.gradelevel ? teacher.gradelevel : null;
        
        if (!section || !gradeLevel) return;

        let quarter = getParam('quarter') || 'auto';
        let name = getParam('name') || 'AutoSaved_' + new Date().toISOString().slice(0,19).replace(/:/g,'-');
        let subject = getParam('subject') || 'general';

        saveCurrentSlide();
        
        // Process slides with quiz-specific game data for auto-save
        const processedSlides = slides.map(slide => {
            if (slide.game && slide.game.data) {
                return {
                    ...slide,
                    game: {
                        ...slide.game,
                        data: typeof slide.game.data === 'string' ? 
                              slide.game.data : JSON.stringify(slide.game.data),
                        isQuizSpecific: true,
                        autoSaved: true
                    }
                };
            }
            return slide;
        });
        
        const currentCanvasState = JSON.stringify(processedSlides);
        
        if (currentCanvasState === lastCanvasState) return;

        let existingDescription = lastDescription || '';
        
        try {
            const existingQuizSnap = await db.ref('teachers/' + teacherUID + '/sections/' + section + '/quizzes/' + subject + '/' + quarter + '/' + name).once('value');
            if (existingQuizSnap.exists()) {
                const existingQuiz = existingQuizSnap.val();
                existingDescription = existingQuiz.description || lastDescription || '';
            }
        } catch (error) {
            console.log('Could not fetch existing description');
        }
        
        const teacherName = `${teacher.firstname || ''} ${teacher.lastname || ''}`.trim();
        const quizPassword = Math.floor(100000 + Math.random() * 900000).toString();
        const now = new Date().toISOString();

        // Enhanced auto-save data with quiz-specific game information
        const teacherAutoSaveData = {
            slides: currentCanvasState,
            savedAt: now,
            title: name,
            quarter: quarter,
            subject: subject,
            description: existingDescription,
            autoSaved: true,
            section: section,
            gradeLevel: gradeLevel,
            createdBy: teacherUID,
            teacherName: teacherName,
            password: quizPassword,
            isLocked: true,
            hasPassword: true,
            hasCustomGames: processedSlides.some(slide => slide.game && slide.game.data),
            gameCount: processedSlides.filter(slide => slide.game).length,
            customGameCount: processedSlides.filter(slide => slide.game && slide.game.data).length,
            quizId: getQuizId()
        };

        await db.ref('teachers/' + teacherUID + '/sections/' + section + '/quizzes/' + subject + '/' + quarter + '/' + name).set(teacherAutoSaveData);

        // Update students with quiz-specific game data
        const studentsSnap = await db.ref('students').once('value');
        const studentUpdatePromises = [];

        if (studentsSnap.exists()) {
            studentsSnap.forEach(studentSnap => {
                const student = studentSnap.val();
                const studentUID = studentSnap.key;
                
                const studentSection = (student.section || '').toString().trim().toLowerCase();
                const teacherSectionLower = (section || '').toString().trim().toLowerCase();
                const studentGrade = (student.gradelevel || '').toString().trim();
                const teacherGrade = (gradeLevel || '').toString().trim();
                
                if (studentSection === teacherSectionLower && studentGrade === teacherGrade) {
                    const studentAutoSaveData = {
                        title: name,
                        description: existingDescription,
                        quarter: quarter,
                        section: section,
                        gradeLevel: gradeLevel,
                        createdBy: teacherUID,
                        teacherName: teacherName,
                        password: quizPassword,
                        isLocked: true,
                        slides: currentCanvasState, // Include quiz-specific game data
                        assignedBy: teacherUID,
                        assignedAt: now,
                        status: 'available',
                        attempts: 0,
                        bestScore: 0,
                        lastAttemptAt: null,
                        hasCustomGames: teacherAutoSaveData.hasCustomGames,
                        gameCount: teacherAutoSaveData.gameCount,
                        customGameCount: teacherAutoSaveData.customGameCount,
                        quizId: teacherAutoSaveData.quizId
                    };
                    
                    studentUpdatePromises.push(
                        db.ref(`students/${studentUID}/quizzes/${subject}/${quarter}/${name}`).set(studentAutoSaveData)
                    );
                }
            });
        }

        await Promise.all(studentUpdatePromises);
        
        lastCanvasState = currentCanvasState;
        showAutoSaveIndicator('Auto-saved with quiz customizations');
        
    } catch (error) {
        console.error('Auto-save failed:', error);
        showAutoSaveIndicator('Auto-save Failed', true);
    }
}


    
    </script>]

<script>
    // Add this function for auto-save visual feedback
function showAutoSaveIndicator(message, isError = false) {
    // Create or update auto-save indicator
    let indicator = document.getElementById('auto-save-indicator');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'auto-save-indicator';
        indicator.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            transition: all 0.3s ease;
            pointer-events: none;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        `;
        document.body.appendChild(indicator);
    }
    
    indicator.textContent = message;
    indicator.style.background = isError ? '#e74c3c' : 'var(--primary)';
    indicator.style.opacity = '1';
    indicator.style.transform = 'translateY(0) translateX(0)';
    
    // Fade out after 4 seconds
    setTimeout(() => {
        indicator.style.opacity = '0';
        indicator.style.transform = 'translateY(-20px) translateX(10px)';
    }, 4000);
}
</script>

<script>
    // Add this enhanced function to properly handle quiz-specific game data saving
function saveQuizSpecificGameData() {
    // Get the current game iframe if it exists
    const gameIframe = document.getElementById('game-iframe');
    if (!gameIframe || !slides[currentSlide] || !slides[currentSlide].game) {
        return;
    }

    // Request current game data from the iframe
    gameIframe.contentWindow.postMessage({
        type: 'requestCurrentGameData',
        quizId: getQuizId()
    }, '*');
}

// Enhanced message handler to properly capture and save game data
function handleGameMessage(event) {
    console.log('üì® Quiz Editor received message:', event.data);
    
    const data = event.data;
    
    // Handle when game sends updated data (when user edits questions)
    if (data.type === 'saveQuizGameData' || data.type === 'gameDataUpdate') {
        console.log('üíæ SAVING game data from iframe:', data.gameData);
        
        // Update the current slide's game data
        if (slides[currentSlide] && slides[currentSlide].game) {
            // Store the complete game data
            slides[currentSlide].game.data = JSON.stringify(data.gameData);
            slides[currentSlide].game.lastModified = new Date().toISOString();
            slides[currentSlide].game.quizId = getQuizId();
            slides[currentSlide].game.isQuizSpecific = true;
            slides[currentSlide].game.customized = true;
            slides[currentSlide].game.hasEditedQuestions = true;
            
            console.log('‚úÖ Game data saved to canvas slide');
            
            // Force immediate save to ensure data persistence
            saveCurrentSlide();
            triggerImmediateAutoSave();
            showAutoSaveIndicator('üéÆ Game questions updated!');
        }
    }
    
    // Handle when game requests existing data (on load)
    else if (data.type === 'requestQuizGameData') {
        console.log('üîÑ Game requesting existing quiz data');
        
        const iframe = document.getElementById('game-iframe');
        if (iframe && slides[currentSlide] && slides[currentSlide].game && slides[currentSlide].game.data) {
            let gameData = slides[currentSlide].game.data;
            
            // Parse if it's a string
            if (typeof gameData === 'string') {
                try {
                    gameData = JSON.parse(gameData);
                } catch (e) {
                    console.error('Error parsing stored game data:', e);
                    gameData = null;
                }
            }
            
            console.log('üì§ Sending existing game data to iframe:', gameData);
            
            iframe.contentWindow.postMessage({
                type: 'loadQuizGameData',
                gameData: gameData,
                quizId: getQuizId(),
                isEditMode: true
            }, '*');
        } else {
            console.log('‚ùå No existing game data, sending null');
            iframe.contentWindow.postMessage({
                type: 'loadQuizGameData',
                gameData: null,
                quizId: getQuizId(),
                isEditMode: true
            }, '*');
        }
    }
    
    // Handle response when we request current game data
    else if (data.type === 'currentGameData') {
        console.log('üì• Received current game data from iframe:', data.gameData);
        
        if (slides[currentSlide] && slides[currentSlide].game) {
            // Store the current game state
            slides[currentSlide].game.data = JSON.stringify(data.gameData);
            slides[currentSlide].game.lastModified = new Date().toISOString();
            slides[currentSlide].game.customized = true;
            
            console.log('‚úÖ Current game state captured and saved');
            
            saveCurrentSlide();
            triggerImmediateAutoSave();
            showAutoSaveIndicator('üéÆ Current game state saved');
        }
    }
}

// FIXED: Enhanced save function that properly captures and saves game data
document.getElementById('save-btn').onclick = async function() {
    console.log('üíæ SAVE CLICKED - Capturing all game data...');
    
    const saveBtn = this;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '‚è≥ Saving...';
    
    try {
        // STEP 1: If there's an active game, request its current data first
        const gameIframe = document.getElementById('game-iframe');
        if (gameIframe && slides[currentSlide] && slides[currentSlide].game) {
            console.log('üì® Requesting final game state before save...');
            
            // Request current game state and wait for response
            await new Promise((resolve) => {
                let responseReceived = false;
                
                const messageHandler = (event) => {
                    if (!responseReceived && 
                        (event.data.type === 'saveQuizGameData' || 
                         event.data.type === 'currentGameData')) {
                        console.log('‚úÖ Received final game data:', event.data.gameData);
                        
                        // Update the slide with the latest data
                        if (slides[currentSlide] && slides[currentSlide].game) {
                            slides[currentSlide].game.data = JSON.stringify(event.data.gameData);
                            slides[currentSlide].game.lastModified = new Date().toISOString();
                            slides[currentSlide].game.customized = true;
                        }
                        
                        responseReceived = true;
                        window.removeEventListener('message', messageHandler);
                        resolve();
                    }
                };
                
                window.addEventListener('message', messageHandler);
                
                // Request the data
                gameIframe.contentWindow.postMessage({
                    type: 'requestCurrentGameData',
                    quizId: getQuizId(),
                    finalSave: true
                }, '*');
                
                // Timeout after 3 seconds
                setTimeout(() => {
                    if (!responseReceived) {
                        console.log('‚è∞ Timeout waiting for game data, proceeding with save');
                        window.removeEventListener('message', messageHandler);
                        resolve();
                    }
                }, 3000);
            });
        }
        
        // Continue with existing save logic...
        let quarter = getParam('quarter');
        let name = getParam('name');
        let subject = getParam('subject');
        
        if (!name) {
            name = prompt('Enter a Name for this quiz:', 'MyQuiz');
            if (!name) return;
            name = name.trim();
            if (!name) return alert('Name cannot be empty.');
        }
        
        if (!quarter) {
            quarter = prompt('Which quarter? (1, 2, 3, or 4)', '1');
            if (!quarter || !['1','2','3','4'].includes(quarter.trim())) {
                return alert('Invalid quarter.');
            }
            quarter = quarter.trim();
        }
        
        if (!subject) {
            subject = prompt('Enter subject:', 'subject_math');
            if (!subject) return alert('Subject is required.');
            subject = subject.trim();
        }

        let description = prompt('Enter quiz description (optional):', lastDescription || '');
        if (description === null) return;
        description = description.trim();
        lastDescription = description;

        // Save current slide with all captured data
        saveCurrentSlide();
        
        // Process slides ensuring game data is properly serialized
        const processedSlides = slides.map((slide, index) => {
            if (slide.game && slide.game.data) {
                return {
                    ...slide,
                    game: {
                        ...slide.game,
                        data: typeof slide.game.data === 'string' ? slide.game.data : JSON.stringify(slide.game.data),
                        savedAt: new Date().toISOString(),
                        isQuizSpecific: true,
                        customized: true
                    }
                };
            }
            return slide;
        });
        
        const slidesJson = JSON.stringify(processedSlides);

        // Continue with Firebase save
        const user = firebase.auth().currentUser;
        if (!user) {
            alert('Please log in to save quiz.');
            return;
        }

        const teacherUID = user.uid;
        const teacherSnap = await db.ref('teachers/' + teacherUID).once('value');
        const teacher = teacherSnap.val();
        
        if (!teacher || !teacher.section || !teacher.gradelevel) {
            alert('Your section and grade level must be set. Please update your profile.');
            return;
        }
        
        const section = teacher.section;
        const gradeLevel = teacher.gradelevel;
        const teacherName = `${teacher.firstname || ''} ${teacher.lastname || ''}`.trim();
        const quizPassword = Math.floor(100000 + Math.random() * 900000).toString();
        const now = new Date().toISOString();

        const teacherQuizData = {
            slides: slidesJson,
            savedAt: now,
            title: name,
            quarter: quarter,
            description: description,
            subject: subject,
            section: section,
            gradeLevel: gradeLevel,
            createdBy: teacherUID,
            teacherName: teacherName,
            password: quizPassword,
            isLocked: true,
            hasPassword: true,
            hasCustomGames: processedSlides.some(slide => slide.game && slide.game.data),
            gameCount: processedSlides.filter(slide => slide.game).length,
            customGameCount: processedSlides.filter(slide => slide.game && slide.game.data).length,
            quizId: getQuizId()
        };

        // Save to teacher's collection
        await db.ref('teachers/' + teacherUID + '/sections/' + section + '/quizzes/' + subject + '/' + quarter + '/' + name).set(teacherQuizData);

        // Update all students in the same section and grade
        const studentsSnap = await db.ref('students').once('value');
        const studentUpdatePromises = [];
        let studentsUpdated = 0;

        if (studentsSnap.exists()) {
            studentsSnap.forEach(studentSnap => {
                const student = studentSnap.val();
                const studentUID = studentSnap.key;
                
                const studentSection = (student.section || '').toString().trim().toLowerCase();
                const teacherSectionLower = (section || '').toString().trim().toLowerCase();
                const studentGrade = (student.gradelevel || '').toString().trim();
                const teacherGrade = (gradeLevel || '').toString().trim();
                
                if (studentSection === teacherSectionLower && studentGrade === teacherGrade) {
                    studentsUpdated++;
                    
                    const studentQuizData = {
                        ...teacherQuizData,
                        assignedBy: teacherUID,
                        assignedAt: now,
                        status: 'available',
                        attempts: 0,
                        bestScore: 0,
                        lastAttemptAt: null,
                        studentUID: studentUID
                    };
                    
                    studentUpdatePromises.push(
                        db.ref(`students/${studentUID}/quizzes/${subject}/${quarter}/${name}`).set(studentQuizData)
                    );
                }
            });
        }

        await Promise.all(studentUpdatePromises);

        const customGamesCount = teacherQuizData.customGameCount;
        const successMessage = `‚úÖ Quiz saved successfully!\n\n` +
            `üìù Quiz: "${name}"\n` +
            `üîê Password: ${quizPassword}\n` +
            `üéÆ Customized games: ${customGamesCount}\n` +
            `üë• Students updated: ${studentsUpdated}\n\n` +
            `Your edited questions will now appear when students take the quiz!`;
        
        alert(successMessage);
        
    } catch (error) {
        console.error('‚ùå Save error:', error);
        alert('Error saving quiz: ' + error.message);
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fa fa-save"></i> Save';
    }
};

async function autoSaveCanvas() {
    if (!isAutoSaveEnabled) return;
    
    try {
        // Always save current slide first
        saveCurrentSlide();
        
        const user = firebase.auth().currentUser;
        if (!user) {
            // Save to localStorage if not logged in
            localStorage.setItem('quiz-autosave-slides', JSON.stringify(slides));
            localStorage.setItem('quiz-autosave-timestamp', new Date().toISOString());
            showAutoSaveIndicator('Auto-saved locally');
            return;
        }
        
        console.log('Auto-saving to Firebase...'); // Debug log
        
        const teacherUID = user.uid;
        const teacherSnap = await db.ref('teachers/' + teacherUID).once('value');
        const teacher = teacherSnap.val();
        const section = teacher && teacher.section ? teacher.section : null;
        const gradeLevel = teacher && teacher.gradelevel ? teacher.gradelevel : null;
        
        if (!section || !gradeLevel) {
            // Save locally if teacher profile incomplete
            localStorage.setItem('quiz-autosave-slides', JSON.stringify(slides));
            showAutoSaveIndicator('Auto-saved locally (profile incomplete)');
            return;
        }

        let quarter = getParam('quarter') || 'auto';
        let name = getParam('name') || 'AutoSaved_' + new Date().toISOString().slice(0,19).replace(/:/g,'-');
        let subject = getParam('subject') || 'general';

        // Process slides with all content including game data
        const processedSlides = slides.map((slide, index) => {
            const processedSlide = { ...slide };
            
            // Include game data if present
            if (slide.game) {
                processedSlide.game = {
                    ...slide.game,
                    data: typeof slide.game.data === 'string' ? 
                          slide.game.data : JSON.stringify(slide.game.data || null),
                    isQuizSpecific: true,
                    autoSaved: true,
                    lastAutoSave: new Date().toISOString()
                };
            }
            
            return processedSlide;
        });
        
        const currentCanvasState = JSON.stringify(processedSlides);
        
        // Only save if there are actual changes
        if (currentCanvasState === lastCanvasState) {
            console.log('No changes detected, skipping auto-save');
            return;
        }

        let existingDescription = lastDescription || '';
        
        // Try to get existing description
        try {
            const existingQuizSnap = await db.ref('teachers/' + teacherUID + '/sections/' + section + '/quizzes/' + subject + '/' + quarter + '/' + name).once('value');
            if (existingQuizSnap.exists()) {
                const existingQuiz = existingQuizSnap.val();
                existingDescription = existingQuiz.description || lastDescription || '';
            }
        } catch (error) {
            console.log('Could not fetch existing description:', error);
        }
        
        const teacherName = `${teacher.firstname || ''} ${teacher.lastname || ''}`.trim();
        const quizPassword = Math.floor(100000 + Math.random() * 900000).toString();
        const now = new Date().toISOString();

        // Comprehensive auto-save data
        const teacherAutoSaveData = {
            slides: currentCanvasState,
            savedAt: now,
            title: name,
            quarter: quarter,
            subject: subject,
            description: existingDescription,
            autoSaved: true,
            section: section,
            gradeLevel: gradeLevel,
            createdBy: teacherUID,
            teacherName: teacherName,
            password: quizPassword,
            isLocked: true,
            hasPassword: true,
            // Game tracking
            hasCustomGames: processedSlides.some(slide => slide.game && slide.game.data),
            gameCount: processedSlides.filter(slide => slide.game).length,
            customGameCount: processedSlides.filter(slide => slide.game && slide.game.data).length,
            // Canvas content tracking
            totalSlides: processedSlides.length,
            hasContent: processedSlides.some(slide => slide.objects && slide.objects.length > 0),
            lastModified: now,
            quizId: getQuizId(),
            version: '1.0'
        };

        // Save to teacher's collection
        await db.ref('teachers/' + teacherUID + '/sections/' + section + '/quizzes/' + subject + '/' + quarter + '/' + name).set(teacherAutoSaveData);

        // Update students with complete quiz data
        const studentsSnap = await db.ref('students').once('value');
        const studentUpdatePromises = [];
        let studentsUpdated = 0;

        if (studentsSnap.exists()) {
            studentsSnap.forEach(studentSnap => {
                const student = studentSnap.val();
                const studentUID = studentSnap.key;
                
                const studentSection = (student.section || '').toString().trim().toLowerCase();
                const teacherSectionLower = (section || '').toString().trim().toLowerCase();
                const studentGrade = (student.gradelevel || '').toString().trim();
                const teacherGrade = (gradeLevel || '').toString().trim();
                
                if (studentSection === teacherSectionLower && studentGrade === teacherGrade) {
                    studentsUpdated++;
                    
                    const studentAutoSaveData = {
                        title: name,
                        description: existingDescription,
                        quarter: quarter,
                        section: section,
                        gradeLevel: gradeLevel,
                        createdBy: teacherUID,
                        teacherName: teacherName,
                        password: quizPassword,
                        isLocked: true,
                        slides: currentCanvasState, // Complete slide data including games
                        assignedBy: teacherUID,
                        assignedAt: now,
                        status: 'available',
                        attempts: 0,
                        bestScore: 0,
                        lastAttemptAt: null,
                        hasCustomGames: teacherAutoSaveData.hasCustomGames,
                        gameCount: teacherAutoSaveData.gameCount,
                        customGameCount: teacherAutoSaveData.customGameCount,
                        totalSlides: teacherAutoSaveData.totalSlides,
                        quizId: teacherAutoSaveData.quizId,
                        lastUpdated: now
                    };
                    
                    studentUpdatePromises.push(
                        db.ref(`students/${studentUID}/quizzes/${subject}/${quarter}/${name}`).set(studentAutoSaveData)
                    );
                }
            });
        }

        await Promise.all(studentUpdatePromises);
        
        // Update last saved state
        lastCanvasState = currentCanvasState;
        
        // Also save to localStorage as backup
        localStorage.setItem('quiz-autosave-slides', JSON.stringify(processedSlides));
        localStorage.setItem('quiz-autosave-timestamp', now);
        
        const gameInfo = teacherAutoSaveData.customGameCount > 0 ? 
            ` (${teacherAutoSaveData.customGameCount} customized games)` : '';
        
        showAutoSaveIndicator(`Auto-saved: ${studentsUpdated} students updated${gameInfo}`);
        console.log('Auto-save completed successfully');
        
    } catch (error) {
        console.error('Auto-save failed:', error);
        // Fallback to localStorage
        try {
            saveCurrentSlide();
            localStorage.setItem('quiz-autosave-slides', JSON.stringify(slides));
            localStorage.setItem('quiz-autosave-timestamp', new Date().toISOString());
            showAutoSaveIndicator('Auto-saved locally (Firebase error)', true);
        } catch (localError) {
            console.error('Local auto-save also failed:', localError);
            showAutoSaveIndicator('Auto-save Failed', true);
        }
    }
}

</script>


</body>
</html>