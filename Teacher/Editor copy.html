<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lesson Editor | Eduktaktaktika</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        :root {
        --primary: #2e8b57;
        --secondary: #ffd700;
        --accent: #ff69b4;
        --background: #f0f8ff;
        --card-bg: #ffffff;
        --text-main: #22223b;
        --text-light: #9a8c98;
        --shadow: 0 4px 24px rgba(46, 139, 87, 0.08);
        --radius: 18px;
    }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            overflow: hidden;
            background: #f0f1f5;
        }
        body {
            min-height: 100vh;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: var(--background);
    color: var(--text-main);
        }
        .breadcrumbs {
            width: 100vw;
            left: 0;
            top: 0;
            position: relative;
            box-sizing: border-box;
            padding: 5px 24px;
            color: #888;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 18px;
            background: rgb(255, 255, 255);
            z-index: 2;
            margin: 0;
        }
        .right-breadcrumb-btns {
            margin-left: auto;
            margin-right: 20px;
            display: flex;
            gap: 10px;
        }
        .right-breadcrumb-btns button {
            background: #388e3c;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 6px 8px;
            font-weight: 600;
            font-size: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.15s;
        }
        .right-breadcrumb-btns button#present-btn {
            background: #b39ddb;
        }
        .right-breadcrumb-btns button:hover {
            background: #232946;
        }
        .editor-layout {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 64px);
            min-height: 0;
            min-width: 0;
            overflow: hidden;
        }
        .main-area {
            display: flex;
            flex: 1 1 auto;
            min-height: 0;
            min-width: 0;
            overflow: hidden;
        }
        .sidebar {
            min-width: 100px;
            width: 190px;
            max-width: 320px;
            height: 100%;
            overflow-y: auto;
            background: #e5f5ee; border-right: 1px solid #e0e0e0; padding: 24px 12px; display: flex; flex-direction: column; gap: 32px;
            z-index: 1;
        }
        .sidebar h4 { margin: 0 0 18px 0; color:rgb(0, 0, 0); font-size: 12px; }

        .sidebar-label { font-size: 12px; color:rgb(0, 0, 0); margin-bottom: 7px; }
        .sidebar button, .sidebar input[type="file"] {
            display: block; width: 100%; margin-bottom: 7px; padding: 5px 0; border: none; border-radius: 6px; background: #fff; color: #232946; cursor: pointer; font-size: 12px;
            transition: background 0.15s;
        }
        .sidebar button:hover { background: #e3f0ff; }
        .sidebar .shape-btn { font-size: 12px; width: 40px; display: inline-block; margin-right: 6px; }
.editor-content {
    flex: 1 1 auto;
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 24px;
    min-height: 0;
    min-width: 0;
    overflow: hidden;
    background: #f0f1f5;
    box-sizing: border-box;
}

.canvas-area {
    padding: 1vw;
    min-height: 0;
    min-width: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1 1 auto;
    overflow: hidden;
    margin-left: 20px;
    margin-bottom: 30px;
    box-sizing: border-box;
    width: 100%;
    max-width: 100vw;
}
.canvas-wrapper {
    width: 100%;
    max-width: 1280px;
    aspect-ratio: 16/9;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
}

#canvas {
    width: 100%;
    height: 100%;
    max-width: 1280px;
    max-height: 720px;
    display: block;
    aspect-ratio: 16/9;
}
        .rightbar {
            width: 240px;
            min-width: 160px;
            max-width: 320px;
            background: #fff;
            border-left: 1px solid #e0e0e0;
            padding: 16px 8px;
            border-radius: 0 18px 18px 0;
            box-shadow: 0 2px 8px #e0e0e055;
            display: flex;
            flex-direction: column;
            gap: 18px;
            min-height: 0;
            height: 100%;
            overflow-y: auto;
        }
        /* Shrink rightbar/sidebar buttons and controls */
.rightbar button,
.rightbar select,
.rightbar input[type="number"],
.rightbar input[type="color"],
.sidebar button,
.sidebar input[type="file"] {
    font-size: 0.8rem !important;
    padding: 2px 4px !important;
    min-width: 0 !important;
    min-height: 0 !important;
    height: 26px !important;
    border-radius: 4px !important;
    box-sizing: border-box;
}

.rightbar .position-btns button,
.rightbar .text-btns button,
.rightbar .align-btns button,
#layers-list button {
    width: 24px !important;
    height: 24px !important;
    font-size: 0.95em !important;
    padding: 0 !important;
    margin: 1px 0 !important;
    min-width: 0 !important;
    min-height: 0 !important;
}

#layers-list li {
    font-size: 0.9em !important;
    padding: 4px 4px !important;
    gap: 4px !important;
}
        .rightbar label { font-weight: 600; color: #232946; margin-bottom: 6px; display: block; }
        .rightbar .position-btns, .rightbar .layer-btns, .rightbar .text-btns, .rightbar .align-btns {
            display: flex; gap: 6px; margin-bottom: 10px;
        }
        .rightbar button, .rightbar select, .rightbar input[type="number"] {
            border: 1px solid #e0e0e0; border-radius: 5px; background: #f4f8ff; padding: 6px 10px; font-size: 1rem; cursor: pointer;
        }
        .rightbar button.selected, .rightbar button:focus { background: #e3f0ff; }
        .rightbar .color-btn { width: 24px; height: 24px; border-radius: 4px; border: none; background: #388e3c; }
        .undo-redo-bar { display: flex; gap: 12px; margin: 18px 0 0 0; }
        .undo-redo-bar button { background: #fff; border: 1px solid #e0e0e0; border-radius: 6px; padding: 7px 18px; cursor: pointer; font-weight: 600; }
        .undo-redo-bar button:hover { background: #e3f0ff; }
        @media (max-width: 1200px) {
            .sidebar, .rightbar { width: 180px; min-width: 140px; }
        }
        @media (max-width: 900px) {
            .editor-layout { flex-direction: column; height: auto; }
            .sidebar, .rightbar {
                width: 100vw;
                min-width: 0;
                max-width: 100vw;
                position: static;
                height: auto;
            }
            .main-area {
                flex-direction: column;
            }
            .editor-content { flex-direction: column; align-items: stretch; gap: 12px; }
            .canvas-area { max-width: 100vw; }
            .canvas { max-width: 98vw; max-height: 40vw; }
        }
        @media (max-width: 600px) {
            .canvas { max-width: 100vw; max-height: 56vw; }
            .sidebar, .rightbar { padding: 8px 2px; }
        }
        .canvas-gif-overlay {
            pointer-events: none;
            z-index: 50;
            position: absolute;
        }
        canvas {
    outline: none;
}
.upper-canvas {
    outline: none;
}
.fab-canvas .canvas-container .upper-canvas {
    outline: none;
}
/* Change Fabric.js selection border color */
canvas:focus + .upper-canvas {
    outline: none;
}
.fabric-canvas .canvas-container .upper-canvas {
    outline: none;
}
.fabric-canvas .canvas-container .upper-canvas .active {
    outline: none;
}
/* Selection border color */
.canvas-container .upper-canvas {
    outline: none;
}
.fabric-canvas .canvas-container .upper-canvas .active {
    outline: none;
}
/* Shrink and align Text Effects section */
#text-effects-group,
#text-effects-group label,
#text-effects-group .sidebar-label {
    font-size: 0.85rem !important;
    margin-bottom: 4px !important;
}

#text-effects-group label {
    font-weight: 600;
    margin-top: 6px;
    margin-bottom: 2px;
    display: block;
}

#text-effects-group > label,
#text-effects-group > .sidebar-label {
    margin-bottom: 2px !important;
}

#text-effects-group input[type="color"],
#text-effects-group input[type="number"] {
    height: 22px !important;
    width: 22px !important;
    min-width: 22px !important;
    min-height: 22px !important;
    font-size: 0.85rem !important;
    padding: 0 2px !important;
    margin-right: 2px !important;
    box-sizing: border-box;
    vertical-align: middle;
}

#text-effects-group input[type="number"] {
    width: 32px !important;
    min-width: 32px !important;
    text-align: center;
}

#text-effects-group input[type="checkbox"] {
    width: 14px !important;
    height: 14px !important;
    vertical-align: middle;
    margin-right: 4px;
}

#text-effects-group > label,
#text-effects-group > .sidebar-label {
    font-size: 0.9rem !important;
    margin-bottom: 2px !important;
}

#text-effects-group > div,
#text-effects-group > label,
#text-effects-group > .sidebar-label {
    margin-bottom: 2px !important;
}

#text-effects-group .effect-row {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-bottom: 2px;
}

#text-effects-group .effect-row input[type="color"] {
    margin-right: 2px;
}

#text-effects-group .effect-row input[type="number"] {
    margin-right: 6px;
}

@keyframes objectSlideUp { from { opacity:0; transform:translateY(30px);} to { opacity:1; transform:translateY(0);} }
@keyframes objectSlideLeft { from { opacity:0; transform:translateX(30px);} to { opacity:1; transform:translateX(0);} }
@keyframes objectZoomIn { from { opacity:0; transform:scale(0.7);} to { opacity:1; transform:scale(1);} }

.object-anim-fade { animation: objectFadeIn 0.5s; }
.object-anim-slide-up { animation: objectSlideUp 0.5s; }
.object-anim-slide-left { animation: objectSlideLeft 0.5s; }
.object-anim-zoom-in { animation: objectZoomIn 0.5s; }

@keyframes slideLeftIn { from { opacity:0; transform:translateX(60px);} to { opacity:1; transform:translateX(0);} }
@keyframes slideRightIn { from { opacity:0; transform:translateX(-60px);} to { opacity:1; transform:translateX(0);} }
@keyframes slideZoomIn { from { opacity:0; transform:scale(0.7);} to { opacity:1; transform:scale(1);} }

.canvas-slide-fade { animation: slideFadeIn 0.4s; }
.canvas-slide-left { animation: slideLeftIn 0.4s; }
.canvas-slide-right { animation: slideRightIn 0.4s; }
.canvas-slide-zoom { animation: slideZoomIn 0.4s; }

    </style>
</head>
<body>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
    // Add this before your main script logic
    const firebaseConfig = {
        apiKey: "AIzaSyB5BbeLLvPX8l1c4Lq0f-CmIUml4hQOQlE",
        authDomain: "edutaktika.firebaseapp.com",
        databaseURL: "https://edutaktika-default-rtdb.firebaseio.com",
        projectId: "edutaktika",
        storageBucket: "edutaktika.appspot.com",
        messagingSenderId: "676848575316",
        appId: "1:676848575316:web:f78f8c0f83bf3d9dfb5ec1",
        measurementId: "G-X3GT5TNN87"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
</script>



    <div class="breadcrumbs">
        <div style="display:flex;align-items:center;gap:12px;">
            <button id="burger-menu-btn" style="background:none;border:none;padding:0 10px 0 0;cursor:pointer;font-size:15px;color:#232946;outline:none;">
                <i class="fa fa-bars"></i>
            </button>
            <span class="logo" style="font-weight:bold;font-size:15px;">Eduktaktaktika</span>
        </div>
        
        <span class="right-breadcrumb-btns">
            <button id="save-btn"><i class="fa fa-save"></i> Save</button>
            <button id="export-btn"><i class="fa fa-download"></i> Export</button>
            <button id="import-btn"><i class="fa fa-upload"></i> Import</button>
            <button id="present-btn"><i class="fa fa-play"></i> Present</button>
        </span>
        <div id="burger-dropdown" style="display:none;position:absolute;top:54px;left:16px;min-width:160px;background:#fff;border-radius:8px;box-shadow:0 2px 8px #0002;padding:10px 0;z-index:100;">
            <a href="#" id="burger-export" style="display:block;padding:10px 24px;color:#232946;text-decoration:none;"><i class="fa fa-download"></i> Export</a>
            <a href="#" id="burger-import" style="display:block;padding:10px 24px;color:#232946;text-decoration:none;"><i class="fa fa-upload"></i> Import</a>
            <a href="subject_math.html" style="display:block;padding:10px 24px;color:#232946;text-decoration:none;">Home</a>

        </div>
    </div>

    <script>
    // Burger menu Export/Import logic
    document.getElementById('burger-export').onclick = function(e) {
        e.preventDefault();
        document.getElementById('export-btn').click();
        document.getElementById('burger-dropdown').style.display = 'none';
    };
    document.getElementById('burger-import').onclick = function(e) {
        e.preventDefault();
        document.getElementById('import-btn').click();
        document.getElementById('burger-dropdown').style.display = 'none';
    };
    // Burger menu dropdown logic
    const burgerBtn = document.getElementById('burger-menu-btn');
    const burgerDropdown = document.getElementById('burger-dropdown');
    burgerBtn.addEventListener('click', function(e) {
        burgerDropdown.style.display = burgerDropdown.style.display === 'none' || burgerDropdown.style.display === '' ? 'block' : 'none';
        e.stopPropagation();
    });
    document.addEventListener('click', function(e) {
        if (burgerDropdown.style.display === 'block' && !burgerDropdown.contains(e.target) && e.target !== burgerBtn) {
            burgerDropdown.style.display = 'none';
        }
    });
    </script>

    <div class="editor-layout">
        <div class="main-area">
            <aside class="sidebar">

                <div class="sidebar-group"> 
                    <div style="display:flex;align-items:center;justify-content:space-between;">
                        <h4 class="sidebar-label" style="margin-bottom:0;">Template</h4>
                        <p id="see-all-elements-btn" style="font-size:0.95em;cursor:pointer;">See all</p>
                    </div>
                    <div class="elements-library-list" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;"></div>
                    <input type="file" id="element-upload" accept="image/*,.json" style="margin-top:10px; display: none;" />
                    <button id="upload-element-btn"  style="display: none;">Upload Element</button>
                </div>
                <div class="sidebar-group"> 


                    <button id="save-template-btn">Save as Template</button>


    <div style="display:flex;align-items:center;justify-content:space-between;">
        <h4 class="sidebar-label" style="margin-bottom:0;">Template</h4>
        <p id="see-all-elements-btn" style="font-size:0.95em;cursor:pointer;">See all</p>
    </div>
    <div class="elements-library-list" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;"></div>
    <input type="file" id="element-upload" accept="image/*,.json" style="margin-top:10px; display: none;" />
    <button id="upload-element-btn"  style="display: none;">Upload Element</button>
    <!-- Add this line below -->
    <button id="custom-template-btn" style="background:#ffd700;color:#232946;font-weight:bold;">Insert Custom Template</button>
</div>

                <!-- Add this inside your <aside class="sidebar"> -->
                <div class="sidebar-group" style="display: none;">
                    <div class="sidebar-label">GIFs</div>
                    <input type="file" id="gif-upload" accept="image/gif" />
                    <button id="upload-gif-btn">Upload GIF</button>
                </div>
               
                <div class="sidebar-group">
                    <div class="sidebar-label">Text</div>
                    <button class="add-headline">Headline</button>
                    <button class="add-body">Body Text</button>
                </div>
                <div class="sidebar-group">
                    <div class="sidebar-label">Images</div>
                    <button class="upload-img">Upload</button>
                    <button class="img-url" style="display: none;">From URL</button>
                </div>
                <div class="sidebar-group">
                    <div class="sidebar-label">Shapes</div>
                    <button class="shape-btn" data-shape="rect">‚ñ†</button>
                    <button class="shape-btn" data-shape="rounded-rect">‚ñ≠</button>
                    <button class="shape-btn" data-shape="rounded-square">‚¨õ</button>
                    <button class="shape-btn" data-shape="circle">‚óè</button>
                    <button class="shape-btn" data-shape="ellipse">‚¨≠</button>
                    <button class="shape-btn" data-shape="star">‚òÖ</button>
                    <button class="shape-btn" data-shape="triangle">‚ñ≤</button>
                    <button class="shape-btn" data-shape="pentagon">‚¨ü</button>
                    <button class="shape-btn" data-shape="hexagon">‚¨¢</button>
                    <button class="shape-btn" data-shape="line">/</button>
                    <button class="shape-btn" data-shape="arrow">‚ûî</button>
                </div>
                <div class="sidebar-group" style="padding-bottom: 25px;">
                    <div class="sidebar-label">Background</div>
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:7px;">
                        <input type="color" class="bg-color-input" title="Background Color" style="width:28px;height:28px;border:none;background:none;padding:0;">
                        <input type="text" class="bg-color-text" value="#fff" style="width:70px;font-size:1rem;padding:4px 6px;border-radius:4px;border:1px solid #ccc;">
                    </div>
                    <button class="bg-url" style="display: none;">From URL</button>
                </div>
            </aside>
            <div class="editor-content">
                <div class="canvas-area">
                    <div class="canvas-wrapper">
                        <canvas id="canvas"></canvas>
                    </div>
                </div>
                <aside class="rightbar">
                    <label>Position</label>
                    <div class="position-btns">
                        <button title="Align Left"><i class="fa fa-align-left"></i></button>
                        <button title="Align Center"><i class="fa fa-align-center"></i></button>
                        <button title="Align Right"><i class="fa fa-align-right"></i></button>
                        <button title="Align Top"><i class="fa fa-arrow-up"></i></button>
                        <button title="Align Middle"><i class="fa fa-arrows-alt-v"></i></button>
                        <button title="Align Bottom"><i class="fa fa-arrow-down"></i></button>
                    </div>

                    <div class="layer-btns" style="display:none;">
                        <button title="Send Backward"><i class="fa fa-arrow-down"></i></button>
                        <button title="Bring Forward"><i class="fa fa-arrow-up"></i></button>
                        <button title="Delete"><i class="fa fa-trash"></i></button>
                    </div>
                                        <div class="sidebar-group" id="layers-panel-group">
                        <div class="sidebar-label">Layers</div>
                        <ul id="layers-list" style="list-style:none;padding:0;margin:0;max-height:220px;overflow:auto;"></ul>
                    </div>
                    <label>Text</label>
                    <div>
                        <select class="font-family">
                            <option>Inter</option>
                            <option>Arial</option>
                            <option>Times</option>
                        </select>
                        <input type="number" class="font-size" value="36" min="8" max="120" style="width:50px;">
                    </div>
                
                    <div class="text-btns">
                        <button class="bold-btn"><b>B</b></button>
                        <button class="italic-btn"><i>I</i></button>
                        <button class="underline-btn"><u>U</u></button>
                        <input type="color" class="color-input" title="Text Color" style="width:28px; height:28px; border:none; background:none; padding:0; margin-right:4px; display:none;">
                        <input type="color" class="shape-color-input" title="Shape Color" style="width:28px; height:28px; border:none; background:none; padding:0; display:none;">
                    </div>
                    
                    <div class="align-btns">
                        <button class="align-left"><i class="fa fa-align-left"></i></button>
                        <button class="align-center"><i class="fa fa-align-center"></i></button>
                        <button class="align-right"><i class="fa fa-align-right"></i></button>
                        <button class="align-justify"><i class="fa fa-align-justify"></i></button>
                    </div>
                    
                    <div class="sidebar-group" id="text-effects-group">
                        <div class="sidebar-label">Text Effects</div>
                        <label style="margin-top:8px;">Shadow</label>
                        <input type="color" id="text-shadow-color" value="#000000" style="width:28px;">
                        <input type="number" id="text-shadow-blur" value="0" min="0" max="50" style="width:50px;">
                        <input type="color" id="text-stroke-color" value="#000000" style="width:28px;">
                        <input type="number" id="text-stroke-width" value="0" min="0" max="10" style="width:50px;">
                        <!-- Outline effect -->
                        <label style="margin-top:8px;">Outline</label>
                        <input type="color" id="text-outline-color" value="#ff69b4" style="width:28px;">
                        <input type="number" id="text-outline-width" value="0" min="0" max="10" style="width:50px;">

                        <!-- Hallow (Glow) effect -->
                        <label style="margin-top:8px;">Hallow/Glow</label>
                        <input type="color" id="text-hallow-color" value="#ffd700" style="width:28px;">
                        <input type="number" id="text-hallow-blur" value="0" min="0" max="50" style="width:50px;">
                        <input type="color" id="text-bg-color" value="#ffffff" style="width:28px;">
                        <input type="checkbox" id="text-bg-transparent" checked> Transparent
                    </div>

                    <div class="undo-redo-bar" style="margin-bottom:25px;">
                        <button id="undo-btn"><i class="fa fa-undo"></i> Undo</button>
                        <button id="redo-btn"><i class="fa fa-redo"></i> Redo</button>
                    </div>
            </div>
        </div>
    </div>

    <script>


document.getElementById('upload-element-btn').onclick = function() {
    const input = document.getElementById('element-upload');
    const file = input.files[0];
    if (!file) return alert('Choose a file!');
    const reader = new FileReader();
    reader.onload = function(e) {
        // For images, store as dataURL; for JSON, store as is
        let type = file.type.startsWith('image/') ? 'image' : 'json';
        let data = e.target.result;
        if (type === 'json') {
            try { data = JSON.parse(data); } catch { return alert('Invalid JSON'); }
        }
        db.ref('elements').push({
            type,
            data,
            name: file.name,
            uploaded: Date.now()
        }, () => alert('Element uploaded!'));
    };
    reader.readAsDataURL(file);
};

    function showElementsLibrary() {
        const list = document.querySelector('.elements-library-list');
        list.innerHTML = '';
        db.ref('elements').orderByChild('uploaded').limitToLast(3).once('value', snap => {
            snap.forEach(child => {
                const el = child.val();
                const btn = document.createElement('div');
                btn.style = 'width:60px;height:54px;display:flex;align-items:center;justify-content:center;cursor:pointer;';
                if (el.type === 'image') {
                    btn.innerHTML = `<img src="${el.data}" style="max-width:60px;max-height:54px;">`;
                } else if (el.type === 'json') {
                    btn.innerHTML = `<span style="font-size:2rem;">üß©</span>`;
                }
                btn.title = el.name;
                btn.onclick = function() {
                    if (el.type === 'image') {
                        fabric.Image.fromURL(el.data, function(img) {
                            img.set({ left: 100, top: 100, scaleX: 0.5, scaleY: 0.5 });
                            canvas.add(img);
                            canvas.setActiveObject(img);
                            canvas.requestRenderAll();
                        });
                    } else if (el.type === 'json') {
                        fabric.util.enlivenObjects([el.data], function(objects) {
                            if (objects[0]) {
                                objects[0].set({ left: 100, top: 100 });
                                canvas.add(objects[0]);
                                canvas.setActiveObject(objects[0]);
                                canvas.requestRenderAll();
                            }
                        });
                    }
                };
                list.appendChild(btn);
            });
        });
    }
    showElementsLibrary();

    // See All Elements Modal (shows all images from 'elements' node)
    function showAllElementsModal() {
        db.ref('elements').orderByChild('uploaded').once('value', snap => {
            const elements = [];
            snap.forEach(child => {
                const val = child.val();
                // Only include images
                if (val.type === 'image') {
                    elements.push({ key: child.key, ...val });
                }
            });
            elements.reverse(); // Show most recent first
            // Modal HTML
            let modal = document.getElementById('allElementsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'allElementsModal';
                modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:99999;display:flex;align-items:center;justify-content:center;';
                modal.innerHTML = `
                    <div style="background:#fff;padding:32px 28px;border-radius:14px;max-width:600px;width:96vw;max-height:90vh;overflow:auto;box-shadow:0 4px 24px #0002;position:relative;">
                        <h3 style="margin-top:0;margin-bottom:18px;">All Images</h3>
                        <div id="allElementsList" style="display:flex;flex-wrap:wrap;gap:12px;"></div>
                        <button id="closeAllElementsModal" style="position:absolute;top:10px;right:18px;background:#eee;color:#232946;border:none;padding:6px 18px;border-radius:8px;cursor:pointer;">Close</button>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('closeAllElementsModal').onclick = function() {
                    modal.style.display = 'none';
                };
            }
            // Render images in the modal
            const listDiv = modal.querySelector('#allElementsList');
            listDiv.innerHTML = '';
            elements.forEach(el => {
                const btn = document.createElement('div');
                btn.style = 'width:60px;height:54px;display:flex;align-items:center;justify-content:center;cursor:pointer;';
                btn.innerHTML = `<img src="${el.data}" style="max-width:60px;max-height:54px;">`;
                btn.title = el.name;
                btn.onclick = function() {
                    fabric.Image.fromURL(el.data, function(img) {
                        img.set({ left: 100, top: 100, scaleX: 0.5, scaleY: 0.5 });
                        canvas.add(img);
                        canvas.setActiveObject(img);
                        canvas.requestRenderAll();
                    });
                    modal.style.display = 'none';
                };
                listDiv.appendChild(btn);
            });
            modal.style.display = 'flex';
        });
    }
    document.getElementById('see-all-elements-btn').onclick = showAllElementsModal;
    
</script>
    
    <script>
   
// Helper to get URL parameters
function getParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
}


// Initialize Fabric.js canvas
const canvas = new fabric.Canvas('canvas', {
    backgroundColor: '#fff',
    width: 1280,
    height: 720
});

function addDraggableGifOverlay(gifUrl, left = 100, top = 100, width = 200, height = 200) {
    const wrapper = document.querySelector('.canvas-wrapper');
    const img = document.createElement('img');
    img.src = gifUrl;
    img.className = 'canvas-gif-overlay';
    img.style.position = 'absolute';
    img.style.left = left + 'px';
    img.style.top = top + 'px';
    img.style.width = width + 'px';
    img.style.height = height + 'px';
    img.style.zIndex = 50;
    img.style.cursor = 'move';
    img.style.pointerEvents = 'auto';

    // Drag logic
    let dragging = false, offsetX = 0, offsetY = 0;
    img.addEventListener('mousedown', function(e) {
        dragging = true;
        offsetX = e.clientX - img.offsetLeft;
        offsetY = e.clientY - img.offsetTop;
        img.style.opacity = '0.7';
        e.preventDefault();
    });
    document.addEventListener('mousemove', function(e) {
        if (dragging) {
            img.style.left = (e.clientX - offsetX) + 'px';
            img.style.top = (e.clientY - offsetY) + 'px';
        }
    });
    document.addEventListener('mouseup', function() {
        if (dragging) {
            dragging = false;
            img.style.opacity = '1';
        }
    });

    // Simple resize handle (bottom-right corner)
    const handle = document.createElement('div');
    handle.style.position = 'absolute';
    handle.style.right = '0';
    handle.style.bottom = '0';
    handle.style.width = '16px';
    handle.style.height = '16px';
    handle.style.background = '#b39ddb';
    handle.style.cursor = 'nwse-resize';
    handle.style.zIndex = '51';
    img.appendChild(handle);

    let resizing = false, startX = 0, startY = 0, startW = 0, startH = 0;
    handle.addEventListener('mousedown', function(e) {
        resizing = true;
        startX = e.clientX;
        startY = e.clientY;
        startW = img.offsetWidth;
        startH = img.offsetHeight;
        e.stopPropagation();
        e.preventDefault();
    });
    document.addEventListener('mousemove', function(e) {
        if (resizing) {
            img.style.width = (startW + (e.clientX - startX)) + 'px';
            img.style.height = (startH + (e.clientY - startY)) + 'px';
        }
    });
    document.addEventListener('mouseup', function() {
        if (resizing) {
            resizing = false;
        }
    });

    wrapper.appendChild(img);
}

function overlayGifsOnCanvas() {
    document.querySelectorAll('.canvas-gif-overlay').forEach(el => el.remove());
    const wrapper = document.querySelector('.canvas-wrapper');
    if (!wrapper) return;

    canvas.getObjects().forEach(obj => {
        if (
            obj.type === 'image' &&
            obj._element &&
            obj._element.src &&
            (obj._element.src.includes('.gif') || obj._element.src.startsWith('data:image/gif'))
        ) {
            const rect = obj.getBoundingRect();
            const left = rect.left;
            const top = rect.top;
            const width = rect.width;
            const height = rect.height;

            // Make static image transparent but interactive
            obj.opacity = 0;
            // obj.visible = false; // REMOVE THIS LINE

            // Add animated overlay
            const img = document.createElement('img');
            img.src = obj._element.src;
            img.className = 'canvas-gif-overlay';
            img.style.position = 'absolute';
            img.style.left = left + 'px';
            img.style.top = top + 'px';
            img.style.width = width + 'px';
            img.style.height = height + 'px';
            img.style.pointerEvents = 'none';
            img.style.zIndex = 50;
            wrapper.appendChild(img);

            canvas.requestRenderAll();
        }
    });
}
canvas.on('object:added', overlayGifsOnCanvas);
canvas.on('object:modified', overlayGifsOnCanvas);
canvas.on('object:removed', overlayGifsOnCanvas);
canvas.on('after:render', overlayGifsOnCanvas);




// Layer Logic
function updateLayersPanel() {
    const list = document.getElementById('layers-list');
    if (!list) return;
    list.innerHTML = '';
    // Get all objects in reverse order (top-most first)
    const objects = canvas.getObjects().slice().reverse();
    objects.forEach((obj, idx) => {
        const li = document.createElement('li');
        li.style = 'padding:6px 8px;cursor:pointer;display:flex;align-items:center;gap:8px;border-bottom:1px solid #eee;font-size:1em;';
        // Show a simple icon for type
        let icon = '';
        if (obj.type === 'i-text') icon = 'üÖ£';
        else if (obj.type === 'image') icon = obj._element && obj._element.src && obj._element.src.endsWith('.gif') ? 'üñºÔ∏è (GIF)' : 'üñºÔ∏è';
        else if (obj.type === 'rect') icon = '‚ñ≠';
        else if (obj.type === 'circle') icon = '‚óØ';
        else if (obj.type === 'polygon') icon = '‚¨ü';
        else if (obj.type === 'triangle') icon = '‚ñ≤';
        else if (obj.type === 'ellipse') icon = '‚¨≠';
        else if (obj.type === 'line') icon = 'Ôºè';
        else icon = 'üî≤';

        li.innerHTML = `<span>${icon}</span> <span style="flex:1;">${obj.type.charAt(0).toUpperCase() + obj.type.slice(1)}</span>`;

        // Highlight if selected
        if (canvas.getActiveObject() === obj) {
            li.style.background = '#e3f0ff';
            li.style.fontWeight = 'bold';
        }

        // Click to select
        li.onclick = () => {
            canvas.setActiveObject(obj);
            canvas.requestRenderAll();
            updateLayersPanel();
        };

        // Add delete button
        const delBtn = document.createElement('button');
        delBtn.textContent = 'üóëÔ∏è';
        delBtn.style = 'margin-left:8px;border:none;background:none;cursor:pointer;font-size:1em;';
        delBtn.onclick = (e) => {
            e.stopPropagation();
            canvas.remove(obj);
            updateLayersPanel();
        };
        li.appendChild(delBtn);

        // Move up/down buttons
        const upBtn = document.createElement('button');
        upBtn.textContent = '‚Üë';
        upBtn.style = 'margin-left:4px;border:none;background:none;cursor:pointer;font-size:1em;';
        upBtn.onclick = (e) => {
            e.stopPropagation();
            canvas.bringForward(obj);
            updateLayersPanel();
        };
        li.appendChild(upBtn);

        const downBtn = document.createElement('button');
        downBtn.textContent = '‚Üì';
        downBtn.style = 'margin-left:2px;border:none;background:none;cursor:pointer;font-size:1em;';
        downBtn.onclick = (e) => {
            e.stopPropagation();
            canvas.sendBackwards(obj);
            updateLayersPanel();
        };
        li.appendChild(downBtn);

        list.appendChild(li);
    });
}

// Update panel on canvas changes
canvas.on('object:added', updateLayersPanel);
canvas.on('object:removed', updateLayersPanel);
canvas.on('object:modified', updateLayersPanel);
canvas.on('selection:created', updateLayersPanel);
canvas.on('selection:updated', updateLayersPanel);
canvas.on('selection:cleared', updateLayersPanel);

// Initial call
updateLayersPanel();


document.addEventListener('mousedown', function(e) {
    const canvasWrapper = document.querySelector('.canvas-wrapper');
    const rightbar = document.querySelector('.rightbar');
    // Only unselect if click is outside both the canvas and the rightbar
    if (
        !canvasWrapper.contains(e.target) &&
        !(rightbar && rightbar.contains(e.target))
    ) {
        if (canvas.getActiveObject()) {
            canvas.discardActiveObject();
            canvas.requestRenderAll();
            updateLayersPanel && updateLayersPanel();
        }
    }
});


canvas.on('selection:created', updateFontSizeInput);
canvas.on('selection:updated', updateFontSizeInput);

function updateFontSizeInput() {
    const obj = canvas.getActiveObject();
    const fontSizeInput = document.querySelector('.font-size');
    if (obj && obj.type === 'i-text' && fontSizeInput) {
        // Get canvas zoom (from scale slider)
        const zoom = parseFloat(document.getElementById('canvas-scale').value) || 1;
        // Show the "visual" font size (fontSize * scaleY * zoom)
        const visualFontSize = Math.round(obj.fontSize * obj.scaleY * zoom);
        fontSizeInput.value = visualFontSize;
        fontSizeInput.title = `Actual: ${obj.fontSize} √ó scaleY: ${obj.scaleY} √ó zoom: ${zoom}`;
    }
}

        // Responsive canvas
        function resizeCanvas() {
            const wrapper = document.querySelector('.canvas-wrapper');
            const rect = wrapper.getBoundingClientRect();
            canvas.setWidth(rect.width);
            canvas.setHeight(rect.height);
            canvas.calcOffset && canvas.calcOffset();
            canvas.renderAll();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        // Add text
        function addText(type) {
            const fontSizeInput = document.querySelector('.font-size');
            let fontSize = type === 'headline' ? 36 : 24;
            if (fontSizeInput && fontSizeInput.value) {
                fontSize = parseInt(fontSizeInput.value);
            }
            const text = new fabric.IText(type === 'headline' ? 'Headline' : 'Body Text', {
                left: 100,
                top: 100,
                fontSize: fontSize,
                fill: '#232946',
                fontWeight: type === 'headline' ? 'bold' : 'normal',
                underline: false,
                scaleX: 1,
                scaleY: 1
            });
            canvas.add(text).setActiveObject(text);
        }
        // Add shape
        function addShape(shape) {
            let obj;
            switch(shape) {
                case 'rect':
                    obj = new fabric.Rect({ left: 150, top: 150, width: 120, height: 80, fill: '#b39ddb', rx: 0, ry: 0 });
                    break;
                case 'rounded-rect':
                    obj = new fabric.Rect({ left: 180, top: 180, width: 140, height: 80, fill: '#b39ddb', rx: 20, ry: 20 });
                    break;
                case 'rounded-square':
                    obj = new fabric.Rect({ left: 210, top: 210, width: 90, height: 90, fill: '#b39ddb', rx: 20, ry: 20 });
                    break;
                case 'circle':
                    obj = new fabric.Circle({ left: 200, top: 200, radius: 50, fill: '#b39ddb' });
                    break;
                case 'ellipse':
                    obj = new fabric.Ellipse({ left: 220, top: 220, rx: 60, ry: 40, fill: '#b39ddb' });
                    break;
                case 'star':
                    obj = new fabric.Polygon([
                        {x:50,y:0},{x:61,y:35},{x:98,y:35},{x:68,y:57},{x:79,y:91},{x:50,y:70},{x:21,y:91},{x:32,y:57},{x:2,y:35},{x:39,y:35}
                    ], { left: 250, top: 200, fill: '#b39ddb', scaleX:0.7, scaleY:0.7 });
                    break;
                case 'triangle':
                    obj = new fabric.Triangle({ left: 300, top: 200, width: 100, height: 100, fill: '#b39ddb' });
                    break;
                case 'pentagon':
                    obj = new fabric.Polygon([
                        {x:50,y:0},{x:98,y:36},{x:79,y:91},{x:21,y:91},{x:2,y:36}
                    ], { left: 350, top: 200, fill: '#b39ddb', scaleX:1, scaleY:1 });
                    break;
                case 'hexagon':
                    obj = new fabric.Polygon([
                        {x:50,y:0},{x:98,y:25},{x:98,y:75},{x:50,y:100},{x:2,y:75},{x:2,y:25}
                    ], { left: 400, top: 200, fill: '#b39ddb', scaleX:1, scaleY:1 });
                    break;
                case 'line':
                    obj = new fabric.Line([100, 100, 250, 100], { left: 100, top: 100, stroke: '#b39ddb', strokeWidth: 5 });
                    break;
                case 'arrow':
                    // Arrow as a line with a triangle head
                    const line = new fabric.Line([100, 100, 220, 100], { stroke: '#b39ddb', strokeWidth: 5, selectable: false });
                    const arrowHead = new fabric.Triangle({ left: 220, top: 95, width: 20, height: 20, angle: 90, fill: '#b39ddb', selectable: false });
                    obj = new fabric.Group([line, arrowHead], { left: 100, top: 100 });
                    break;
            }
            if(obj) canvas.add(obj).setActiveObject(obj);
        }
        // Add image
        function addImage(url) {
            fabric.Image.fromURL(url, function(img) {
                img.set({ left: 100, top: 100, scaleX: 0.5, scaleY: 0.5 }); 
                canvas.add(img).setActiveObject(img);
            });
        }
        // Upload image
        document.querySelector('.upload-img').onclick = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    addImage(e.target.result);
                };
                reader.readAsDataURL(file);
            };
            input.click();
        };
        // Image from URL
        document.querySelector('.img-url').onclick = function() {
            const url = prompt('Enter image URL:');
            if (url) addImage(url);
        };
        // Add text events
        document.querySelector('.add-headline').onclick = () => addText('headline');
        document.querySelector('.add-body').onclick = () => addText('body');
        // Add shape events
        document.querySelectorAll('.shape-btn').forEach(btn => {
            btn.onclick = () => addShape(btn.dataset.shape);
        });
        // Background color controls
        const bgColorInput = document.querySelector('.bg-color-input');
        const bgColorText = document.querySelector('.bg-color-text');
        // Sync color input and text
        function setBgColor(color) {
            canvas.setBackgroundColor(color, canvas.renderAll.bind(canvas));
            // Try to get the hex value for the color
            let hex = color;
            try {
                hex = fabric.Color.fromSource(fabric.Color.sourceFromHex(color)).toHex();
            } catch (e) {
                // fallback: try to use the color as is
                hex = color;
            }
            bgColorInput.value = hex;
            bgColorText.value = color;
            // Also update the color picker background to match
            bgColorInput.style.background = hex;
        }
        bgColorInput.addEventListener('input', function() {
            setBgColor(this.value);
        });
        bgColorText.addEventListener('change', function() {
            setBgColor(this.value);
        });
        // Keep color input in sync with background changes (e.g. on import)
        function syncBgColorInputs() {
            let color = canvas.backgroundColor || '#fff';
            let hex = color;
            try {
                hex = fabric.Color.fromSource(fabric.Color.sourceFromHex(color)).toHex();
            } catch (e) {
                hex = color;
            }
            bgColorInput.value = hex;
            bgColorText.value = color;
            // Also update the color picker background to match
            bgColorInput.style.background = hex;
        }
        // Initialize with current background color
        syncBgColorInputs();
        // Also update on background change (e.g. after import)
        canvas.on('background:changed', syncBgColorInputs);
        // Patch Fabric.js setBackgroundColor to fire event
        const origSetBackgroundColor = canvas.setBackgroundColor;
        canvas.setBackgroundColor = function(color, callback) {
            origSetBackgroundColor.call(this, color, callback);
            this.fire('background:changed');
        };
        // Background from URL
        document.querySelector('.bg-url').onclick = function() {
            const url = prompt('Enter background image URL:');
            if (url) {
                fabric.Image.fromURL(url, function(img) {
                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                        scaleX: canvas.width / img.width,
                        scaleY: canvas.height / img.height
                    });
                });
            }
        };
        // Position controls
        document.querySelector('.position-btns').onclick = function(e) {
            const btn = e.target.closest('button');
            if (!btn) return;
            const obj = canvas.getActiveObject();
            if (!obj) return;
            switch(btn.title) {
                case 'Align Left': obj.set({ left: 0 }); break;
                case 'Align Center': obj.set({ left: (canvas.width - obj.getScaledWidth())/2 }); break;
                case 'Align Right': obj.set({ left: canvas.width - obj.getScaledWidth() }); break;
                case 'Align Top': obj.set({ top: 0 }); break;
                case 'Align Middle': obj.set({ top: (canvas.height - obj.getScaledHeight())/2 }); break;
                case 'Align Bottom': obj.set({ top: canvas.height - obj.getScaledHeight() }); break;
            }
            canvas.renderAll();
        };
        // Layer controls
        document.querySelector('.layer-btns').onclick = function(e) {
            const btn = e.target.closest('button');
            if (!btn) return;
            const activeObjects = canvas.getActiveObjects();
            if (!activeObjects || activeObjects.length === 0) return;
            switch(btn.title) {
                case 'Bring Forward':
                    // Only bring forward the top-most selected object
                    canvas.bringForward(activeObjects[activeObjects.length - 1]);
                    break;
                case 'Send Backward':
                    // Only send backward the bottom-most selected object
                    canvas.sendBackwards(activeObjects[0]);
                    break;
                case 'Delete':
                    // Remove all selected objects
                    activeObjects.forEach(obj => canvas.remove(obj));
                    break;
            }
            // Keep the object selected after layer change (if not deleted)
            canvas.discardActiveObject();
            // If objects remain, reselect the first one
            const remaining = canvas.getObjects().filter(obj => activeObjects.includes(obj));
            if (remaining.length > 0) {
                canvas.setActiveObject(remaining[0]);
            }
            canvas.renderAll();
        };
        // Text controls
        document.querySelector('.font-family').onchange = function() {
            const obj = canvas.getActiveObject();
            if (obj && obj.type === 'i-text') {
                obj.set({ fontFamily: this.value });
                canvas.renderAll();
            }
        };
        document.querySelector('.font-size').onchange = function() {
            const obj = canvas.getActiveObject();
            if (obj && obj.type === 'i-text') {
                obj.set({ fontSize: parseInt(this.value), scaleY: 1 });
                canvas.renderAll();
            }
        };
        document.querySelector('.bold-btn').onclick = function() {
            const obj = canvas.getActiveObject();
            if (obj && obj.type === 'i-text') {
                obj.set({ fontWeight: obj.fontWeight === 'bold' ? 'normal' : 'bold' });
                canvas.renderAll();
            }
        };
        document.querySelector('.italic-btn').onclick = function() {
            const obj = canvas.getActiveObject();
            if (obj && obj.type === 'i-text') {
                obj.set({ fontStyle: obj.fontStyle === 'italic' ? 'normal' : 'italic' });
                canvas.renderAll();
            }
        };
        document.querySelector('.underline-btn').onclick = function() {
            const obj = canvas.getActiveObject();
            if (obj && obj.type === 'i-text') {
                obj.set({ underline: !obj.underline });
                canvas.renderAll();
            }
        };
        const colorInput = document.querySelector('.color-input');
        const shapeColorInput = document.querySelector('.shape-color-input');

        // Show/hide color pickers based on selection
        function updateColorPickers() {
            const active = canvas.getActiveObject();
            const activeGroup = canvas.getActiveObjects && canvas.getActiveObjects();
            colorInput.style.display = 'none';
            shapeColorInput.style.display = 'none';
            // Multi-selection
            if (activeGroup && activeGroup.length > 1) {
                // If all selected are text, show text color picker; if all are shapes, show shape color picker; if mixed, show both
                let allText = activeGroup.every(obj => obj.type === 'i-text');
                let allShapes = activeGroup.every(obj => ['rect','circle','polygon','triangle','ellipse'].includes(obj.type));
                let allLines = activeGroup.every(obj => obj.type === 'line');
                let allArrows = activeGroup.every(obj => obj.type === 'group' && obj._objects && obj._objects.length === 2 && obj._objects[0].type === 'line' && obj._objects[1].type === 'triangle');
                if (allText) {
                    colorInput.style.display = '';
                    let hex = activeGroup[0].fill ? fabric.Color.fromSource(fabric.Color.sourceFromHex(activeGroup[0].fill)).toHex() : '#232946';
                    colorInput.value = hex;
                    colorInput.style.background = hex;
                } else if (allShapes) {
                    shapeColorInput.style.display = '';
                    let hex = activeGroup[0].fill ? fabric.Color.fromSource(fabric.Color.sourceFromHex(activeGroup[0].fill)).toHex() : '#b39ddb';
                    shapeColorInput.value = hex;
                    shapeColorInput.style.background = hex;
                } else if (allLines || allArrows) {
                    shapeColorInput.style.display = '';
                    let hex = allLines ? (activeGroup[0].stroke || '#b39ddb') : (activeGroup[0]._objects[0].stroke || '#b39ddb');
                    try { hex = fabric.Color.fromSource(fabric.Color.sourceFromHex(hex)).toHex(); } catch(e){}
                    shapeColorInput.value = hex;
                    shapeColorInput.style.background = hex;
                } else {
                    // Mixed selection: show shape color picker
                    shapeColorInput.style.display = '';
                    shapeColorInput.value = '#b39ddb';
                    shapeColorInput.style.background = '#b39ddb';
                }
                return;
            }
            if (active) {
                if (active.type === 'i-text') {
                    colorInput.style.display = '';
                    let hex = active.fill ? fabric.Color.fromSource(fabric.Color.sourceFromHex(active.fill)).toHex() : '#232946';
                    colorInput.value = hex;
                    colorInput.style.background = hex;
                } else if (['rect','circle','polygon','triangle','ellipse'].includes(active.type)) {
                    shapeColorInput.style.display = '';
                    let hex = active.fill ? fabric.Color.fromSource(fabric.Color.sourceFromHex(active.fill)).toHex() : '#b39ddb';
                    shapeColorInput.value = hex;
                    shapeColorInput.style.background = hex;
                } else if (active.type === 'line') {
                    shapeColorInput.style.display = '';
                    let hex = active.stroke || '#b39ddb';
                    try { hex = fabric.Color.fromSource(fabric.Color.sourceFromHex(hex)).toHex(); } catch(e){}
                    shapeColorInput.value = hex;
                    shapeColorInput.style.background = hex;
                } else if (active.type === 'group' && active._objects && active._objects.length === 2 && active._objects[0].type === 'line' && active._objects[1].type === 'triangle') {
                    // Arrow group
                    shapeColorInput.style.display = '';
                    let hex = active._objects[0].stroke || '#b39ddb';
                    try { hex = fabric.Color.fromSource(fabric.Color.sourceFromHex(hex)).toHex(); } catch(e){}
                    shapeColorInput.value = hex;
                    shapeColorInput.style.background = hex;
                } else if (active.type === 'group') {
                    // Generic group: use fill or stroke of first child
                    shapeColorInput.style.display = '';
                    const first = active._objects && active._objects[0];
                    let hex = '#b39ddb';
                    if (first && first.fill) {
                        hex = fabric.Color.fromSource(fabric.Color.sourceFromHex(first.fill)).toHex();
                    } else if (first && first.stroke) {
                        hex = fabric.Color.fromSource(fabric.Color.sourceFromHex(first.stroke)).toHex();
                    }
                    shapeColorInput.value = hex;
                    shapeColorInput.style.background = hex;
                }
            }
        }
        canvas.on('selection:created', updateColorPickers);
        canvas.on('selection:updated', updateColorPickers);
        canvas.on('selection:cleared', updateColorPickers);
        // Also update on object modified (color change)
        canvas.on('object:modified', updateColorPickers);

        // Text color (color input)
        colorInput.addEventListener('input', function() {
            const obj = canvas.getActiveObject();
            if (obj && obj.type === 'i-text') {
                obj.set({ fill: this.value });
                canvas.renderAll();
                // Update color swatch
                colorInput.style.background = this.value;
            }
        });
        // Shape color (color input)
        shapeColorInput.addEventListener('input', function() {
            const activeGroup = canvas.getActiveObjects && canvas.getActiveObjects();
            if (activeGroup && activeGroup.length > 1) {
                activeGroup.forEach(obj => {
                    if (['rect','circle','polygon','triangle','ellipse'].includes(obj.type)) {
                        obj.set({ fill: this.value });
                    } else if (obj.type === 'line') {
                        obj.set({ stroke: this.value });
                    } else if (obj.type === 'group' && obj._objects && obj._objects.length === 2 && obj._objects[0].type === 'line' && obj._objects[1].type === 'triangle') {
                        obj._objects[0].set({ stroke: this.value });
                        obj._objects[1].set({ fill: this.value });
                    }
                });
                canvas.renderAll();
                shapeColorInput.style.background = this.value;
                return;
            }
            const obj = canvas.getActiveObject();
            if (obj) {
                if (['rect','circle','polygon','triangle','ellipse'].includes(obj.type)) {
                    obj.set({ fill: this.value });
                } else if (obj.type === 'line') {
                    obj.set({ stroke: this.value });
                } else if (obj.type === 'group' && obj._objects && obj._objects.length === 2 && obj._objects[0].type === 'line' && obj._objects[1].type === 'triangle') {
                    obj._objects[0].set({ stroke: this.value });
                    obj._objects[1].set({ fill: this.value });
                } else if (obj.type === 'group' && obj._objects) {
                    obj._objects.forEach(child => {
                        if ('fill' in child) child.set({ fill: this.value });
                        if ('stroke' in child && child.type === 'line') child.set({ stroke: this.value });
                    });
                }
                canvas.renderAll();
                shapeColorInput.style.background = this.value;
            }
        });
        // Initialize color pickers on load
        updateColorPickers();
        // Text align
        document.querySelector('.align-btns').onclick = function(e) {
            const btn = e.target.closest('button');
            if (!btn) return;
            const obj = canvas.getActiveObject();
            if (obj && obj.type === 'i-text') {
                if (btn.classList.contains('align-left')) obj.set({ textAlign: 'left' });
                if (btn.classList.contains('align-center')) obj.set({ textAlign: 'center' });
                if (btn.classList.contains('align-right')) obj.set({ textAlign: 'right' });
                if (btn.classList.contains('align-justify')) obj.set({ textAlign: 'justify' });
                canvas.renderAll();
                // Visually indicate selected align button
                document.querySelectorAll('.align-btns button').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
            }
        };
        // Undo/Redo
        let state = [], mods = 0;
        function saveState() {
            mods = 0;
            state.push(JSON.stringify(canvas));
        }
        canvas.on('object:added', saveState);
        canvas.on('object:modified', saveState);
        canvas.on('object:removed', saveState);
        document.getElementById('undo-btn').onclick = function() {
            if (state.length > 1) {
                state.pop();
                canvas.loadFromJSON(state[state.length-1], canvas.renderAll.bind(canvas));
            }
        };
        document.getElementById('redo-btn').onclick = function() {
            // redo next time
            alert('Redo not implemented.');
        };
        // Copy/Paste
        let clipboard = null;
        document.addEventListener('keydown', function(e) {
            // Ctrl+C or Cmd+C
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'c') {
                const activeGroup = canvas.getActiveObjects && canvas.getActiveObjects();
                if (activeGroup && activeGroup.length > 1) {
                    // Multi-selection: create an activeSelection and clone it
                    const sel = new fabric.ActiveSelection(activeGroup, { canvas: canvas });
                    sel.clone(function(cloned) {
                        clipboard = cloned;
                    });
                } else {
                    const active = canvas.getActiveObject();
                    if (active) {
                        active.clone(function(cloned) {
                            clipboard = cloned;
                        });
                    }
                }
            }
            // Ctrl+V or Cmd+V
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'v') {
                if (clipboard) {
                    clipboard.clone(function(clonedObj) {
                        canvas.discardActiveObject();
                        clonedObj.set({ left: (clonedObj.left || 0) + 30, top: (clonedObj.top || 0) + 30, evented: true });
                        if (clonedObj.type === 'activeSelection') {
                            // activeSelection needs to be ungrouped and added
                            clonedObj.canvas = canvas;
                            clonedObj.forEachObject(function(obj) {
                                canvas.add(obj);
                            });
                            clonedObj.setCoords();
                        } else {
                            canvas.add(clonedObj);
                        }
                        canvas.setActiveObject(clonedObj);
                        canvas.requestRenderAll();
                    });
                }
            }
        });
        
        
        // Save
// ...existing code...

// Store the last description globally
let lastDescription = "";

// Save button logic
document.getElementById('save-btn').onclick = async function() {
    saveCurrentSlide();
    let quarter = getParam('quarter');
    let name = getParam('name');
    let subject = getParam('subject');
    if (!name) {
        name = prompt('Enter a Name for this presentation:', 'MyPresentation');
        if (!name) return;
        name = name.trim();
        if (!name) return alert('Name cannot be empty.');
    }
    if (!quarter) {
        quarter = prompt('Which quarter do you want to save this in? (1, 2, 3, or 4)', '1');
        if (!quarter || !['1','2','3','4'].includes(quarter.trim())) return alert('Invalid quarter.');
        quarter = quarter.trim();
    }
    if (!subject) {
        subject = prompt('Enter subject (e.g. subject_math, subject_english, subject_science):', 'subject_math');
        if (!subject) return alert('Subject is required.');
        subject = subject.trim();
    }
    // Pre-fill prompt with lastDescription
    let description = prompt('Enter a description for this presentation (optional):', lastDescription);
    if (description !== null) description = description.trim();
    if (description) lastDescription = description; // Update global

    // Save all slides
    const slidesJson = JSON.stringify(slides);

    // Save to section-specific path for student access
    const user = firebase.auth().currentUser;
    if (user) {
        const teacherUID = user.uid;
        const teacherSnap = await db.ref('teachers/' + teacherUID).once('value');
        const teacher = teacherSnap.val();
        if (teacher && teacher.section) {
            const section = teacher.section;
            db.ref('teachers/' + teacherUID + '/sections/' + section + '/lessons/' + subject + '/quarter-' + quarter + '/' + name).set({
                slides: slidesJson,
                savedAt: new Date().toISOString(),
                title: name,
                quarter: quarter,
                description: lastDescription // Always use lastDescription
            }, function(error) {
                if (error) {
                    alert('Error saving to Firebase: ' + error.message);
                } else {
                    alert('Presentation saved as "' + name + '" in Quarter ' + quarter + '!');
                }
            });
        }
    }


};




        // Present
        document.getElementById('present-btn').onclick = function() {
            window.open('present.html', '_blank');
        };
        // Export as JSON file
        document.getElementById('export-btn').onclick = function() {
            const json = JSON.stringify(canvas.toJSON(['selectable', 'evented', 'editable', 'lockMovementX', 'lockMovementY', 'lockScalingX', 'lockScalingY', 'lockRotation', 'hasControls', 'hasBorders', 'clipPath', 'data']));
            const blob = new Blob([json], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (prompt('Enter filename for export:', 'presentation') || 'presentation') + '.json';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
        };

        // Import from JSON file
        document.getElementById('import-btn').onclick = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,application/json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    try {
                        const json = evt.target.result;
                        canvas.loadFromJSON(json, function() {
                            canvas.renderAll();
                            alert('Presentation loaded! You can now save it.');
                        });
                    } catch (err) {
                        alert('Invalid JSON file.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };
    </script>

<script>

    // Initialize with one slide
    function initSlides() {
        if (slides.length === 0) {
            slides.push(canvas.toJSON());
            currentSlide = 0;
            loadSlide(currentSlide); // <-- ensure canvas is synced
        }
        updateSlideIndicator();
    }

// Helper to get URL parameters
function getParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
}

const subject = getParam('subject');
const quarter = getParam('quarter');
const name = getParam('name');

// Load the selected presentation from Firebase if editing
firebase.auth().onAuthStateChanged(async function(user) {
    if (quarter && name && subject && user) {
        const teacherUID = user.uid;
        const teacherSnap = await db.ref('teachers/' + teacherUID).once('value');
        const teacher = teacherSnap.val();
        const section = teacher && teacher.section ? teacher.section : null;
        if (!section) return initSlides();

        db.ref('teachers/' + teacherUID + '/sections/' + section + '/lessons/' + subject + '/quarter-' + quarter + '/' + name).once('value', function(snapshot) {
            const val = snapshot.val();
            if (val && val.slides) {
                slides = JSON.parse(val.slides);
                currentSlide = 0;
                loadSlide(currentSlide);
                updateSlideIndicator();
            } else if (val && val.json) {
                canvas.loadFromJSON(val.json, function() {
                    canvas.renderAll();
                    slides = [canvas.toJSON()];
                    currentSlide = 0;
                    updateSlideIndicator();
                });
            } else {
                initSlides();
            }
        });
    } else {
        initSlides();
    }
});

// Slides logic
let slides = [];
let currentSlide = 0;


// Create slide navigation UI
const navBar = document.createElement('div');
navBar.style = 'position:fixed; padding: 15px; width: 65%; justify-content: center; align-items: center; bottom:14px;left:50%;transform:translateX(-50%);z-index:20;display:flex;gap:12px;';
navBar.innerHTML = `
    <div id="slide-preview-bar" style="
        display:flex;
        gap:4px;
        align-items:center;
        overflow-x:auto;
        max-width: 60vw;
        flex: 1 1 auto;
        padding: 0 10px 0 0;
    "></div>
    <span id="slide-indicator" style="font-size:0.85em;font-weight:bold;margin-left:6px;">Slide 1/1</span>
    <div style="margin-left:auto;display:flex;align-items:center;gap:3px;">
        <label for="canvas-scale" style="margin-left:4px;font-size:0.8em;">Zoom:</label>
        <input type="range" id="canvas-scale" min="0.1" max="1" step="0.01" value="0.8" style="width:60px;vertical-align:middle;">
        <span id="canvas-scale-value" style="font-size:0.8em;">80%</span>
        <button id="reset-zoom-btn" title="Reset Zoom" style="background:none;border:none;cursor:pointer;font-size:0.95em;vertical-align:middle;padding:0 1px;">
            <i class="fa fa-rotate-right"></i>
        </button>
    </div>
`;
document.body.appendChild(navBar);

const scaleInput = document.getElementById('canvas-scale');
const scaleValue = document.getElementById('canvas-scale-value');
const canvasWrapper = document.querySelector('.canvas-wrapper');

// Set initial zoom to 80%
scaleInput.value = 0.8;

function updateCanvasScale() {
    const scale = parseFloat(scaleInput.value);
    canvasWrapper.style.transform = `scale(${scale})`;
    canvasWrapper.style.transformOrigin = 'center center';
    scaleValue.textContent = Math.round(scale * 100) + '%';
    updateFontSizeInput();
}

scaleInput.addEventListener('input', updateCanvasScale);

// Call on load and after window resize
window.addEventListener('resize', updateCanvasScale);
updateCanvasScale();

document.getElementById('reset-zoom-btn').onclick = function() {
    scaleInput.value = 0.8;
    updateCanvasScale();
};


function updateSlidePreviewBar() {
    const bar = document.getElementById('slide-preview-bar');
    bar.innerHTML = '';
    slides.forEach((slide, idx) => {
        const thumb = document.createElement('div');
        thumb.draggable = true; // Enable drag
        thumb.style = `
            width: 50px; height: 28px; background: #fff; border-radius: 6px; box-shadow: 0 2px 8px #0001;
            border: ${idx === currentSlide ? '2px solid var(--primary)' : '1px solid #ccc'};
            display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative;
            overflow: hidden; margin-right:4px;
        `;

        // Drag events for reordering
        thumb.ondragstart = (e) => {
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', idx);
            thumb.style.opacity = '0.5';
        };
        thumb.ondragend = () => {
            thumb.style.opacity = '1';
        };
        thumb.ondragover = (e) => {
            e.preventDefault();
            thumb.style.borderColor = 'var(--accent)';
        };
        thumb.ondragleave = () => {
            thumb.style.borderColor = idx === currentSlide ? 'var(--primary)' : '#ccc';
        };
        thumb.ondrop = (e) => {
            e.preventDefault();
            const fromIdx = Number(e.dataTransfer.getData('text/plain'));
            if (fromIdx !== idx) {
                const moved = slides.splice(fromIdx, 1)[0];
                slides.splice(idx, 0, moved);
                if (currentSlide === fromIdx) currentSlide = idx;
                else if (currentSlide > fromIdx && currentSlide <= idx) currentSlide--;
                else if (currentSlide < fromIdx && currentSlide >= idx) currentSlide++;
                loadSlide(currentSlide);
                updateSlideIndicator();
            }
        };

        // Render a mini canvas for preview
        const canvasEl = document.createElement('canvas');
        canvasEl.width = 70;
        canvasEl.height = 44;
        thumb.appendChild(canvasEl);

        const previewCanvas = new fabric.StaticCanvas(canvasEl, { backgroundColor: '#fff', width: 70, height: 44 });
        previewCanvas.loadFromJSON(slide, function() {
            const scale = Math.min(70 / 1280, 44 / 720);
            previewCanvas.setZoom(scale);
            previewCanvas.renderAll();
        });

        // Slide number indicator
        const num = document.createElement('span');
        num.textContent = idx + 1;
        num.style = 'position:absolute;top:2px;right:6px;font-size:0.85em;color:#2e8b57;font-weight:bold;';
        thumb.appendChild(num);

        // Delete button (hidden by default)
        const delBtn = document.createElement('button');

        delBtn.innerHTML = '<i class="fa fa-trash"></i>';
        delBtn.title = 'Delete Slide';
        delBtn.style = `
            display:none; position:absolute; top:2px; left:2px; width:16px; height:16px; border:none; background:rgba(255,60,60,0.9);
            color:#fff; border-radius:50%; align-items:center; justify-content:center; cursor:pointer; z-index:2; font-size:0.8em;
        `;
        delBtn.onclick = (e) => {
            e.stopPropagation();
            delBtn.style.display = 'none';
            copyBtn.style.display = 'none';
            if (slides.length > 1) {
                slides.splice(idx, 1);
                if (currentSlide >= slides.length) currentSlide = slides.length-1;
                loadSlide(currentSlide);
                updateSlideIndicator();
            } else {
                canvas.clear();
                slides[0] = canvas.toJSON();
                updateSlideIndicator();
            }
        };
        thumb.appendChild(delBtn);

        // Copy button (hidden by default)
        const copyBtn = document.createElement('button');
        copyBtn.innerHTML = '<i class="fa fa-copy"></i>';
        copyBtn.title = 'Copy Slide';
        copyBtn.style = `
           display:none; position:absolute; top:2px; right:0; margin-right:2px; width:16px; height:16px; border:none; background:rgba(60,60,255,0.9);
            color:#fff; border-radius:50%; align-items:center; justify-content:center; cursor:pointer; z-index:2; font-size:0.8em;
        `;
        copyBtn.onclick = (e) => {
            e.stopPropagation();
            delBtn.style.display = 'none';
            copyBtn.style.display = 'none';
            // Deep clone the slide JSON
            const clone = JSON.parse(JSON.stringify(slides[idx]));
            slides.splice(idx + 1, 0, clone);
            currentSlide = idx + 1;
            loadSlide(currentSlide);
            updateSlideIndicator();
        };
        thumb.appendChild(copyBtn);

        // Show buttons on right-click
        thumb.oncontextmenu = function(e) {
            e.preventDefault();
            // Hide all delete/copy buttons first (not the plus button)
            document.querySelectorAll('#slide-preview-bar .slide-action-btn').forEach(btn => btn.style.display = 'none');
            delBtn.style.display = 'flex';
            copyBtn.style.display = 'flex';
        };

        // Hide buttons when clicking elsewhere
        document.addEventListener('click', function hideBtns(ev) {
            if (!thumb.contains(ev.target)) {
                delBtn.style.display = 'none';
                copyBtn.style.display = 'none';
                document.removeEventListener('click', hideBtns);
            }
        });
        // Click to jump to slide
        thumb.onclick = function(e) {
            if (e.target === delBtn || e.target === copyBtn) return;
            saveCurrentSlide();
            currentSlide = idx;
            loadSlide(currentSlide);
            updateSlideIndicator();
            updateSlidePreviewBar();
        };

        bar.appendChild(thumb);
    });

    // Add "+" button for new slide (not draggable)
    const addBtn = document.createElement('button');
    addBtn.innerHTML = '<i class="fa fa-plus"></i>';
    addBtn.title = 'Add Slide';
    addBtn.style = `
        width: 30px; height: 30px; border-radius: 50%; border: none; background: #b39ddb; color: #fff;
        font-size: 1.5em; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left:6px;
        box-shadow: 0 2px 8px #0001;
    `;
    addBtn.onclick = function() {
        saveCurrentSlide();
        const blankCanvas = new fabric.Canvas('canvas', { backgroundColor: '#fff', width: canvas.width, height: canvas.height });
        slides.splice(currentSlide+1, 0, blankCanvas.toJSON());
        currentSlide++;
        loadSlide(currentSlide);
        updateSlideIndicator();
    };
    bar.appendChild(addBtn);
}



// Slide indicator
function updateSlideIndicator() {
    document.getElementById('slide-indicator').textContent = `Slide ${currentSlide+1}/${slides.length}`;
    updateSlidePreviewBar();
}
function saveCurrentSlide() {
    // Save the canvas JSON for the current slide
    let slideJson = canvas.toJSON();
    // If a game is attached to this slide, save its info
    if (typeof gameUrl !== 'undefined' && gameUrl && currentSlide === gameSlideIndex) {
        slideJson.game = { url: gameUrl };
    } else {
        // Remove game info if not present
        if (slideJson.game) delete slideJson.game;
    }
    slides[currentSlide] = slideJson;
}

function loadSlide(idx) {
    if (slides[idx]) {
        canvas.loadFromJSON(slides[idx], function() {
            canvas.renderAll();
            updateSlideIndicator();
            showGameIframe(); 
            // Restore game info if present
            if (slides[idx].game) {
                gameUrl = slides[idx].game.url;
                gameSlideIndex = idx;
            } else {
                gameUrl = null;
                gameSlideIndex = null;
            }
            showGameIframe();
        });
    }
}

// Add slide
document.getElementById('add-slide-btn').onclick = function() {
    saveCurrentSlide();
    // Create a blank canvas JSON with white background
    const blankCanvas = new fabric.Canvas('canvas', { backgroundColor: '#fff', width: canvas.width, height: canvas.height });
    slides.splice(currentSlide+1, 0, blankCanvas.toJSON());
    currentSlide++;
    loadSlide(currentSlide);
    updateSlideIndicator();
};
// Next slide
document.getElementById('next-slide-btn').onclick = function() {
    saveCurrentSlide();
    if (currentSlide < slides.length-1) {
        currentSlide++;
        loadSlide(currentSlide);
        updateSlideIndicator();
    }
};
// Prev slide
document.getElementById('prev-slide-btn').onclick = function() {
    saveCurrentSlide();
    if (currentSlide > 0) {
        currentSlide--;
        loadSlide(currentSlide);
        updateSlideIndicator();
    }
};
// Delete slide
document.getElementById('delete-slide-btn').onclick = function() {
    if (slides.length > 1) {
        slides.splice(currentSlide, 1);
        if (currentSlide >= slides.length) currentSlide = slides.length-1;
        loadSlide(currentSlide);
        updateSlideIndicator();
    } else {
        canvas.clear();
        slides[0] = canvas.toJSON();
        updateSlideIndicator();
    }
};

</script>

    <div id="game-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); z-index:99999; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:32px 28px; border-radius:14px; max-width:800px; width:96vw; box-shadow:0 4px 24px #0002; position:relative;">
            <h2 style="margin-top:0;margin-bottom:18px;">Choose a Game</h2>
            <button class="game-option" data-game="../Games/assessment/lesson1.html" style="margin-bottom:10px;">Game 1: Time & World Time Zones</button>
            <button class="game-option" data-game="../Games/assessment/lesson2.html">Game 2: GMDAS </button>
            <button class="game-option" data-game="../Games/assessment/lesson3.html">Game 3: Fraction Match</button>
            <button class="game-option" data-game="../Games/assessment/lesson4.html">Game 4: Fraction Match</button>
            <!-- Add more games here as needed -->  
            <button class="cancel-button" onclick="document.getElementById('game-modal').style.display='none'">Cancel</button>
        </div>
    </div>
    <style>
        #game-modal {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .game-option {
           --bg: #000;
            --hover-bg: #ff90e8;
            --hover-text: #000;
            color: #fff;
            cursor: pointer;
            border: 1px solid var(--bg);
            border-radius: 4px;
            padding: 0.8em 2em;
            background: var(--bg);
            transition: 0.2s; 
        }
        .game-option:hover {
            color: var(--hover-text);
            transform: translate(-0.25rem, -0.25rem);
            background: var(--hover-bg);
            box-shadow: 0.25rem 0.25rem var(--bg);
        }
        .game-option:active {
            transform: translate(0);
            box-shadow: none;
        }
        
        .cancel-button {
            display: block;
            padding: 12px 25px;
            background-color: var(--white);
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            border: 2px solid var(--sun-yellow);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            border: 1px solid #2b2929;
        }

        .cancel-button:hover {
            background-color:#ff3030;
            color: white;
        }

        .cancel-button.active {
            background-color: #2e8b57;
            color: var(--white);
            border-color: var(--forest-green);
        }
    </style>
    
    <script>
        // Show game modal
        document.getElementById('add-game-btn').onclick = function() {
            document.getElementById('game-modal').style.display = 'flex';
        };
        // Game option click handler
        document.querySelectorAll('.game-option').forEach(btn => {
        btn.onclick = function() {
            // Save current slide before adding new
            saveCurrentSlide();
            // Create a blank slide
            const blankCanvas = new fabric.Canvas('canvas', { backgroundColor: '#fff', width: canvas.width, height: canvas.height });
            const newSlide = blankCanvas.toJSON();
            // Attach the selected game to the new slide
            newSlide.game = { url: this.dataset.game };
            // Insert the new slide after the current one
            slides.splice(currentSlide + 1, 0, newSlide);
            // Move to the new slide
            currentSlide++;
            gameUrl = this.dataset.game;
            gameSlideIndex = currentSlide;
            loadSlide(currentSlide);
            updateSlideIndicator();
            document.getElementById('game-modal').style.display = 'none';
        };
        });
        // Hide modal on click outside
        document.getElementById('game-modal').onclick = function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        };

        // Keep iframe size in sync with canvas on resize
        function syncGameIframeSize() {
            const iframe = document.getElementById('game-iframe');
            const canvasEl = document.getElementById('canvas');
            if (iframe && canvasEl) {
                iframe.style.width = canvasEl.width + 'px';
                iframe.style.height = canvasEl.height + 'px';
                iframe.style.left = '50%';
                iframe.style.transform = 'translateX(-50%)';
            }
        }
        window.addEventListener('resize', syncGameIframeSize);
        // Also call after canvas resize
        if (typeof resizeCanvas === 'function') {
            const origResizeCanvas = resizeCanvas;
            window.resizeCanvas = function() {
                origResizeCanvas();
                syncGameIframeSize();
            };
        }
    </script>
    <script>
       // Update showGameIframe and syncGameIframeSize to ensure the game iframe is always exactly inside the canvas and matches its size

function showGameIframe() {
    const wrapper = document.querySelector('.canvas-wrapper');
    const canvasEl = document.getElementById('canvas');
    let existing = document.getElementById('game-iframe');
    // Remove if not on a game slide
    if (!slides[currentSlide] || !slides[currentSlide].game) {
        if (existing) existing.remove();
        return;
    }
    // Show if on a game slide
    if (!existing) {
        const iframe = document.createElement('iframe');
        iframe.id = 'game-iframe';
        iframe.src = slides[currentSlide].game.url;
        iframe.style.position = 'absolute';
        iframe.style.top = '0';
        iframe.style.left = '0';
        iframe.style.width = canvasEl.width + 'px';
        iframe.style.height = canvasEl.height + 'px';
        iframe.style.border = 'none';
        iframe.style.zIndex = '10';
        iframe.allow = 'fullscreen';
        wrapper.style.position = 'relative';
        wrapper.appendChild(iframe);
    } else {
        existing.src = slides[currentSlide].game.url;
        existing.style.display = '';
    }
    // Always update size
    syncGameIframeSize();
}

function syncGameIframeSize() {
    const iframe = document.getElementById('game-iframe');
    const canvasEl = document.getElementById('canvas');
    if (iframe && canvasEl) {
        iframe.style.width = canvasEl.width + 'px';
        iframe.style.height = canvasEl.height + 'px';
        iframe.style.top = '0';
        iframe.style.left = '0';
    }
}
window.addEventListener('resize', syncGameIframeSize);
// Also call after canvas resize
if (typeof resizeCanvas === 'function') {
    const origResizeCanvas = resizeCanvas;
    window.resizeCanvas = function() {
        origResizeCanvas();
        syncGameIframeSize();
    };
}
   
if (scaleInput) scaleInput.addEventListener('input', overlayGifsOnCanvas);
window.addEventListener('resize', overlayGifsOnCanvas);

// Add this after your saveCurrentSlide() function and after Firebase/auth/db are initialized

// Debounce helper to avoid too many writes
function debounce(fn, delay) {
    let timer = null;
    return function(...args) {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), delay);
    };
}

// Auto-save slides to Firebase
async function autoSaveSlides() {
    saveCurrentSlide();
    let quarter = getParam('quarter');
    let name = getParam('name');
    let subject = getParam('subject');
    if (!quarter || !name || !subject) return;

    const user = firebase.auth().currentUser;
    if (!user) return;
    const teacherUID = user.uid;
    const teacherSnap = await db.ref('teachers/' + teacherUID).once('value');
    const teacher = teacherSnap.val();
    const section = teacher && teacher.section ? teacher.section : null;
    if (!section) return;

    const slidesJson = JSON.stringify(slides);

    await db.ref('teachers/' + teacherUID + '/sections/' + section + '/lessons/' + subject + '/quarter-' + quarter + '/' + name).update({
        slides: slidesJson,
        savedAt: new Date().toISOString(),
        title: name,
        quarter: quarter,
        subject: subject,
        description: lastDescription // Always use lastDescription
    });
}

// Debounced auto-save function
const debouncedAutoSave = debounce(autoSaveSlides, 1000);

// Auto-save on canvas changes
['object:added', 'object:modified', 'object:removed', 'background:changed'].forEach(evt => {
    canvas.on(evt, debouncedAutoSave);
});

// Auto-save on slide navigation
function autoSaveAndLoadSlide(idx) {
    debouncedAutoSave();
    loadSlide(idx);
}
document.getElementById('next-slide-btn').onclick = function() {
    saveCurrentSlide();
    if (currentSlide < slides.length-1) {
        currentSlide++;
        autoSaveAndLoadSlide(currentSlide);
        updateSlideIndicator();
    }
};
document.getElementById('prev-slide-btn').onclick = function() {
    saveCurrentSlide();
    if (currentSlide > 0) {
        currentSlide--;
        autoSaveAndLoadSlide(currentSlide);
        updateSlideIndicator();
    }
};
document.getElementById('add-slide-btn').onclick = function() {
    saveCurrentSlide();
    const blankCanvas = new fabric.Canvas('canvas', { backgroundColor: '#fff', width: canvas.width, height: canvas.height });
    slides.splice(currentSlide+1, 0, blankCanvas.toJSON());
    currentSlide++;
    autoSaveAndLoadSlide(currentSlide);
    updateSlideIndicator();
};
document.getElementById('delete-slide-btn').onclick = function() {
    if (slides.length > 1) {
        slides.splice(currentSlide, 1);
        if (currentSlide >= slides.length) currentSlide = slides.length-1;
        autoSaveAndLoadSlide(currentSlide);
        updateSlideIndicator();
    } else {
        canvas.clear();
        slides[0] = canvas.toJSON();
        debouncedAutoSave();
        updateSlideIndicator();
    }
};

// Auto-save on first load
window.addEventListener('DOMContentLoaded', debouncedAutoSave);


document.addEventListener('paste', function(e) {
    // Check for image in clipboard
    console.log('Paste event detected');
    if (e.clipboardData && e.clipboardData.items) {
        for (let i = 0; i < e.clipboardData.items.length; i++) {
            const item = e.clipboardData.items[i];
            console.log('Clipboard item:', item.type);
            if (item.type.indexOf('image') !== -1) {
                const file = item.getAsFile();
                console.log('Got file:', file);
                const reader = new FileReader();
                reader.onload = function(event) {
                    console.log('FileReader loaded:', event.target.result);
                    fabric.Image.fromURL(event.target.result, function(img) {
                        if (!img) {
                            alert('Could not load image from clipboard!');
                            return;
                        }
                        img.set({ left: 100, top: 100, scaleX: 0.5, scaleY: 0.5 });
                        canvas.add(img).setActiveObject(img);
                        canvas.requestRenderAll();
                    });
                };
                reader.readAsDataURL(file);
                e.preventDefault();
                return;
            }
        }
    }
    // Optionally, handle text paste as image URL
    if (e.clipboardData && e.clipboardData.getData) {
        const text = e.clipboardData.getData('text');
        if (text && (text.startsWith('http://') || text.startsWith('https://')) && /\.(png|jpg|jpeg|gif|svg)$/.test(text)) {
            fabric.Image.fromURL(text, function(img) {
                img.set({ left: 100, top: 100, scaleX: 0.5, scaleY: 0.5 });
                canvas.add(img).setActiveObject(img);
                canvas.requestRenderAll();
            });
            e.preventDefault();
        }
    }
});

function applyTextEffects() {
    const obj = canvas.getActiveObject();
    if (obj && obj.type === 'i-text') {
        // Shadow & Glow (hallow)
        const shadowColor = document.getElementById('text-shadow-color').value;
        const shadowBlur = parseInt(document.getElementById('text-shadow-blur').value) || 0;
        const hallowColor = document.getElementById('text-hallow-color').value;
        const hallowBlur = parseInt(document.getElementById('text-hallow-blur').value) || 0;

        // If hallow/glow is set, use it as shadow
        let shadow = null;
        if (hallowBlur > 0) {
            shadow = {
                color: hallowColor,
                blur: hallowBlur,
                offsetX: 0,
                offsetY: 0
            };
        } else if (shadowBlur > 0) {
            shadow = {
                color: shadowColor,
                blur: shadowBlur,
                offsetX: 2,
                offsetY: 2
            };
        }
        obj.set('shadow', shadow);

        // Stroke/Outline (Fabric only supports one stroke at a time)
        const outlineWidth = parseInt(document.getElementById('text-outline-width').value) || 0;
        const outlineColor = document.getElementById('text-outline-color').value;
        const strokeWidth = parseInt(document.getElementById('text-stroke-width').value) || 0;
        const strokeColor = document.getElementById('text-stroke-color').value;

        if (outlineWidth > 0) {
            obj.set('stroke', outlineColor);
            obj.set('strokeWidth', outlineWidth);
        } else if (strokeWidth > 0) {
            obj.set('stroke', strokeColor);
            obj.set('strokeWidth', strokeWidth);
        } else {
            obj.set('stroke', null);
            obj.set('strokeWidth', 0);
        }

        // Background
        const bgTransparent = document.getElementById('text-bg-transparent').checked;
        const bgColor = bgTransparent ? '' : document.getElementById('text-bg-color').value;
        obj.set('backgroundColor', bgColor);

        canvas.renderAll();
    }
}

// Add listeners for new controls
[
    'text-shadow-color', 'text-shadow-blur',
    'text-stroke-color', 'text-stroke-width',
    'text-bg-color', 'text-bg-transparent',
    'text-outline-color', 'text-outline-width',
    'text-hallow-color', 'text-hallow-blur'
].forEach(id => {
    document.getElementById(id).addEventListener('input', applyTextEffects);
    document.getElementById(id).addEventListener('change', applyTextEffects);
});

// When selecting a text object, update controls to match its current effects
canvas.on('selection:created', updateTextEffectInputs);
canvas.on('selection:updated', updateTextEffectInputs);

function updateTextEffectInputs() {
    const obj = canvas.getActiveObject();
    if (obj && obj.type === 'i-text') {
        // Shadow
        const shadow = obj.shadow || {};
        document.getElementById('text-shadow-color').value = shadow.color || '#000000';
        document.getElementById('text-shadow-blur').value = shadow.blur || 0;
        // Stroke
        document.getElementById('text-stroke-color').value = obj.stroke || '#000000';
        document.getElementById('text-stroke-width').value = obj.strokeWidth || 0;
        // Outline
        document.getElementById('text-outline-color').value = obj.stroke || '#ff69b4';
        document.getElementById('text-outline-width').value = obj.strokeWidth || 0;
        // Hallow/Glow
        document.getElementById('text-hallow-color').value = shadow.color || '#ffd700';
        document.getElementById('text-hallow-blur').value = shadow.blur || 0;
        // Background
        const bgColor = obj.backgroundColor || '';
        document.getElementById('text-bg-color').value = bgColor && bgColor !== '' ? bgColor : '#ffffff';
        document.getElementById('text-bg-transparent').checked = !bgColor;
    }
}
   
</script>

<script src="../assets/js/templates.js"></script>

<script>
    // Add this JS after your canvas setup
document.getElementById('save-template-btn').onclick = async function() {
    const templateJSON = canvas.toJSON();
    // Save to Firebase (Firestore example)
    await firebase.firestore().collection('templates').add({
        data: templateJSON,
        name: 'My Custom Template',
        created: new Date()
    });
    alert('Template saved to Firebase!');
};
</script>
</body>
</html>
