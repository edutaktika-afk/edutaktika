<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="../CSS/fonts.css">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700&family=Manrope:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../CSS/header.css">
    <link rel="stylesheet" href="../CSS/homepage.css">
    <link rel="stylesheet" href="../CSS/footer.css">
    <link rel="stylesheet" href="../CSS/dropdown.css">
    <link rel="stylesheet" href="../CSS/burger.css">
    <link rel="icon" type="image/png" href="../images/icons/home.png" />
    <title>Grading System | Edutaktika</title>
    
    <style>
        :root {
            --primary: #2e8b57;
            --secondary: #ffd700;
            --accent: #ff69b4;
            --background: #f0f8ff;
            --card-bg: #ffffff;
            --text-main: #22223b;
            --text-light: #9a8c98;
            --shadow: 0 4px 24px rgba(46, 139, 87, 0.08);
            --radius: 18px;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
        }

        body {
            background: var(--background);
            min-height: 100vh;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            min-height: calc(100vh - 200px);
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-header h1 {
            font-family: var(--font-heading);
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 10px;
            font-weight: 700;
        }

        .page-header p {
            color: var(--text-light);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .grading-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            align-items: start;
        }

        .grading-form {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            border-top: 4px solid var(--primary);
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h3 {
            font-family: var(--font-heading);
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .attribute-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid var(--accent);
            transition: all 0.3s ease;
        }

        .attribute-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .attribute-name {
            flex: 1;
            font-weight: 600;
            color: var(--text-main);
        }

        .attribute-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .percentage-input {
            width: 80px;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .percentage-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .percentage-input.error {
            border-color: var(--error);
            background-color: #ffebee;
        }

        .percentage-input.warning {
            border-color: var(--warning);
            background-color: #fff3e0;
        }

        .max-indicator {
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .remove-btn {
            background: var(--error);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .remove-btn:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }

        .edit-btn {
            background: var(--warning);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            margin-right: 5px;
        }

        .edit-btn:hover {
            background: #f57c00;
            transform: scale(1.1);
        }

        .attribute-name {
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
        }

        .attribute-name.editing {
            display: none;
        }

        .attribute-name-input {
            display: none;
            flex: 1;
            padding: 8px 12px;
            border: 2px solid var(--primary);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            background: white;
        }

        .attribute-name-input.editing {
            display: block;
        }

        .attribute-actions {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .add-attribute {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .add-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .add-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .add-btn {
            background: var(--secondary);
            color: var(--text-main);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-btn:hover {
            background: #e6c200;
            transform: translateY(-2px);
        }

        .summary-panel {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .summary-panel h3 {
            font-family: var(--font-heading);
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .total-percentage {
            text-align: center;
            margin-bottom: 20px;
        }

        .total-value {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 5px;
            transition: color 0.3s;
        }

        .total-value.valid {
            color: var(--success);
        }

        .total-value.invalid {
            color: var(--error);
        }

        .total-label {
            color: var(--text-light);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .validation-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s;
        }

        .validation-message.success {
            background: #e8f5e8;
            color: var(--success);
            border: 2px solid var(--success);
        }

        .validation-message.error {
            background: #ffebee;
            color: var(--error);
            border: 2px solid var(--error);
        }

        .validation-message.warning {
            background: #fff3e0;
            color: var(--warning);
            border: 2px solid var(--warning);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .save-btn, .reset-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .save-btn {
            background: var(--primary);
            color: white;
        }

        .save-btn:hover {
            background: #267d4a;
            transform: translateY(-2px);
        }

        .save-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .reset-btn {
            background: #f5f5f5;
            color: var(--text-main);
            border: 2px solid #e0e0e0;
        }

        .reset-btn:hover {
            background: #e0e0e0;
        }

        .attributes-list {
            margin-bottom: 20px;
        }

        .attribute-preview {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .attribute-preview:last-child {
            border-bottom: none;
        }

        .preview-name {
            font-weight: 500;
            color: var(--text-main);
        }

        .preview-percentage {
            font-weight: 600;
            color: var(--primary);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .grading-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .summary-panel {
                position: static;
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 20px 15px;
            }

            .page-header h1 {
                font-size: 2rem;
            }

            .grading-form, .summary-panel {
                padding: 20px;
            }

            .attribute-item {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .attribute-input {
                justify-content: space-between;
            }

            .add-attribute {
                flex-direction: column;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        /* Animation for adding/removing items */
        .attribute-item {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .removing {
            animation: slideOut 0.3s ease-in forwards;
        }

        @keyframes slideOut {
            to {
                opacity: 0;
                transform: translateX(-100%);
                height: 0;
                margin: 0;
                padding: 0;
            }
        }

        /* Grading Sheet Styles */
        .grading-sheet-section {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px;
            margin-top: 30px;
            box-shadow: var(--shadow);
            border-top: 4px solid var(--accent);
        }

        .section-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .section-header h2 {
            font-family: var(--font-heading);
            color: var(--primary);
            font-size: 1.8rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .section-header p {
            color: var(--text-light);
            font-size: 1.1rem;
        }

        .grading-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .refresh-btn, .export-btn, .add-grade-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }

        .refresh-btn {
            background: var(--primary);
            color: white;
        }

        .refresh-btn:hover {
            background: #267d4a;
            transform: translateY(-2px);
        }

        .export-btn {
            background: var(--secondary);
            color: var(--text-main);
        }

        .export-btn:hover {
            background: #e6c200;
            transform: translateY(-2px);
        }

        .add-grade-btn {
            background: var(--accent);
            color: white;
        }

        .add-grade-btn:hover {
            background: #e91e63;
            transform: translateY(-2px);
        }

        .grade-actions {
            display: flex;
            gap: 10px;
        }

        .grading-table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .grading-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 0.95rem;
        }

        .grading-table th {
            background: var(--primary);
            color: white;
            padding: 15px 12px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .grading-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .grading-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .grading-table .student-name {
            text-align: left;
            font-weight: 600;
            color: var(--text-main);
        }

        .grading-table .grade-input {
            width: 60px;
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 0.9rem;
        }

        .grading-table .grade-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .grading-table .final-grade {
            font-weight: bold;
            color: var(--primary);
            font-size: 1rem;
        }

        .grading-table .grade-excellent {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        .grading-table .grade-good {
            background-color: #fff3e0;
            color: #f57c00;
        }

        .grading-table .grade-fair {
            background-color: #ffebee;
            color: #d32f2f;
        }

        .edit-grade-btn,
        .delete-grade-btn {
            background: none;
            border: none;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .edit-grade-btn {
            color: var(--primary);
        }

        .edit-grade-btn:hover {
            background: var(--primary);
            color: white;
        }

        .delete-grade-btn {
            color: var(--error);
        }

        .delete-grade-btn:hover {
            background: var(--error);
            color: white;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), #3ba866);
            color: white;
            padding: 25px 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(46, 139, 87, 0.2);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
            font-family: var(--font-heading);
        }

        .stat-label {
            font-size: 0.95rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Grade Modal Styles */
        .grade-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .grade-modal.show {
            display: flex;
        }

        .grade-modal-content {
            background: white;
            border-radius: var(--radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--primary);
            font-size: 1.3rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--text-light);
            cursor: pointer;
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: var(--error);
        }

        .modal-body {
            padding: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-main);
        }

        .form-group input,
        .form-group select {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .grade-inputs {
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8f9fa;
        }

        .grade-inputs h4 {
            margin: 0 0 15px 0;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .grade-input-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .grade-input-item:last-child {
            margin-bottom: 0;
        }

        .grade-input-label {
            font-weight: 600;
            color: var(--text-main);
            flex: 1;
        }

        .grade-input-field {
            width: 80px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            text-align: center;
            margin-left: 10px;
        }

        .grade-weight {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-left: 10px;
        }

        .calculated-grade {
            background: var(--primary);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
        }

        .calculated-grade label {
            display: block;
            margin-bottom: 10px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .final-grade-display {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: var(--font-heading);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            padding: 20px 25px;
            border-top: 2px solid #f0f0f0;
            background: #f8f9fa;
        }

        .btn-cancel,
        .btn-save {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .btn-cancel {
            background: #f5f5f5;
            color: var(--text-main);
            border: 2px solid #e0e0e0;
        }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

        .btn-save {
            background: var(--primary);
            color: white;
        }

        .btn-save:hover {
            background: #267d4a;
            transform: translateY(-2px);
        }

        /* Responsive Design for Grading Sheet */
        @media (max-width: 1024px) {
            .grading-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-controls,
            .grade-actions {
                justify-content: center;
            }

            .grading-table {
                font-size: 0.85rem;
            }

            .grading-table th,
            .grading-table td {
                padding: 8px 6px;
            }
        }

        @media (max-width: 768px) {
            .grading-sheet-section {
                padding: 20px 15px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .filter-controls {
                flex-direction: column;
                gap: 10px;
            }

            .grade-actions {
                flex-direction: column;
                gap: 10px;
            }

            .refresh-btn,
            .export-btn,
            .add-grade-btn {
                width: 100%;
                justify-content: center;
            }

            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .stat-number {
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            .summary-stats {
                grid-template-columns: 1fr;
            }

            .grading-table-container {
                overflow-x: scroll;
            }

            .grade-modal-content {
                width: 95%;
                margin: 10px;
            }
        }

        /* Custom Warning Modal Styles */
        .warning-modal {
            display: none;
            position: fixed;
            z-index: 10001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }

        .warning-modal.show {
            display: flex;
        }

        .warning-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: warningSlideIn 0.4s ease-out;
            overflow: hidden;
        }

        @keyframes warningSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .warning-header {
            background: linear-gradient(135deg, #ff9800, #ff5722);
            color: white;
            padding: 20px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .warning-icon {
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            animation: warningPulse 2s infinite;
        }

        @keyframes warningPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .warning-header h3 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .warning-body {
            padding: 25px;
        }

        .warning-body p {
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            color: var(--text-main);
            line-height: 1.5;
        }

        .warning-details {
            background: #fff3e0;
            border: 1px solid #ffcc02;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .warning-details p {
            margin: 0;
            color: #e65100;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .warning-footer {
            padding: 20px 25px;
            background: #f8f9fa;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            border-top: 1px solid #e9ecef;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-delete:hover {
            background: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        @media (max-width: 768px) {
            .warning-modal-content {
                width: 95%;
                margin: 10px;
            }
            
            .warning-header {
                padding: 15px 20px;
            }
            
            .warning-body {
                padding: 20px;
            }
            
            .warning-footer {
                padding: 15px 20px;
                flex-direction: column;
            }
            
            .btn-cancel, .btn-delete {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <!-- Authentication Check Script -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            auth.onAuthStateChanged(async function(user) {
                if (!user) {
                    window.location.href = "logreg.html";
                    return;
                }
                const uid = user.uid;
                const snap = await db.ref('teachers/' + uid).once('value');
                const teacher = snap.val();
                if (!teacher || teacher.role !== "teacher") {
                    document.getElementById('mainContent').style.display = "none";
                    alert("Access denied.");
                    await auth.signOut();
                    window.location.href = "logreg.html";
                } else {
                    document.getElementById('mainContent').style.display = "block";
                }
            });
        });
    </script>

    <div id="mainContent" style="display:none;">
        <!-- Burger icon for mobile -->
        <button id="burgerBtn" class="burger-btn" aria-label="Open menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <!-- Overlay for navbar -->
        <div class="sidebar-overlay" id="navOverlay"></div>
        <!-- Overlay for profile sidebar -->
        <div class="sidebar-overlay" id="profileSidebarOverlay"></div>

        <header>
            <div class="floating-elements">
                <div class="floating-element"></div>
                <div class="floating-element"></div>
                <div class="floating-element"></div>
                <div class="floating-element"></div>
            </div>
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="logo-text">
                        <span>E</span><span>d</span><span>u</span><span>t</span><span>a</span><span>k</span><span>t</span><span>i</span><span>k</span><span>a</span>
                    </div>
                </div>
                <nav>
                    <ul>
                        <li><a href="homepage.html">Home</a></li>
                        <li class="dropdown">
                            <a href="#" class="dropbtn">Subject <i class="fa fa-caret-down"></i></a>
                            <ul class="dropdown-content">
                                <li><a href="subject_math.html">Math</a></li>
                                <li><a href="subject_english.html">English</a></li>
                                <li><a href="subject_science.html">Science</a></li>
                            </ul>
                        </li>
                        <li><a href="studentlist.html">Student</a></li>
                        <li class="dropdown">
                            <a href="#" class="dropbtn">Leaderboard <i class="fa fa-caret-down"></i></a>
                            <ul class="dropdown-content">
                                <li><a href="leaderboard_math.html">Math</a></li>
                                <li><a href="leaderboard_english.html">English</a></li>
                                <li><a href="leaderboard_science.html">Science</a></li>
                            </ul>
                        </li>
                        <li><a href="grading.html" style="background-color: var(--primary); color: white;">Grading</a></li>
                        <li>
                            <a href="#" id="profileBtn"><i class="fas fa-user-circle"></i> Profile</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </header>

        <!-- Profile Sidebar (Dynamic with Firebase) -->
        <div id="profileSidebar" class="profile-sidebar">
            <div class="sidebar-content">
                <button class="close-btn" id="closeSidebar">&times;</button>
                <div style="position:relative; display:flex; flex-direction:column; align-items:center;">
                    <img class="profile-avatar" id="profileAvatar" src="https://api.dicebear.com/7.x/bottts/svg?seed=user" alt="Profile Avatar">
                    <i class="fa-solid fa-star sidebar-star" style="position:absolute; bottom:0; right:10px; color:#ffd700; font-size:1.2rem; background:white; border-radius:50%; padding:2px 4px; box-shadow:0 1px 4px #ffd70044;"></i>
                </div>
                <div class="profile-name" id="profileName">Loading...</div>
                <br>
                <div class="profile-info" style="width:100%;max-width:260px;margin-bottom:24px;">
                    <div class="profile-role" style="color:#2e8b57; font-weight:700; font-size:1.1rem; margin-bottom:8px; letter-spacing:1px; text-align:center;">
                        Teacher
                    </div>
                    <div>
                        <i class="fa-solid fa-id-badge" style="color:violet;margin-right:10px;"></i>
                        <strong>ID:</strong> <span id="profileId">-</span>
                    </div>
                    <div>
                        <i class="fa-solid fa-user" style="color:#ff69b4;margin-right:10px;"></i>
                        <strong>First Name:</strong> <span id="profileFirstName">-</span>
                    </div>
                    <div>
                        <i class="fa-solid fa-user" style="color:#ffd700;margin-right:10px;"></i>
                        <strong>Middle Name:</strong> <span id="profileMiddleName">-</span>
                    </div>
                    <div>
                        <i class="fa-solid fa-user" style="color:#f14141;margin-right:10px;"></i>
                        <strong>Last Name:</strong> <span id="profileLastName">-</span>
                    </div>
                    <div>
                        <i class="fa-solid fa-graduation-cap" style="color:#2e8b57;margin-right:10px;"></i>
                        <strong>Grade Level:</strong> <span id="profileGrade">-</span>
                    </div>
                    <div>
                        <i class="fa-solid fa-apple-whole" style="color:#4faaff;margin-right:10px;"></i>
                        <strong>Section:</strong> <span id="profileSection">-</span>
                    </div>
                    <div>
                        <i class="fas fa-map-marker-alt" style="color:#ff69b4;margin-right:10px;"></i>
                        <strong>House/Street:</strong> <span id="profileAddressStreet">-</span>
                    </div>
                    <div>
                        <i class="fas fa-map-marker-alt" style="color:#ffd700;margin-right:10px;"></i>
                        <strong>Barangay:</strong> <span id="profileAddressBarangay">-</span>
                    </div>
                    <div>
                        <i class="fas fa-map-marker-alt" style="color:#4faaff;margin-right:10px;"></i>
                        <strong>City:</strong> <span id="profileAddressCity">-</span>
                    </div>
                    <div>
                        <i class="fas fa-map-marker-alt" style="color:#2e8b57;margin-right:10px;"></i>
                        <strong>Province:</strong> <span id="profileAddressProvince">-</span>
                    </div>
                    <div>
                        <i class="fas fa-map-marker-alt" style="color:#f14141;margin-right:10px;"></i>
                        <strong>ZIP:</strong> <span id="profileAddressZip">-</span>
                    </div>
                    <div>
                        <i class="fas fa-map-marker-alt" style="color:violet;margin-right:10px;"></i>
                        <strong>Region:</strong> <span id="profileAddressRegion">-</span>
                    </div>
                </div>
                <div class="logout-switch-row">
                    <div class="logout-switch" id="logoutSwitch">
                        <div class="logout-switch-circle"></div>
                    </div>
                    <span class="logout-label" id="logoutLabel">LOGOUT</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-container">
            <div class="page-header">
                <h1><i class="fas fa-chart-line"></i> Grading System Configuration</h1>
                <p>Configure and adjust grading criteria dynamically for your class. Set percentage weights for different assessment components.</p>
            </div>

            <div class="grading-container">
                <div class="grading-form">
                    <div class="form-section">
                        <h3><i class="fas fa-cogs"></i> Grading Attributes</h3>
                        <div class="info-note" style="background: #e3f2fd; border-left: 4px solid var(--primary); padding: 12px; margin-bottom: 20px; border-radius: 8px;">
                            <i class="fas fa-info-circle" style="color: var(--primary); margin-right: 8px;"></i>
                            <strong>Smart Validation:</strong> The system automatically prevents any single attribute from exceeding the remaining percentage to keep the total at or below 100%.
                        </div>
                        <div id="attributesList">
                            <!-- Default attributes will be populated here -->
                        </div>
                        
                        <div class="add-attribute">
                            <input type="text" id="newAttributeName" class="add-input" placeholder="Enter new attribute name (e.g., Project, Group Work)" maxlength="50">
                            <button id="addAttributeBtn" class="add-btn">
                                <i class="fas fa-plus"></i> Add Attribute
                            </button>
                        </div>
                    </div>
                </div>

                <div class="summary-panel">
                    <h3><i class="fas fa-calculator"></i> Summary</h3>
                    
                    <div class="total-percentage">
                        <div id="totalValue" class="total-value">0</div>
                        <div class="total-label">Total Percentage</div>
                    </div>

                    <div id="validationMessage" class="validation-message error">
                        <i class="fas fa-exclamation-triangle"></i>
                        Total must equal 100%
                    </div>

                    <div class="attributes-list">
                        <h4 style="margin-bottom: 15px; color: var(--text-main);">Current Attributes:</h4>
                        <div id="attributesPreview">
                            <!-- Preview will be populated here -->
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button id="saveBtn" class="save-btn" disabled>
                            <i class="fas fa-save"></i> Save Configuration
                        </button>
                        <button id="resetBtn" class="reset-btn">
                            <i class="fas fa-undo"></i> Reset to Default
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grading Sheet Section -->
        <div class="grading-sheet-section" id="gradingSheetSection" style="margin-top: 50px;">
            <div class="section-header">
                <h2><i class="fas fa-table"></i> Student Grading Sheet</h2>
                <p>View and manage student grades based on your configured grading criteria.</p>
            </div>

            <div class="grading-controls">
                <div class="filter-controls">
                    <select id="subjectFilter" class="filter-select">
                        <option value="">All Subjects</option>
                        <option value="math">Math</option>
                        <option value="english">English</option>
                        <option value="science">Science</option>
                    </select>
                    <select id="quarterFilter" class="filter-select">
                        <option value="">All Quarters</option>
                        <option value="1">Quarter 1</option>
                        <option value="2">Quarter 2</option>
                        <option value="3">Quarter 3</option>
                        <option value="4">Quarter 4</option>
                    </select>
                    <select id="gradeLevelFilter" class="filter-select">
                        <option value="">All Grade Levels</option>
                        <option value="1">Grade 1</option>
                        <option value="2">Grade 2</option>
                        <option value="3">Grade 3</option>
                        <option value="4">Grade 4</option>
                        <option value="5">Grade 5</option>
                        <option value="6">Grade 6</option>
                    </select>
                    <button id="refreshGradesBtn" class="refresh-btn">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                </div>
                <div class="grade-actions">
                    <button id="exportGradesBtn" class="export-btn">
                        <i class="fas fa-download"></i> Export to CSV
                    </button>
                    <button id="bulkGradeBtn" class="export-btn" style="background: #ff9800;">
                        <i class="fas fa-upload"></i> Bulk Grade Entry
                    </button>
                    <button id="gradeHistoryBtn" class="export-btn" style="background: #9c27b0;">
                        <i class="fas fa-history"></i> Grade History
                    </button>
                    <button id="addGradeBtn" class="add-grade-btn">
                        <i class="fas fa-plus"></i> Add Grade Entry
                    </button>
                </div>
            </div>

            <div class="grading-table-container">
                <table id="gradingTable" class="grading-table">
                    <thead id="gradingTableHead">
                        <!-- Dynamic headers will be generated based on grading attributes -->
                    </thead>
                    <tbody id="gradingTableBody">
                        <!-- Student grade data will be populated here -->
                    </tbody>
                </table>
            </div>

            <div class="grading-summary">
                <div class="summary-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalStudents">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="averageGrade">0.0</div>
                        <div class="stat-label">Class Average</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="passingRate">0%</div>
                        <div class="stat-label">Passing Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="highestGrade">0.0</div>
                        <div class="stat-label">Highest Grade</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lowestGrade">0.0</div>
                        <div class="stat-label">Lowest Grade</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="gradeRange">0.0</div>
                        <div class="stat-label">Grade Range</div>
                    </div>
                </div>
                
                <!-- Grade Distribution Chart -->
                <div class="grade-distribution" style="margin-top: 30px;">
                    <h4 style="color: var(--primary); margin-bottom: 20px; text-align: center;">
                        <i class="fas fa-chart-pie"></i> Grade Distribution
                    </h4>
                    <div class="distribution-bars" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                        <div class="distribution-item" style="text-align: center;">
                            <div class="distribution-bar" id="excellentBar" style="height: 0px; background: #4caf50; border-radius: 4px 4px 0 0; transition: height 0.5s ease;"></div>
                            <div class="distribution-label" style="margin-top: 10px; font-weight: 600; color: var(--text-main);">Excellent<br><span style="color: #4caf50; font-size: 1.2rem;" id="excellentCount">0</span></div>
                            <div style="font-size: 0.8rem; color: var(--text-light);">90-100</div>
                        </div>
                        <div class="distribution-item" style="text-align: center;">
                            <div class="distribution-bar" id="goodBar" style="height: 0px; background: #ff9800; border-radius: 4px 4px 0 0; transition: height 0.5s ease;"></div>
                            <div class="distribution-label" style="margin-top: 10px; font-weight: 600; color: var(--text-main);">Good<br><span style="color: #ff9800; font-size: 1.2rem;" id="goodCount">0</span></div>
                            <div style="font-size: 0.8rem; color: var(--text-light);">80-89</div>
                        </div>
                        <div class="distribution-item" style="text-align: center;">
                            <div class="distribution-bar" id="fairBar" style="height: 0px; background: #ff5722; border-radius: 4px 4px 0 0; transition: height 0.5s ease;"></div>
                            <div class="distribution-label" style="margin-top: 10px; font-weight: 600; color: var(--text-main);">Fair<br><span style="color: #ff5722; font-size: 1.2rem;" id="fairCount">0</span></div>
                            <div style="font-size: 0.8rem; color: var(--text-light);">70-79</div>
                        </div>
                        <div class="distribution-item" style="text-align: center;">
                            <div class="distribution-bar" id="poorBar" style="height: 0px; background: #f44336; border-radius: 4px 4px 0 0; transition: height 0.5s ease;"></div>
                            <div class="distribution-label" style="margin-top: 10px; font-weight: 600; color: var(--text-main);">Needs Improvement<br><span style="color: #f44336; font-size: 1.2rem;" id="poorCount">0</span></div>
                            <div style="font-size: 0.8rem; color: var(--text-light);">Below 70</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grade Entry Modal -->
        <div id="gradeModal" class="grade-modal">
            <div class="grade-modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-edit"></i> <span id="modalTitle">Add Grade Entry</span></h3>
                    <button class="modal-close" id="closeGradeModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="gradeForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="studentSelect">Student:</label>
                                <select id="studentSelect" required>
                                    <option value="">Select a student</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="subjectSelect">Subject:</label>
                                <select id="subjectSelect" required>
                                    <option value="">Select subject</option>
                                    <option value="math">Math</option>
                                    <option value="english">English</option>
                                    <option value="science">Science</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="quarterSelect">Quarter:</label>
                                <select id="quarterSelect" required>
                                    <option value="">Select quarter</option>
                                    <option value="1">Quarter 1</option>
                                    <option value="2">Quarter 2</option>
                                    <option value="3">Quarter 3</option>
                                    <option value="4">Quarter 4</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="gradingPeriod">Grading Period:</label>
                                <input type="text" id="gradingPeriod" placeholder="e.g., 2024-2025" required>
                            </div>
                        </div>
                        <div id="gradeInputs" class="grade-inputs">
                            <!-- Dynamic grade inputs based on grading attributes -->
                        </div>
                        <div class="calculated-grade">
                            <label>Calculated Final Grade:</label>
                            <div class="final-grade-display" id="finalGradeDisplay">0.00</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeGradeModal()">Cancel</button>
                    <button type="submit" form="gradeForm" class="btn-save">Save Grade</button>
                </div>
            </div>
        </div>

        <!-- Bulk Grade Entry Modal -->
        <div id="bulkGradeModal" class="grade-modal">
            <div class="grade-modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h3><i class="fas fa-upload"></i> Bulk Grade Entry</h3>
                    <button class="modal-close" id="closeBulkGradeModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="bulk-grade-info" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: var(--primary);">
                            <i class="fas fa-info-circle"></i> Bulk Grade Entry Instructions
                        </h4>
                        <p style="margin: 0; font-size: 0.9rem;">
                            Select a subject, quarter, and grading period. Then enter grades for all students in your class for the selected criteria.
                        </p>
                    </div>
                    
                    <form id="bulkGradeForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="bulkSubjectSelect">Subject:</label>
                                <select id="bulkSubjectSelect" required>
                                    <option value="">Select subject</option>
                                    <option value="math">Math</option>
                                    <option value="english">English</option>
                                    <option value="science">Science</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="bulkQuarterSelect">Quarter:</label>
                                <select id="bulkQuarterSelect" required>
                                    <option value="">Select quarter</option>
                                    <option value="1">Quarter 1</option>
                                    <option value="2">Quarter 2</option>
                                    <option value="3">Quarter 3</option>
                                    <option value="4">Quarter 4</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="bulkGradingPeriod">Grading Period:</label>
                                <input type="text" id="bulkGradingPeriod" placeholder="e.g., 2024-2025" required>
                            </div>
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="button" id="generateBulkInputs" class="btn-save" style="width: 100%;">
                                    <i class="fas fa-table"></i> Generate Grade Inputs
                                </button>
                            </div>
                        </div>
                        
                        <div id="bulkGradeInputs" class="bulk-grade-inputs" style="display: none;">
                            <h4 style="margin-bottom: 15px; color: var(--primary);">Student Grades:</h4>
                            <div id="bulkStudentsList">
                                <!-- Dynamic student grade inputs will be generated here -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeBulkGradeModal()">Cancel</button>
                    <button type="submit" form="bulkGradeForm" class="btn-save" id="saveBulkGrades" style="display: none;">
                        <i class="fas fa-save"></i> Save All Grades
                    </button>
                </div>
            </div>
        </div>

        <!-- Grade History Modal -->
        <div id="gradeHistoryModal" class="grade-modal">
            <div class="grade-modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h3><i class="fas fa-history"></i> Grade History & Audit Trail</h3>
                    <button class="modal-close" id="closeGradeHistoryModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="history-filters" style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <div class="form-group" style="flex: 1; min-width: 150px;">
                            <label for="historyStudentFilter">Student:</label>
                            <select id="historyStudentFilter" class="filter-select">
                                <option value="">All Students</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 150px;">
                            <label for="historySubjectFilter">Subject:</label>
                            <select id="historySubjectFilter" class="filter-select">
                                <option value="">All Subjects</option>
                                <option value="math">Math</option>
                                <option value="english">English</option>
                                <option value="science">Science</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 150px;">
                            <label for="historyQuarterFilter">Quarter:</label>
                            <select id="historyQuarterFilter" class="filter-select">
                                <option value="">All Quarters</option>
                                <option value="1">Quarter 1</option>
                                <option value="2">Quarter 2</option>
                                <option value="3">Quarter 3</option>
                                <option value="4">Quarter 4</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 150px;">
                            <label for="historyActionFilter">Action:</label>
                            <select id="historyActionFilter" class="filter-select">
                                <option value="">All Actions</option>
                                <option value="created">Created</option>
                                <option value="updated">Updated</option>
                                <option value="deleted">Deleted</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="history-table-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <table class="grading-table" style="margin: 0;">
                            <thead style="position: sticky; top: 0; z-index: 10;">
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Student</th>
                                    <th>Subject</th>
                                    <th>Quarter</th>
                                    <th>Action</th>
                                    <th>Final Grade</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="gradeHistoryBody">
                                <!-- History entries will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="history-summary" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="margin: 0 0 10px 0; color: var(--primary);">Summary</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div>
                                <strong>Total Entries:</strong> <span id="historyTotalEntries">0</span>
                            </div>
                            <div>
                                <strong>Created:</strong> <span id="historyCreated">0</span>
                            </div>
                            <div>
                                <strong>Updated:</strong> <span id="historyUpdated">0</span>
                            </div>
                            <div>
                                <strong>Deleted:</strong> <span id="historyDeleted">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeGradeHistoryModal()">Close</button>
                    <button type="button" class="btn-save" onclick="exportGradeHistory()">
                        <i class="fas fa-download"></i> Export History
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <div class="footer-wrap">
                <div class="footer-col">
                    <h4 class="footer-brand">Eduktaktika</h4>
                    <p>Interactive, gamebased learning for Math, English, and Science.</p>
                </div>
                <div class="footer-col">
                    <h4>Connect</h4>
                    <ul class="footer-social">
                        <li><a href="homepage.html">Homepage</a></li>
                        <li><a href="studentlist.html">Student</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Subjects</h4>
                    <ul class="footer-links">
                        <li><a href="subject_math.html">Math</a></li>
                        <li><a href="subject_english.html">English</a></li>
                        <li><a href="subject_science.html">Science</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Leaderboards</h4>
                    <ul class="footer-links">
                        <li><a href="leaderboard_math.html">Math</a></li>
                        <li><a href="leaderboard_english.html">English</a></li>
                        <li><a href="leaderboard_science.html">Science</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <div class="footer-social-row">
                    <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                    <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="#" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
                </div>
                <p> 2025 Eduktaktika. All rights reserved.</p>
            </div>
        </footer>

        <!-- Custom Warning Modal -->
        <div id="warningModal" class="warning-modal">
            <div class="warning-modal-content">
                <div class="warning-header">
                    <div class="warning-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3>Delete Required Attribute</h3>
                </div>
                <div class="warning-body">
                    <p id="warningMessage">Are you sure you want to delete this attribute?</p>
                    <div class="warning-details">
                        <p><strong> WARNING:</strong> This action cannot be undone and may affect your grading system.</p>
                    </div>
                </div>
                <div class="warning-footer">
                    <button type="button" class="btn-cancel" onclick="closeWarningModal()">Cancel</button>
                    <button type="button" class="btn-delete" onclick="confirmDelete()">Delete</button>
                </div>
            </div>
        </div>

        <!-- Edit Profile Modal -->
        <link rel="stylesheet" href="../CSS/editProfile.css">
        <div id="editProfileModal" class="edit-profile-modal">
            <div class="edit-profile-card">
                <button type="button" class="close-btn" onclick="closeEditProfileModal()">&times;</button>
                <h3>Edit Profile</h3>
                <form id="editProfileForm">
                    <label>First Name:
                        <input type="text" id="edit_fname" required>
                    </label>
                    <label>Middle Name:
                        <input type="text" id="edit_mname">
                    </label>
                    <label>Last Name:
                        <input type="text" id="edit_lname" required>
                    </label>
                    <label>Grade Level:
                        <input type="text" id="edit_gradelevel" required>
                    </label>
                    <label>Section:
                        <input type="text" id="edit_section" required>
                    </label>
                    <div class="edit-profile-actions">
                        <button type="button" onclick="closeEditProfileModal()">Cancel</button>
                        <button type="submit">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <!-- Firebase Configuration -->
    <script>
        // Firebase config is already initialized in profile.js
        // Use the existing db and auth variables from profile.js
    </script>

    <!-- Include existing scripts -->
    <script src="../assets/js/Teacher Side/profile.js"></script>
    <script src="../assets/js/Teacher Side/header.js"></script>
    <script src="../assets/js/Teacher Side/editProfile.js"></script>
    <script src="../assets/js/navbar.js"></script>
    <script src="../assets/js/Teacher Side/grading-sheet-demo.js"></script>

    <!-- Grading System JavaScript -->
    <script>
        // Default grading attributes
        const defaultAttributes = [
            { name: 'Attendance', percentage: 10, required: true },
            { name: 'Quiz', percentage: 20, required: true },
            { name: 'Midterm Exam (Semi-finals)', percentage: 25, required: true },
            { name: 'Final Exam (Periodical)', percentage: 30, required: true },
            { name: 'Activities', percentage: 15, required: true },
            { name: 'Recitation', percentage: 0, required: false }
        ];

        let gradingAttributes = [];
        let currentTeacherUID = null;
        let currentSection = null;
        let pendingDeleteAttribute = null;

        // Initialize the grading system
        function initializeGradingSystem() {
            // Load from localStorage or use defaults
            const saved = localStorage.getItem('gradingAttributes');
            if (saved) {
                try {
                    gradingAttributes = JSON.parse(saved);
                } catch (e) {
                    gradingAttributes = [...defaultAttributes];
                }
            } else {
                gradingAttributes = [...defaultAttributes];
            }
            
            renderAttributes();
            updateSummary();
        }

        // Render attributes list
        function renderAttributes() {
            const container = document.getElementById('attributesList');
            container.innerHTML = '';

            gradingAttributes.forEach((attr, index) => {
                const item = document.createElement('div');
                item.className = 'attribute-item';
                // Calculate max allowed for this attribute
                const otherTotal = gradingAttributes.reduce((sum, otherAttr, i) => {
                    return i === index ? sum : sum + otherAttr.percentage;
                }, 0);
                const maxAllowed = 100 - otherTotal;
                
                item.innerHTML = `
                    <div class="attribute-name" id="attr-name-${index}">
                        ${attr.name}
                        <div class="attribute-actions">
                            <button class="edit-btn" onclick="editAttributeName(${index})" title="Edit attribute name">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="remove-btn" onclick="removeAttributeByName('${attr.name}')" title="Remove attribute">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <input type="text" 
                           class="attribute-name-input" 
                           id="attr-input-${index}"
                           value="${attr.name}"
                           maxlength="50"
                           onblur="saveAttributeName(${index})"
                           onkeypress="handleAttributeNameKeypress(event, ${index})">
                    <div class="attribute-input">
                        <input type="number" 
                               class="percentage-input" 
                               value="${attr.percentage}" 
                               min="0" 
                               max="${maxAllowed}" 
                               data-index="${index}"
                               data-max-allowed="${maxAllowed}"
                               onchange="updatePercentage(${index}, this.value)"
                               oninput="showMaxAllowed(${index}, this)"
                               title="Maximum allowed: ${maxAllowed}%">
                        <span>%</span>
                        <span class="max-indicator" id="max-${index}" style="font-size: 0.8rem; color: var(--text-light); margin-left: 5px;">
                            ${maxAllowed < 100 ? `(max: ${maxAllowed}%)` : ''}
                        </span>
                    </div>
                `;
                item.setAttribute('data-index', index);
                container.appendChild(item);
            });

            updatePreview();
        }

        // Update max allowed values for all inputs
        function updateMaxAllowedValues() {
            gradingAttributes.forEach((attr, index) => {
                const input = document.querySelector(`input[data-index="${index}"]`);
                const maxIndicator = document.getElementById(`max-${index}`);
                
                if (input && maxIndicator) {
                    // Calculate new max allowed for this attribute
                    const otherTotal = gradingAttributes.reduce((sum, otherAttr, i) => {
                        return i === index ? sum : sum + otherAttr.percentage;
                    }, 0);
                    const maxAllowed = 100 - otherTotal;
                    
                    // Update input attributes
                    input.setAttribute('max', maxAllowed);
                    input.setAttribute('data-max-allowed', maxAllowed);
                    input.setAttribute('title', `Maximum allowed: ${maxAllowed}%`);
                    
                    // Update max indicator
                    maxIndicator.innerHTML = maxAllowed < 100 ? `(max: ${maxAllowed}%)` : '';
                    maxIndicator.style.color = 'var(--text-light)';
                    maxIndicator.style.fontWeight = 'normal';
                }
            });
        }

        // Show maximum allowed value as user types
        function showMaxAllowed(index, input) {
            const maxAllowed = parseInt(input.dataset.maxAllowed);
            const currentValue = parseFloat(input.value) || 0;
            const maxIndicator = document.getElementById(`max-${index}`);
            
            if (maxIndicator) {
                if (currentValue > maxAllowed) {
                    maxIndicator.style.color = 'var(--error)';
                    maxIndicator.style.fontWeight = 'bold';
                    maxIndicator.innerHTML = `(max: ${maxAllowed}% - will be adjusted!)`;
                } else if (currentValue === maxAllowed && maxAllowed < 100) {
                    maxIndicator.style.color = 'var(--warning)';
                    maxIndicator.style.fontWeight = 'bold';
                    maxIndicator.innerHTML = `(max: ${maxAllowed}% - at limit)`;
                } else {
                    maxIndicator.style.color = 'var(--text-light)';
                    maxIndicator.style.fontWeight = 'normal';
                    maxIndicator.innerHTML = maxAllowed < 100 ? `(max: ${maxAllowed}%)` : '';
                }
            }
        }

        // Update percentage for an attribute
        function updatePercentage(index, value) {
            const numValue = parseFloat(value) || 0;
            
            // Calculate current total without this attribute
            const otherTotal = gradingAttributes.reduce((sum, attr, i) => {
                return i === index ? sum : sum + attr.percentage;
            }, 0);
            
            // Maximum allowed value for this attribute to not exceed 100%
            const maxAllowed = 100 - otherTotal;
            
            // Clamp the value between 0 and the maximum allowed
            const clampedValue = Math.max(0, Math.min(maxAllowed, Math.min(100, numValue)));
            
            gradingAttributes[index].percentage = clampedValue;
            
            // Update the input field to reflect the clamped value
            const input = document.querySelector(`input[data-index="${index}"]`);
            input.value = gradingAttributes[index].percentage;
            
            // Show warning if user tried to enter a value that would exceed 100%
            if (numValue > clampedValue && numValue > 0) {
                showTemporaryMessage(`Value adjusted to ${clampedValue}% to prevent exceeding 100% total.`, 'warning');
            }
            
            updateSummary();
            updatePreview();
            saveToLocalStorage();
            
            // Regenerate grading table to reflect percentage changes
            generateGradingTable();
            
            // Update max allowed values for all other inputs without full re-render
            updateMaxAllowedValues();
        }

        // Add new attribute
        function addAttribute() {
            const nameInput = document.getElementById('newAttributeName');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Please enter an attribute name.');
                return;
            }

            // Check if attribute already exists
            if (gradingAttributes.some(attr => attr.name.toLowerCase() === name.toLowerCase())) {
                alert('An attribute with this name already exists.');
                return;
            }

            gradingAttributes.push({
                name: name,
                percentage: 0,
                required: false
            });

            nameInput.value = '';
            renderAttributes();
            updateSummary();
            saveToLocalStorage();
            
            // Regenerate grading table to reflect changes
            generateGradingTable();
        }

        // Remove attribute by name (more reliable than by index)
        function removeAttributeByName(attributeName) {
            const index = gradingAttributes.findIndex(attr => attr.name === attributeName);
            if (index === -1) {
                console.error('Could not find attribute with name:', attributeName);
                return;
            }
            
            const attribute = gradingAttributes[index];
            pendingDeleteAttribute = attribute;
            
            // Show custom warning modal
            showWarningModal(attribute);
        }

        // Show custom warning modal
        function showWarningModal(attribute) {
            const modal = document.getElementById('warningModal');
            const message = document.getElementById('warningMessage');
            
            // Update modal content
            message.textContent = `Are you sure you want to delete "${attribute.name}"?`;
            
            // Show the modal
            modal.classList.add('show');
            
            // Focus on cancel button for accessibility
            setTimeout(() => {
                document.querySelector('.btn-cancel').focus();
            }, 100);
        }

        // Close warning modal
        function closeWarningModal() {
            const modal = document.getElementById('warningModal');
            modal.classList.remove('show');
            pendingDeleteAttribute = null;
        }

        // Confirm delete action
        function confirmDelete() {
            if (!pendingDeleteAttribute) return;
            
            const attribute = pendingDeleteAttribute;
            const index = gradingAttributes.findIndex(attr => attr.name === attribute.name);
            
            if (index === -1) {
                console.error('Could not find attribute with name:', attribute.name);
                closeWarningModal();
                return;
            }

            // Find the item by attribute name
            const item = document.querySelector(`.attribute-item[data-index="${index}"]`);
            if (item) {
                item.classList.add('removing');
            }
            
            // Close modal first
            closeWarningModal();
            
            setTimeout(() => {
                gradingAttributes.splice(index, 1);
                renderAttributes();
                updateSummary();
                saveToLocalStorage();
                
                // Regenerate grading table to reflect changes
                generateGradingTable();
                
                // Show success message
                const message = attribute.required ? 
                    `Required attribute "${attribute.name}" deleted successfully!` : 
                    `Attribute "${attribute.name}" deleted successfully!`;
                showTemporaryMessage(message, 'success');
            }, 300);
        }

        // Legacy function for backward compatibility
        function removeAttribute(index) {
            if (index >= 0 && index < gradingAttributes.length) {
                removeAttributeByName(gradingAttributes[index].name);
            }
        }

        // Edit attribute name
        function editAttributeName(index) {
            const nameElement = document.getElementById(`attr-name-${index}`);
            const inputElement = document.getElementById(`attr-input-${index}`);
            
            if (nameElement && inputElement) {
                // Hide name display and show input
                nameElement.classList.add('editing');
                inputElement.classList.add('editing');
                
                // Focus and select text in input
                inputElement.focus();
                inputElement.select();
            }
        }

        // Save attribute name
        function saveAttributeName(index) {
            const nameElement = document.getElementById(`attr-name-${index}`);
            const inputElement = document.getElementById(`attr-input-${index}`);
            const newName = inputElement.value.trim();
            
            if (nameElement && inputElement) {
                // Validate name
                if (!newName) {
                    alert('Attribute name cannot be empty.');
                    inputElement.value = gradingAttributes[index].name;
                    cancelEdit(index);
                    return;
                }

                // Check if name already exists (excluding current attribute)
                if (gradingAttributes.some((attr, i) => i !== index && attr.name.toLowerCase() === newName.toLowerCase())) {
                    alert('An attribute with this name already exists.');
                    inputElement.value = gradingAttributes[index].name;
                    cancelEdit(index);
                    return;
                }

                // Update the attribute name
                gradingAttributes[index].name = newName;
                
                // Hide input and show updated name
                cancelEdit(index);
                
                // Update the name display
                nameElement.textContent = newName;
                nameElement.appendChild(createAttributeActions(index));
                
                // Save to localStorage
                saveToLocalStorage();
                
                // Regenerate grading table to reflect name changes
                generateGradingTable();
                
                showTemporaryMessage('Attribute name updated successfully!', 'success');
            }
        }

        // Cancel edit mode
        function cancelEdit(index) {
            const nameElement = document.getElementById(`attr-name-${index}`);
            const inputElement = document.getElementById(`attr-input-${index}`);
            
            if (nameElement && inputElement) {
                nameElement.classList.remove('editing');
                inputElement.classList.remove('editing');
            }
        }

        // Handle keypress events for attribute name input
        function handleAttributeNameKeypress(event, index) {
            if (event.key === 'Enter') {
                event.preventDefault();
                saveAttributeName(index);
            } else if (event.key === 'Escape') {
                event.preventDefault();
                cancelEdit(index);
            }
        }

        // Create attribute actions HTML
        function createAttributeActions(index) {
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'attribute-actions';
            const isRequired = gradingAttributes[index].required;
            
            actionsDiv.innerHTML = `
                <button class="edit-btn" onclick="editAttributeName(${index})" title="Edit attribute name">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="remove-btn" onclick="removeAttributeByName('${gradingAttributes[index].name}')" title="Remove attribute">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            return actionsDiv;
        }

        // Show temporary message
        function showTemporaryMessage(message, type = 'warning') {
            const messageElement = document.getElementById('validationMessage');
            const originalContent = messageElement.innerHTML;
            const originalClass = messageElement.className;
            
            messageElement.className = `validation-message ${type}`;
            const icon = type === 'warning' ? 'fa-exclamation-triangle' : 
                        type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
            messageElement.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            
            setTimeout(() => {
                messageElement.className = originalClass;
                messageElement.innerHTML = originalContent;
            }, 3000);
        }

        // Update summary panel
        function updateSummary() {
            const total = gradingAttributes.reduce((sum, attr) => sum + attr.percentage, 0);
            const totalElement = document.getElementById('totalValue');
            const messageElement = document.getElementById('validationMessage');
            const saveBtn = document.getElementById('saveBtn');

            totalElement.textContent = total + '%';
            
            // Update validation
            if (total === 100) {
                totalElement.className = 'total-value valid';
                messageElement.className = 'validation-message success';
                messageElement.innerHTML = '<i class="fas fa-check-circle"></i> Perfect! Total equals 100%';
                saveBtn.disabled = false;
            } else if (total < 100) {
                totalElement.className = 'total-value invalid';
                messageElement.className = 'validation-message warning';
                messageElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Need ${100 - total}% more to reach 100%`;
                saveBtn.disabled = true;
            } else {
                totalElement.className = 'total-value invalid';
                messageElement.className = 'validation-message error';
                messageElement.innerHTML = `<i class="fas fa-times-circle"></i> Exceeds 100% by ${total - 100}%`;
                saveBtn.disabled = true;
            }

            // Update input field styles
            document.querySelectorAll('.percentage-input').forEach((input, index) => {
                const value = parseFloat(input.value) || 0;
                const maxAllowed = parseInt(input.dataset.maxAllowed) || 100;
                
                // Remove all styling classes first
                input.classList.remove('error', 'warning');
                
                if (value < 0 || value > 100) {
                    input.classList.add('error');
                } else if (value > maxAllowed) {
                    input.classList.add('error');
                } else if (value === maxAllowed && maxAllowed < 100) {
                    input.classList.add('warning');
                }
            });
        }

        // Update preview in summary panel
        function updatePreview() {
            const container = document.getElementById('attributesPreview');
            container.innerHTML = '';

            gradingAttributes.forEach(attr => {
                if (attr.percentage > 0) {
                    const item = document.createElement('div');
                    item.className = 'attribute-preview';
                    item.innerHTML = `
                        <span class="preview-name">${attr.name}</span>
                        <span class="preview-percentage">${attr.percentage}%</span>
                    `;
                    container.appendChild(item);
                }
            });

            if (container.children.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); font-style: italic;">No attributes with percentage > 0</p>';
            }
        }

        // Save to localStorage
        function saveToLocalStorage() {
            localStorage.setItem('gradingAttributes', JSON.stringify(gradingAttributes));
        }

        // Save to Firebase
        async function saveToFirebase() {
            if (!currentTeacherUID || !currentSection) {
                alert('Teacher information not available. Please refresh and try again.');
                return;
            }

            const total = gradingAttributes.reduce((sum, attr) => sum + attr.percentage, 0);
            if (total !== 100) {
                alert('Cannot save: Total percentage must equal 100%');
                return;
            }

            try {
                const gradingData = {
                    attributes: gradingAttributes,
                    lastUpdated: new Date().toISOString(),
                    totalPercentage: total
                };

                await db.ref(`teachers/${currentTeacherUID}/sections/${currentSection}/gradingSystem`).set(gradingData);
                
                // Regenerate grading table to reflect saved changes
                generateGradingTable();
                
                // Show success message
                const messageElement = document.getElementById('validationMessage');
                const originalContent = messageElement.innerHTML;
                const originalClass = messageElement.className;
                
                messageElement.className = 'validation-message success';
                messageElement.innerHTML = '<i class="fas fa-check-circle"></i> Configuration saved successfully!';
                
                setTimeout(() => {
                    messageElement.className = originalClass;
                    messageElement.innerHTML = originalContent;
                }, 3000);

            } catch (error) {
                console.error('Error saving to Firebase:', error);
                alert('Error saving configuration. Please try again.');
            }
        }

        // Load from Firebase
        async function loadFromFirebase() {
            if (!currentTeacherUID || !currentSection) return;

            try {
                const snapshot = await db.ref(`teachers/${currentTeacherUID}/sections/${currentSection}/gradingSystem`).once('value');
                const data = snapshot.val();
                
                if (data && data.attributes) {
                    gradingAttributes = data.attributes;
                    renderAttributes();
                    updateSummary();
                    
                    // Regenerate grading table to reflect loaded attributes
                    generateGradingTable();
                    
                    // Clear localStorage since we loaded from Firebase
                    localStorage.removeItem('gradingAttributes');
                }
            } catch (error) {
                console.error('Error loading from Firebase:', error);
            }
        }

        // Reset to default
        function resetToDefault() {
            if (confirm('Are you sure you want to reset to default grading attributes? This will overwrite your current configuration.')) {
                gradingAttributes = [...defaultAttributes];
                renderAttributes();
                updateSummary();
                saveToLocalStorage();
                
                // Regenerate grading table to reflect changes
                generateGradingTable();
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize grading system
            initializeGradingSystem();
            
            // Initialize grading sheet
            setTimeout(() => {
                initializeGradingSheet();
            }, 1000);

            // Add attribute button
            document.getElementById('addAttributeBtn').addEventListener('click', addAttribute);

            // Warning modal event listeners
            const warningModal = document.getElementById('warningModal');
            
            // Click outside to close
            warningModal.addEventListener('click', function(e) {
                if (e.target === warningModal) {
                    closeWarningModal();
                }
            });
            
            // Keyboard support
            document.addEventListener('keydown', function(e) {
                if (warningModal.classList.contains('show')) {
                    if (e.key === 'Escape') {
                        closeWarningModal();
                    } else if (e.key === 'Enter' && e.target.classList.contains('btn-delete')) {
                        confirmDelete();
                    }
                }
            });

            // Enter key in add input
            document.getElementById('newAttributeName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addAttribute();
                }
            });

            // Save button
            document.getElementById('saveBtn').addEventListener('click', saveToFirebase);

            // Reset button
            document.getElementById('resetBtn').addEventListener('click', resetToDefault);

            // Firebase auth state change
            auth.onAuthStateChanged(async function(user) {
                if (user) {
                    currentTeacherUID = user.uid;
                    
                    // Get teacher info
                    const teacherSnap = await db.ref('teachers/' + user.uid).once('value');
                    const teacher = teacherSnap.val();
                    
                    if (teacher && teacher.section) {
                        currentSection = teacher.section;
                        // Load configuration from Firebase
                        await loadFromFirebase();
                    }
                }
            });
        });

        // Grading Sheet Variables
        let studentsData = [];
        let gradesData = [];
        let filteredGrades = [];

        // Initialize grading sheet
        function initializeGradingSheet() {
            setupGradingSheetEventListeners();
            loadStudentsData();
            loadGradesData();
            generateGradingTable();
        }

        // Setup event listeners for grading sheet
        function setupGradingSheetEventListeners() {
            // Filter controls
            document.getElementById('subjectFilter').addEventListener('change', filterGrades);
            document.getElementById('quarterFilter').addEventListener('change', filterGrades);
            document.getElementById('gradeLevelFilter').addEventListener('change', filterGrades);
            document.getElementById('refreshGradesBtn').addEventListener('click', refreshGradingData);
            
            // Action buttons
            document.getElementById('exportGradesBtn').addEventListener('click', exportToCSV);
            document.getElementById('bulkGradeBtn').addEventListener('click', openBulkGradeModal);
            document.getElementById('gradeHistoryBtn').addEventListener('click', openGradeHistoryModal);
            document.getElementById('addGradeBtn').addEventListener('click', openGradeModal);
            
            // Modal controls
            document.getElementById('closeGradeModal').addEventListener('click', closeGradeModal);
            document.getElementById('closeBulkGradeModal').addEventListener('click', closeBulkGradeModal);
            document.getElementById('gradeForm').addEventListener('submit', saveGrade);
            document.getElementById('bulkGradeForm').addEventListener('submit', saveBulkGrades);
            document.getElementById('generateBulkInputs').addEventListener('click', generateBulkGradeInputs);
            
            // Grade inputs change listener for real-time calculation
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('grade-input-field')) {
                    calculateFinalGrade();
                }
            });

            // Close modal when clicking outside
            document.getElementById('gradeModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeGradeModal();
                }
            });
        }

        // Load students data from Firebase
        async function loadStudentsData() {
            if (!currentTeacherUID || !currentSection) return;

            try {
                // Get teacher information first
                const teacherSnap = await db.ref('teachers/' + currentTeacherUID).once('value');
                const teacher = teacherSnap.val();
                const teacherGrade = teacher && teacher.gradelevel ? teacher.gradelevel : null;
                const teacherSchoolYear = teacher && teacher.school_year ? teacher.school_year : null;

                const snapshot = await db.ref('students').once('value');
                studentsData = [];
                
                snapshot.forEach(child => {
                    const student = child.val();
                    
                    // Filter by section, grade level, and school year
                    const sectionMatch = student.section && student.section.trim().toLowerCase() === currentSection.trim().toLowerCase();
                    const gradeMatch = !teacherGrade || student.gradelevel === teacherGrade;
                    const schoolYearMatch = !teacherSchoolYear || student.school_year === teacherSchoolYear;
                    
                    if (sectionMatch && gradeMatch && schoolYearMatch) {
                        studentsData.push({
                            uid: child.key,
                            ...student
                        });
                    }
                });

                console.log(`Loaded ${studentsData.length} students for section: ${currentSection}, grade: ${teacherGrade}, school year: ${teacherSchoolYear}`);

                // Populate student dropdown in modal
                populateStudentDropdown();
                
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        // Load grades data from Firebase
        async function loadGradesData() {
            if (!currentTeacherUID || !currentSection) return;

            try {
                const snapshot = await db.ref(`teachers/${currentTeacherUID}/sections/${currentSection}/grades`).once('value');
                gradesData = [];
                
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        gradesData.push({
                            id: child.key,
                            ...child.val()
                        });
                    });
                }

                filterGrades();
                
            } catch (error) {
                console.error('Error loading grades:', error);
            }
        }

        // Filter grades based on subject, quarter, and grade level
        function filterGrades() {
            const subjectFilter = document.getElementById('subjectFilter').value;
            const quarterFilter = document.getElementById('quarterFilter').value;
            const gradeLevelFilter = document.getElementById('gradeLevelFilter').value;

            filteredGrades = gradesData.filter(grade => {
                const matchSubject = !subjectFilter || grade.subject === subjectFilter;
                const matchQuarter = !quarterFilter || grade.quarter === quarterFilter;
                
                // Find the student to check their grade level
                const student = studentsData.find(s => s.uid === grade.studentUID);
                const matchGradeLevel = !gradeLevelFilter || (student && student.gradelevel === gradeLevelFilter);
                
                return matchSubject && matchQuarter && matchGradeLevel;
            });

            generateGradingTable();
            updateSummaryStats();
        }

        // Generate grading table based on current grading attributes
        function generateGradingTable() {
            const tableHead = document.getElementById('gradingTableHead');
            const tableBody = document.getElementById('gradingTableBody');
            
            // Debug: Log current grading attributes
            console.log('Generating table with attributes:', gradingAttributes);

            // Generate table headers
            let headerHTML = '<tr><th>Student Name</th><th>Subject</th><th>Quarter</th>';
            
            gradingAttributes.forEach(attr => {
                if (attr.percentage > 0) {
                    headerHTML += `<th>${attr.name} (${attr.percentage}%)</th>`;
                }
            });
            
            headerHTML += '<th>Final Grade</th><th>Actions</th></tr>';
            tableHead.innerHTML = headerHTML;

            // Generate table body
            tableBody.innerHTML = '';

            if (filteredGrades.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="${gradingAttributes.filter(a => a.percentage > 0).length + 5}" style="text-align: center; padding: 40px; color: var(--text-light);">
                    <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                    No grade data available. Click "Add Grade Entry" to get started.
                </td>`;
                tableBody.appendChild(row);
                return;
            }

            filteredGrades.forEach(grade => {
                const student = studentsData.find(s => s.uid === grade.studentUID);
                const studentName = student ? `${student.fname} ${student.lname}` : 'Unknown Student';

                const row = document.createElement('tr');
                let rowHTML = `
                    <td class="student-name">${studentName}</td>
                    <td>${grade.subject ? grade.subject.charAt(0).toUpperCase() + grade.subject.slice(1) : '-'}</td>
                    <td>Q${grade.quarter || '-'}</td>
                `;

                let finalGrade = 0;
                gradingAttributes.forEach(attr => {
                    if (attr.percentage > 0) {
                        const gradeValue = grade.grades && grade.grades[attr.name] ? grade.grades[attr.name] : 0;
                        const cellClass = getGradeClass(gradeValue);
                        rowHTML += `<td class="${cellClass}">${gradeValue.toFixed(1)}</td>`;
                        finalGrade += (gradeValue * attr.percentage / 100);
                    }
                });

                const finalGradeClass = `final-grade ${getGradeClass(finalGrade)}`;
                rowHTML += `
                    <td class="${finalGradeClass}">${finalGrade.toFixed(2)}</td>
                    <td>
                        <button class="edit-grade-btn" onclick="editGrade('${grade.id}')" title="Edit Grade">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-grade-btn" onclick="deleteGrade('${grade.id}')" title="Delete Grade" style="margin-left: 5px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;

                row.innerHTML = rowHTML;
                tableBody.appendChild(row);
            });
        }

        // Get CSS class based on grade value
        function getGradeClass(grade) {
            if (grade >= 90) return 'grade-excellent';
            if (grade >= 75) return 'grade-good';
            if (grade >= 60) return 'grade-fair';
            return '';
        }

        // Update summary statistics
        function updateSummaryStats() {
            const totalStudents = new Set(filteredGrades.map(g => g.studentUID)).size;
            document.getElementById('totalStudents').textContent = totalStudents;

            if (filteredGrades.length === 0) {
                document.getElementById('averageGrade').textContent = '0.0';
                document.getElementById('passingRate').textContent = '0%';
                document.getElementById('highestGrade').textContent = '0.0';
                document.getElementById('lowestGrade').textContent = '0.0';
                document.getElementById('gradeRange').textContent = '0.0';
                updateGradeDistribution([], 0);
                return;
            }

            // Calculate final grades for all entries
            const finalGrades = filteredGrades.map(grade => {
                let finalGrade = 0;
                gradingAttributes.forEach(attr => {
                    if (attr.percentage > 0) {
                        const gradeValue = grade.grades && grade.grades[attr.name] ? grade.grades[attr.name] : 0;
                        finalGrade += (gradeValue * attr.percentage / 100);
                    }
                });
                return finalGrade;
            });

            // Basic statistics
            const average = finalGrades.reduce((sum, grade) => sum + grade, 0) / finalGrades.length;
            const highest = Math.max(...finalGrades);
            const lowest = Math.min(...finalGrades);
            const gradeRange = highest - lowest;

            // Passing rate (assuming 75 is passing)
            const passingGrades = finalGrades.filter(grade => grade >= 75).length;
            const passingRate = (passingGrades / finalGrades.length) * 100;

            // Update display
            document.getElementById('averageGrade').textContent = average.toFixed(1);
            document.getElementById('passingRate').textContent = passingRate.toFixed(0) + '%';
            document.getElementById('highestGrade').textContent = highest.toFixed(1);
            document.getElementById('lowestGrade').textContent = lowest.toFixed(1);
            document.getElementById('gradeRange').textContent = gradeRange.toFixed(1);

            // Update grade distribution
            updateGradeDistribution(finalGrades, Math.max(...finalGrades));
        }

        // Update grade distribution chart
        function updateGradeDistribution(finalGrades, maxGrade) {
            if (finalGrades.length === 0) {
                // Reset all bars
                document.getElementById('excellentBar').style.height = '0px';
                document.getElementById('goodBar').style.height = '0px';
                document.getElementById('fairBar').style.height = '0px';
                document.getElementById('poorBar').style.height = '0px';
                document.getElementById('excellentCount').textContent = '0';
                document.getElementById('goodCount').textContent = '0';
                document.getElementById('fairCount').textContent = '0';
                document.getElementById('poorCount').textContent = '0';
                return;
            }

            // Count grades in each category
            const excellent = finalGrades.filter(g => g >= 90).length;
            const good = finalGrades.filter(g => g >= 80 && g < 90).length;
            const fair = finalGrades.filter(g => g >= 70 && g < 80).length;
            const poor = finalGrades.filter(g => g < 70).length;

            // Update counts
            document.getElementById('excellentCount').textContent = excellent;
            document.getElementById('goodCount').textContent = good;
            document.getElementById('fairCount').textContent = fair;
            document.getElementById('poorCount').textContent = poor;

            // Calculate bar heights (max 100px)
            const maxCount = Math.max(excellent, good, fair, poor);
            const maxHeight = 100;

            const excellentHeight = maxCount > 0 ? (excellent / maxCount) * maxHeight : 0;
            const goodHeight = maxCount > 0 ? (good / maxCount) * maxHeight : 0;
            const fairHeight = maxCount > 0 ? (fair / maxCount) * maxHeight : 0;
            const poorHeight = maxCount > 0 ? (poor / maxCount) * maxHeight : 0;

            // Update bar heights with animation
            setTimeout(() => {
                document.getElementById('excellentBar').style.height = excellentHeight + 'px';
                document.getElementById('goodBar').style.height = goodHeight + 'px';
                document.getElementById('fairBar').style.height = fairHeight + 'px';
                document.getElementById('poorBar').style.height = poorHeight + 'px';
            }, 100);
        }

        // Populate student dropdown
        function populateStudentDropdown() {
            const select = document.getElementById('studentSelect');
            select.innerHTML = '<option value="">Select a student</option>';
            
            studentsData.forEach(student => {
                const option = document.createElement('option');
                option.value = student.uid;
                option.textContent = `${student.fname} ${student.lname} (${student.id})`;
                select.appendChild(option);
            });
        }

        // Open grade modal
        function openGradeModal(gradeId = null) {
            const modal = document.getElementById('gradeModal');
            const modalTitle = document.getElementById('modalTitle');
            
            if (gradeId) {
                modalTitle.textContent = 'Edit Grade Entry';
                loadGradeData(gradeId);
            } else {
                modalTitle.textContent = 'Add Grade Entry';
                document.getElementById('gradeForm').reset();
                document.getElementById('finalGradeDisplay').textContent = '0.00';
            }
            
            generateGradeInputs();
            modal.classList.add('show');
        }

        // Close grade modal
        function closeGradeModal() {
            const modal = document.getElementById('gradeModal');
            modal.classList.remove('show');
            document.getElementById('gradeForm').reset();
        }

        // Generate grade inputs based on current grading attributes
        function generateGradeInputs() {
            const container = document.getElementById('gradeInputs');
            container.innerHTML = '<h4>Grade Components:</h4>';

            gradingAttributes.forEach(attr => {
                if (attr.percentage > 0) {
                    const inputItem = document.createElement('div');
                    inputItem.className = 'grade-input-item';
                    inputItem.innerHTML = `
                        <span class="grade-input-label">${attr.name}</span>
                        <span class="grade-weight">${attr.percentage}%</span>
                        <input type="number" 
                               class="grade-input-field" 
                               name="grade_${attr.name}" 
                               min="0" 
                               max="100" 
                               step="0.1" 
                               placeholder="0.0"
                               required>
                    `;
                    container.appendChild(inputItem);
                }
            });
        }

        // Calculate final grade in real-time
        function calculateFinalGrade() {
            let finalGrade = 0;
            
            // Debug: Log calculation details
            console.log('Calculating final grade with attributes:', gradingAttributes.map(a => `${a.name}: ${a.percentage}%`));
            
            gradingAttributes.forEach(attr => {
                if (attr.percentage > 0) {
                    const input = document.querySelector(`input[name="grade_${attr.name}"]`);
                    if (input) {
                        const value = parseFloat(input.value) || 0;
                        finalGrade += (value * attr.percentage / 100);
                    }
                }
            });

            document.getElementById('finalGradeDisplay').textContent = finalGrade.toFixed(2);
        }

        // Save grade entry
        async function saveGrade(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const studentUID = formData.get('studentSelect') || document.getElementById('studentSelect').value;
            const subject = formData.get('subjectSelect') || document.getElementById('subjectSelect').value;
            const quarter = formData.get('quarterSelect') || document.getElementById('quarterSelect').value;
            const gradingPeriod = formData.get('gradingPeriod') || document.getElementById('gradingPeriod').value;

            if (!studentUID || !subject || !quarter || !gradingPeriod) {
                alert('Please fill in all required fields.');
                return;
            }

            // Collect grade values
            const grades = {};
            gradingAttributes.forEach(attr => {
                if (attr.percentage > 0) {
                    const input = document.querySelector(`input[name="grade_${attr.name}"]`);
                    if (input) {
                        grades[attr.name] = parseFloat(input.value) || 0;
                    }
                }
            });

            // Calculate final grade
            let finalGrade = 0;
            Object.keys(grades).forEach(attrName => {
                const attr = gradingAttributes.find(a => a.name === attrName);
                if (attr) {
                    finalGrade += (grades[attrName] * attr.percentage / 100);
                }
            });

            const gradeEntry = {
                studentUID,
                subject,
                quarter,
                gradingPeriod,
                grades,
                finalGrade,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            try {
                const gradeId = Date.now().toString();
                await db.ref(`teachers/${currentTeacherUID}/sections/${currentSection}/grades/${gradeId}`).set(gradeEntry);
                
                // Log the action
                await logGradeAction('created', gradeEntry, 'New grade entry created');
                
                showTemporaryMessage('Grade entry saved successfully!', 'success');
                closeGradeModal();
                loadGradesData();
                
            } catch (error) {
                console.error('Error saving grade:', error);
                alert('Error saving grade entry. Please try again.');
            }
        }

        // Edit grade entry
        function editGrade(gradeId) {
            openGradeModal(gradeId);
        }

        // Delete grade entry
        async function deleteGrade(gradeId) {
            if (!confirm('Are you sure you want to delete this grade entry?')) {
                return;
            }

            try {
                const grade = gradesData.find(g => g.id === gradeId);
                await db.ref(`teachers/${currentTeacherUID}/sections/${currentSection}/grades/${gradeId}`).remove();
                
                // Log the deletion
                if (grade) {
                    await logGradeAction('deleted', grade, 'Grade entry deleted');
                }
                
                showTemporaryMessage('Grade entry deleted successfully!', 'success');
                loadGradesData();
                
            } catch (error) {
                console.error('Error deleting grade:', error);
                alert('Error deleting grade entry. Please try again.');
            }
        }

        // Load grade data for editing
        function loadGradeData(gradeId) {
            const grade = gradesData.find(g => g.id === gradeId);
            if (!grade) return;

            document.getElementById('studentSelect').value = grade.studentUID;
            document.getElementById('subjectSelect').value = grade.subject;
            document.getElementById('quarterSelect').value = grade.quarter;
            document.getElementById('gradingPeriod').value = grade.gradingPeriod;

            // Load grade values
            setTimeout(() => {
                gradingAttributes.forEach(attr => {
                    if (attr.percentage > 0) {
                        const input = document.querySelector(`input[name="grade_${attr.name}"]`);
                        if (input && grade.grades && grade.grades[attr.name] !== undefined) {
                            input.value = grade.grades[attr.name];
                        }
                    }
                });
                calculateFinalGrade();
            }, 100);
        }

        // Refresh grading data
        function refreshGradingData() {
            loadStudentsData();
            loadGradesData();
            showTemporaryMessage('Data refreshed successfully!', 'success');
        }

        // Export to CSV
        function exportToCSV() {
            if (filteredGrades.length === 0) {
                alert('No data to export.');
                return;
            }

            let csvContent = 'Student Name,Subject,Quarter,';
            
            // Add grading attribute headers
            gradingAttributes.forEach(attr => {
                if (attr.percentage > 0) {
                    csvContent += `${attr.name} (${attr.percentage}%),`;
                }
            });
            csvContent += 'Final Grade\n';

            // Add data rows
            filteredGrades.forEach(grade => {
                const student = studentsData.find(s => s.uid === grade.studentUID);
                const studentName = student ? `${student.fname} ${student.lname}` : 'Unknown Student';
                
                let row = `"${studentName}","${grade.subject}","Q${grade.quarter}",`;
                
                let finalGrade = 0;
                gradingAttributes.forEach(attr => {
                    if (attr.percentage > 0) {
                        const gradeValue = grade.grades && grade.grades[attr.name] ? grade.grades[attr.name] : 0;
                        row += `${gradeValue},`;
                        finalGrade += (gradeValue * attr.percentage / 100);
                    }
                });
                
                row += `${finalGrade.toFixed(2)}\n`;
                csvContent += row;
            });

            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `grades_${currentSection}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Bulk Grade Entry Functions
        function openBulkGradeModal() {
            const modal = document.getElementById('bulkGradeModal');
            document.getElementById('bulkGradeForm').reset();
            document.getElementById('bulkGradeInputs').style.display = 'none';
            document.getElementById('saveBulkGrades').style.display = 'none';
            modal.classList.add('show');
        }

        function closeBulkGradeModal() {
            const modal = document.getElementById('bulkGradeModal');
            modal.classList.remove('show');
            document.getElementById('bulkGradeForm').reset();
            document.getElementById('bulkGradeInputs').style.display = 'none';
            document.getElementById('saveBulkGrades').style.display = 'none';
        }

        function generateBulkGradeInputs() {
            const subject = document.getElementById('bulkSubjectSelect').value;
            const quarter = document.getElementById('bulkQuarterSelect').value;
            const gradingPeriod = document.getElementById('bulkGradingPeriod').value;

            if (!subject || !quarter || !gradingPeriod) {
                alert('Please fill in all required fields.');
                return;
            }

            const container = document.getElementById('bulkStudentsList');
            container.innerHTML = '';

            if (studentsData.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 20px;">No students found for your class.</p>';
                return;
            }

            studentsData.forEach((student, index) => {
                const studentDiv = document.createElement('div');
                studentDiv.className = 'bulk-student-item';
                studentDiv.style.cssText = `
                    background: white;
                    border: 1px solid #e0e0e0;
                    border-radius: 8px;
                    padding: 15px;
                    margin-bottom: 15px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                `;

                let inputsHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <h5 style="margin: 0; flex: 1; color: var(--primary);">
                            ${student.fname} ${student.lname} (${student.id})
                        </h5>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                `;

                gradingAttributes.forEach(attr => {
                    if (attr.percentage > 0) {
                        inputsHTML += `
                            <div style="display: flex; flex-direction: column;">
                                <label style="font-size: 0.8rem; font-weight: 600; margin-bottom: 4px; color: var(--text-main);">
                                    ${attr.name} (${attr.percentage}%)
                                </label>
                                <input type="number" 
                                       class="bulk-grade-input" 
                                       data-student-uid="${student.uid}"
                                       data-attribute="${attr.name}"
                                       min="0" 
                                       max="100" 
                                       step="0.1" 
                                       placeholder="0.0"
                                       style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                            </div>
                        `;
                    }
                });

                inputsHTML += `
                    </div>
                    <div style="margin-top: 10px; text-align: right;">
                        <span style="font-weight: 600; color: var(--primary);">
                            Final Grade: <span class="bulk-final-grade" data-student-uid="${student.uid}">0.00</span>
                        </span>
                    </div>
                `;

                studentDiv.innerHTML = inputsHTML;
                container.appendChild(studentDiv);
            });

            // Add event listeners for real-time calculation
            container.addEventListener('input', function(e) {
                if (e.target.classList.contains('bulk-grade-input')) {
                    calculateBulkFinalGrade(e.target.dataset.studentUid);
                }
            });

            document.getElementById('bulkGradeInputs').style.display = 'block';
            document.getElementById('saveBulkGrades').style.display = 'inline-flex';
        }

        function calculateBulkFinalGrade(studentUID) {
            let finalGrade = 0;
            
            gradingAttributes.forEach(attr => {
                if (attr.percentage > 0) {
                    const input = document.querySelector(`input[data-student-uid="${studentUID}"][data-attribute="${attr.name}"]`);
                    if (input) {
                        const value = parseFloat(input.value) || 0;
                        finalGrade += (value * attr.percentage / 100);
                    }
                }
            });

            const finalGradeElement = document.querySelector(`.bulk-final-grade[data-student-uid="${studentUID}"]`);
            if (finalGradeElement) {
                finalGradeElement.textContent = finalGrade.toFixed(2);
            }
        }

        async function saveBulkGrades(e) {
            e.preventDefault();

            const subject = document.getElementById('bulkSubjectSelect').value;
            const quarter = document.getElementById('bulkQuarterSelect').value;
            const gradingPeriod = document.getElementById('bulkGradingPeriod').value;

            if (!subject || !quarter || !gradingPeriod) {
                alert('Please fill in all required fields.');
                return;
            }

            const bulkGrades = [];
            let hasValidGrades = false;

            studentsData.forEach(student => {
                const grades = {};
                let hasGrades = false;

                gradingAttributes.forEach(attr => {
                    if (attr.percentage > 0) {
                        const input = document.querySelector(`input[data-student-uid="${student.uid}"][data-attribute="${attr.name}"]`);
                        if (input && input.value) {
                            grades[attr.name] = parseFloat(input.value);
                            hasGrades = true;
                            hasValidGrades = true;
                        }
                    }
                });

                if (hasGrades) {
                    // Calculate final grade
                    let finalGrade = 0;
                    Object.keys(grades).forEach(attrName => {
                        const attr = gradingAttributes.find(a => a.name === attrName);
                        if (attr) {
                            finalGrade += (grades[attrName] * attr.percentage / 100);
                        }
                    });

                    bulkGrades.push({
                        studentUID: student.uid,
                        subject,
                        quarter,
                        gradingPeriod,
                        grades,
                        finalGrade,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                }
            });

            if (!hasValidGrades) {
                alert('Please enter at least one grade for at least one student.');
                return;
            }

            if (!confirm(`Are you sure you want to save grades for ${bulkGrades.length} students?`)) {
                return;
            }

            try {
                const batch = [];

                bulkGrades.forEach(gradeEntry => {
                    const gradeId = Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9);
                    batch.push(
                        db.ref(`teachers/${currentTeacherUID}/sections/${currentSection}/grades/${gradeId}`).set(gradeEntry)
                    );
                });

                await Promise.all(batch);
                
                // Log bulk actions
                for (const gradeEntry of bulkGrades) {
                    await logGradeAction('created', gradeEntry, 'Bulk grade entry created');
                }
                
                showTemporaryMessage(`Successfully saved grades for ${bulkGrades.length} students!`, 'success');
                closeBulkGradeModal();
                loadGradesData();
                
            } catch (error) {
                console.error('Error saving bulk grades:', error);
                alert('Error saving grades. Please try again.');
            }
        }

        // Grade History Functions
        let gradeHistoryData = [];

        function openGradeHistoryModal() {
            const modal = document.getElementById('gradeHistoryModal');
            populateHistoryStudentDropdown();
            loadGradeHistory();
            modal.classList.add('show');
        }

        function closeGradeHistoryModal() {
            const modal = document.getElementById('gradeHistoryModal');
            modal.classList.remove('show');
        }

        function populateHistoryStudentDropdown() {
            const select = document.getElementById('historyStudentFilter');
            select.innerHTML = '<option value="">All Students</option>';
            
            studentsData.forEach(student => {
                const option = document.createElement('option');
                option.value = student.uid;
                option.textContent = `${student.fname} ${student.lname} (${student.id})`;
                select.appendChild(option);
            });
        }

        async function loadGradeHistory() {
            if (!currentTeacherUID || !currentSection) return;

            try {
                const snapshot = await db.ref(`teachers/${currentTeacherUID}/sections/${currentSection}/gradeHistory`).once('value');
                gradeHistoryData = [];
                
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        gradeHistoryData.push({
                            id: child.key,
                            ...child.val()
                        });
                    });
                }

                // Sort by date (newest first)
                gradeHistoryData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                filterGradeHistory();
                
            } catch (error) {
                console.error('Error loading grade history:', error);
            }
        }

        function filterGradeHistory() {
            const studentFilter = document.getElementById('historyStudentFilter').value;
            const subjectFilter = document.getElementById('historySubjectFilter').value;
            const quarterFilter = document.getElementById('historyQuarterFilter').value;
            const actionFilter = document.getElementById('historyActionFilter').value;

            const filteredHistory = gradeHistoryData.filter(entry => {
                const matchStudent = !studentFilter || entry.studentUID === studentFilter;
                const matchSubject = !subjectFilter || entry.subject === subjectFilter;
                const matchQuarter = !quarterFilter || entry.quarter === quarterFilter;
                const matchAction = !actionFilter || entry.action === actionFilter;
                
                return matchStudent && matchSubject && matchQuarter && matchAction;
            });

            displayGradeHistory(filteredHistory);
            updateHistorySummary(filteredHistory);
        }

        function displayGradeHistory(historyEntries) {
            const tbody = document.getElementById('gradeHistoryBody');
            tbody.innerHTML = '';

            if (historyEntries.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-light);">
                            <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            No grade history found.
                        </td>
                    </tr>
                `;
                return;
            }

            historyEntries.forEach(entry => {
                const student = studentsData.find(s => s.uid === entry.studentUID);
                const studentName = student ? `${student.fname} ${student.lname}` : 'Unknown Student';
                
                const date = new Date(entry.timestamp);
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                
                const actionClass = entry.action === 'created' ? 'grade-excellent' : 
                                  entry.action === 'updated' ? 'grade-good' : 'grade-fair';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-size: 0.9rem;">${formattedDate}</td>
                    <td class="student-name">${studentName}</td>
                    <td>${entry.subject ? entry.subject.charAt(0).toUpperCase() + entry.subject.slice(1) : '-'}</td>
                    <td>Q${entry.quarter || '-'}</td>
                    <td><span class="${actionClass}" style="padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; text-transform: uppercase;">${entry.action}</span></td>
                    <td class="final-grade">${entry.finalGrade ? entry.finalGrade.toFixed(2) : '-'}</td>
                    <td style="font-size: 0.8rem; color: var(--text-light);">${entry.details || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateHistorySummary(historyEntries) {
            const total = historyEntries.length;
            const created = historyEntries.filter(e => e.action === 'created').length;
            const updated = historyEntries.filter(e => e.action === 'updated').length;
            const deleted = historyEntries.filter(e => e.action === 'deleted').length;

            document.getElementById('historyTotalEntries').textContent = total;
            document.getElementById('historyCreated').textContent = created;
            document.getElementById('historyUpdated').textContent = updated;
            document.getElementById('historyDeleted').textContent = deleted;
        }

        async function logGradeAction(action, gradeData, details = '') {
            if (!currentTeacherUID || !currentSection) return;

            try {
                const historyEntry = {
                    action: action,
                    studentUID: gradeData.studentUID,
                    subject: gradeData.subject,
                    quarter: gradeData.quarter,
                    gradingPeriod: gradeData.gradingPeriod,
                    finalGrade: gradeData.finalGrade,
                    details: details,
                    timestamp: new Date().toISOString(),
                    teacherUID: currentTeacherUID
                };

                const historyId = Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9);
                await db.ref(`teachers/${currentTeacherUID}/sections/${currentSection}/gradeHistory/${historyId}`).set(historyEntry);
                
            } catch (error) {
                console.error('Error logging grade action:', error);
            }
        }

        function exportGradeHistory() {
            const studentFilter = document.getElementById('historyStudentFilter').value;
            const subjectFilter = document.getElementById('historySubjectFilter').value;
            const quarterFilter = document.getElementById('historyQuarterFilter').value;
            const actionFilter = document.getElementById('historyActionFilter').value;

            const filteredHistory = gradeHistoryData.filter(entry => {
                const matchStudent = !studentFilter || entry.studentUID === studentFilter;
                const matchSubject = !subjectFilter || entry.subject === subjectFilter;
                const matchQuarter = !quarterFilter || entry.quarter === quarterFilter;
                const matchAction = !actionFilter || entry.action === actionFilter;
                
                return matchStudent && matchSubject && matchQuarter && matchAction;
            });

            if (filteredHistory.length === 0) {
                alert('No history data to export.');
                return;
            }

            let csvContent = 'Date,Time,Student,Subject,Quarter,Action,Final Grade,Details\n';
            
            filteredHistory.forEach(entry => {
                const student = studentsData.find(s => s.uid === entry.studentUID);
                const studentName = student ? `${student.fname} ${student.lname}` : 'Unknown Student';
                const date = new Date(entry.timestamp);
                
                csvContent += `"${date.toLocaleDateString()}","${date.toLocaleTimeString()}","${studentName}","${entry.subject}","Q${entry.quarter}","${entry.action}","${entry.finalGrade || ''}","${entry.details || ''}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `grade_history_${currentSection}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Add event listeners for history filters and profile sidebar
        document.addEventListener('DOMContentLoaded', function() {
            // History filter event listeners
            document.getElementById('historyStudentFilter').addEventListener('change', filterGradeHistory);
            document.getElementById('historySubjectFilter').addEventListener('change', filterGradeHistory);
            document.getElementById('historyQuarterFilter').addEventListener('change', filterGradeHistory);
            document.getElementById('historyActionFilter').addEventListener('change', filterGradeHistory);
            
            // Profile sidebar event listeners
            const profileBtn = document.getElementById('profileBtn');
            const closeSidebar = document.getElementById('closeSidebar');
            const profileSidebar = document.getElementById('profileSidebar');
            const logoutSwitch = document.getElementById('logoutSwitch');
            
            if (profileBtn) {
                profileBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    profileSidebar.classList.add('active');
                });
            }
            
            if (closeSidebar) {
                closeSidebar.addEventListener('click', function() {
                    profileSidebar.classList.remove('active');
                });
            }
            
            // Close sidebar when clicking outside
            window.addEventListener('click', function(e) {
                if (profileSidebar.classList.contains('active') && 
                    !profileSidebar.contains(e.target) && 
                    e.target.id !== 'profileBtn') {
                    profileSidebar.classList.remove('active');
                }
            });
            
            // Logout functionality
            if (logoutSwitch) {
                logoutSwitch.addEventListener('click', function() {
                    auth.signOut().then(function() {
                        window.location.href = "logreg.html";
                    }).catch(function(error) {
                        console.error('Error signing out:', error);
                    });
                });
            }
        });

        // Make functions globally available
        window.editGrade = editGrade;
        window.deleteGrade = deleteGrade;
        window.closeGradeModal = closeGradeModal;
        window.closeBulkGradeModal = closeBulkGradeModal;
        window.closeGradeHistoryModal = closeGradeHistoryModal;
        window.exportGradeHistory = exportGradeHistory;

        // Load Teacher Profile Information
        function loadTeacherProfile() {
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    console.log('Loading profile for user:', user.uid);
                    db.ref('teachers/' + user.uid).once('value').then(function(snapshot) {
                        const data = snapshot.val();
                        console.log('Teacher data loaded:', data);
                        if (data) {
                            // Update profile sidebar information
                            if (document.getElementById('profileName')) {
                                document.getElementById('profileName').textContent = (data.fname || '') + ' ' + (data.lname || '');
                            }
                            if (document.getElementById('profileId')) {
                                document.getElementById('profileId').textContent = data.id || user.uid;
                            }
                            if (document.getElementById('profileFirstName')) {
                                document.getElementById('profileFirstName').textContent = data.fname || '-';
                            }
                            if (document.getElementById('profileMiddleName')) {
                                document.getElementById('profileMiddleName').textContent = data.mname || '-';
                            }
                            if (document.getElementById('profileLastName')) {
                                document.getElementById('profileLastName').textContent = data.lname || '-';
                            }
                            if (document.getElementById('profileGrade')) {
                                document.getElementById('profileGrade').textContent = data.gradelevel || data.grade || '-';
                            }
                            if (document.getElementById('profileSection')) {
                                document.getElementById('profileSection').textContent = data.section || '-';
                            }
                            if (document.getElementById('profileAvatar')) {
                                document.getElementById('profileAvatar').src = "https://api.dicebear.com/7.x/bottts/svg?seed=" + encodeURIComponent(data.fname || "user");
                            }
                            
                            // Update address information
                            if (data.address) {
                                if (document.getElementById('profileAddressStreet')) {
                                    document.getElementById('profileAddressStreet').textContent = data.address.street || '-';
                                }
                                if (document.getElementById('profileAddressBarangay')) {
                                    document.getElementById('profileAddressBarangay').textContent = data.address.barangay || '-';
                                }
                                if (document.getElementById('profileAddressCity')) {
                                    document.getElementById('profileAddressCity').textContent = data.address.city || '-';
                                }
                                if (document.getElementById('profileAddressProvince')) {
                                    document.getElementById('profileAddressProvince').textContent = data.address.province || '-';
                                }
                                if (document.getElementById('profileAddressZip')) {
                                    document.getElementById('profileAddressZip').textContent = data.address.zip || '-';
                                }
                                if (document.getElementById('profileAddressRegion')) {
                                    document.getElementById('profileAddressRegion').textContent = data.address.region || '-';
                                }
                            } else {
                                // Set default values if no address data
                                const addressFields = ['profileAddressStreet', 'profileAddressBarangay', 'profileAddressCity', 
                                                     'profileAddressProvince', 'profileAddressZip', 'profileAddressRegion'];
                                addressFields.forEach(fieldId => {
                                    if (document.getElementById(fieldId)) {
                                        document.getElementById(fieldId).textContent = '-';
                                    }
                                });
                            }
                        } else {
                            console.log('No teacher data found for user:', user.uid);
                        }
                    }).catch(function(error) {
                        console.error('Error loading teacher profile:', error);
                    });
                } else {
                    console.log('No user authenticated');
                }
            });
        }

        // Advanced Session Management
        document.addEventListener("DOMContentLoaded", function() {
            function checkAuthReady(cb) {
                if (window.firebase && firebase.auth && auth) cb();
                else setTimeout(() => checkAuthReady(cb), 100);
            }
            checkAuthReady(function() {
                auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(() => {
                    auth.onAuthStateChanged(function(user) {
                        if (!user) {
                            window.location.href = "logreg.html";
                        } else {
                            user.getIdTokenResult().then(idTokenResult => {
                                if (idTokenResult.claims.role && idTokenResult.claims.role !== "teacher") {
                                    alert("Access denied. Not a teacher account.");
                                    auth.signOut();
                                    window.location.href = "logreg.html";
                                }
                            });

                            sessionStorage.setItem("edutaktikaUser", JSON.stringify({
                                uid: user.uid,
                                email: user.email,
                                displayName: user.displayName,
                                photoURL: user.photoURL
                            }));

                            // Load teacher profile information
                            loadTeacherProfile();
                        }
                    });

                    window.addEventListener('storage', function(e) {
                        if (e.key === 'firebase:authUser:' + firebase.app().options.apiKey + ':[DEFAULT]' && !e.newValue) {
                            window.location.href = "logreg.html";
                        }
                    });
                });
            });
        });
    </script>
</body>
</html>
