<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clock Quiz - Set the Time</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="../../CSS/header.css">
  <link rel="stylesheet" href="../../CSS/subject.css">
  <link rel="stylesheet" href="../../CSS/dropdown.css">
  <link rel="stylesheet" href="../SAMPLE%20GAMES/draggable-analog-clock/draggable-analog-clock.css">
  <style>
    :root {
      --primary: #2e8b57;
      --secondary: #ffd700;
      --peach: #ff69b4;
      --forest-green: #3f4d34;
      --sun-yellow: #ffd700;
      --white: #ffffff;
    }
    body { font-family: 'Baloo 2', Arial, sans-serif; background:#f5f7fb; margin:0; }
    main { padding:100px 20px 40px; min-height:calc(100vh - 260px); }
    .page-wrapper { display:flex; align-items:center; justify-content:center; }
    .game-container { background: var(--white); border-radius: 16px; box-shadow: 0 4px 24px var(--peach); padding: 32px; text-align: center; max-width: 560px; width: 96vw; position: relative; }
    .title { color: var(--primary); margin-bottom: 18px; }
    .hud { display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px; color:#333; font-weight:600; }
    .clock-wrap { display:flex; align-items:center; justify-content:center; }
    #uploadStatus { font-size:13px;margin-top:10px;color:#444; }
    #viewAttemptsBtn { display:none; margin-top:12px; background:#6d28d9; color:#fff; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; }

    /* Modals */
    .modal-bg { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); z-index:100000; align-items:center; justify-content:center; }
    .modal-content { background:#fff; padding: 48px 40px; border-radius: 18px; max-width: 520px; width: 96vw; box-shadow: 0 4px 24px var(--peach); text-align:center; position:relative; }
    .modal-content h2 { font-size: 2.0rem; color: var(--primary); margin-bottom: 18px; }
    .modal-btn { padding: 14px 36px; border-radius: 12px; background: var(--primary); color: var(--white); border: none; font-size: 1.4rem; font-weight: bold; margin-top: 16px; cursor: pointer; }
    .small { font-size: 0.95rem; color:#444; }

    /* Attempts modal */
    #attemptsModal { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); z-index:100001; align-items:center; justify-content:center; }
    #attemptsModal .modal-content { max-width:640px; text-align:left; }
    .attempt-row { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid #eee; font-size:0.95rem; }
    .close-x { position:absolute; right:12px; top:8px; border:none; background:none; font-size:22px; cursor:pointer; }

    /* Ensure dropdown behaves like subject pages */
    header nav ul { display:flex; align-items:center; padding:0; margin:0; }
    header nav ul li { list-style:none; margin:0 10px; position:relative; height:100%; display:flex; align-items:center; }
    header nav ul li a, header nav ul li .dropbtn { display:flex; align-items:center; height:48px; line-height:48px; padding:0 18px; color:#2d3923; text-decoration:none; font-size:1rem; background:none; border:none; cursor:pointer; }
    header nav ul li .dropdown-content { display:none; position:absolute; background:#fff; min-width:140px; box-shadow:0 4px 16px #0002; z-index:1000; border-radius:8px; padding:6px 0; margin:0; top:100%; left:0; }
    header nav ul li .dropdown-content li { list-style:none; border-bottom:1px solid #eee; }
    header nav ul li .dropdown-content li:last-child { border-bottom:none; }
    header nav ul li .dropdown-content a { color:#2d3923; padding:10px 16px; display:block; text-decoration:none; border-radius:0; transition:background 0.2s; height:auto; line-height:normal; }
    header nav ul li .dropdown-content a:hover { background:#f0f0f0; }
    header nav ul li.dropdown:hover .dropdown-content { display:block; }

    /* Hide the clock widget's automatic "Correct!" feedback bubble */
    .dac-feedback { display:none !important; }
  </style>
</head>
<body>
  <!-- Top header styled like subject_math.html -->
  <header>
    <div class="floating-elements">
      <div class="floating-element"></div>
      <div class="floating-element"></div>
      <div class="floating-element"></div>
      <div class="floating-element"></div>
    </div>
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon"><i class="fas fa-graduation-cap"></i></div>
        <div class="logo-text"><span>E</span><span>d</span><span>u</span><span>t</span><span>a</span><span>k</span><span>t</span><span>i</span><span>k</span><span>a</span></div>
      </div>
      <nav id="dynamic-nav">
        <!-- Navigation will be populated based on user role -->
      </nav>
    </div>
  </header>

  <main>
    <div class="page-wrapper">
      <!-- Start Modal -->
      <div id="start-modal" class="modal-bg" style="display:flex;">
        <div class="modal-content">
          <h2 id="modal-title">Set the Clock</h2>
          <p class="small" id="modal-description">Practice setting an analog clock to the requested time. 10 questions, earn points, and track your attempts.</p>
          <button id="start-btn" class="modal-btn">Start</button>
          <button id="answer-sheet-btn" class="modal-btn" style="background:#6d28d9; display:none;">Answer Sheet</button>
        </div>
      </div>
      <!-- Instructions Modal -->
      <div id="instructions-modal" class="modal-bg">
        <div class="modal-content">
          <h2>How it works</h2>
          <ul style="text-align:left; line-height:1.6;">
            <li>Drag the hour or minute hand (or use arrow keys) to set the time.</li>
            <li>Snap: 5-minute increments. Tolerance: ±2 minutes is counted correct.</li>
            <li>Click Submit for each question. Your score is saved if you are logged in.</li>
          </ul>
          <button id="close-instructions-btn" class="modal-btn">Continue</button>
        </div>
      </div>
      <!-- Final Modal -->
      <div id="final-modal" class="modal-bg">
        <div class="modal-content">
          <h2>Great job!</h2>
          <p id="final-score" class="small"></p>
          <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
            <button id="play-again-btn" class="modal-btn">Play Again</button>
            <button id="to-lessons-btn" class="modal-btn" style="background:#6d28d9;">Back to Lessons</button>
          </div>
        </div>
      </div>

      <!-- Attempts Modal -->
      <div id="attemptsModal">
        <div class="modal-content">
          <button class="close-x" onclick="closeAttemptsModal()">✕</button>
          <h2>Your Attempts</h2>
          <div id="attemptsList" class="small">Loading...</div>
        </div>
      </div>

      <div class="game-container" style="display:none;">
        <div class="hud">
          <div>Question <span id="qIndex">1</span>/<span id="qTotal">10</span></div>
          <div>Score: <span id="scoreEl">0</span></div>
        </div>
        <h2 class="title">Clock Quiz</h2>
        <div class="clock-wrap">
          <div id="clock-container" style="width:240px;height:300px;position:relative;margin:auto;"></div>
        </div>
        <div id="uploadStatus"></div>
        <button id="viewAttemptsBtn">View Attempts</button>
        <div id="teacher-navigation" style="display:none; margin-top:20px; text-align:center;">
          <button id="prev-question-btn" class="modal-btn" style="background:#6d28d9; margin-right:10px;">Previous</button>
          <button id="next-question-btn" class="modal-btn" style="background:#6d28d9;">Next</button>
        </div>
      </div>
    </div>
  </main>

      <!-- Answer Sheet Modal -->
      <div id="answer-sheet-modal" class="modal-bg">
        <div class="modal-content">
          <h2>Answer Sheet</h2>
          <div id="answer-sheet-content" class="small" style="text-align:left; line-height:1.6;">
            <!-- Answer sheet content will be populated here -->
          </div>
          <button id="close-answer-sheet-btn" class="modal-btn">Close</button>
        </div>
      </div>

  <!-- Draggable Analog Clock -->
  <script src="../SAMPLE%20GAMES/draggable-analog-clock/draggable-analog-clock.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    // Firebase init (same project as other pages)
    const firebaseConfig = { apiKey:"AIzaSyB5BbeLLvPX8l1c4Lq0f-CmIUml4hQOQlE", authDomain:"edutaktika.firebaseapp.com", databaseURL:"https://edutaktika-default-rtdb.firebaseio.com", projectId:"edutaktika", storageBucket:"edutaktika.appspot.com", messagingSenderId:"676848575316", appId:"1:676848575316:web:f78f8c0f83bf3d9dfb5ec1", measurementId:"G-X3GT5TNN87" };
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // Attempts/summary storage (mirrors lesson1.html style)
    const QUIZ_KEY = 'clock-quiz';
    const USE_STUDENT_PATH = true;
    function requireAuthUid(){ const u = auth.currentUser; if(!u){ document.getElementById('uploadStatus').textContent='Login required to save score.'; return null;} return u.uid; }
    function primaryAttemptRef(uid){ return db.ref(`quizAttempts/${QUIZ_KEY}/${uid}`).push(); }
    function studentAttemptRef(uid){ return db.ref(`students/${uid}/quizzes/${QUIZ_KEY}/attempts`).push(); }
    function summaryRefPrimary(uid){ return db.ref(`quizSummaries/${QUIZ_KEY}/${uid}`); }
    function summaryRefStudent(uid){ return db.ref(`students/${uid}/quizzes/${QUIZ_KEY}/summary`); }
    function saveAttempt(rawScore,total){
      const uid = requireAuthUid(); if(!uid) return;
      const payload = { score:rawScore, total:total, percentage: Math.round(rawScore/total*100), timestamp: Date.now() };
      const statusEl = document.getElementById('uploadStatus');
      statusEl.textContent='Saving attempt...';
      const tryPrimary = !USE_STUDENT_PATH;
      const doPrimary = () => primaryAttemptRef(uid).set(payload).then(()=> updateSummary(uid,payload,true));
      const doStudent = () => studentAttemptRef(uid).set(payload).then(()=> updateSummary(uid,payload,false));
      (tryPrimary ? doPrimary().catch(err=>{ if(err && err.code==='PERMISSION_DENIED') return doStudent(); throw err; }) : doStudent())
        .then(()=>{ statusEl.textContent='Attempt saved.'; })
        .catch(e=>{ statusEl.textContent='Save failed: ' + e.message; });
    }
    function updateSummary(uid,payload,usedPrimary){
      const ref = (USE_STUDENT_PATH || !usedPrimary) ? summaryRefStudent(uid) : summaryRefPrimary(uid);
      let bestDelta = 0;
      return ref.transaction(current => {
        current = current || {};
        const best = Math.max(current.best || 0, payload.score);
        bestDelta = best - (current.best || 0);
        return {
          best,
          bestPercentage: Math.round(best/payload.total*100),
          last: payload.score,
          lastPercentage: payload.percentage,
          total: payload.total,
          attempts: (current.attempts||0)+1,
          lastTimestamp: payload.timestamp
        };
      }).then(()=>{ if(bestDelta>0){ db.ref(`students/${uid}/points`).transaction(p => (p||0)+bestDelta); } });
    }
    function openAttemptsModal(){ document.getElementById('attemptsModal').style.display='flex'; loadAttempts(); }
    function closeAttemptsModal(){ document.getElementById('attemptsModal').style.display='none'; }
    window.closeAttemptsModal = closeAttemptsModal;
    function loadAttempts(){
      const uid = requireAuthUid(); if(!uid) return;
      const listDiv = document.getElementById('attemptsList'); listDiv.textContent='Loading...';
      const path = (USE_STUDENT_PATH ? `students/${uid}/quizzes/${QUIZ_KEY}/attempts` : `quizAttempts/${QUIZ_KEY}/${uid}`);
      db.ref(path).orderByChild('timestamp').once('value').then(snap=>{
        const rows = [];
        snap.forEach(child=> rows.push(child.val()));
        rows.sort((a,b)=> (b.timestamp||0)-(a.timestamp||0));
        if(rows.length===0){ listDiv.textContent='No attempts yet.'; return; }
        listDiv.innerHTML = rows.map((a,i)=>{
          const ds = new Date(a.timestamp).toLocaleString();
          return `<div class='attempt-row'><span>#${rows.length - i}</span><span>${a.score}/${a.total}</span><span>${a.percentage}%</span><span>${ds}</span></div>`;
        }).join('');
      }).catch(e=>{ listDiv.textContent='Load failed: '+ e.message; });
    }
  </script>

  <script>
    // Quiz logic using draggable analog clock
    const TOTAL_QUESTIONS = 10;
    const SNAP_MIN = 5; // snap minutes
    const TOLERANCE_MIN = 2; // +/- minutes accepted

    let currentIndex = 0;
    let score = 0;
    let clockApi = null;

    const qIndexEl = document.getElementById('qIndex');
    const qTotalEl = document.getElementById('qTotal');
    const scoreEl = document.getElementById('scoreEl');
    qTotalEl.textContent = String(TOTAL_QUESTIONS);

    // Generate target times (spread across hours/minutes on 5-min grid)
    function genQuestions(n){
      const qs = [];
      // Pick some varied targets
      const candidates = [
        {h:1,m:0},{h:2,m:15},{h:3,m:30},{h:4,m:45},{h:5,m:20},
        {h:6,m:50},{h:7,m:5},{h:8,m:40},{h:9,m:35},{h:10,m:10},
        {h:11,m:55},{h:12,m:25}
      ];
      // Shuffle
      for(let i=candidates.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [candidates[i],candidates[j]]=[candidates[j],candidates[i]]; }
      for(let i=0;i<n;i++){ const c = candidates[i % candidates.length]; qs.push({hour:c.h, minute:c.m}); }
      return qs;
    }

    const QUESTIONS = genQuestions(TOTAL_QUESTIONS);

    // UI flows
    document.getElementById('close-instructions-btn').onclick = function(){
      document.getElementById('instructions-modal').style.display='none';
      document.querySelector('.game-container').style.display='';
      startQuiz();
    };

    document.getElementById('play-again-btn').onclick = () => { location.reload(); };

    document.getElementById('to-lessons-btn').onclick = () => { 
        if (isTeacher) {
            window.location.href='../../Teacher/subject_math.html#quizzes';
        } else {
            window.location.href='../../Student/subject_math.html#quizzes';
        }
    };

    document.getElementById('viewAttemptsBtn').addEventListener('click', openAttemptsModal);

    auth.onAuthStateChanged(u=>{ if(u){ document.getElementById('viewAttemptsBtn').style.display='inline-block'; }});

    // Teacher functionality
    let isTeacher = false;
    let currentQuestionIndex = 0;

    // Check if user is teacher and setup UI accordingly
    auth.onAuthStateChanged(async function(user) {
        if (user) {
            const uid = user.uid;
            const teacherSnap = await db.ref('teachers/' + uid).once('value');
            const teacher = teacherSnap.val();
            
            if (teacher && teacher.role === "teacher") {
                isTeacher = true;
                setupTeacherUI();
                addTeacherNavigation();
            } else {
                setupStudentUI();
            }
            addDynamicNavigation();
        }
    });

    function setupTeacherUI() {
        // Update start modal for teachers
        document.getElementById('modal-title').textContent = 'Teacher View - Clock Quiz';
        document.getElementById('modal-description').textContent = 'View the clock quiz questions and answers. You can navigate through questions and see the answer sheet.';
        document.getElementById('start-btn').textContent = 'View Quiz';
        document.getElementById('answer-sheet-btn').style.display = 'inline-block';
        
        // Show teacher navigation
        document.getElementById('teacher-navigation').style.display = 'block';
    }

    function setupStudentUI() {
        // Hide answer sheet button for students
        document.getElementById('answer-sheet-btn').style.display = 'none';
    }

    function addTeacherNavigation() {
        // Navigation will be handled in the quiz logic
    }

    function addDynamicNavigation() {
        const nav = document.getElementById('dynamic-nav');
        if (!nav) return;
        
        if (isTeacher) {
            nav.innerHTML = `
                <ul>
                    <li><a href="../../Teacher/homepage.html">Home</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropbtn">Subject <i class="fa fa-caret-down"></i></a>
                        <ul class="dropdown-content">
                            <li><a href="../../Teacher/subject_math.html">Math</a></li>
                            <li><a href="../../Teacher/subject_english.html">English</a></li>
                            <li><a href="../../Teacher/subject_science.html">Science</a></li>
                        </ul>
                    </li>
                    <li><a href="../../Teacher/studentlist.html">Students</a></li>
                    <li><a href="../../Teacher/leaderboard.html">Leaderboard</a></li>
                </ul>
            `;
        } else {
            nav.innerHTML = `
                <ul>
                    <li><a href="../../Student/homepage.html">Home</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropbtn">Subject <i class="fa fa-caret-down"></i></a>
                        <ul class="dropdown-content">
                            <li><a href="../../Student/subject_math.html">Math</a></li>
                            <li><a href="../../Student/subject_english.html">English</a></li>
                            <li><a href="../../Student/subject_science.html">Science</a></li>
                        </ul>
                    </li>
                    <li><a href="../../Student/studentlist.html">Student</a></li>
                    <li><a href="../../Student/leaderboard.html">Leaderboard</a></li>
                </ul>
            `;
        }
    }

    function showAnswerSheet() {
        const content = document.getElementById('answer-sheet-content');
        let html = '<h3>Clock Quiz Answer Sheet</h3><ol>';
        
        QUESTIONS.forEach((q, index) => {
            const timeStr = formatTime(q.hour, q.minute);
            html += `<li><strong>Question ${index + 1}:</strong> Set the clock to <strong>${timeStr}</strong></li>`;
        });
        
        html += '</ol>';
        content.innerHTML = html;
        document.getElementById('answer-sheet-modal').style.display = 'flex';
    }

    function formatTime(hour, minute) {
        const period = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
        const displayMinute = minute.toString().padStart(2, '0');
        return `${displayHour}:${displayMinute} ${period}`;
    }

    function updateTeacherNavigation() {
        if (!isTeacher) return;
        
        const prevBtn = document.getElementById('prev-question-btn');
        const nextBtn = document.getElementById('next-question-btn');
        
        prevBtn.disabled = currentQuestionIndex === 0;
        nextBtn.disabled = currentQuestionIndex >= TOTAL_QUESTIONS - 1;
    }

    // Event listeners for teacher functionality
    document.addEventListener('click', function(e) {
        if (e.target.id === 'answer-sheet-btn') {
            showAnswerSheet();
        } else if (e.target.id === 'close-answer-sheet-btn') {
            document.getElementById('answer-sheet-modal').style.display = 'none';
        } else if (e.target.id === 'prev-question-btn' && isTeacher) {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion(currentQuestionIndex);
                updateTeacherNavigation();
            }
        } else if (e.target.id === 'next-question-btn' && isTeacher) {
            if (currentQuestionIndex < TOTAL_QUESTIONS - 1) {
                currentQuestionIndex++;
                loadQuestion(currentQuestionIndex);
                updateTeacherNavigation();
            }
        } else if (e.target.id === 'start-btn') {
            if (isTeacher) {
                // Teachers skip instructions and go directly to quiz
                document.getElementById('start-modal').style.display = 'none';
                document.querySelector('.game-container').style.display = '';
                startQuiz();
            } else {
                // Students see instructions first
                document.getElementById('start-modal').style.display = 'none';
                document.getElementById('instructions-modal').style.display = 'flex';
            }
        }
    });

    function startQuiz(){
      // Build/attach clock
      const container = document.getElementById('clock-container');
      container.innerHTML = '';
      clockApi = createDraggableClock(container, {
        id: 'clock-quiz',
        targetTime: { hour: QUESTIONS[0].hour, minute: QUESTIONS[0].minute },
        toleranceMinutes: TOLERANCE_MIN,
        snapToMinutes: SNAP_MIN,
        clockMode: '12h',
        initialTime: { hour: 12, minute: 0 }
      });
      
      if (isTeacher) {
        // Teachers can't submit answers, just view
        clockApi.disableSubmit();
        // Set clock to correct time for teachers
        clockApi._setTime(QUESTIONS[0].hour, QUESTIONS[0].minute);
        currentQuestionIndex = 0;
        updateTeacherNavigation();
      } else {
        // Students can submit answers
        clockApi.onSubmit(function(state){
          const target = QUESTIONS[currentIndex];
          const t = clockApi.getState();
          const diff = Math.abs((t.hour*60 + t.minute) - (target.hour*60 + target.minute));
          const correct = diff <= TOLERANCE_MIN;
          if(correct) score++;
          nextQuestion();
        });
      }
      
      // First render
      updateHud();
    }

    function loadQuestion(index) {
      if (!isTeacher || !clockApi) return;
      
      currentQuestionIndex = index;
      const question = QUESTIONS[index];
      
      // Update clock to show correct answer
      clockApi._setTime(question.hour, question.minute);
      clockApi.setTarget({ hour: question.hour, minute: question.minute });
      
      // Update HUD
      updateHud();
      updateTeacherNavigation();
    }

    function nextQuestion(){
      currentIndex++;
      if(currentIndex >= TOTAL_QUESTIONS){
        endQuiz();
        return;
      }
      // Update target
      clockApi.setTarget({ hour: QUESTIONS[currentIndex].hour, minute: QUESTIONS[currentIndex].minute });
      // Optionally randomize initial time a bit
      const randH = (Math.floor(Math.random()*12) || 12);
      const randM = (Math.floor(Math.random()*12)*5) % 60;
      clockApi._setTime(randH, randM);
      updateHud();
    }

    function updateHud(){
      qIndexEl.textContent = String(currentIndex+1);
      scoreEl.textContent = String(score);
    }

    function endQuiz(){
      if (isTeacher) return; // Teachers don't see final modal
      
      const pct = Math.round(score / TOTAL_QUESTIONS * 100);
      document.getElementById('final-score').textContent = `Your Score: ${score}/${TOTAL_QUESTIONS} (${pct}%)`;
      document.getElementById('final-modal').style.display='flex';
      saveAttempt(score, TOTAL_QUESTIONS);
    }
  </script>

  <script>
    // Make dropdown work on click (mobile-friendly) in addition to hover
    (function(){
      const dropBtn = document.querySelector('nav .dropbtn');
      const menu = document.querySelector('nav .dropdown .dropdown-content');
      if (!dropBtn || !menu) return;
      dropBtn.addEventListener('click', function(e){
        e.preventDefault(); e.stopPropagation();
        const visible = menu.style.display === 'block';
        menu.style.display = visible ? 'none' : 'block';
      });
      document.addEventListener('click', function(){
        if (menu) menu.style.display = 'none';
      });
    })();
  </script>
</body>
</html>
