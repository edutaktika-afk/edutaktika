<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Drag & Drop Multiple Choice Quiz</title>
<style>
:root{
  --accent:#1e88e5;
  --accent-alt:#1565c0;
  --bg:#f2f7fc;
  --panel:#ffffff;
  --muted:#607389;
  --danger:#e74c3c;
  --ok:#2e7d32;
  --radius:14px;
  --transition:140ms cubic-bezier(.25,.8,.25,1);
}
/* Full canvas fit (no scroll outside) */
html,body{
  height:100%;width:100%;margin:0;padding:0;overflow:hidden;
  background:var(--bg);
  font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
  -webkit-font-smoothing:antialiased;
}
*{box-sizing:border-box;}
#app{
  width:100%;height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
/* Inner container fills parent (we adjust size in JS for canvas) */
#quizApp{
  width:100%;height:100%;max-width:1200px;max-height:860px;
  background:linear-gradient(180deg,#ffffff 0%,#f0f6fb 100%);
  box-shadow:0 10px 38px -8px rgba(18,38,60,.12);
  border-radius:10px;
  padding:18px;
  display:flex;
  flex-direction:column;
  gap:14px;
  overflow:hidden;
}
header{display:flex;align-items:center;gap:14px}
h1{margin:0;font-size:20px;color:#16354a;font-weight:700}
.controls{margin-left:auto;display:flex;gap:8px}
button{
  background:var(--accent);color:#fff;border:0;
  padding:8px 14px;border-radius:8px;font-weight:600;
  cursor:pointer;font-size:14px;letter-spacing:.2px;
  transition:var(--transition);
}
button:hover{background:var(--accent-alt)}
button.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent)}
button.ghost:hover{background:var(--accent);color:#fff}
button.danger{background:var(--danger);}
button.small{padding:4px 10px;font-size:12px}
main{
  flex:1;display:flex;gap:14px;min-height:0;
}
.left{flex:1;display:flex;flex-direction:column;gap:12px;min-height:0}
.right{width:300px;min-width:260px;display:flex;flex-direction:column;gap:12px}
.panel{
  background:var(--panel);border-radius:var(--radius);padding:14px;
  box-shadow:0 4px 16px rgba(16,42,68,.06);
  position:relative;display:flex;flex-direction:column;
  overflow:hidden;min-height:0
}
.panel.scroll{overflow:auto}
#questionPrompt{font-size:18px;font-weight:600;color:#18394f;line-height:1.35;margin:0 0 10px}
.meta-bar{display:flex;align-items:center;justify-content:space-between;font-size:13px;color:var(--muted);margin-bottom:6px;flex-wrap:wrap;gap:4px}
#choicesTray{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-content:flex-start;
  overflow:auto;
  padding:10px;
  min-height:160px;
  max-height:360px;
  background:#ffffff;
  border:1px solid #dbe7f0;
  border-radius:12px;
}
.choice{
  background:#fff;border:2px solid rgba(30,136,229,.18);
  border-radius:10px;padding:10px 12px;
  cursor:grab;user-select:none;
  display:flex;align-items:center;gap:8px;font-weight:600;
  font-size:14px;color:#16354a;position:relative;
  box-shadow:0 4px 10px -4px rgba(18,38,60,.10);
  transition:var(--transition);
  max-width:240px;
}
.choice[data-selected="true"]{opacity:.55;cursor:not-allowed}
.choice.correct{border-color:var(--ok);background:#e5f6e9}
.choice.incorrect{border-color:var(--danger);background:#ffeceb}
.drop-zone-wrap{
  display:flex;flex-direction:column;gap:10px;
  padding:4px 2px;overflow:auto;min-height:140px;
}
.drop-zone{
  flex:1;
  background:#f4f9fd;
  border:2px dashed rgba(0,85,145,.25);
  border-radius:14px;
  padding:16px;
  min-height:120px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-content:flex-start;
  transition:var(--transition);
  position:relative;
  overflow:auto;
}
.drop-zone.dragover{background:#e2f2ff;border-color:var(--accent)}
.drop-zone.correct{box-shadow:0 0 0 2px var(--ok) inset}
.drop-zone.incorrect{box-shadow:0 0 0 2px var(--danger) inset}
.token{
  background:#fff;border:1px solid rgba(0,0,0,.08);
  padding:8px 10px;
  border-radius:8px;
  font-size:14px;font-weight:600;
  color:#16354a;
  display:flex;align-items:center;gap:8px;
  cursor:grab;
  box-shadow:0 4px 10px -4px rgba(18,38,60,.12);
  max-width:260px;
}
.token.returning{opacity:.6}
.token.correct{background:#e5f6e9;border-color:var(--ok)}
.token.incorrect{background:#ffeceb;border-color:var(--danger)}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.status-line{font-size:13px;color:var(--muted);margin-top:6px;min-height:18px}
.progress{height:6px;background:#e2eef5;border-radius:4px;overflow:hidden;margin:4px 0 10px}
.progress > div{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-alt));width:0;transition:width .35s}
.score-badge{
  background:#18394f;color:#fff;padding:6px 10px;border-radius:8px;font-size:13px;font-weight:600
}
nav.qnav{display:flex;gap:8px;margin-top:auto;flex-wrap:wrap}
.separator{height:1px;background:#e3edf4;margin:12px 0}
small.muted{color:var(--muted);font-size:12px;font-weight:500;letter-spacing:.3px}
/* Editor modal */
#editorModal{
  position:fixed;inset:0;display:none;align-items:center;justify-content:center;
  background:rgba(10,24,40,.55);z-index:200;
  padding:24px;
}
#editorCard{
  width:min(1080px,98%);
  max-height:92vh;
  background:#fff;
  color:#122536;
  border-radius:14px;
  padding:18px 20px 26px;
  display:flex;
  flex-direction:column;
  gap:18px;
  overflow:auto;                /* allow whole form to scroll */
  box-shadow:0 24px 64px -12px rgba(5,25,50,.45);
  font-size:14px;
  -webkit-overflow-scrolling:touch;
}

/* Allow inner flex region to scroll independently if tall */
.editor-flex{
  display:flex;
  gap:16px;
  flex:1;
  min-height:0;
  flex-wrap:nowrap;
  overflow:auto;                /* secondary scroll (horizontal on very narrow) */
}

/* Ensure columns can shrink and their internal lists scroll */
.editor-left,
.editor-right{
  flex:1 1 0;
  min-width:300px;
  min-height:0;
  display:flex;
  flex-direction:column;
  gap:12px;
}

.list{flex:1;overflow:auto;}
.choice-rows{flex:1;overflow:auto;}

@media (max-width:820px){
  .editor-flex{flex-wrap:wrap;overflow:auto;}
  .editor-left,.editor-right{min-width:100%;}
}
/* Editor modal */
#editorModal{
  position:fixed;inset:0;display:none;align-items:center;justify-content:center;
  background:rgba(10,24,40,.55);z-index:200;
  padding:24px;
}
#editorCard{
  width:min(1080px,98%);
  max-height:92vh;
  background:#fff;
  color:#122536;
  border-radius:14px;
  padding:18px 20px 26px;
  display:flex;
  flex-direction:column;
  gap:18px;
  overflow:auto;                /* allow whole form to scroll */
  box-shadow:0 24px 64px -12px rgba(5,25,50,.45);
  font-size:14px;
  -webkit-overflow-scrolling:touch;
}

/* Allow inner flex region to scroll independently if tall */
.editor-flex{
  display:flex;
  gap:16px;
  flex:1;
  min-height:0;
  flex-wrap:nowrap;
  overflow:auto;                /* secondary scroll (horizontal on very narrow) */
}

/* Ensure columns can shrink and their internal lists scroll */
.editor-left,
.editor-right{
  flex:1 1 0;
  min-width:300px;
  min-height:0;
  display:flex;
  flex-direction:column;
  gap:12px;
}

.list{flex:1;overflow:auto;}
.choice-rows{flex:1;overflow:auto;}

@media (max-width:820px){
  .editor-flex{flex-wrap:wrap;overflow:auto;}
  .editor-left,.editor-right{min-width:100%;}
}
.qrow.active{background:#eef6ff;border-radius:6px;}
.choice-row input.ch-text:invalid{outline:2px solid #e74c3c}
/* Thank You modal */
#thankModal{
  position:fixed;inset:0;display:none;
  align-items:center;justify-content:center;
  background:rgba(15,35,55,.55);
  z-index:500;
  backdrop-filter:blur(3px);
}
#thankModal .card{
  background:#ffffff;
  width:min(440px,92%);
  padding:34px 42px 36px;
  border-radius:20px;
  text-align:center;
  box-shadow:0 28px 72px -18px rgba(10,30,60,.40);
  font-family:inherit;
  animation:popIn .38s cubic-bezier(.4,.8,.3,1);
}
#thankModal h3{margin:0 0 12px;font-size:24px;color:#16354a}
#thankModal p{margin:0 0 22px;font-size:15px;color:#4a5e71;line-height:1.45}
#thankClose{
  background:var(--accent);color:#fff;border:0;
  padding:10px 22px;font-size:14px;font-weight:600;
  border-radius:10px;cursor:pointer;
}
#thankClose:hover{background:var(--accent-alt)}
@keyframes popIn{0%{transform:scale(.8) translateY(12px);opacity:0}100%{transform:scale(1) translateY(0);opacity:1}}
</style>
</head>
<body>
<div id="app">
  <div id="quizApp" role="application" aria-label="Drag & Drop Quiz">
    <header>
      <h1>Drag & Drop Quiz</h1>
      <div class="controls">
        <button id="playBtn">Play</button>
        <button id="editBtn" class="ghost">Edit</button>
      </div>
    </header>

    <main>
      <section class="left panel">
        <div class="meta-bar">
          <div><span class="score-badge" id="scoreBadge">0 / 0</span></div>
          <div id="progressInfo">Question <span id="qNum">1</span>/<span id="qTotal">1</span></div>
        </div>
        <div class="progress"><div id="progressBar"></div></div>
        <!-- Instructions shown ONLY at beginning -->
        <div id="instructions" class="hint">
          Drag the correct answers from the Choices panel into the Answer Zone. Double‑click to remove.
        </div>
        <h2 id="questionPrompt">—</h2>
        <div class="drop-zone-wrap">
          <div id="answerZone" class="drop-zone" aria-label="Answer Drop Zone"></div>
        </div>

        <div class="actions">
          <button id="clearZone" class="ghost small">Clear Answers</button>
          
            <nav class="qnav">
                <button id="nextBtn" class="ghost small">Next</button>
                <button id="finishBtn" class="ghost small" style="display:none">Finish</button>
            </nav>

            <div class="status-line" id="statusLine"></div>
        </div>
       
      </section>

      <!-- NEW right-side choices panel -->
      <aside class="right panel" aria-label="Choices Panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <strong style="font-size:14px;color:#16354a">Choices</strong>
          <small class="muted" id="remainingLabel">0 left</small>
        </div>
        <div id="choicesTray" aria-label="Choices tray"></div>
      </aside>
    </main>
  </div>
</div>

<!-- Editor Modal -->
<div id="editorModal" aria-hidden="true">
  <div id="editorCard" role="dialog" aria-modal="true" aria-label="Quiz Editor">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div>
        <strong style="font-size:18px">Quiz Editor</strong><br/>
        <small style="color:#516476">Create or modify drag & drop MCQ questions</small>
      </div>
      <div style="display:flex;gap:8px">
        <button id="closeEditor" class="ghost small">Close</button>
      </div>
    </div>

    <div class="editor-flex">
      <div class="editor-left">
        <div class="list" id="questionList"></div>
        <div class="editor-actions">
          <button id="addQuestion">Add Question</button>
          <button id="importBtn" class="ghost">Import</button>
          <button id="exportBtn" class="ghost">Export</button>
          <button id="defaultsBtn" class="ghost">Defaults</button>
        </div>
      </div>
      <div class="editor-right">
        <label>Prompt</label>
        <textarea id="editPrompt" placeholder="Enter question prompt..."></textarea>
        <div style="display:flex;gap:12px">
          <div style="flex:1">
            <label>Max selections (0 = auto)</label>
            <input id="editMaxSel" type="number" min="0" step="1" placeholder="0"/>
          </div>
          <div style="flex:1">
            <label>Shuffle choices</label>
            <select id="editShuffle">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
        </div>
        <label style="margin-top:6px">Choices (mark correct)</label>
        <div id="choiceRows" class="choice-rows"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="addChoiceRow" class="ghost small">Add Choice</button>
          <button id="saveQuestion" class="small">Save</button>
          <button id="deleteQuestion" class="ghost small">Delete</button>
          <span id="editorStatus" style="align-self:center;font-size:12px"></span>
        </div>
      </div>
    </div>
    <small style="color:#516476">Format exports as JSON. Correct answers are dragged into Answer Zone by learners.</small>
  </div>
</div>

<!-- Thank You Modal -->
<div id="thankModal" aria-hidden="true">
  <div class="card" role="dialog" aria-modal="true" aria-label="Submission complete">
    <h3>Thank You!</h3>
    <p id="thankMsg">Your answers have been submitted.</p>
    <button id="thankClose">Close</button>
  </div>
</div>

<script>
/* Responsive fit (no scaling transforms) */
(function(){
  const app=document.getElementById('app');
  const quizApp=document.getElementById('quizApp');
  function fit(){
    const parent=app.parentElement||document.documentElement;
    const r=parent.getBoundingClientRect();
    quizApp.style.width=Math.max(320,r.width-0)+'px';
    quizApp.style.height=Math.max(360,r.height-0)+'px';
  }
  window.addEventListener('resize',fit);
  setTimeout(fit,30);setTimeout(fit,300);
})();
</script>

<script>
/* Data + State */
const LS_KEY='dd_mcq_quiz_v1';
let questions=[];
let currentIndex=0;
let score=0;
let answeredMap={}; // questionId -> correct? bool
/* Elements */
const playBtn=qs('#playBtn');
const editBtn=qs('#editBtn');
const nextBtn=qs('#nextBtn');
const finishBtn=qs('#finishBtn');
const clearZoneBtn=qs('#clearZone');
const choicesTray=qs('#choicesTray');          // now present again
const answerZone=qs('#answerZone');
const questionPrompt=qs('#questionPrompt');
const scoreBadge=qs('#scoreBadge');
const qNum=qs('#qNum');
const qTotal=qs('#qTotal');
const progressBar=qs('#progressBar');
const statusLine=qs('#statusLine');
const remainingLabel=qs('#remainingLabel');    // restored
const instructions=qs('#instructions');

let userAnswers = {};           // q.id -> [selected texts]
let hasInteracted = false;      // to hide instructions after first interaction

/* Editor refs */
const editorModal=qs('#editorModal');
const questionList=qs('#questionList');
const closeEditor=qs('#closeEditor');
const addQuestionBtn=qs('#addQuestion');
const importBtn=qs('#importBtn');
const exportBtn=qs('#exportBtn');
const defaultsBtn=qs('#defaultsBtn');
const editPrompt=qs('#editPrompt');
const editMaxSel=qs('#editMaxSel');
const editShuffle=qs('#editShuffle');
const choiceRows=qs('#choiceRows');
const addChoiceRow=qs('#addChoiceRow');
const saveQuestionBtn=qs('#saveQuestion');
const deleteQuestionBtn=qs('#deleteQuestion');
const editorStatus=qs('#editorStatus');
let editing=-1;

/* Thank You modal refs */
const thankModal = document.getElementById('thankModal');
const thankClose = document.getElementById('thankClose');
const thankMsg   = document.getElementById('thankMsg');
let finishedOnce = false;

/* Defaults */
const DEFAULTS=[
 { id:uid(), prompt:"Select the prime numbers.", maxSelect:0, shuffle:true,
   choices:[
     {text:"12",correct:false},
     {text:"13",correct:true},
     {text:"17",correct:true},
     {text:"20",correct:false}
   ]},
 { id:uid(), prompt:"Drag all mammals.", maxSelect:0, shuffle:true,
   choices:[
     {text:"Dolphin",correct:true},
     {text:"Eagle",correct:false},
     {text:"Elephant",correct:true},
     {text:"Lizard",correct:false}
   ]}
];

function load(){
  try{
    const raw=localStorage.getItem(LS_KEY);
    if(raw){
      const parsed=JSON.parse(raw);
      if(Array.isArray(parsed)&&parsed.length) questions=parsed;
      else questions=clone(DEFAULTS);
    } else questions=clone(DEFAULTS);
  }catch(e){questions=clone(DEFAULTS);}
}
function save(){ try{localStorage.setItem(LS_KEY,JSON.stringify(questions));}catch(e){} }
function clone(o){ return JSON.parse(JSON.stringify(o)); }

/* Rendering */
function renderQuestion(){
  const q=questions[currentIndex];
  if(!q) return;
  questionPrompt.textContent=q.prompt;
  // ONLY show instructions at very beginning & not after interaction
  if(currentIndex===0 && !hasInteracted){
    instructions && instructions.classList.remove('hidden');
  } else {
    instructions && instructions.classList.add('hidden');
  }
  // compute maxSelect
  const correctCount=q.choices.filter(c=>c.correct).length;
  q.effectiveMax = q.maxSelect && q.maxSelect>0 ? q.maxSelect : correctCount;
  answerZone.innerHTML='';
  choicesTray.innerHTML='';
  let list=q.choices.map((c,i)=>({...c, id:uid(), baseIndex:i}));
  if(q.shuffle) list=shuffle(list);
  q._renderedChoices=list;
  list.forEach(c=>{
    const el=div('choice',escape(c.text));
    el.draggable=true;
    el.dataset.cid=c.id;
    el.dataset.correct=c.correct?"1":"0";
    el.addEventListener('dragstart',dragStart);
    el.addEventListener('dragend',dragEnd);
    el.addEventListener('dblclick',()=> tryToggleSelect(el));
    choicesTray.appendChild(el);
  });
  const stored = userAnswers[q.id] || [];
  if(stored.length){
    stored.forEach(txt=>{
      const match=[...choicesTray.querySelectorAll('.choice')].find(ch=>ch.textContent.trim()===txt && ch.dataset.selected!=='true');
      if(match) addTokenFromChoice(match,true);
    });
  }
  qNum.textContent=currentIndex+1;
  qTotal.textContent=questions.length;
  nextBtn.disabled = currentIndex === questions.length - 1; /* ADDED: disable on last question */
  updateRemaining();
  updateProgressBar();
  statusLine.textContent='';
  markAnsweredState();
  syncScoreBadge();
  updateFinishVisibility();
}
function updateRemaining(){
  if(!choicesTray || !remainingLabel) return;
  const trayChoices=[...choicesTray.querySelectorAll('.choice')].filter(c=>c.dataset.selected!=='true').length;
  remainingLabel.textContent=trayChoices+' left';
}
function updateProgressBar(){
  const pct=((currentIndex)/Math.max(1,questions.length-1))*100;
  progressBar.style.width=pct+'%';
}
function syncScoreBadge(){
  score=Object.values(answeredMap).filter(Boolean).length;
  scoreBadge.textContent=score+' / '+questions.length;
}
function markAnsweredState(){
  const q=questions[currentIndex];
  const answered=answeredMap[q.id];
  if(answered===undefined){ statusLine.textContent=''; return; }
  statusLine.textContent=answered ? 'Correct!' : 'Checked';
  statusLine.style.color=answered ? 'var(--ok)' : 'var(--muted)';
}

/* Drag logic */
function dragStart(e){
  const el=e.target;
  if(el.dataset.selected==='true'){ e.preventDefault(); return; }
  el.classList.add('dragging');
  e.dataTransfer.setData('text/plain',el.dataset.cid);
}
function dragEnd(e){
  e.target.classList.remove('dragging');
}

function setupDrop(){
  ['dragover','dragenter'].forEach(evt=>{
    answerZone.addEventListener(evt,e=>{
      e.preventDefault();
      answerZone.classList.add('dragover');
    });
  });
  answerZone.addEventListener('dragleave',()=> answerZone.classList.remove('dragover'));
  answerZone.addEventListener('drop', e=>{
    e.preventDefault();
    answerZone.classList.remove('dragover');
    const id=e.dataTransfer.getData('text/plain');
    const origin=choicesTray.querySelector(`.choice[data-cid="${CSS.escape(id)}"]`);
    if(!origin || origin.dataset.selected==='true') return;
    addTokenFromChoice(origin);
  });
}

function tryToggleSelect(choiceEl){
  // double-click to move toggle
  if(choiceEl.dataset.selected==='true'){
    // remove from answer zone
    const token=answerZone.querySelector(`.token[data-cid="${CSS.escape(choiceEl.dataset.cid)}"]`);
    if(token) token.remove();
    choiceEl.dataset.selected='false';
    updateAnswerState();
  } else {
    addTokenFromChoice(choiceEl);
  }
}

function addTokenFromChoice(choiceEl, silent){
  const q=questions[currentIndex];
  const currentTokens=answerZone.querySelectorAll('.token').length;
  if(currentTokens>=q.effectiveMax){
    if(!silent){
      flash(answerZone,'shake');
      statusLine.textContent='Max selections reached ('+q.effectiveMax+').';
      statusLine.style.color='var(--danger)';
    }
    return;
  }
  if(!hasInteracted){
    hasInteracted=true;
    instructions && instructions.classList.add('hidden');
  }
  choiceEl.dataset.selected='true';
  const token=div('token',choiceEl.textContent);
  token.draggable=true;
  token.dataset.cid=choiceEl.dataset.cid;
  token.dataset.correct=choiceEl.dataset.correct;
  token.addEventListener('dragstart',e=>{
    e.dataTransfer.setData('text/plain',token.dataset.cid);
    token.classList.add('dragging');
  });
  token.addEventListener('dragend',()=> token.classList.remove('dragging'));
  token.addEventListener('dblclick',()=>{
    token.remove();
    choiceEl.dataset.selected='false';
    updateAnswerState();
  });
  answerZone.appendChild(token);
  updateAnswerState();
  if(!silent) statusLine.textContent='';
}

function updateAnswerState(){
  const q=questions[currentIndex];
  const tokens=[...answerZone.querySelectorAll('.token')];
  userAnswers[q.id]=tokens.map(t=>t.textContent.trim());
  updateRemaining();
  updateFinishVisibility();
}

function nextQuestion(){
  const q=questions[currentIndex];
  const answered = (userAnswers[q.id]||[]).length>0;
  if(!answered){
    statusLine.textContent='Please select at least one answer before continuing.';
    statusLine.style.color='var(--danger)';
    flash(answerZone,'shake');
    return;
  }
  if(currentIndex<questions.length-1){
    currentIndex++; renderQuestion();
  }
}

function updateFinishVisibility(){
  const allAnswered = questions.every(q=> (userAnswers[q.id]||[]).length>0 );
  finishBtn.style.display = allAnswered ? 'inline-block' : 'none';
}

function finishQuiz(){
  // lock UI on finish (no scoring shown to student; scoring logic kept internal if needed)
  answerZone.querySelectorAll('.token').forEach(t=>t.draggable=false);
  choicesTray.querySelectorAll('.choice').forEach(c=>c.draggable=false);
  statusLine.textContent='Submitted. Thank you!';
  statusLine.style.color='var(--accent)';
  nextBtn.disabled=true;
  clearZoneBtn.disabled=true;
  // hide buttons after finishing
  nextBtn.style.display='none';
  clearZoneBtn.style.display='none';

  // Show thank you modal
  openThankYouModal();
}

/* Utilities */
function qs(sel,root=document){return root.querySelector(sel);}
function div(cls,txt){const d=document.createElement('div');if(cls)d.className=cls;if(txt!==undefined)d.textContent=txt;return d;}
function uid(){return Math.random().toString(36).slice(2,10);}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function escape(s){return String(s||'');}
function flash(el,cls){el.classList.add(cls);setTimeout(()=>el.classList.remove(cls),480);}

/* Editor */
function openEditor(){
  buildQuestionList();
  if(editing<0 && questions.length) { editing=0; loadEditorQuestion(0); }
  editorModal.style.display='flex';
  editorModal.setAttribute('aria-hidden','false');
}
function closeEditorModal(){
  editorModal.style.display='none';
  editorModal.setAttribute('aria-hidden','true');
}
function buildQuestionList(){
  questionList.innerHTML='';
  questions.forEach((q,i)=>{
    const row=document.createElement('div');
    row.className='qrow'+(i===editing?' active':'');
    row.innerHTML=`<div class="ttl">${i+1}. ${escape(q.prompt).slice(0,70)}</div>
      <div class="inline-btns">
        <button data-act="edit" data-i="${i}">Edit</button>
        <button data-act="up" data-i="${i}">↑</button>
        <button data-act="down" data-i="${i}">↓</button>
      </div>`;
    questionList.appendChild(row);
  });
  questionList.querySelectorAll('button').forEach(btn=>{
    btn.onclick=()=>{
      const i=Number(btn.dataset.i);
      const act=btn.dataset.act;
      if(act==='edit'){
        editing=i;
        loadEditorQuestion(i);
        buildQuestionList();
      }else if(act==='up' && i>0){
        [questions[i-1],questions[i]]=[questions[i],questions[i-1]];
        save(); buildQuestionList();
      }else if(act==='down' && i<questions.length-1){
        [questions[i+1],questions[i]]=[questions[i],questions[i+1]];
        save(); buildQuestionList();
      }
    };
  });
}
function loadEditorQuestion(i){
  const q=questions[i]; if(!q) return;
  editPrompt.value=q.prompt;
  editMaxSel.value=q.maxSelect || 0;
  editShuffle.value=q.shuffle ? 'true':'false';
  choiceRows.innerHTML='';
  q.choices.forEach(c=>addChoiceRowEl(c.text,c.correct));
  editorStatus.textContent='';
}
function addChoiceRowEl(text='',correct=false){
  const row=document.createElement('div');
  row.className='choice-row';
  // text input
  const inp=document.createElement('input');
  inp.type='text';
  inp.required=true;
  inp.className='ch-text';
  inp.placeholder='Choice text';
  inp.value=text;
  // correct checkbox
  const chkWrap=document.createElement('div');
  chkWrap.className='chk';
  const chk=document.createElement('input');
  chk.type='checkbox';
  chk.className='ch-correct';
  chk.checked=!!correct;
  const lbl=document.createElement('label');
  lbl.style.fontSize='11px';
  lbl.textContent='Correct';
  chkWrap.appendChild(chk); chkWrap.appendChild(lbl);
  // delete button
  const del=document.createElement('button');
  del.type='button';
  del.textContent='Del';
  del.onclick=()=>{ row.remove(); };
  row.appendChild(inp);
  row.appendChild(chkWrap);
  row.appendChild(del);
  choiceRows.appendChild(row);
}
function saveEditorQuestion(){
  if(editing<0) return;
  const prompt=editPrompt.value.trim() || 'Untitled question';
  const maxSel=Math.max(0, parseInt(editMaxSel.value,10) || 0);
  const shuffle=editShuffle.value==='true';
  const rows=[...choiceRows.querySelectorAll('.choice-row')];
  const choices=rows.map(r=>{
    const txt=r.querySelector('.ch-text').value.trim();
    if(!txt) return null;
    return { text:txt, correct:r.querySelector('.ch-correct').checked };
  }).filter(Boolean);
  if(!choices.length){
    editorStatus.textContent='Add at least one choice.';
    editorStatus.style.color='var(--danger)';
    return;
  }
  if(!choices.some(c=>c.correct)){
    editorStatus.textContent='Mark at least one correct.';
    editorStatus.style.color='var(--danger)';
    return;
  }
  questions[editing]={ id:questions[editing].id||uid(), prompt, maxSelect:maxSel, shuffle, choices };
  save();
  editorStatus.textContent='Saved';
  editorStatus.className='save-ok';
  buildQuestionList();
  renderQuestion();
}

function addNewQuestion(){
  const q = {
    id: uid(),
    prompt: 'New question',
    maxSelect: 0,
    shuffle: true,
    choices: [
      { text: 'Choice 1', correct: true },
      { text: 'Choice 2', correct: false }
    ]
  };
  questions.push(q);
  editing = questions.length - 1;
  save();
  buildQuestionList();
  loadEditorQuestion(editing);
}

function deleteEditorQuestion(){
  if(editing < 0) return;
  if(!confirm('Delete this question?')) return;
  questions.splice(editing,1);
  if(editing >= questions.length) editing = questions.length - 1;
  save();
  buildQuestionList();
  if(editing >= 0){
    loadEditorQuestion(editing);
  } else {
    editPrompt.value='';
    editMaxSel.value=0;
    editShuffle.value='true';
    choiceRows.innerHTML='';
  }
  renderQuestion();
}

// In the Event bindings section ensure these listeners exist (keep one set only):
playBtn.addEventListener('click',()=>{ 
  currentIndex=0; answeredMap={}; score=0; userAnswers={}; hasInteracted=false;
  renderQuestion(); syncScoreBadge(); nextBtn.disabled=false; clearZoneBtn.disabled=false;
  nextBtn.style.display='inline-block';
  clearZoneBtn.style.display='inline-block';
});
editBtn.addEventListener('click',openEditor);
finishBtn.addEventListener('click',finishQuiz);
clearZoneBtn.addEventListener('click',()=>{
  answerZone.innerHTML='';
  [...choicesTray.querySelectorAll('.choice')].forEach(c=>c.dataset.selected='false');
  updateAnswerState();
  statusLine.textContent='Cleared'; statusLine.style.color='var(--muted)';
});
nextBtn.addEventListener('click', nextQuestion); /* ADDED listener */
closeEditor.addEventListener('click',closeEditorModal);
addQuestionBtn.addEventListener('click',addNewQuestion);
deleteQuestionBtn.addEventListener('click',deleteEditorQuestion);
addChoiceRow.addEventListener('click',()=> addChoiceRowEl());
saveQuestionBtn.addEventListener('click',saveEditorQuestion);
thankClose.addEventListener('click',closeThankYouModal);

/* Init */
load();
if(!questions.length){questions=clone(DEFAULTS);}
renderQuestion();
setupDrop();
syncScoreBadge();

/* Keyboard navigation */
document.addEventListener('keydown',e=>{
  if(e.key==='ArrowRight') nextQuestion();
  else if(e.key==='ArrowLeft') {/* (prev removed) */}
  // REMOVED: Ctrl+Enter checkCurrent (function no longer used)
});

/* Accessibility: Enter toggles choice selection */
if(choicesTray){
  choicesTray.addEventListener('keydown',e=>{
    if(e.target.classList.contains('choice') && e.key==='Enter'){
      tryToggleSelect(e.target);
    }
  });
}

/* Thank You modal */
function openThankYouModal(){
  const modal=qs('#thankModal');
  if(!modal) return;
  modal.style.display='flex';
  modal.setAttribute('aria-hidden','false');
}
function closeThankYouModal(){
  const modal=qs('#thankModal');
  if(modal){
    modal.style.display='none';
    modal.setAttribute('aria-hidden','true');
  }
}
qs('#thankClose').addEventListener('click',closeThankYouModal);
qs('#reviewBtn').addEventListener('click',()=>{
  closeThankYouModal();
  currentIndex=0;
  renderQuestion();
});
qs('#retakeBtn').addEventListener('click',()=>{
  closeThankYouModal();
  questions=clone(DEFAULTS);
  save();
  currentIndex=0;
  renderQuestion();
});
</script>
</body>
</html>