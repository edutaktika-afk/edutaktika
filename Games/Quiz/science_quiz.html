<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Science Quiz - Multiple Choice</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="../../CSS/header.css">
  <link rel="stylesheet" href="../../CSS/subject.css">
  <link rel="stylesheet" href="../../CSS/footer.css">
  <style>
    :root {
      --primary: #2e8b57;
      --secondary: #ffd700;
      --peach: #ff69b4;
      --forest-green: #3f4d34;
      --sun-yellow: #ffd700;
      --white: #ffffff;
    }
    body { font-family: 'Baloo 2', Arial, sans-serif; background:#f5f7fb; margin:0; }
    main { padding:100px 20px 40px; min-height:calc(100vh - 260px); }
    .page-wrapper { display:flex; align-items:center; justify-content:center; }
    .game-container { background: var(--white); border-radius: 16px; box-shadow: 0 4px 24px var(--peach); padding: 32px; text-align: center; max-width: 600px; width: 96vw; position: relative; }
    .title { color: var(--primary); margin-bottom: 18px; }
    .hud { display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px; color:#333; font-weight:600; }
    .question-container { margin-bottom: 24px; }
    .question { font-size: 1.3rem; color: var(--forest-green); font-weight: bold; margin-bottom: 20px; line-height: 1.4; }
    .answers { display: grid; gap: 12px; margin-bottom: 24px; }
    .answer-btn { 
      background: var(--sun-yellow); 
      color: var(--forest-green); 
      border-radius: 12px; 
      padding: 16px 20px; 
      font-size: 1.1rem; 
      font-weight: bold; 
      cursor: pointer; 
      border: 3px solid var(--primary); 
      box-shadow: 0 2px 8px var(--peach); 
      transition: all 0.3s ease;
      text-align: left;
    }
    .answer-btn:hover { 
      background: var(--secondary); 
      transform: translateY(-2px); 
      box-shadow: 0 4px 16px var(--peach); 
    }
    .answer-btn.selected { 
      background: var(--primary); 
      color: var(--white); 
      border-color: var(--secondary); 
    }
    .answer-btn.correct { 
      background: #4caf50; 
      color: var(--white); 
      border-color: #2e7d32; 
    }
    .answer-btn.incorrect { 
      background: #f44336; 
      color: var(--white); 
      border-color: #c62828; 
    }
    .submit-btn { 
      background: var(--primary); 
      color: var(--white); 
      border: none; 
      border-radius: 12px; 
      padding: 14px 32px; 
      font-size: 1.2rem; 
      font-weight: bold; 
      cursor: pointer; 
      margin-top: 16px; 
      transition: background 0.3s; 
    }
    .submit-btn:hover { background: #1e6b47; }
    .submit-btn:disabled { background: #ccc; cursor: not-allowed; }
    #uploadStatus { font-size:13px;margin-top:10px;color:#444; }
    #viewAttemptsBtn { display:none; margin-top:12px; background:#6d28d9; color:#fff; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; }

    /* Modals */
    .modal-bg { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); z-index:100000; align-items:center; justify-content:center; }
    .modal-content { background:#fff; padding: 48px 40px; border-radius: 18px; max-width: 520px; width: 96vw; box-shadow: 0 4px 24px var(--peach); text-align:center; position:relative; }
    .modal-content h2 { font-size: 2.0rem; color: var(--primary); margin-bottom: 18px; }
    .modal-btn { padding: 14px 36px; border-radius: 12px; background: var(--primary); color: var(--white); border: none; font-size: 1.4rem; font-weight: bold; margin-top: 16px; cursor: pointer; }
    .small { font-size: 0.95rem; color:#444; }

    /* Attempts modal */
    #attemptsModal { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); z-index:100001; align-items:center; justify-content:center; }
    #attemptsModal .modal-content { max-width:640px; text-align:left; }
    .attempt-row { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid #eee; font-size:0.95rem; }
    .close-x { position:absolute; right:12px; top:8px; border:none; background:none; font-size:22px; cursor:pointer; }

    /* Ensure dropdown behaves like subject pages */
    header nav ul { display:flex; align-items:center; padding:0; margin:0; }
    header nav ul li { list-style:none; margin:0 10px; position:relative; height:100%; display:flex; align-items:center; }
    header nav ul li a, header nav ul li .dropbtn { display:flex; align-items:center; height:48px; line-height:48px; padding:0 18px; color:#2d3923; text-decoration:none; font-size:1rem; background:none; border:none; cursor:pointer; }
    header nav ul li.dropdown .dropdown-content { display:none; position:absolute; background:#fff; min-width:140px; box-shadow:0 4px 16px #0002; z-index:1000; border-radius:8px; padding:6px 0; margin:0; top:100%; left:0; }
    header nav ul li.dropdown .dropdown-content li { list-style:none; border-bottom:1px solid #eee; }
    header nav ul li.dropdown .dropdown-content li:last-child { border-bottom:none; }
    header nav ul li.dropdown .dropdown-content a { color:#2d3923; padding:10px 16px; display:block; text-decoration:none; border-radius:0; transition:background 0.2s; height:auto; line-height:normal; }
    header nav ul li.dropdown .dropdown-content a:hover { background:#f0f0f0; }
    header nav ul li.dropdown:hover .dropdown-content { display:block; }
  </style>
</head>
<body>
  <!-- Top header styled like subject pages -->
  <header>
    <div class="floating-elements">
      <div class="floating-element"></div>
      <div class="floating-element"></div>
      <div class="floating-element"></div>
      <div class="floating-element"></div>
    </div>
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon"><i class="fas fa-graduation-cap"></i></div>
        <div class="logo-text"><span>E</span><span>d</span><span>u</span><span>t</span><span>a</span><span>k</span><span>t</span><span>i</span><span>k</span><span>a</span></div>
      </div>
      <nav id="dynamic-nav">
        <ul>
          <li><a href="../../Student/homepage.html">Home</a></li>
          <li class="dropdown">
            <a href="#" class="dropbtn">Subject <i class="fa fa-caret-down"></i></a>
            <ul class="dropdown-content">
              <li><a href="../../Student/subject_math.html">Math</a></li>
              <li><a href="../../Student/subject_english.html">English</a></li>
              <li><a href="../../Student/subject_science.html">Science</a></li>
            </ul>
          </li>
          <li><a href="../../Student/studentlist.html">Student</a></li>
          <li><a href="../../Student/leaderboard.html">Leaderboard</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <div class="page-wrapper">
      <!-- Start Modal -->
      <div id="start-modal" class="modal-bg" style="display:flex;">
        <div class="modal-content">
          <h2>Science Quiz</h2>
          <p class="small">Test your knowledge of science fundamentals! 10 multiple choice questions covering basic science concepts.</p>
          <button id="start-btn" class="modal-btn">Start Quiz</button>
        </div>
      </div>
      <!-- Instructions Modal -->
      <div id="instructions-modal" class="modal-bg">
        <div class="modal-content">
          <h2>How it works</h2>
          <ul style="text-align:left; line-height:1.6;">
            <li>Read each question carefully.</li>
            <li>Click on your chosen answer.</li>
            <li>Click Submit to confirm your answer.</li>
            <li>Your score will be saved if you are logged in.</li>
          </ul>
          <button id="close-instructions-btn" class="modal-btn">Continue</button>
        </div>
      </div>
      <!-- Final Modal -->
      <div id="final-modal" class="modal-bg">
        <div class="modal-content">
          <h2>Great job!</h2>
          <p id="final-score" class="small"></p>
          <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
            <button id="play-again-btn" class="modal-btn">Play Again</button>
            <button id="to-lessons-btn" class="modal-btn" style="background:#6d28d9;">Back to Lessons</button>
          </div>
        </div>
      </div>

      <!-- Attempts Modal -->
      <div id="attemptsModal">
        <div class="modal-content">
          <button class="close-x" onclick="closeAttemptsModal()">✕</button>
          <h2>Your Attempts</h2>
          <div id="attemptsList" class="small">Loading...</div>
        </div>
      </div>

      <div class="game-container" style="display:none;">
        <div class="hud">
          <div>Question <span id="qIndex">1</span>/<span id="qTotal">10</span></div>
          <div>Score: <span id="scoreEl">0</span></div>
        </div>
        <h2 class="title">Science Quiz</h2>
        <div class="question-container">
          <div class="question" id="question"></div>
          <div class="answers" id="answers"></div>
          <button id="submit-btn" class="submit-btn" disabled>Submit Answer</button>
        </div>
        <div id="uploadStatus"></div>
        <button id="viewAttemptsBtn">View Attempts</button>
      </div>
    </div>
  </main>


  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    // Firebase init (same project as other pages)
    const firebaseConfig = { apiKey:"AIzaSyB5BbeLLvPX8l1c4Lq0f-CmIUml4hQOQlE", authDomain:"edutaktika.firebaseapp.com", databaseURL:"https://edutaktika-default-rtdb.firebaseio.com", projectId:"edutaktika", storageBucket:"edutaktika.appspot.com", messagingSenderId:"676848575316", appId:"1:676848575316:web:f78f8c0f83bf3d9dfb5ec1", measurementId:"G-X3GT5TNN87" };
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // Attempts/summary storage (mirrors lesson1.html style)
    const QUIZ_KEY = 'science-quiz';
    const USE_STUDENT_PATH = true;
    function requireAuthUid(){ const u = auth.currentUser; if(!u){ document.getElementById('uploadStatus').textContent='Login required to save score.'; return null;} return u.uid; }
    function primaryAttemptRef(uid){ return db.ref(`quizAttempts/${QUIZ_KEY}/${uid}`).push(); }
    function studentAttemptRef(uid){ return db.ref(`students/${uid}/quizzes/${QUIZ_KEY}/attempts`).push(); }
    function summaryRefPrimary(uid){ return db.ref(`quizSummaries/${QUIZ_KEY}/${uid}`); }
    function summaryRefStudent(uid){ return db.ref(`students/${uid}/quizzes/${QUIZ_KEY}/summary`); }
    function saveAttempt(rawScore,total){
      const uid = requireAuthUid(); if(!uid) return;
      const payload = { score:rawScore, total:total, percentage: Math.round(rawScore/total*100), timestamp: Date.now() };
      const statusEl = document.getElementById('uploadStatus');
      statusEl.textContent='Saving attempt...';
      const tryPrimary = !USE_STUDENT_PATH;
      const doPrimary = () => primaryAttemptRef(uid).set(payload).then(()=> updateSummary(uid,payload,true));
      const doStudent = () => studentAttemptRef(uid).set(payload).then(()=> updateSummary(uid,payload,false));
      (tryPrimary ? doPrimary().catch(err=>{ if(err && err.code==='PERMISSION_DENIED') return doStudent(); throw err; }) : doStudent())
        .then(()=>{ statusEl.textContent='Attempt saved.'; })
        .catch(e=>{ statusEl.textContent='Save failed: ' + e.message; });
    }
    function updateSummary(uid,payload,usedPrimary){
      const ref = (USE_STUDENT_PATH || !usedPrimary) ? summaryRefStudent(uid) : summaryRefPrimary(uid);
      let bestDelta = 0;
      return ref.transaction(current => {
        current = current || {};
        const best = Math.max(current.best || 0, payload.score);
        bestDelta = best - (current.best || 0);
        return {
          best,
          bestPercentage: Math.round(best/payload.total*100),
          last: payload.score,
          lastPercentage: payload.percentage,
          total: payload.total,
          attempts: (current.attempts||0)+1,
          lastTimestamp: payload.timestamp
        };
      }).then(()=>{ if(bestDelta>0){ db.ref(`students/${uid}/points`).transaction(p => (p||0)+bestDelta); } });
    }
    function openAttemptsModal(){ document.getElementById('attemptsModal').style.display='flex'; loadAttempts(); }
    function closeAttemptsModal(){ document.getElementById('attemptsModal').style.display='none'; }
    window.closeAttemptsModal = closeAttemptsModal;
    function loadAttempts(){
      const uid = requireAuthUid(); if(!uid) return;
      const listDiv = document.getElementById('attemptsList'); listDiv.textContent='Loading...';
      const path = (USE_STUDENT_PATH ? `students/${uid}/quizzes/${QUIZ_KEY}/attempts` : `quizAttempts/${QUIZ_KEY}/${uid}`);
      db.ref(path).orderByChild('timestamp').once('value').then(snap=>{
        const rows = [];
        snap.forEach(child=> rows.push(child.val()));
        rows.sort((a,b)=> (b.timestamp||0)-(a.timestamp||0));
        if(rows.length===0){ listDiv.textContent='No attempts yet.'; return; }
        listDiv.innerHTML = rows.map((a,i)=>{
          const ds = new Date(a.timestamp).toLocaleString();
          return `<div class='attempt-row'><span>#${rows.length - i}</span><span>${a.score}/${a.total}</span><span>${a.percentage}%</span><span>${ds}</span></div>`;
        }).join('');
      }).catch(e=>{ listDiv.textContent='Load failed: '+ e.message; });
    }
  </script>

  <script>
    // Science Quiz Questions
    const QUESTIONS = [
      {
        question: "What is the chemical symbol for water?",
        answers: ["H2O", "CO2", "NaCl", "O2"],
        correct: 0
      },
      {
        question: "Which planet is closest to the Sun?",
        answers: ["Venus", "Mercury", "Earth", "Mars"],
        correct: 1
      },
      {
        question: "What gas do plants absorb from the atmosphere during photosynthesis?",
        answers: ["Oxygen", "Nitrogen", "Carbon Dioxide", "Hydrogen"],
        correct: 2
      },
      {
        question: "What is the hardest natural substance on Earth?",
        answers: ["Gold", "Iron", "Diamond", "Quartz"],
        correct: 2
      },
      {
        question: "Which organ pumps blood throughout the body?",
        answers: ["Liver", "Heart", "Lungs", "Brain"],
        correct: 1
      },
      {
        question: "What is the process by which plants make their own food?",
        answers: ["Respiration", "Digestion", "Photosynthesis", "Fermentation"],
        correct: 2
      },
      {
        question: "What is the smallest unit of matter?",
        answers: ["Cell", "Molecule", "Atom", "Electron"],
        correct: 2
      },
      {
        question: "Which force pulls objects toward the center of the Earth?",
        answers: ["Magnetism", "Gravity", "Friction", "Electricity"],
        correct: 1
      },
      {
        question: "What is the chemical symbol for gold?",
        answers: ["Go", "Gd", "Au", "Ag"],
        correct: 2
      },
      {
        question: "Which part of the plant cell contains chlorophyll?",
        answers: ["Nucleus", "Cell Wall", "Chloroplast", "Vacuole"],
        correct: 2
      }
    ];

    const TOTAL_QUESTIONS = QUESTIONS.length;
    let currentIndex = 0;
    let score = 0;
    let selectedAnswer = null;

    const qIndexEl = document.getElementById('qIndex');
    const qTotalEl = document.getElementById('qTotal');
    const scoreEl = document.getElementById('scoreEl');
    const questionEl = document.getElementById('question');
    const answersEl = document.getElementById('answers');
    const submitBtn = document.getElementById('submit-btn');

    qTotalEl.textContent = String(TOTAL_QUESTIONS);

    // UI flows
    document.getElementById('start-btn').onclick = function(){
      document.getElementById('start-modal').style.display='none';
      document.getElementById('instructions-modal').style.display='flex';
    };
    document.getElementById('close-instructions-btn').onclick = function(){
      document.getElementById('instructions-modal').style.display='none';
      document.querySelector('.game-container').style.display='';
      startQuiz();
    };

    document.getElementById('play-again-btn').onclick = () => { location.reload(); };
    // Detect if user is teacher and adjust back button
    let isTeacher = false;
    firebase.auth().onAuthStateChanged(async function(user) {
        if (user) {
            const uid = user.uid;
            // Check if user is a teacher
            const teacherSnap = await firebase.database().ref('teachers/' + uid).once('value');
            const teacher = teacherSnap.val();
            
            if (teacher && teacher.role === "teacher") {
                isTeacher = true;
                // Update back button for teachers
                const backBtn = document.getElementById('to-lessons-btn');
                if (backBtn) {
                    backBtn.textContent = 'Back to Lessons (Teacher)';
                }
                
                // Update navigation for teachers
                updateNavigationForTeachers();
                
                // Show teacher view with answer sheet
                showTeacherView();
            } else {
                // Enable navigation for students
                enableNavigationForStudents();
            }
        }
    });

    document.getElementById('to-lessons-btn').onclick = () => { 
        if (isTeacher) {
            window.location.href='../../Teacher/subject_science.html#quizzes';
        } else {
            window.location.href='../../Student/subject_science.html#quizzes';
        }
    };

    document.getElementById('viewAttemptsBtn').addEventListener('click', openAttemptsModal);

    auth.onAuthStateChanged(u=>{ if(u){ document.getElementById('viewAttemptsBtn').style.display='inline-block'; }});


    function updateNavigationForTeachers() {
        const nav = document.getElementById('dynamic-nav');
        nav.innerHTML = `
            <ul>
                <li><a href="../../Teacher/homepage.html">Home</a></li>
                <li class="dropdown">
                    <a href="#" class="dropbtn">Subject <i class="fa fa-caret-down"></i></a>
                    <ul class="dropdown-content">
                        <li><a href="../../Teacher/subject_math.html">Math</a></li>
                        <li><a href="../../Teacher/subject_english.html">English</a></li>
                        <li><a href="../../Teacher/subject_science.html">Science</a></li>
                    </ul>
                </li>
                <li><a href="../../Teacher/admin.html">Admin</a></li>
                <li><a href="../../Teacher/leaderboard.html">Leaderboard</a></li>
            </ul>
        `;
    }

    function enableNavigationForStudents() {
        const nav = document.getElementById('dynamic-nav');
        nav.innerHTML = `
            <ul>
                <li><a href="../../Student/homepage.html">Home</a></li>
                <li class="dropdown">
                    <a href="#" class="dropbtn">Subject <i class="fa fa-caret-down"></i></a>
                    <ul class="dropdown-content">
                        <li><a href="../../Student/subject_math.html">Math</a></li>
                        <li><a href="../../Student/subject_english.html">English</a></li>
                        <li><a href="../../Student/subject_science.html">Science</a></li>
                    </ul>
                </li>
                <li><a href="../../Student/studentlist.html">Student</a></li>
                <li><a href="../../Student/leaderboard.html">Leaderboard</a></li>
            </ul>
        `;
    }

    function showTeacherView() {
        // Hide the start modal for teachers
        document.getElementById('start-modal').style.display = 'none';
        
        // Show the game container and replace its content with answer sheet
        const gameContainer = document.querySelector('.game-container');
        gameContainer.style.display = 'block';
        gameContainer.innerHTML = `
            <div style="text-align: center; margin-bottom: 20px;">
                <h3 style="color: #2e8b57;">Answer Sheet</h3>
                <p style="color: #666;">This view shows all questions with correct answers highlighted</p>
            </div>
            <div id="answerSheet"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="window.location.href='../../Teacher/subject_science.html'" style="background: #6d28d9; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                    Back to Teacher Dashboard
                </button>
            </div>
        `;
        
        // Display all questions with answers
        const answerSheet = document.getElementById('answerSheet');
        QUESTIONS.forEach((q, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.style.cssText = 'margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;';
            
            questionDiv.innerHTML = `
                <h4 style="color: #333; margin-bottom: 10px;">Question ${index + 1}: ${q.question}</h4>
                <div style="margin-left: 20px;">
                    ${q.answers.map((answer, answerIndex) => `
                        <div style="margin: 5px 0; padding: 5px; border-radius: 4px; ${answerIndex === q.correct ? 'background: #d4edda; border: 1px solid #c3e6cb; color: #155724; font-weight: bold;' : 'background: #f8f9fa;'}">
                            ${String.fromCharCode(65 + answerIndex)}. ${answer}
                            ${answerIndex === q.correct ? ' ✓' : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            
            answerSheet.appendChild(questionDiv);
        });
    }



    function startQuiz(){
      loadQuestion();
    }

    function loadQuestion(index = currentIndex){
      const question = QUESTIONS[index];
      questionEl.textContent = question.question;
      answersEl.innerHTML = '';
      selectedAnswer = null;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submit Answer';

      question.answers.forEach((answer, answerIndex) => {
        const btn = document.createElement('button');
        btn.className = 'answer-btn';
        btn.textContent = answer;
        btn.onclick = () => selectAnswer(answerIndex, btn);
        answersEl.appendChild(btn);
      });

      updateHud();
    }

    function selectAnswer(index, btn){
      // Remove previous selection
      document.querySelectorAll('.answer-btn').forEach(b => b.classList.remove('selected'));
      
      // Add selection to clicked button
      btn.classList.add('selected');
      selectedAnswer = index;
      submitBtn.disabled = false;
    }

    function submitAnswer(){
      if(selectedAnswer === null) return;
      
      const question = QUESTIONS[currentIndex];
      const isCorrect = selectedAnswer === question.correct;
      
      // Show correct/incorrect answers
      document.querySelectorAll('.answer-btn').forEach((btn, index) => {
        if(index === question.correct){
          btn.classList.add('correct');
        } else if(index === selectedAnswer && !isCorrect){
          btn.classList.add('incorrect');
        }
        btn.disabled = true;
      });

      if(isCorrect) score++;

      submitBtn.textContent = 'Next Question';
      submitBtn.onclick = nextQuestion;
    }

    function nextQuestion(){
      currentIndex++;
      if(currentIndex >= TOTAL_QUESTIONS){
        endQuiz();
        return;
      }
      loadQuestion();
    }

    function updateHud(){
      qIndexEl.textContent = String(currentIndex+1);
      scoreEl.textContent = String(score);
    }

    function endQuiz(){
      const pct = Math.round(score / TOTAL_QUESTIONS * 100);
      document.getElementById('final-score').textContent = `Your Score: ${score}/${TOTAL_QUESTIONS} (${pct}%)`;
      document.getElementById('final-modal').style.display='flex';
      saveAttempt(score, TOTAL_QUESTIONS);
    }

    // Set up submit button
    submitBtn.onclick = submitAnswer;
  </script>

  <script>
    // Make dropdown work on click (mobile-friendly) in addition to hover
    (function(){
      const dropBtn = document.querySelector('nav .dropbtn');
      const menu = document.querySelector('nav .dropdown .dropdown-content');
      if (!dropBtn || !menu) return;
      dropBtn.addEventListener('click', function(e){
        e.preventDefault(); e.stopPropagation();
        const visible = menu.style.display === 'block';
        menu.style.display = visible ? 'none' : 'block';
      });
      document.addEventListener('click', function(){
        if (menu) menu.style.display = 'none';
      });
    })();
  </script>
</body>
</html>
