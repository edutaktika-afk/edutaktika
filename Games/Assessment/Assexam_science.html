<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Assessment 1 - Science</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- Site global styles -->
  <link rel="stylesheet" href="../../CSS/header.css">
  <link rel="stylesheet" href="../../CSS/footer.css">
  <style>
    /* Page specific styles */
    body { font-family: Arial, sans-serif; background:#f9f9f9; margin:0; }
    main { padding:100px 20px 40px; min-height:calc(100vh - 260px); }
    .quiz-container { max-width:640px; margin:auto; background:#fff; padding:28px 28px 32px; border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,0.08); position:relative; }
    .quiz-container h2 { margin-top:0; }
    .question { font-size:18px; margin-bottom:15px; font-weight:600; }
    .options label { display:block; padding:10px 14px; margin-bottom:10px; border:1px solid #ddd; border-radius:10px; cursor:pointer; transition:.18s; background:#fafafa; }
    .options label:hover { background:#f1f5ff; border-color:#b6c8ff; }
    .options input[type=radio] { margin-right:6px; }
    button { margin-top:15px; padding:12px 26px; background:#4285f4; border:none; color:#fff; border-radius:8px; cursor:pointer; font-size:16px; font-weight:600; letter-spacing:.3px; }
    button:disabled { background:#9bbcf1; cursor:not-allowed; }
    #result { margin-top:24px; font-weight:bold; font-size:18px; }
    #uploadStatus { margin-top:8px; font-size:14px; color:#555; }
    .attempts-btn { background:#6d28d9; }
    .attempts-btn:hover { filter:brightness(1.05); }
    /* Attempts Modal */
    #attemptsModal { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.45); z-index:1200; align-items:center; justify-content:center; }
    #attemptsModal .modal-content { background:#fff; padding:24px 28px; border-radius:18px; width:95%; max-width:520px; max-height:80vh; overflow:auto; box-shadow:0 8px 28px #0004; }
    #attemptsModal h3 { margin-top:0; }
    .attempt-row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee; font-size:14px; font-family:monospace; }
    .attempt-row:last-child { border-bottom:none; }
    .back-link { position:absolute; top:-42px; left:0; text-decoration:none; font-size:14px; font-weight:600; color:#4285f4; display:flex; align-items:center; gap:6px; }
    .back-link i { font-size:16px; }
    footer { margin-top:60px; }
  </style>
</head>
<body>
  <!-- Site Header -->
  <header>
    <div class="floating-elements">
      <div class="floating-element"></div>
      <div class="floating-element"></div>
      <div class="floating-element"></div>
      <div class="floating-element"></div>
    </div>
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon"><i class="fas fa-graduation-cap"></i></div>
        <div class="logo-text"><span>E</span><span>d</span><span>u</span><span>t</span><span>a</span><span>k</span><span>t</span><span>i</span><span>k</span><span>a</span></div>
      </div>
      <nav>
        <ul>
          <li><a href="../../Student/homepage.html" id="navHome">Home</a></li>
          <li><a href="../../Student/subject_math.html" id="navMath">Math</a></li>
          <li><a href="../../Student/subject_english.html" id="navEnglish">English</a></li>
          <li><a href="../../Student/subject_science.html" id="navScience">Science</a></li>
          <li><a href="../../Student/leaderboard.html" id="navLeaderboard">Leaderboard</a></li>
        </ul>
      </nav>
    </div>
  </header>
  <main>
  <div class="quiz-container">
    <a class="back-link" id="backLink" href="../../Student/subject_science.html"><i class="fa fa-arrow-left"></i> Back to Science</a>
    <h2 style="margin-top:0;text-align:center;">Assessment 1: Science Fundamentals</h2>
    <div id="quiz">
      <div class="question" id="questionText"></div>
      <div class="options" id="options"></div>
      <button id="nextBtn">Next</button>
      <div id="result"></div>
      <div id="uploadStatus"></div>
      <button id="viewAttemptsBtn" class="attempts-btn" style="display:none;">View Attempts</button>
    </div>
  </div>

  <!-- Attempts Modal -->
  <div id="attemptsModal">
    <div class="modal-content">
      <h3>Your Attempts</h3>
      <div id="attemptsList">Loading...</div>
      <div style="text-align:right;margin-top:18px;">
        <button onclick="closeAttemptsModal()">Close</button>
      </div>
    </div>
  </div>
  </main>
  <!-- Footer -->
  <footer>
    <div class="footer-wrap">
      <div class="footer-col">
        <h4 class="footer-brand">Edutaktika</h4>
        <p>Making learning fun and engaging through interactive game-based education.</p>
      </div>
      <div class="footer-col">
        <h4>Quick Links</h4>
        <ul class="footer-links">
          <li><a href="../../Student/homepage.html">Home</a></li>
          <li><a href="../../Student/subject_science.html">Science</a></li>
          <li><a href="../../Student/leaderboard.html">Leaderboard</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <h4>Support</h4>
        <ul class="footer-links">
          <li><a href="#">Help Center</a></li>
          <li><a href="#">Contact Us</a></li>
          <li><a href="#">Privacy Policy</a></li>
          <li><a href="#">Terms of Service</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="footer-social-row">
        <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
        <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
        <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
        <a href="#" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
      </div>
      <p>© 2025 Edutaktika. All rights reserved.</p>
    </div>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = { apiKey:"AIzaSyB5BbeLLvPX8l1c4Lq0f-CmIUml4hQOQlE", authDomain:"edutaktika.firebaseapp.com", databaseURL:"https://edutaktika-default-rtdb.firebaseio.com", projectId:"edutaktika", storageBucket:"edutaktika.appspot.com", messagingSenderId:"676848575316", appId:"1:676848575316:web:f78f8c0f83bf3d9dfb5ec1", measurementId:"G-X3GT5TNN87" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const ASSESSMENT_KEY = 'assessment1_science';

    // Detect if user is teacher and adjust back link and view
    let isTeacher = false;
    auth.onAuthStateChanged(async function(user) {
        console.log('Science Assessment - Auth state changed:', user);
        if (user) {
            const uid = user.uid;
            console.log('Science Assessment - User UID:', uid);
            // Check if user is a teacher
            const teacherSnap = await db.ref('teachers/' + uid).once('value');
            const teacher = teacherSnap.val();
            console.log('Science Assessment - Teacher data:', teacher);
            
            if (teacher && teacher.role === "teacher") {
                console.log('Science Assessment - Teacher detected, updating navigation');
                isTeacher = true;
                // User is a teacher, update back link to teacher page
                const backLink = document.getElementById('backLink');
                if (backLink) {
                    backLink.href = '../../Teacher/subject_science.html';
                    backLink.innerHTML = '<i class="fa fa-arrow-left"></i> Back to Science (Teacher)';
                }
                
                // Update navigation links for teachers
                updateNavigationForTeachers();
                
                // Show teacher view with answers
                showTeacherView();
            } else {
                console.log('Science Assessment - Not a teacher or teacher data not found');
            }
        }
    });

    // Function to update navigation links for teachers
    function updateNavigationForTeachers() {
        console.log('Science Assessment - Updating navigation for teachers');
        const navHome = document.getElementById('navHome');
        const navMath = document.getElementById('navMath');
        const navEnglish = document.getElementById('navEnglish');
        const navScience = document.getElementById('navScience');
        const navLeaderboard = document.getElementById('navLeaderboard');
        
        console.log('Science Assessment - Navigation elements found:', {
            navHome: !!navHome,
            navMath: !!navMath,
            navEnglish: !!navEnglish,
            navScience: !!navScience,
            navLeaderboard: !!navLeaderboard
        });
        
        if (navHome) {
            navHome.href = '../../Teacher/homepage.html';
            console.log('Science Assessment - Updated navHome href');
        }
        if (navMath) {
            navMath.href = '../../Teacher/subject_math.html';
            console.log('Science Assessment - Updated navMath href');
        }
        if (navEnglish) {
            navEnglish.href = '../../Teacher/subject_english.html';
            console.log('Science Assessment - Updated navEnglish href');
        }
        if (navScience) {
            navScience.href = '../../Teacher/subject_science.html';
            console.log('Science Assessment - Updated navScience href');
        }
        if (navLeaderboard) {
            navLeaderboard.href = '../../Teacher/leaderboard.html';
            console.log('Science Assessment - Updated navLeaderboard href');
        }
    }

    const quizData = [
      { question: "What is the center of our solar system?", options: ["Earth","Moon","Sun","Mars"], correct:2 },
      { question: "Which of these is a living thing?", options: ["rock","tree","water","air"], correct:1 },
      { question: "What do plants need to make their own food?", options: ["water only","sunlight only","water and sunlight","soil only"], correct:2 },
      { question: "What happens when you mix red and blue paint?", options: ["green","purple","orange","yellow"], correct:1 },
      { question: "Which sense do you use to hear sounds?", options: ["eyes","ears","nose","mouth"], correct:1 },
      { question: "What is the largest planet in our solar system?", options: ["Earth","Jupiter","Saturn","Mars"], correct:1 },
      { question: "What do we call water when it turns into ice?", options: ["melting","freezing","boiling","evaporating"], correct:1 },
      { question: "Which animal is a mammal?", options: ["fish","bird","dog","frog"], correct:2 },
      { question: "What do we call the air we breathe out?", options: ["oxygen","carbon dioxide","nitrogen","water vapor"], correct:1 },
      { question: "What is the force that pulls things down?", options: ["magnetism","gravity","electricity","friction"], correct:1 }
    ];

    let currentQuestion = 0;
    let score = 0;

    // Teacher view function
    function showTeacherView() {
        const quizContainer = document.querySelector('.quiz-container');
        const title = quizContainer.querySelector('h2');
        title.textContent = 'Assessment 1: Science Fundamentals (Teacher View)';
        
        // Hide the quiz interface and show answer sheet
        const quiz = document.getElementById('quiz');
        quiz.innerHTML = `
            <div style="text-align: center; margin-bottom: 20px;">
                <h3 style="color: #2e8b57;">Answer Sheet</h3>
                <p style="color: #666;">This view shows all questions with correct answers highlighted</p>
            </div>
            <div id="answerSheet"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="window.location.href='../../Teacher/subject_science.html'" style="background: #6d28d9; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                    Back to Teacher Dashboard
                </button>
            </div>
        `;
        
        // Display all questions with answers
        const answerSheet = document.getElementById('answerSheet');
        quizData.forEach((q, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.style.cssText = 'margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;';
            questionDiv.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 10px;">Question ${index + 1}: ${q.question}</div>
                <div style="margin-left: 20px;">
                    ${q.options.map((option, optIndex) => `
                        <div style="padding: 5px 0; ${optIndex === q.correct ? 'background: #d4edda; color: #155724; font-weight: bold; padding: 8px; border-radius: 4px;' : ''}">
                            ${String.fromCharCode(65 + optIndex)}. ${option} ${optIndex === q.correct ? '✓' : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            answerSheet.appendChild(questionDiv);
        });
    }

    const questionText = document.getElementById('questionText');
    const optionsContainer = document.getElementById('options');
    const nextBtn = document.getElementById('nextBtn');
    const resultDiv = document.getElementById('result');
    const uploadStatus = document.getElementById('uploadStatus');
    const viewAttemptsBtn = document.getElementById('viewAttemptsBtn');

    function loadQuestion(){
      const q = quizData[currentQuestion];
      questionText.textContent = `Question ${currentQuestion + 1}: ${q.question}`;
      optionsContainer.innerHTML='';
      q.options.forEach((opt,i)=>{
        const label = document.createElement('label');
        label.innerHTML = `<input type="radio" name="option" value="${i}"> ${opt}`;
        optionsContainer.appendChild(label);
      });
      nextBtn.disabled = true;
      optionsContainer.querySelectorAll('input[name="option"]').forEach(r=>r.addEventListener('change',()=>{nextBtn.disabled=false;}));
      nextBtn.textContent = currentQuestion === quizData.length -1 ? 'Finish' : 'Next';
    }

    nextBtn.addEventListener('click', ()=>{
      const sel = document.querySelector("input[name='option']:checked");
      if(!sel) return;
      if(parseInt(sel.value) === quizData[currentQuestion].correct) score++;
      currentQuestion++;
      if(currentQuestion < quizData.length) loadQuestion(); else showResult();
    });

    function showResult(){
      questionText.style.display='none';
      optionsContainer.style.display='none';
      nextBtn.style.display='none';
      resultDiv.innerHTML = `You scored ${score} out of ${quizData.length}`;
      saveAttempt(score, quizData.length);
    }

    function requireAuthUid(){
      const u = auth.currentUser; if(!u){ uploadStatus.textContent='Login required to save score.'; return null;} return u.uid; }

    const USE_STUDENT_PATH = true; // set to true to store under students/<uid>/assessments (more permissive in your current rules)

    function primaryAttemptRef(uid){
      return db.ref(`assessmentAttempts/${ASSESSMENT_KEY}/${uid}`).push();
    }
    function studentAttemptRef(uid){
      return db.ref(`students/${uid}/assessments/${ASSESSMENT_KEY}/attempts`).push();
    }
    function summaryRefPrimary(uid){
      return db.ref(`assessmentSummaries/${ASSESSMENT_KEY}/${uid}`);
    }
    function summaryRefStudent(uid){
      return db.ref(`students/${uid}/assessments/${ASSESSMENT_KEY}/summary`);
    }

    function saveAttempt(rawScore,total){
      const uid = requireAuthUid(); if(!uid) return;
      const payload = { score:rawScore, total:total, percentage: Math.round(rawScore/total*100), timestamp: Date.now() };
      uploadStatus.textContent='Saving attempt...';

      // choose primary path first unless flag forces student path
      const tryPrimary = !USE_STUDENT_PATH;
      const doPrimary = () => {
        const ref = primaryAttemptRef(uid);
        return ref.set(payload).then(()=> updateSummary(uid, payload, true)).catch(err=>{ throw err; });
      };
      const doStudent = () => {
        const ref = studentAttemptRef(uid);
        return ref.set(payload).then(()=> updateSummary(uid, payload, false));
      };

      const exec = tryPrimary ? doPrimary().catch(err => {
        if(err && err.code === 'PERMISSION_DENIED'){ return doStudent(); }
        throw err;
      }) : doStudent();

      exec.then(()=>{
        uploadStatus.textContent='Attempt saved ✅';
        viewAttemptsBtn.style.display='inline-block';
      }).catch(e=>{
        uploadStatus.textContent='Save failed: '+ e.message + ' (check DB rules)';
        console.error('Attempt save error', e);
      });
    }

    function updateSummary(uid, payload, usedPrimary){
      const ref = (USE_STUDENT_PATH || !usedPrimary) ? summaryRefStudent(uid) : summaryRefPrimary(uid);
      return ref.transaction(current => {
        if(!current) return { best: payload.score, bestPercentage: payload.percentage, last: payload.score, lastPercentage: payload.percentage, total: payload.total, attempts:1, lastTimestamp: payload.timestamp };
        const best = Math.max(current.best || 0, payload.score);
        return { best, bestPercentage: Math.round(best/payload.total*100), last: payload.score, lastPercentage: payload.percentage, total: payload.total, attempts:(current.attempts||0)+1, lastTimestamp: payload.timestamp };
      });
    }

    // Attempts modal logic
    function openAttemptsModal(){
      const modal = document.getElementById('attemptsModal');
      modal.style.display='flex';
      loadAttempts();
    }
    function closeAttemptsModal(){ document.getElementById('attemptsModal').style.display='none'; }
    window.closeAttemptsModal = closeAttemptsModal; // expose

    function loadAttempts(){
      const uid = requireAuthUid(); if(!uid) return;
      const listDiv = document.getElementById('attemptsList');
      listDiv.textContent='Loading...';
      // decide path
      const attemptsPath = (USE_STUDENT_PATH ? `students/${uid}/assessments/${ASSESSMENT_KEY}/attempts` : `assessmentAttempts/${ASSESSMENT_KEY}/${uid}`);
      db.ref(attemptsPath).orderByChild('timestamp').once('value', snap => {
        if(!snap.exists()) { listDiv.textContent='No attempts yet.'; return; }
        const rows=[]; snap.forEach(child => rows.push(child.val()));
        rows.sort((a,b)=> b.timestamp - a.timestamp);
        listDiv.innerHTML = rows.map((a,i)=>{ const ds = new Date(a.timestamp).toLocaleString(); return `<div class='attempt-row'><span>#${rows.length - i}</span><span>${a.score}/${a.total}</span><span>${a.percentage}%</span><span>${ds}</span></div>`; }).join('');
      }).catch(e=>{ listDiv.textContent='Load failed: '+e.message; });
    }

    viewAttemptsBtn.addEventListener('click', openAttemptsModal);

    auth.onAuthStateChanged(u=>{ if(u){ viewAttemptsBtn.style.display='inline-block'; } });

    // Only load question for students, teachers see answer sheet
    if (!isTeacher) {
        loadQuestion();
    }
  </script>
</body>
</html>
